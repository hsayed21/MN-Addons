# ğŸ“š MarginNote æ’ä»¶å¼€å‘ï¼šä» JavaScript é›¶åŸºç¡€åˆ°å…¥é—¨

> ğŸ¯ **æœ¬æ–‡ç›®æ ‡**ï¼šè®©å®Œå…¨æ²¡æœ‰ç¼–ç¨‹ç»éªŒçš„å°ç™½ï¼Œé€šè¿‡ MarginNote æ’ä»¶çš„å®é™…ä»£ç ï¼Œç†è§£ JavaScript çš„æ ¸å¿ƒæ¦‚å¿µï¼Œæœ€ç»ˆèƒ½å¤Ÿå¼€å‘ç®€å•çš„æ’ä»¶ã€‚

## ğŸ“– å‰è¨€ï¼šä¸ºä»€ä¹ˆè¦å­¦ JavaScriptï¼Ÿ

å¦‚æœä½ æ˜¯ MarginNote çš„æ·±åº¦ç”¨æˆ·ï¼Œä¸€å®šç”¨è¿‡å„ç§æ’ä»¶ï¼šMNUtilsã€MNToolbarã€MNChatGLM ç­‰ã€‚è¿™äº›æ’ä»¶éƒ½æ˜¯ç”¨ JavaScript ç¼–å†™çš„ã€‚å­¦ä¼š JavaScriptï¼Œä½ å°±èƒ½ï¼š

1. **å®šåˆ¶è‡ªå·±çš„å·¥ä½œæµ**ï¼šä¸å†å—é™äºç°æœ‰åŠŸèƒ½
2. **ç†è§£æ’ä»¶çš„å·¥ä½œåŸç†**ï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶
3. **å‚ä¸ç¤¾åŒºè´¡çŒ®**ï¼šå¸®åŠ©æ”¹è¿›ç°æœ‰æ’ä»¶

æœ¬æ–‡å°†é€šè¿‡åˆ†æçœŸå®çš„æ’ä»¶ä»£ç ï¼Œè®©ä½ åœ¨ç†è§£ JavaScript çš„åŒæ—¶ï¼ŒæŒæ¡ MarginNote æ’ä»¶å¼€å‘ã€‚

---

## ğŸš€ å¼€å§‹å‰çš„é€ŸæŸ¥è¡¨ - é‡è¦æ¦‚å¿µä¸€è§ˆ

åœ¨å¼€å§‹å­¦ä¹ ä¹‹å‰ï¼Œè¿™é‡Œæ˜¯ä¸€äº›ä½ ä¼šç»å¸¸é‡åˆ°çš„é‡è¦æ¦‚å¿µã€‚ä¸ç”¨ç°åœ¨å°±å®Œå…¨ç†è§£ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°æ—¶å¯ä»¥å›æ¥æŸ¥çœ‹ï¼š

### ğŸ“ å˜é‡ç›¸å…³
| æ¦‚å¿µ | ç®€å•ç†è§£ | ä½•æ—¶é‡åˆ° |
|-----|---------|----------|
| **undefined** | å£°æ˜äº†å˜é‡ä½†æ²¡ç»™å€¼ | å¿˜è®°èµ‹å€¼æ—¶ |
| **null** | æ•…æ„è¡¨ç¤º"ç©º" | ä¸»åŠ¨æ¸…ç©ºå˜é‡æ—¶ |
| **å˜é‡** | è£…æ•°æ®çš„ç›’å­ | å­˜å‚¨ä¿¡æ¯æ—¶ |

### ğŸ”§ å‡½æ•°ç›¸å…³  
| æ¦‚å¿µ | ç®€å•ç†è§£ | ä½•æ—¶é‡åˆ° |
|-----|---------|----------|
| **å‡½æ•°** | æ‰§è¡Œä»»åŠ¡çš„æœºå™¨ | æƒ³é‡å¤æ‰§è¡Œä»£ç æ—¶ |
| **å‚æ•°** | ç»™æœºå™¨çš„åŸæ–™ | å‡½æ•°éœ€è¦å¤–éƒ¨æ•°æ®æ—¶ |
| **è¿”å›å€¼** | æœºå™¨çš„äº§å“ | éœ€è¦å‡½æ•°ç»™ç»“æœæ—¶ |
| **æå‡(hoisting)** | å‡½æ•°å¯ä»¥åœ¨å£°æ˜å‰ä½¿ç”¨ | ä»£ç é¡ºåºçœ‹èµ·æ¥ä¸å¯¹æ—¶ |

### ğŸ—ï¸ é¢å‘å¯¹è±¡ç›¸å…³
| æ¦‚å¿µ | ç®€å•ç†è§£ | ä½•æ—¶é‡åˆ° |
|-----|---------|----------|
| **ç±»(class)** | åˆ¶é€ äº§å“çš„æ¨¡å…· | è¦åˆ›å»ºç›¸ä¼¼å¯¹è±¡æ—¶ |
| **å®ä¾‹** | æ¨¡å…·åˆ¶é€ çš„äº§å“ | ç”¨ new åˆ›å»ºå¯¹è±¡æ—¶ |
| **static** | å±äºå·¥å‚çš„åŠŸèƒ½ï¼Œä¸å±äºäº§å“ | ä¸éœ€è¦å®ä¾‹çš„å·¥å…·æ–¹æ³• |
| **constructor** | äº§å“å‡ºå‚å‰çš„åŒ…è£…æµç¨‹ | åˆ›å»ºå®ä¾‹æ—¶çš„åˆå§‹åŒ– |
| **this** | "å½“å‰è¿™ä¸ªå¯¹è±¡" | è®¿é—®å¯¹è±¡è‡ªå·±çš„å±æ€§æ—¶ |

### âš™ï¸ é«˜çº§æ¦‚å¿µ
| æ¦‚å¿µ | ç®€å•ç†è§£ | ä½•æ—¶é‡åˆ° |
|-----|---------|----------|
| **é—­åŒ…** | å‡½æ•°çš„è®°å¿†ç›’å­ | éœ€è¦å‡½æ•°è®°ä½æ•°æ®æ—¶ |
| **å¼‚æ­¥** | ä¸ç­‰ç»“æœï¼Œå…ˆåšå…¶ä»–äº‹ | ç­‰å¾…ç½‘ç»œè¯·æ±‚æˆ–å»¶æ—¶æ—¶ |
| **Promise** | è£…æœªæ¥ç»“æœçš„ç›’å­ | å¤„ç†å¼‚æ­¥æ“ä½œæ—¶ |
| **getter/setter** | æ§åˆ¶è¯»å†™å±æ€§çš„å®ˆé—¨å‘˜ | å±æ€§éœ€è¦ç‰¹æ®Šå¤„ç†æ—¶ |

### ğŸ” MarginNote ç‰¹æœ‰
| æ¦‚å¿µ | ç®€å•ç†è§£ | ä½•æ—¶é‡åˆ° |
|-----|---------|----------|
| **JSB.defineClass** | MarginNote çš„æ’ä»¶åˆ›å»ºæ–¹å¼ | å¼€å‘æ’ä»¶æ—¶ |
| **prototype** | æ–¹æ³•å…±äº«æœºåˆ¶ | ç»™æ’ä»¶æ·»åŠ åŠŸèƒ½æ—¶ |
| **MNUtil** | MarginNote çš„å·¥å…·ç®± | è°ƒç”¨ç³»ç»ŸåŠŸèƒ½æ—¶ |

### ğŸ’¡ è®°ä½è¿™ä¸ªåŸåˆ™
> **"ä¸æ‡‚å°±æŸ¥ï¼ŒæŸ¥äº†å°±ç”¨ï¼Œç”¨äº†å°±ä¼š"** - ç¼–ç¨‹å­¦ä¹ çš„ä¸äºŒæ³•é—¨

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šJavaScript åŸºç¡€æ¦‚å¿µ

### 1.1 å˜é‡å’Œæ•°æ®ç±»å‹ - å­˜å‚¨ä¿¡æ¯çš„å®¹å™¨

#### ä»€ä¹ˆæ˜¯å˜é‡ï¼Ÿ

æƒ³è±¡ä½ æœ‰å¾ˆå¤šç›’å­ï¼Œæ¯ä¸ªç›’å­ä¸Šè´´ç€æ ‡ç­¾ï¼Œé‡Œé¢è£…ç€ä¸åŒçš„ä¸œè¥¿ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œå˜é‡å°±æ˜¯è¿™æ ·çš„"ç›’å­"ã€‚

è®©æˆ‘ä»¬ä»æœ€ç®€å•çš„å˜é‡å¼€å§‹ï¼š

```javascript
// æœ€åŸºç¡€çš„å˜é‡ä¾‹å­
let pluginName = "MNUtils";        // å­—ç¬¦ä¸²å˜é‡ - è£…æ–‡å­—
let version = 1.0;                 // æ•°å­—å˜é‡ - è£…æ•°å­—  
let isEnabled = true;              // å¸ƒå°”å˜é‡ - è£…çœŸ/å‡
```

**ğŸ“ "class" æ˜¯ä»€ä¹ˆï¼Ÿ** ä½ å¯èƒ½æ³¨æ„åˆ°ä¸‹é¢çš„ä¾‹å­ä¸­æœ‰ `class` è¿™ä¸ªè¯ã€‚åˆ«æ‹…å¿ƒï¼

- **ç®€å•ç†è§£**ï¼šclass å°±æ˜¯åˆ¶é€ ç›¸ä¼¼ç‰©å“çš„"æ¨¡å…·"
- **ç°åœ¨åªéœ€çŸ¥é“**ï¼š`class MNLog` æ„æ€æ˜¯"åˆ›å»ºä¸€ä¸ªå« MNLog çš„å·¥å…·é›†åˆ"
- **æ·±å…¥å­¦ä¹ **ï¼šæˆ‘ä»¬ä¼šåœ¨1.3èŠ‚è¯¦ç»†è§£é‡Šç±»çš„æ¦‚å¿µ

ç°åœ¨çœ‹ **mnutils/mnutils.js** ä¸­çš„å®é™…ä¾‹å­ï¼š

```javascript
// mnutils.js:174-180 è¡Œ
class MNLog {  // åˆ›å»ºä¸€ä¸ªå« MNLog çš„å·¥å…·é›†åˆ
  static logs = []  // è¿™æ˜¯ä¸€ä¸ªå˜é‡ï¼Œå­˜å‚¨æ‰€æœ‰æ—¥å¿—
  
  static updateLog(log){
    // log æ˜¯å‚æ•°å˜é‡ï¼Œå­˜å‚¨ä¼ å…¥çš„æ—¥å¿—å†…å®¹
    if (subscriptionUtils.subscriptionController) {
      subscriptionUtils.subscriptionController?.appendLog(log)
    }
  }
}
```

#### JavaScript ä¸­çš„æ•°æ®ç±»å‹

åœ¨ MarginNote æ’ä»¶ä¸­ï¼Œä½ ä¼šç»å¸¸é‡åˆ°è¿™äº›æ•°æ®ç±»å‹ï¼š

##### 1. **å­—ç¬¦ä¸²ï¼ˆStringï¼‰** - æ–‡æœ¬å†…å®¹

```javascript
// mntoolbar/xdyy_button_registry.js çš„å®é™…ä¾‹å­
global.registerButton("custom15", {
  name: "æ—¶é—´æˆ³",        // å­—ç¬¦ä¸²ï¼šæŒ‰é’®æ˜¾ç¤ºçš„æ–‡å­—
  image: "custom15",     // å­—ç¬¦ä¸²ï¼šå›¾æ ‡æ–‡ä»¶å
  templateName: "menu_timestamp"  // å­—ç¬¦ä¸²ï¼šèœå•æ¨¡æ¿å
});
```

##### 2. **æ•°å­—ï¼ˆNumberï¼‰** - æ•°å€¼

```javascript
// mnutils.js:3067 è¡Œ - MNNote ç±»ä¸­
note.colorIndex = 3;     // æ•°å­—ï¼šé¢œè‰²ç´¢å¼•ï¼ˆ0-15ï¼‰
note.fillIndex = 0;      // æ•°å­—ï¼šå¡«å……æ ·å¼ç´¢å¼•
menu.rowHeight = 35;     // æ•°å­—ï¼šèœå•è¡Œé«˜ï¼ˆåƒç´ ï¼‰
```

##### 3. **å¸ƒå°”å€¼ï¼ˆBooleanï¼‰** - çœŸ/å‡

```javascript
// mnutils.js:2145 è¡Œ
class MNUtil {
  static onAlert = false  // å¸ƒå°”å€¼ï¼šæ˜¯å¦æ­£åœ¨æ˜¾ç¤ºå¯¹è¯æ¡†
  
  static showHUD(message, duration = 2) {
    if (this.onAlert) {  // æ£€æŸ¥å¸ƒå°”å€¼
      return;  // å¦‚æœæ­£åœ¨æ˜¾ç¤ºï¼Œç›´æ¥è¿”å›
    }
    // æ˜¾ç¤ºæç¤º...
  }
}
```

##### 4. **æ•°ç»„ï¼ˆArrayï¼‰** - æœ‰åºåˆ—è¡¨

```javascript
// mntoolbar/xdyy_menu_registry.js çš„å®é™…ä¾‹å­
global.registerMenuTemplate("menu_timestamp", {
  menuItems: [  // æ•°ç»„ï¼šåŒ…å«å¤šä¸ªèœå•é¡¹
    { action: "addTimestamp", menuTitle: "æ·»åŠ åˆ°æ ‡é¢˜" },
    { action: "addTimestampComment", menuTitle: "æ·»åŠ ä¸ºè¯„è®º" },
    { action: "copyTimestamp", menuTitle: "å¤åˆ¶æ—¶é—´æˆ³" }
  ]
});
```

##### 5. **å¯¹è±¡ï¼ˆObjectï¼‰** - é”®å€¼å¯¹é›†åˆ

```javascript
// mnutils.js - ä¸€ä¸ªç¬”è®°å¯¹è±¡çš„ç»“æ„
const noteInfo = {
  noteId: "38ACB470-803E-4EE8-B7DD-1BF4722AB0FE",  
  title: "ã€å®šä¹‰ã€‘JavaScript å˜é‡",
  colorIndex: 3,
  comments: ["è¿™æ˜¯è¯„è®º1", "è¿™æ˜¯è¯„è®º2"],
  parentNote: null  // null è¡¨ç¤º"ç©º"ï¼Œæ²¡æœ‰çˆ¶ç¬”è®°
};
```

##### 6. **ç‰¹æ®Šå€¼ï¼šundefined å’Œ null** - åˆå­¦è€…æœ€å›°æƒ‘çš„æ¦‚å¿µ

è¿™ä¸¤ä¸ªéƒ½è¡¨ç¤º"æ²¡æœ‰å€¼"ï¼Œä½†ç”¨æ³•ä¸åŒï¼š

```javascript
// undefinedï¼šç³»ç»Ÿè¯´"æˆ‘ä¸çŸ¥é“"
let userName;                    // å£°æ˜äº†ä½†æ²¡èµ‹å€¼
MNUtil.log(userName);           // undefined

let note = MNNote.getFocusNote();
if (!note) {
  MNUtil.log("æ²¡æœ‰é€‰ä¸­ç¬”è®°");      // note å¯èƒ½æ˜¯ null
}

// nullï¼šç¨‹åºå‘˜è¯´"è¿™é‡Œæ•…æ„ç©ºç€"
let settings = {
  theme: "dark",
  language: "zh-CN", 
  customCSS: null    // æ•…æ„è®¾ä¸ºç©ºï¼Œè¡¨ç¤º"æš‚æ—¶æ²¡æœ‰è‡ªå®šä¹‰æ ·å¼"
};
```

**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
- **undefined**ï¼šå°±åƒé—®"ä½ ä»Šå¤©åƒäº†ä»€ä¹ˆï¼Ÿ"ï¼Œå¯¹æ–¹è¯´"æˆ‘å¿˜äº†"ï¼ˆç³»ç»Ÿä¸çŸ¥é“ï¼‰
- **null**ï¼šå°±åƒé—®"ä½ ä»Šå¤©åƒäº†ä»€ä¹ˆï¼Ÿ"ï¼Œå¯¹æ–¹è¯´"æˆ‘æ²¡åƒ"ï¼ˆä¸»åŠ¨å‘Šè¯‰ä½ æ˜¯ç©ºçš„ï¼‰

**åœ¨ MarginNote æ’ä»¶ä¸­çš„å®é™…åº”ç”¨**ï¼š

```javascript
// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨
let focusNote = MNNote.getFocusNote();
if (focusNote === null) {
  MNUtil.showHUD("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°");
  return;
}

// æ£€æŸ¥å±æ€§æ˜¯å¦å®šä¹‰
if (typeof focusNote.customProperty === "undefined") {
  focusNote.customProperty = "é»˜è®¤å€¼";
}

// æ¸…ç©ºæŸä¸ªå±æ€§ï¼ˆè®¾ç½®ä¸º nullï¼‰
focusNote.tempData = null;  // ä¸»åŠ¨æ¸…ç©ºä¸´æ—¶æ•°æ®
```

**å¸¸è§é”™è¯¯å’Œæ­£ç¡®å¤„ç†**ï¼š

```javascript
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨å¯èƒ½ä¸º undefined çš„å€¼
let note = MNNote.getFocusNote();
note.appendComment("æ–°è¯„è®º");  // å¦‚æœ note æ˜¯ nullï¼Œä¼šæŠ¥é”™ï¼

// âœ… æ­£ç¡®ï¼šå…ˆæ£€æŸ¥å†ä½¿ç”¨
let note = MNNote.getFocusNote();
if (note) {  // åŒæ—¶æ£€æŸ¥ null å’Œ undefined
  note.appendComment("æ–°è¯„è®º");
} else {
  MNUtil.showHUD("è¯·å…ˆé€‰æ‹©ç¬”è®°");
}

// âœ… æ›´ç®€æ´çš„å†™æ³•ï¼šå¯é€‰é“¾æ“ä½œç¬¦ï¼ˆå¦‚æœæ”¯æŒï¼‰
note?.appendComment("æ–°è¯„è®º");  // åªæœ‰ note å­˜åœ¨æ—¶æ‰è°ƒç”¨
```

**è®°å¿†æŠ€å·§**ï¼š
- **undefined**ï¼š"æˆ‘ä¸çŸ¥é“" - ç³»ç»Ÿæ²¡ç»™å€¼
- **null**ï¼š"æˆ‘çŸ¥é“æ˜¯ç©ºçš„" - ç¨‹åºå‘˜ä¸»åŠ¨è®¾ç©º

#### ğŸ¤” æ€è€ƒé¢˜

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½ èƒ½æ‰¾å‡ºï¼š
1. å“ªäº›æ˜¯å­—ç¬¦ä¸²ï¼Ÿï¼ˆæç¤ºï¼šç”¨å¼•å·åŒ…å›´çš„ï¼‰
2. å“ªäº›æ˜¯æ•°å­—ï¼Ÿï¼ˆæç¤ºï¼šæ²¡æœ‰å¼•å·çš„æ•°å€¼ï¼‰
3. å“ªäº›æ˜¯æ•°ç»„ï¼Ÿï¼ˆæç¤ºï¼šç”¨ [] åŒ…å›´çš„ï¼‰

---

### 1.2 å‡½æ•°çš„ä¸‰ç§å½¢å¼ - æ‰§è¡Œä»»åŠ¡çš„ä»£ç å—

å‡½æ•°å°±åƒæ˜¯ä¸€ä¸ª"æœºå™¨"ï¼Œä½ ç»™å®ƒè¾“å…¥ï¼ˆå‚æ•°ï¼‰ï¼Œå®ƒæ‰§è¡Œä¸€äº›æ“ä½œï¼Œç„¶åç»™ä½ è¾“å‡ºï¼ˆè¿”å›å€¼ï¼‰ã€‚

#### å½¢å¼1ï¼šæ™®é€šå‡½æ•°å£°æ˜

```javascript
// mnutils.js:102 è¡Œ - Menu ç±»ä¸­
function strCode(str) {
  // è®¡ç®—å­—ç¬¦ä¸²çš„æ˜¾ç¤ºå®½åº¦
  let width = 0;
  for (let i = 0; i < str.length; i++) {
    if (str.charCodeAt(i) > 127) {
      width += 2;  // ä¸­æ–‡å­—ç¬¦ç®—2ä¸ªå®½åº¦
    } else {
      width += 1;  // è‹±æ–‡å­—ç¬¦ç®—1ä¸ªå®½åº¦
    }
  }
  return width;
}
```

**ç‰¹ç‚¹**ï¼š
- ç”¨ `function` å…³é”®å­—å¼€å¤´
- æœ‰å‡½æ•°åï¼ˆstrCodeï¼‰
- å¯ä»¥åœ¨å£°æ˜ä¹‹å‰è°ƒç”¨ï¼ˆæå‡ç‰¹æ€§ï¼‰

**ğŸ“š ä»€ä¹ˆæ˜¯"æå‡ç‰¹æ€§"ï¼ˆHoistingï¼‰ï¼Ÿ**

æƒ³è±¡ä½ åœ¨çœ‹ä¸€æœ¬ä¹¦ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä½ éœ€è¦ä»ç¬¬1é¡µå¼€å§‹è¯»ï¼Œä½†æœ‰äº›ç‰¹æ®Šçš„é¡µé¢ï¼ˆå‡½æ•°å£°æ˜ï¼‰ä½ å¯ä»¥åœ¨è¿˜æ²¡è¯»åˆ°å®ƒä¹‹å‰å°±è·³è½¬è¿‡å»çœ‹ã€‚

```javascript
// ğŸ¤” è¿™æ ·å†™å±…ç„¶ä¸ä¼šæŠ¥é”™ï¼
sayHello("å°æ˜");  // è°ƒç”¨å‡½æ•° - ä½†å‡½æ•°å®šä¹‰åœ¨ä¸‹é¢ï¼Ÿ

// å‡½æ•°å®šä¹‰åœ¨è¿™é‡Œ
function sayHello(name) {
  MNUtil.showHUD("ä½ å¥½ï¼Œ" + name);
}

// JavaScript ä¼šè‡ªåŠ¨æŠŠå‡½æ•°å£°æ˜"æå‡"åˆ°ä»£ç é¡¶éƒ¨ï¼Œå°±å¥½åƒï¼š
// function sayHello(name) { ... }  â† è‡ªåŠ¨ç§»åˆ°æœ€å‰é¢
// sayHello("å°æ˜");  â† ç„¶åæ‰æ‰§è¡Œè¿™é‡Œ
```

**é‡è¦åŒºåˆ«**ï¼š
```javascript
// âœ… å‡½æ•°å£°æ˜ - å¯ä»¥æå‡
sayHello();  // æ­£å¸¸å·¥ä½œ
function sayHello() { MNUtil.showHUD("Hello"); }

// âŒ å‡½æ•°è¡¨è¾¾å¼ - ä¸èƒ½æå‡  
sayGoodbye();  // æŠ¥é”™ï¼Cannot access 'sayGoodbye' before initialization
let sayGoodbye = function() { MNUtil.showHUD("Bye"); };
```

#### å½¢å¼2ï¼šç®­å¤´å‡½æ•°

```javascript
// mntoolbar/webviewController.js:1026 è¡Œ
const getToolbarController = () => self

// æ›´å¤æ‚çš„ä¾‹å­
const titles = items.map(item => item.title)
// ç­‰ä»·äºï¼š
const titles = items.map(function(item) {
  return item.title;
})
```

**ç‰¹ç‚¹**ï¼š
- ç”¨ `=>` ç¬¦å·ï¼ˆåƒç®­å¤´ï¼‰
- æ›´ç®€æ´çš„è¯­æ³•
- **æœ€é‡è¦**ï¼šæ²¡æœ‰è‡ªå·±çš„ `this`ï¼Œä¼šç»§æ‰¿å¤–å±‚çš„ `this`

**æ ¸å¿ƒåŒºåˆ«**ï¼š
```javascript
// ç®€å•ç†è§£
// æ™®é€šå‡½æ•°ï¼šthis = "è°è°ƒç”¨æˆ‘"
// ç®­å¤´å‡½æ•°ï¼šthis = "æˆ‘åœ¨å“ªé‡Œå†™çš„"
```

**è¯¦ç»†å®Œæ•´çš„ä¾‹å­**ï¼š

```javascript
// æ¨¡æ‹Ÿä¸€ä¸ª MN æ’ä»¶ç±»çš„ç¯å¢ƒ
class MyPlugin {
  constructor() {
    this.pluginName = "æˆ‘çš„æ’ä»¶";
    
    // åœ¨æ’ä»¶ç±»å†…éƒ¨å®šä¹‰çš„ç®­å¤´å‡½æ•°
    this.arrowFn = () => {
      // â­ å…³é”®ï¼šè¿™é‡Œçš„ this å°±æ˜¯ MyPlugin å®ä¾‹ï¼
      // å› ä¸ºç®­å¤´å‡½æ•°æ˜¯åœ¨ MyPlugin æ„é€ å‡½æ•°ä¸­å†™çš„
      MNUtil.showHUD("ç®­å¤´å‡½æ•°: " + this.pluginName);  // "æˆ‘çš„æ’ä»¶"
    };
  }
  
  // æ™®é€šå‡½æ•°æ–¹æ³•
  normalMethod() {
    MNUtil.showHUD("æ™®é€šæ–¹æ³•: " + this.pluginName);  // "æˆ‘çš„æ’ä»¶"
  }
}

// åˆ›å»ºæ’ä»¶å®ä¾‹
let plugin = new MyPlugin();

// æƒ…å†µ1ï¼šæ­£å¸¸è°ƒç”¨ï¼Œthis éƒ½æ­£ç¡®
plugin.normalMethod();  // æ˜¾ç¤º: "æ™®é€šæ–¹æ³•: æˆ‘çš„æ’ä»¶"
plugin.arrowFn();       // æ˜¾ç¤º: "ç®­å¤´å‡½æ•°: æˆ‘çš„æ’ä»¶"

// æƒ…å†µ2ï¼šæŠŠæ–¹æ³•å•ç‹¬æ‹¿å‡ºæ¥ç»™åˆ«äººç”¨ï¼ˆå…³é”®åŒºåˆ«ï¼ï¼‰
let normalFn = plugin.normalMethod;
let arrowFn = plugin.arrowFn;

// ç°åœ¨ç”±å…¨å±€ç¯å¢ƒè°ƒç”¨
normalFn();  // âŒ æ™®é€šå‡½æ•°: undefined ï¼ˆthis ä¸¢äº†ï¼ï¼‰
arrowFn();   // âœ… ç®­å¤´å‡½æ•°: æˆ‘çš„æ’ä»¶ ï¼ˆthis è¿˜åœ¨ï¼ï¼‰

// æƒ…å†µ3ï¼šæ›´æ˜æ˜¾çš„å¯¹æ¯” - æŠŠå‡½æ•°ç»™å…¶ä»–å¯¹è±¡ä½¿ç”¨
let otherObj = {
  pluginName: "åˆ«çš„æ’ä»¶",
  testNormal: normalFn,   // å€Ÿç”¨æ™®é€šå‡½æ•°
  testArrow: arrowFn      // å€Ÿç”¨ç®­å¤´å‡½æ•°
};

otherObj.testNormal();  // æ˜¾ç¤º: "æ™®é€šæ–¹æ³•: åˆ«çš„æ’ä»¶" ï¼ˆthis å˜æˆäº† otherObjï¼ï¼‰
otherObj.testArrow();   // æ˜¾ç¤º: "ç®­å¤´å‡½æ•°: æˆ‘çš„æ’ä»¶" ï¼ˆthis è¿˜æ˜¯åŸæ¥çš„ pluginï¼ï¼‰
```

**æ ¸å¿ƒåŒºåˆ«è§£é‡Š**ï¼š

1. **æ™®é€šå‡½æ•°**ï¼š`this = "è°è°ƒç”¨æˆ‘"`
   - `plugin.normalMethod()` â†’ this æ˜¯ plugin
   - `otherObj.testNormal()` â†’ this æ˜¯ otherObj
   - `normalFn()` â†’ this æ˜¯ undefinedï¼ˆå…¨å±€è°ƒç”¨ï¼‰

2. **ç®­å¤´å‡½æ•°**ï¼š`this = "æˆ‘åœ¨å“ªé‡Œå†™çš„"`
   - ç®­å¤´å‡½æ•°åœ¨ `MyPlugin` æ„é€ å‡½æ•°ä¸­å†™çš„
   - æ‰€ä»¥ this æ°¸è¿œæ˜¯é‚£ä¸ª `MyPlugin` å®ä¾‹
   - ä¸ç®¡åæ¥è°è°ƒç”¨å®ƒï¼Œthis éƒ½ä¸å˜

**"å†™ä»£ç æ—¶çš„ç¯å¢ƒ" çš„å…·ä½“æ„æ€**ï¼š
```javascript
// ç®­å¤´å‡½æ•°å†™åœ¨å“ªé‡Œï¼Œthis å°±æ˜¯å“ªé‡Œçš„ this
class MyPlugin {
  constructor() {
    // ğŸ‘ˆ ç®­å¤´å‡½æ•°å†™åœ¨è¿™é‡Œï¼Œæ‰€ä»¥ this = MyPlugin å®ä¾‹
    this.arrowFn = () => { ... };
  }
}

// å¦‚æœå†™åœ¨å…¨å±€
let globalArrow = () => {
  // ğŸ‘ˆ å†™åœ¨å…¨å±€ï¼Œæ‰€ä»¥ this = undefinedï¼ˆä¸¥æ ¼æ¨¡å¼ä¸‹ï¼‰
};
```

**ä½¿ç”¨åŸåˆ™**ï¼š
- éœ€è¦è®¿é—®å¯¹è±¡å±æ€§ â†’ æ™®é€šå‡½æ•°åšæ–¹æ³•ï¼Œç®­å¤´å‡½æ•°åšå›è°ƒ
- åªæ˜¯å¤„ç†æ•°æ®ï¼Œä¸ç”¨ this â†’ ç®­å¤´å‡½æ•°æ›´ç®€æ´


---

### 1.3 å¯¹è±¡å’Œç±» - ç†è§£é¢å‘å¯¹è±¡ç¼–ç¨‹

è¿™æ˜¯æœ€é‡è¦çš„æ¦‚å¿µä¹‹ä¸€ï¼Œè®©æˆ‘ä»¬ç”¨ç”Ÿæ´»ä¾‹å­æ¥ç†è§£ã€‚

#### ç±»æ¯”ï¼šç±»æ˜¯"æ¨¡å…·"ï¼Œå¯¹è±¡æ˜¯"äº§å“"

æƒ³è±¡ä½ åœ¨åšæœˆé¥¼ï¼š
- **ç±»ï¼ˆClassï¼‰**= æœˆé¥¼æ¨¡å…·
- **å¯¹è±¡ï¼ˆObjectï¼‰**= ç”¨æ¨¡å…·åšå‡ºçš„ä¸€ä¸ªä¸ªæœˆé¥¼
- **å±æ€§ï¼ˆPropertyï¼‰**= æœˆé¥¼çš„ç‰¹å¾ï¼ˆå£å‘³ã€é‡é‡ï¼‰
- **æ–¹æ³•ï¼ˆMethodï¼‰**= æœˆé¥¼èƒ½åšçš„äº‹ï¼ˆè¢«åƒã€è¢«åŒ…è£…ï¼‰

#### çœŸå®ä»£ç ä¾‹å­ï¼šMNNote ç±»

```javascript
// mnutils.js:3063-3068 è¡Œ
class MNNote {
  // æ„é€ å‡½æ•° - åˆ›å»ºæ–°ç¬”è®°å¯¹è±¡æ—¶è°ƒç”¨
  constructor(note, alert = true) {
    if (typeof note === "string") {
      // å¦‚æœä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²IDï¼Œå»æ•°æ®åº“æŸ¥æ‰¾
      this.note = MNUtil.db.getNoteById(note);
    } else {
      // å¦‚æœä¼ å…¥çš„æ˜¯ç¬”è®°å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
      this.note = note;
    }
  }
  
  // å®ä¾‹å±æ€§ - æ¯ä¸ªç¬”è®°å¯¹è±¡éƒ½æœ‰çš„ç‰¹å¾
  
  // ğŸ“š ä»€ä¹ˆæ˜¯ getï¼Ÿ - å±æ€§çš„"å®ˆé—¨å‘˜"
  // get è®©æ–¹æ³•çœ‹èµ·æ¥åƒæ™®é€šå±æ€§ï¼Œä½†å®é™…ä¸Šæ˜¯å‡½æ•°
  // è°ƒç”¨æ—¶ï¼šmyNote.noteIdï¼ˆä¸éœ€è¦æ‹¬å·ï¼‰
  // å®é™…æ‰§è¡Œï¼šreturn this.note.noteIdï¼ˆä¼šè¿è¡Œè¿™ä¸ªå‡½æ•°ï¼‰
  
  get noteId() {
    return this.note.noteId;
  }
  
  get title() {
    return this.note.noteTitle;
  }
  
  // å®ä¾‹æ–¹æ³• - æ¯ä¸ªç¬”è®°å¯¹è±¡éƒ½èƒ½åšçš„äº‹
  appendComment(text) {
    // ç»™è¿™ä¸ªç¬”è®°æ·»åŠ è¯„è®º
    this.note.appendTextComment(text);
  }
}

// ä½¿ç”¨ç±»åˆ›å»ºå¯¹è±¡
const myNote = new MNNote("38ACB470-803E-4EE8-B7DD-1BF4722AB0FE");
myNote.appendComment("è¿™æ˜¯ä¸€æ¡è¯„è®º");  // è°ƒç”¨å®ä¾‹æ–¹æ³•
```

#### ğŸ” æ·±å…¥ç†è§£ getter å’Œ setter

**ç”Ÿæ´»åŒ–æ¯”å–»**ï¼šgetter å’Œ setter å°±åƒé“¶è¡Œçš„å­˜å–æ¬¾æœºå™¨

```javascript
class BankAccount {
  constructor(initialBalance) {
    this._balance = initialBalance;  // _balance æ˜¯"ç§æœ‰"æ•°æ®
  }
  
  // getterï¼šè¯»å–è´¦æˆ·ä½™é¢çš„"æœºå™¨"
  get balance() {
    MNUtil.showHUD("æ­£åœ¨æŸ¥è¯¢ä½™é¢...");
    return this._balance;  // å¯ä»¥æ·»åŠ é¢å¤–é€»è¾‘
  }
  
  // setterï¼šå­˜æ¬¾çš„"æœºå™¨"  
  set balance(amount) {
    if (amount < 0) {
      MNUtil.showHUD("ä½™é¢ä¸èƒ½ä¸ºè´Ÿæ•°ï¼");
      return;
    }
    MNUtil.showHUD(`å­˜å…¥ ${amount - this._balance} å…ƒ`);
    this._balance = amount;
  }
  
  // æ™®é€šæ–¹æ³•å¯¹æ¯”
  getBalanceMethod() {
    return this._balance;  // éœ€è¦åŠ  ()
  }
}

// ä½¿ç”¨å¯¹æ¯”
let account = new BankAccount(1000);

// getter - åƒè®¿é—®æ™®é€šå±æ€§
let money = account.balance;  // çœ‹èµ·æ¥åƒå±æ€§ï¼Œå®é™…è¿è¡Œäº†å‡½æ•°

// setter - åƒè®¾ç½®æ™®é€šå±æ€§
account.balance = 1500;  // çœ‹èµ·æ¥åƒèµ‹å€¼ï¼Œå®é™…è¿è¡Œäº†å‡½æ•°

// æ™®é€šæ–¹æ³• - éœ€è¦æ‹¬å·
let money2 = account.getBalanceMethod();  // æ˜æ˜¾æ˜¯å‡½æ•°è°ƒç”¨
```

**ä¸ºä»€ä¹ˆè¦ç”¨ getter/setterï¼Ÿ**
1. **æ•°æ®ä¿æŠ¤**ï¼šå¯ä»¥åœ¨è¯»å†™æ—¶è¿›è¡Œæ£€æŸ¥
2. **æ›´è‡ªç„¶**ï¼šåƒæ“ä½œæ™®é€šå±æ€§ï¼Œä½†æœ‰å‡½æ•°çš„çµæ´»æ€§
3. **å‘åå…¼å®¹**ï¼šä»¥åæ”¹æˆå¤æ‚é€»è¾‘ï¼Œä½¿ç”¨æ–¹å¼ä¸å˜

#### ä»€ä¹ˆæ˜¯å®ä¾‹ï¼Ÿ

**å®ä¾‹å°±æ˜¯ç”¨ç±»åˆ›å»ºå‡ºæ¥çš„å…·ä½“å¯¹è±¡**ã€‚å°±åƒï¼š
- `MNNote` æ˜¯ç±»ï¼ˆæœˆé¥¼æ¨¡å…·ï¼‰
- `myNote` æ˜¯å®ä¾‹ï¼ˆä¸€ä¸ªå…·ä½“çš„æœˆé¥¼ï¼‰

ä½ å¯ä»¥ç”¨åŒä¸€ä¸ªç±»åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼š

```javascript
const note1 = new MNNote("ID-001");  // ç¬¬ä¸€ä¸ªç¬”è®°å®ä¾‹
const note2 = new MNNote("ID-002");  // ç¬¬äºŒä¸ªç¬”è®°å®ä¾‹
const note3 = new MNNote("ID-003");  // ç¬¬ä¸‰ä¸ªç¬”è®°å®ä¾‹

// æ¯ä¸ªå®ä¾‹éƒ½æ˜¯ç‹¬ç«‹çš„
note1.appendComment("ç¬”è®°1çš„è¯„è®º");
note2.appendComment("ç¬”è®°2çš„è¯„è®º");
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šç±»çš„æ·±å…¥ç†è§£

### 2.1 ç±»æ–¹æ³• vs å®ä¾‹æ–¹æ³• - static çš„ç§˜å¯†

è¿™æ˜¯åˆå­¦è€…æœ€å›°æƒ‘çš„åœ°æ–¹ï¼šä¸ºä»€ä¹ˆæœ‰äº›æ–¹æ³•è¦åŠ  `static`ï¼Œæœ‰äº›ä¸åŠ ï¼Ÿ

#### ç”Ÿæ´»ç±»æ¯”

æƒ³è±¡ä¸€ä¸ª"æ±½è½¦å·¥å‚"ï¼š
- **ç±»æ–¹æ³•ï¼ˆstaticï¼‰**= å·¥å‚çš„åŠŸèƒ½ï¼ˆç»Ÿè®¡ç”Ÿäº§äº†å¤šå°‘è¾†è½¦ï¼‰
- **å®ä¾‹æ–¹æ³•**= æ¯è¾†è½¦çš„åŠŸèƒ½ï¼ˆå¯åŠ¨ã€åˆ¹è½¦ã€åŠ é€Ÿï¼‰

#### çœŸå®ä»£ç å¯¹æ¯”

è®©æˆ‘ä»¬çœ‹ **mnutils.js** ä¸­ MNUtil ç±»çš„è®¾è®¡ï¼š

```javascript
// mnutils.js:2142-2200 è¡Œï¼ˆç®€åŒ–ç‰ˆï¼‰
class MNUtil {
  // ç±»æ–¹æ³•ï¼ˆstaticï¼‰ - ä¸éœ€è¦åˆ›å»ºå®ä¾‹å°±èƒ½ç”¨
  static showHUD(message, duration = 2) {
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    // ç›´æ¥è°ƒç”¨ï¼šMNUtil.showHUD("ä¿å­˜æˆåŠŸï¼")
  }
  
  static copy(object) {
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    // ç›´æ¥è°ƒç”¨ï¼šMNUtil.copy("è¦å¤åˆ¶çš„æ–‡æœ¬")
  }
  
  static get app() {
    // è·å–åº”ç”¨å®ä¾‹
    return Application.sharedInstance();
  }
}

// âŒ é”™è¯¯ç”¨æ³•ï¼š
const util = new MNUtil();  // MNUtil ä¸éœ€è¦å®ä¾‹åŒ–ï¼
util.showHUD("æ¶ˆæ¯");        // é”™è¯¯ï¼

// âœ… æ­£ç¡®ç”¨æ³•ï¼š
MNUtil.showHUD("æ¶ˆæ¯");     // ç›´æ¥é€šè¿‡ç±»åè°ƒç”¨
```

å†çœ‹ MNNote ç±»çš„è®¾è®¡ï¼š

```javascript
// mnutils.js:3063-3200 è¡Œï¼ˆç®€åŒ–ç‰ˆï¼‰
class MNNote {
  // å®ä¾‹æ–¹æ³• - éœ€è¦å…ˆåˆ›å»ºå®ä¾‹
  appendComment(text) {
    this.note.appendTextComment(text);
    // this æŒ‡å‘å½“å‰å®ä¾‹
  }
  
  // é™æ€æ–¹æ³• - è·å–ç¬”è®°çš„å·¥å…·æ–¹æ³•
  static getFocusNote() {
    // è·å–å½“å‰é€‰ä¸­çš„ç¬”è®°
    const noteId = MNUtil.studyController.focusNote;
    if (noteId) {
      return new MNNote(noteId);  // è¿”å›ä¸€ä¸ªå®ä¾‹
    }
    return null;
  }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼š
const focusNote = MNNote.getFocusNote();  // é™æ€æ–¹æ³•ï¼Œè·å–å®ä¾‹
if (focusNote) {
  focusNote.appendComment("æ–°è¯„è®º");      // å®ä¾‹æ–¹æ³•ï¼Œæ“ä½œå…·ä½“ç¬”è®°
}
```

#### ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ

1. **é™æ€æ–¹æ³•ç”¨äº**ï¼š
   - å·¥å…·å‡½æ•°ï¼ˆMNUtil.showHUDï¼‰
   - å·¥å‚æ–¹æ³•ï¼ˆMNNote.getFocusNoteï¼‰
   - ä¸ä¾èµ–å…·ä½“å®ä¾‹çš„åŠŸèƒ½

2. **å®ä¾‹æ–¹æ³•ç”¨äº**ï¼š
   - æ“ä½œå…·ä½“å¯¹è±¡çš„æ•°æ®ï¼ˆnote.appendCommentï¼‰
   - éœ€è¦è®¿é—® `this` çš„åŠŸèƒ½
   - æ¯ä¸ªå®ä¾‹å¯èƒ½æœ‰ä¸åŒè¡Œä¸ºçš„åŠŸèƒ½

#### ğŸ¯ åˆ¤æ–­æŠ€å·§

é—®è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼š**è¿™ä¸ªåŠŸèƒ½æ˜¯å±äº"ç±»æœ¬èº«"è¿˜æ˜¯å±äº"æŸä¸ªå…·ä½“å¯¹è±¡"ï¼Ÿ**

- æ˜¾ç¤ºæç¤ºæ¡† â†’ ç±»æœ¬èº«çš„åŠŸèƒ½ â†’ static
- ç»™æŸä¸ªç¬”è®°æ·»åŠ è¯„è®º â†’ å…·ä½“ç¬”è®°çš„åŠŸèƒ½ â†’ å®ä¾‹æ–¹æ³•

---

### 2.2 prototype - æ–¹æ³•å…±äº«çš„ç§˜å¯†

**ç®€å•ç†è§£**ï¼šprototype å°±æ˜¯ä¸€ä¸ª"å·¥å…·ç®±"ï¼Œé‡Œé¢æ”¾ç€æ‰€æœ‰å®ä¾‹éƒ½å¯ä»¥ä½¿ç”¨çš„æ–¹æ³•ã€‚

```javascript
// æƒ³è±¡æœ‰ä¸€ä¸ª"ç¬”è®°å·¥å…·ç®±"
class MNNote {
  constructor(id) {
    this.noteId = id;  // æ¯ä¸ªç¬”è®°æœ‰è‡ªå·±çš„IDï¼ˆä¸å…±äº«ï¼‰
  }
}

// å¾€"å·¥å…·ç®±"é‡Œæ”¾æ–¹æ³•ï¼ˆæ‰€æœ‰ç¬”è®°éƒ½å¯ä»¥ç”¨ï¼‰
MNNote.prototype.addComment = function(text) {
  MNUtil.showHUD("ç»™ç¬”è®° " + this.noteId + " æ·»åŠ è¯„è®ºï¼š" + text);
};

// åˆ›å»ºä¸¤ä¸ªç¬”è®°
let note1 = new MNNote("001");
let note2 = new MNNote("002");

// ä¸¤ä¸ªç¬”è®°éƒ½å¯ä»¥ç”¨åŒä¸€ä¸ªæ–¹æ³•
note1.addComment("ç¬¬ä¸€ä¸ªç¬”è®°çš„è¯„è®º");  // "ç»™ç¬”è®° 001 æ·»åŠ è¯„è®º..."
note2.addComment("ç¬¬äºŒä¸ªç¬”è®°çš„è¯„è®º");  // "ç»™ç¬”è®° 002 æ·»åŠ è¯„è®º..."
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- æ•°æ®ç‹¬ç«‹ï¼šæ¯ä¸ªå®ä¾‹æœ‰è‡ªå·±çš„å±æ€§ï¼ˆ`this.noteId`ï¼‰
- æ–¹æ³•å…±äº«ï¼šæ‰€æœ‰å®ä¾‹å…±ç”¨ prototype ä¸Šçš„æ–¹æ³•

**åœ¨ MarginNote æ’ä»¶ä¸­**ï¼š
- `JSB.defineClass` å†…éƒ¨ï¼šæ”¾ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰
- `prototype` ä¸Šï¼šæ”¾è‡ªå·±æ·»åŠ çš„è¾…åŠ©æ–¹æ³•

> ğŸ’¡ **åˆå­¦è€…æç¤º**ï¼šç°åœ¨ç†è§£è¿™ä¸ªæ¦‚å¿µå°±å¤Ÿäº†ï¼Œå¤æ‚çš„ prototype æ“ä½œæˆ‘ä»¬ä¼šåœ¨é™„å½•ä¸­è¯¦ç»†è®²è§£ã€‚

---

### 2.3 JSB.defineClass - MarginNote çš„ç‰¹æ®Šæ¡¥æ¢

**ä»€ä¹ˆæ˜¯ JSBï¼Ÿ**
- **JSB** = JavaScript Bridgeï¼ˆJavaScript æ¡¥æ¥å™¨ï¼‰
- å®ƒæ˜¯è¿æ¥ JavaScript å’Œ MarginNote ç³»ç»Ÿï¼ˆObjective-Cï¼‰çš„æ¡¥æ¢
- å°±åƒç¿»è¯‘å®˜ï¼Œè®© JavaScript ä»£ç èƒ½å’Œ MarginNote çš„åº•å±‚ç³»ç»Ÿå¯¹è¯

**ä¸ºä»€ä¹ˆéœ€è¦ JSB.defineClassï¼Ÿ**

æƒ³è±¡ä½ è¦åœ¨ä¸­å›½å¼€ä¸€å®¶å¤–å›½é¤å…ï¼š
- **æ™®é€šçš„ class**ï¼šå°±åƒä½ è‡ªå·±çš„å¨æˆ¿ï¼Œåšä»€ä¹ˆèœéƒ½å¯ä»¥ï¼Œä½†é¡¾å®¢ï¼ˆMarginNoteï¼‰è¿›ä¸æ¥
- **JSB.defineClass**ï¼šå°±åƒä¸“é—¨çš„é¤å…ï¼Œæœ‰å›ºå®šçš„è¥ä¸šæ—¶é—´ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰ï¼Œé¡¾å®¢èƒ½è¿›æ¥ç‚¹èœ

```javascript
// âŒ æ™®é€šçš„ JavaScript class - MarginNote ä¸è®¤è¯†
class MyPlugin {
  constructor() { MNUtil.log("æˆ‘çš„æ’ä»¶å¯åŠ¨äº†"); }
}

// âœ… JSB.defineClass - MarginNote ä¸“ç”¨æ ¼å¼
var MyPluginClass = JSB.defineClass('MyPlugin : JSExtension', {
  sceneWillConnect: function() {  // MarginNote å¼€æ–°çª—å£æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨
    MNUtil.log("çª—å£è¿æ¥äº†ï¼");
  },
  
  notebookWillOpen: function(topicid) {  // æ‰“å¼€ç¬”è®°æœ¬æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨
    MNUtil.log("ç¬”è®°æœ¬ " + topicid + " æ‰“å¼€äº†ï¼");
  }
});
```

**å…³é”®ç†è§£**ï¼š
- `JSB.defineClass` åˆ›å»ºçš„ä¸æ˜¯æ™®é€šçš„ç±»ï¼Œè€Œæ˜¯ MarginNote æ’ä»¶ç±»
- MarginNote ç³»ç»ŸçŸ¥é“å¦‚ä½•è°ƒç”¨è¿™ç§ç‰¹æ®Šç±»çš„æ–¹æ³•
- ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆå¦‚ sceneWillConnectï¼‰å¿…é¡»æ”¾åœ¨è¿™é‡Œé¢ï¼Œç³»ç»Ÿæ‰èƒ½æ‰¾åˆ°

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š

```javascript
// mnbrowser/main.js çš„ç®€åŒ–ç»“æ„
var MNBrowserClass = JSB.defineClass('MNBrowser : JSExtension', {
  // ç³»ç»Ÿè°ƒç”¨çš„æ–¹æ³•ï¼ˆæ”¾åœ¨è¿™é‡Œï¼‰
  sceneWillConnect: function() { 
    MNUtil.log("æ–°çª—å£è¿æ¥ï¼");
  },
  
  notebookWillOpen: function(topicid) { 
    MNUtil.log("ç¬”è®°æœ¬ " + topicid + " æ‰“å¼€äº†ï¼");
  }
});

// è‡ªå·±æ·»åŠ çš„è¾…åŠ©æ–¹æ³•ï¼ˆæ”¾åœ¨ prototype ä¸Šï¼‰  
MNBrowserClass.prototype.init = function() {
  MNUtil.log("æ’ä»¶åˆå§‹åŒ–");
};

MNBrowserClass.prototype.checkLink = function() {
  MNUtil.log("æ£€æŸ¥é“¾æ¥");
};
```

**è¦ç‚¹æ€»ç»“**ï¼š
- ç³»ç»Ÿè°ƒç”¨çš„æ–¹æ³• â†’ æ”¾åœ¨ `JSB.defineClass` å†…éƒ¨
- è‡ªå·±çš„è¾…åŠ©æ–¹æ³• â†’ æ”¾åœ¨ `prototype` ä¸Š
- MarginNote å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼è¯†åˆ«å’Œè°ƒç”¨ä½ çš„æ’ä»¶æ–¹æ³•

---

### 2.4 æ„é€ å‡½æ•°ã€new å’Œå®ä¾‹åŒ– - æ·±å…¥ç†è§£å¯¹è±¡åˆ›å»º

#### æ ¸å¿ƒæ¦‚å¿µï¼šconstructor å’Œ new çš„å…³ç³»

å¾ˆå¤šåˆå­¦è€…å¯¹ constructor å’Œ new çš„å…³ç³»æ„Ÿåˆ°å›°æƒ‘ã€‚è®©æˆ‘ä»¬ä»æ ¹æœ¬ä¸Šç†è§£å®ƒä»¬ï¼š

```javascript
// å½“ä½ å†™è¿™ä¸ª class
class Menu {
  constructor(sender, delegate) {  // constructor æ˜¯"æ„é€ å‡½æ•°"
    this.sender = sender;          // this æŒ‡å‘å°†è¦åˆ›å»ºçš„å®ä¾‹
    this.delegate = delegate;
  }
}

// æ‰§è¡Œ new Menu() æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
const menu = new Menu(button, self);
```

**å…³é”®ç†è§£**ï¼š
- `new` æ˜¯ä¸€ä¸ª**æ“ä½œç¬¦**ï¼Œè´Ÿè´£åˆ›å»ºå¯¹è±¡å’Œç®¡ç†æµç¨‹
- `constructor` æ˜¯ä¸€ä¸ª**ç‰¹æ®Šæ–¹æ³•**ï¼Œè´Ÿè´£åˆå§‹åŒ–å¯¹è±¡çš„å±æ€§
- å®ƒä»¬é…åˆå·¥ä½œï¼šnew åˆ›å»ºï¼Œconstructor åˆå§‹åŒ–

#### new æ“ä½œç¬¦çš„æ‰§è¡Œè¿‡ç¨‹ - 4æ­¥æ­ç§˜

```javascript
// new Menu(button, self) å®é™…ä¸Šåšäº†è¿™ 4 æ­¥ï¼š

// æ­¥éª¤ 1ï¼šåˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡
const newObject = {};

// æ­¥éª¤ 2ï¼šè®¾ç½®åŸå‹é“¾ï¼ˆè®©æ–°å¯¹è±¡èƒ½è®¿é—®ç±»çš„æ–¹æ³•ï¼‰
newObject.__proto__ = Menu.prototype;

// æ­¥éª¤ 3ï¼šæ‰§è¡Œ constructorï¼Œå¹¶æŠŠ this ç»‘å®šåˆ°æ–°å¯¹è±¡
Menu.constructor.call(newObject, button, self);
// æ­¤æ—¶ constructor é‡Œçš„ this.sender = sender 
// å®é™…ä¸Šæ˜¯ newObject.sender = sender

// æ­¥éª¤ 4ï¼šè¿”å›æ–°å¯¹è±¡ï¼ˆå¦‚æœ constructor æ²¡æœ‰è¿”å›å…¶ä»–å¯¹è±¡ï¼‰
return newObject;  // è¿™å°±æ˜¯ menu å˜é‡å¾—åˆ°çš„å€¼
```

**ç®€å•è®°å¿†**ï¼š`new` = åˆ›å»ºç©ºå¯¹è±¡ â†’ è®¾ç½®åŸå‹ â†’ æ‰§è¡Œæ„é€ å‡½æ•° â†’ è¿”å›å¯¹è±¡

#### Class åªæ˜¯"è¯­æ³•ç³–" - ç†è§£åº•å±‚åŸç†

> **è¯­æ³•ç³–**ï¼šè®©ä»£ç æ›´å¥½å†™çš„"å¿«æ·æ–¹å¼"ï¼Œå°±åƒ"æ‹¿é“"æ¯”"å’–å•¡+ç³–+ç‰›å¥¶"è¯´èµ·æ¥ç®€å•ï¼Œä½†æœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚

```javascript
// ES6 çš„ class å†™æ³•
class Menu {
  constructor(sender) {
    this.sender = sender;
  }
  
  show() {
    MNUtil.log('showing menu');
  }
  
  static create() {  // ä½ ç†Ÿæ‚‰çš„ static
    return new Menu();
  }
}

// å®Œå…¨ç­‰ä»·äº ES5 çš„å†™æ³•
function Menu(sender) {  // è¿™å°±æ˜¯ constructor
  this.sender = sender;
}

Menu.prototype.show = function() {  // å®ä¾‹æ–¹æ³•
  MNUtil.log('showing menu');
};

Menu.create = function() {  // static æ–¹æ³•ç›´æ¥æŒ‚åœ¨å‡½æ•°ä¸Š
  return new Menu();
};
```

**å…³é”®ç†è§£**ï¼š
- `class` æ˜¯ ES6 çš„è¯­æ³•ç³–ï¼ˆè®©ä»£ç æ›´å¥½å†™çš„"å¿«æ·æ–¹å¼"ï¼‰ï¼Œåº•å±‚è¿˜æ˜¯å‡½æ•°å’ŒåŸå‹

> **ä»€ä¹ˆæ˜¯è¯­æ³•ç³–ï¼Ÿ**
> 
> å°±åƒå’–å•¡åº—çš„"æ‹¿é“"å…¶å®å°±æ˜¯"å’–å•¡+ç³–+ç‰›å¥¶"ï¼Œä½†è¯´"æ‹¿é“"æ›´ç®€å•ã€‚
> 
> ```javascript
> // è¯­æ³•ç³–å†™æ³•ï¼ˆçœ‹èµ·æ¥ç®€æ´ï¼‰
> class Person {
>   constructor(name) { this.name = name; }
>   sayHello() { MNUtil.log("Hello " + this.name); }
> }
> 
> // æœ¬è´¨å†™æ³•ï¼ˆå®é™…è¿è¡Œçš„ï¼‰
> function Person(name) { this.name = name; }
> Person.prototype.sayHello = function() { MNUtil.log("Hello " + this.name); };
> 
> // ä¸¤ç§å†™æ³•å®Œå…¨ç­‰ä»·ï¼class åªæ˜¯è®©ä»£ç çœ‹èµ·æ¥æ›´èˆ’æœ
> ```
- `constructor` å°±æ˜¯é‚£ä¸ªæ„é€ å‡½æ•°æœ¬èº«
- æ™®é€šæ–¹æ³•æ”¾åœ¨ `prototype` ä¸Šï¼Œæ‰€æœ‰å®ä¾‹å…±äº«
- `static` æ–¹æ³•ç›´æ¥æŒ‚åœ¨ç±»ï¼ˆå‡½æ•°ï¼‰ä¸Šï¼Œä¸éœ€è¦å®ä¾‹åŒ–

#### ä¸ºä»€ä¹ˆéœ€è¦å®ä¾‹åŒ–ï¼Ÿ- å®æˆ˜ç†è§£

```javascript
// âŒ é”™è¯¯ç†è§£ï¼šåªç”¨ staticï¼ˆå¾ˆå¤šåˆå­¦è€…çš„åšæ³•ï¼‰
class Utils {
  static userName = 'xkw';  // å…¨å±€å…±äº«ï¼Œåªæœ‰ä¸€ä»½
  
  static setName(name) {
    Utils.userName = name;  // åªèƒ½å­˜ä¸€ä¸ªå€¼
  }
}

Utils.setName('å¼ ä¸‰');
Utils.setName('æå››');  // è¦†ç›–äº†ï¼å¼ ä¸‰æ²¡äº†
MNUtil.log(Utils.userName);  // 'æå››'

// âœ… æ­£ç¡®ç†è§£ï¼šéœ€è¦å¤šä¸ªç‹¬ç«‹å®ä¾‹æ—¶ç”¨ constructor
class User {
  constructor(name) {
    this.name = name;  // æ¯ä¸ªå®ä¾‹éƒ½æœ‰è‡ªå·±çš„ name
  }
  
  sayHello() {
    MNUtil.log(`æˆ‘æ˜¯ ${this.name}`);
  }
}

const user1 = new User('å¼ ä¸‰');  // user1 æœ‰è‡ªå·±çš„ name
const user2 = new User('æå››');  // user2 æœ‰è‡ªå·±çš„ name
user1.sayHello();  // "æˆ‘æ˜¯å¼ ä¸‰"
user2.sayHello();  // "æˆ‘æ˜¯æå››" - äº’ä¸å½±å“ï¼
```

#### MarginNote æ’ä»¶ä¸­çš„å®é™…åº”ç”¨

```javascript
// mnutils.js ä¸­çš„ Menu ç±»å°±æ˜¯å…¸å‹ä¾‹å­
class Menu {
  constructor(sender, delegate, width = undefined, preferredPosition = 2) {
    // æ¯ä¸ªèœå•éƒ½æœ‰è‡ªå·±çš„é…ç½®
    this.menuController = MenuController.new()
    this.delegate = delegate
    this.sender = sender        // ä¸åŒçš„æŒ‰é’®
    this.commandTable = []
    this.menuController.rowHeight = 35
    this.preferredPosition = preferredPosition
    
    if (width && width > 100) {
      this.width = width        // ä¸åŒçš„å®½åº¦
    }
  }
  
  show() {
    // ä½¿ç”¨ this è®¿é—®å®ä¾‹çš„å±æ€§
    this.menuController.width = this.width;
    this.menuController.show();
  }
}

// å¯ä»¥åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„èœå•
const menu1 = new Menu(button1, self, 200);  // 200px å®½çš„èœå•
const menu2 = new Menu(button2, self, 300);  // 300px å®½çš„èœå•
// ä¸¤ä¸ªèœå•ç‹¬ç«‹å­˜åœ¨ï¼Œäº’ä¸å¹²æ‰°
```

#### ä»€ä¹ˆæ—¶å€™ç”¨ static vs constructorï¼Ÿ

```javascript
// ç”¨ staticï¼šå·¥å…·æ–¹æ³•ã€å…¨å±€é…ç½®ã€å•ä¾‹
class MNUtil {
  static showHUD(text) { }     // å·¥å…·æ–¹æ³•ï¼Œä¸éœ€è¦çŠ¶æ€
  static version = '1.0.0';    // å…¨å±€é…ç½®
  static getInstance() { }     // å•ä¾‹æ¨¡å¼
}

// ç”¨ constructorï¼šéœ€è¦å¤šä¸ªå®ä¾‹ã€æ¯ä¸ªå®ä¾‹æœ‰è‡ªå·±çš„çŠ¶æ€
class Note {
  constructor(id) {
    this.id = id;              // æ¯ä¸ªç¬”è®°æœ‰è‡ªå·±çš„ ID
    this.comments = [];         // æ¯ä¸ªç¬”è®°æœ‰è‡ªå·±çš„è¯„è®º
  }
  
  addComment(text) {
    this.comments.push(text);   // æ“ä½œè‡ªå·±çš„æ•°æ®
  }
}

// å®é™…ä½¿ç”¨å¯¹æ¯”
MNUtil.showHUD("æç¤º");         // ç›´æ¥è°ƒç”¨ï¼Œæ— éœ€å®ä¾‹
const note1 = new Note("001");  // åˆ›å»ºç‹¬ç«‹å®ä¾‹
const note2 = new Note("002");  // å¦ä¸€ä¸ªç‹¬ç«‹å®ä¾‹
```

#### this çš„å«ä¹‰å’Œç»‘å®š

`this` æ˜¯ JavaScript ä¸­æœ€ä»¤äººå›°æƒ‘çš„æ¦‚å¿µä¹‹ä¸€ã€‚åœ¨ constructor ä¸­ï¼Œ`this` çš„å«ä¹‰å¾ˆæ˜ç¡®ï¼š

```javascript
class MNNote {
  constructor(noteId) {
    // åœ¨ constructor ä¸­ï¼Œthis å§‹ç»ˆæŒ‡å‘æ­£åœ¨åˆ›å»ºçš„æ–°å¯¹è±¡
    this.noteId = noteId;  // ç»™æ–°å¯¹è±¡æ·»åŠ  noteId å±æ€§
    this.comments = [];    // ç»™æ–°å¯¹è±¡æ·»åŠ  comments å±æ€§
  }
  
  appendComment(text) {
    // åœ¨å®ä¾‹æ–¹æ³•ä¸­ï¼Œthis æŒ‡å‘è°ƒç”¨è¯¥æ–¹æ³•çš„å®ä¾‹
    this.comments.push(text);
  }
}

const note = new MNNote("123");
note.appendComment("è¯„è®º");  // this = note å¯¹è±¡
```

**ç®­å¤´å‡½æ•°ä¸æ™®é€šå‡½æ•°çš„ this åŒºåˆ«**ï¼š

å‰é¢æˆ‘ä»¬å­¦è¿‡ç®­å¤´å‡½æ•°"æ²¡æœ‰è‡ªå·±çš„ this"ï¼Œç°åœ¨ç”¨ MN æ’ä»¶çš„çœŸå®ä»£ç æ¥ç†è§£ï¼š

**ç”Ÿæ´»ç±»æ¯”**ï¼š
- **æ™®é€šå‡½æ•°** = ä¼ è¯ç­’ï¼šè°æ‹¿ç€ï¼Œå°±æ˜¯è°çš„å£°éŸ³
- **ç®­å¤´å‡½æ•°** = å½•éŸ³ï¼šä¸ç®¡è°æ’­æ”¾ï¼Œå£°éŸ³éƒ½ä¸å˜

**çœŸå®ä¾‹å­ï¼ˆæ¥è‡ª mntoolbar/main.jsï¼‰**ï¼š
```javascript
// MN æ’ä»¶çš„å®é™…ä»£ç 
MNToolbarClass.prototype.init = function(mainPath) {
  MNUtil.log("init æ–¹æ³•é‡Œçš„ this:", this.initialized);  // true
  
  // è®¾ç½®ä¸€ä¸ªæ™®é€šå‡½æ•°ç»™åˆ«äººè°ƒç”¨
  this.normalCallback = function() {
    MNUtil.log("æ™®é€šå‡½æ•°é‡Œçš„ this:", this.initialized);  
    // ç»“æœï¼šundefinedï¼å› ä¸ºåˆ«äººè°ƒç”¨æ—¶ï¼Œthis å˜äº†
  };
  
  // è®¾ç½®ä¸€ä¸ªç®­å¤´å‡½æ•°ç»™åˆ«äººè°ƒç”¨
  this.arrowCallback = () => {
    MNUtil.log("ç®­å¤´å‡½æ•°é‡Œçš„ this:", this.initialized);  
    // ç»“æœï¼štrueï¼å› ä¸ºç®­å¤´å‡½æ•°"è®°ä½"äº†åŸæ¥çš„ this
  };
};

// æ¨¡æ‹Ÿå…¶ä»–åœ°æ–¹è°ƒç”¨è¿™äº›å›è°ƒå‡½æ•°
const toolbar = new MNToolbarClass();
toolbar.init("/path");

// åˆ«äººæ‹¿åˆ°è¿™äº›å‡½æ•°åè°ƒç”¨
const fn1 = toolbar.normalCallback;
const fn2 = toolbar.arrowCallback;

fn1();  // this.initialized = undefinedï¼ˆæ™®é€šå‡½æ•°çš„ this ä¸¢äº†ï¼‰
fn2();  // this.initialized = trueï¼ˆç®­å¤´å‡½æ•°ä¿æŒäº†åŸæ¥çš„ thisï¼‰
```

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ**
```javascript
// æ™®é€šå‡½æ•°ï¼šthis å–å†³äº"."å‰é¢æ˜¯è°
toolbar.normalCallback();    // this æ˜¯ toolbar âœ…
fn1();                       // æ²¡æœ‰"."ï¼Œthis æ˜¯ undefined âŒ

// ç®­å¤´å‡½æ•°ï¼šthis æ°¸è¿œæ˜¯"å®šä¹‰æ—¶å¤–å±‚çš„ this"
toolbar.arrowCallback();     // this æ˜¯ toolbar âœ…  
fn2();                       // è¿˜æ˜¯å®šä¹‰æ—¶çš„ thisï¼Œä»ç„¶æ˜¯ toolbar âœ…
```

**å®é™…åº”ç”¨**ï¼šè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `getToolbarController = () => self` è¦ç”¨ç®­å¤´å‡½æ•°ï¼

```javascript
// webviewController.js ç¬¬4è¡Œçš„çœŸå®ä»£ç 
const getToolbarController = () => self

// ä¸ºä»€ä¹ˆä¸èƒ½ç”¨æ™®é€šå‡½æ•°ï¼Ÿ
const getToolbarController = function() {
  return self;  // å¯èƒ½ä¼šæŠ¥é”™ï¼Œå› ä¸º this å’Œ self éƒ½ä¸ç¡®å®š
}

// ç®­å¤´å‡½æ•°çš„å¥½å¤„
// 1. æ— è®ºåœ¨å“ªé‡Œè°ƒç”¨ï¼Œæ°¸è¿œè¿”å›æ­£ç¡®çš„ self
webview.evaluateJavaScript(`getToolbarController().doSomething()`)

// 2. ä¸ä¼šè¢«è°ƒç”¨ç¯å¢ƒå½±å“
someOtherObject.getController = getToolbarController;
someOtherObject.getController();  // è¿˜æ˜¯è¿”å›æ­£ç¡®çš„ selfï¼
```

**æ€»ç»“**ï¼š
- **æ™®é€šå‡½æ•°é€‚åˆ**ï¼šä½œä¸ºå¯¹è±¡çš„æ–¹æ³•ï¼ˆéœ€è¦è®¿é—® thisï¼‰
- **ç®­å¤´å‡½æ•°é€‚åˆ**ï¼šä½œä¸ºå›è°ƒå‡½æ•°ã€å·¥å…·å‡½æ•°ï¼ˆä¿æŒç¯å¢ƒä¸å˜ï¼‰
- **è®°ä½å£è¯€**ï¼š"ä¼ è¯ç­’ä¼šå˜å£°ï¼Œå½•éŸ³ä¸ä¼šå˜"

#### self çš„ç‰¹æ®Šç”¨æ³•

åœ¨ MarginNote æ’ä»¶ä¸­ï¼Œä½ ä¼šç»å¸¸çœ‹åˆ° `self` å˜é‡ï¼š

```javascript
// mntoolbar/webviewController.js:1026 è¡Œ
const getToolbarController = () => self

// ä¸ºä»€ä¹ˆè¦è¿™æ ·å†™ï¼Ÿ
// å› ä¸ºåœ¨ JSB.defineClass ä¸­ï¼Œthis å¯èƒ½ä¼šå˜åŒ–
// æ‰€ä»¥ç”¨ self ä¿å­˜æ­£ç¡®çš„å¼•ç”¨
```

#### ğŸ’¡ å…³é”®æ€»ç»“

1. **new çš„ä½œç”¨**ï¼šåˆ›å»ºæ–°å¯¹è±¡ â†’ ç»‘å®š this â†’ æ‰§è¡Œ constructor â†’ è¿”å›å¯¹è±¡
2. **constructor çš„ä½œç”¨**ï¼šåˆå§‹åŒ–å®ä¾‹çš„å±æ€§
3. **this çš„æŒ‡å‘**ï¼šåœ¨ constructor ä¸­æŒ‡å‘æ­£åœ¨åˆ›å»ºçš„æ–°å¯¹è±¡
4. **ä½•æ—¶éœ€è¦å®ä¾‹åŒ–**ï¼šå½“ä½ éœ€è¦å¤šä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œæ¯ä¸ªæœ‰è‡ªå·±çš„çŠ¶æ€æ—¶
5. **ä½•æ—¶ç”¨ static**ï¼šå·¥å…·æ–¹æ³•ã€å…¨å±€é…ç½®ã€ä¸éœ€è¦å®ä¾‹çŠ¶æ€æ—¶

**ä½ ç°åœ¨çš„é—®é¢˜å¯èƒ½æ˜¯**ï¼šåªç”¨ static ç›¸å½“äºåªæœ‰"å·¥å…·ç®±"ï¼Œæ²¡æœ‰"äº§å“"ã€‚class çš„çœŸæ­£å¨åŠ›åœ¨äºèƒ½æ‰¹é‡ç”Ÿäº§"äº§å“"ï¼ˆå®ä¾‹ï¼‰ï¼Œæ¯ä¸ªäº§å“éƒ½æœ‰è‡ªå·±çš„å±æ€§ä½†å…±äº«ç›¸åŒçš„æ–¹æ³•ã€‚

### 2.4 å•ä¾‹æ¨¡å¼ - sharedInstance() çš„ç§˜å¯†

è¿™æ˜¯ MarginNote æ’ä»¶å¼€å‘ä¸­ä¸€ä¸ªéå¸¸é‡è¦ä½†ç»å¸¸è¢«å¿½ç•¥çš„æ¦‚å¿µã€‚

#### ç”Ÿæ´»åŒ–ç†è§£ï¼šæ ¡é•¿åŠå…¬å®¤çš„ä¾‹å­

æƒ³è±¡ä¸€ä¸‹ï¼š
- ä½ çš„å­¦æ ¡åªæœ‰**ä¸€ä¸ªæ ¡é•¿åŠå…¬å®¤**
- æ— è®ºä»å“ªæ ‹æ¥¼ã€å“ªä¸ªå…¥å£ï¼Œ"å»æ ¡é•¿åŠå…¬å®¤"éƒ½æ˜¯å»**åŒä¸€ä¸ªåœ°æ–¹**
- ä¸å¯èƒ½æœ‰ä¸¤ä¸ªæ ¡é•¿åŠå…¬å®¤åŒæ—¶å­˜åœ¨

åœ¨ç¼–ç¨‹ä¸­ï¼Œ**å•ä¾‹æ¨¡å¼**å°±æ˜¯è¿™æ ·çš„æ¦‚å¿µï¼š
- `Application.sharedInstance()` = å»æ ¡é•¿åŠå…¬å®¤
- æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œéƒ½è¿”å›**åŒä¸€ä¸ªåº”ç”¨å®ä¾‹**
- æ•´ä¸ª MarginNote ç¨‹åºåªæœ‰ä¸€ä¸ªåº”ç”¨å¯¹è±¡

#### å•ä¾‹ vs new çš„æœ¬è´¨åŒºåˆ«

è®©æˆ‘ä»¬ç”¨ä»£ç æ¥ç†è§£ï¼š

```javascript
// ğŸ« å•ä¾‹æ¨¡å¼ï¼šApplicationï¼ˆç›¸å½“äºæ ¡é•¿åŠå…¬å®¤ï¼‰
const app1 = Application.sharedInstance();
const app2 = Application.sharedInstance();
const app3 = Application.sharedInstance();

MNUtil.log(app1 === app2);  // true - æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼
MNUtil.log(app2 === app3);  // true - è¿˜æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼
MNUtil.log("åº”ç”¨å®ä¾‹æ•°é‡ï¼š", "åªæœ‰1ä¸ª");

// ğŸ—ï¸ new æ“ä½œï¼šåˆ›å»ºæ–°å¯¹è±¡ï¼ˆç›¸å½“äºç›–æ–°æˆ¿å­ï¼‰
class MyClass {
  constructor(name) {
    this.name = name;
  }
}

const obj1 = new MyClass("å¯¹è±¡1");
const obj2 = new MyClass("å¯¹è±¡2");
const obj3 = new MyClass("å¯¹è±¡3");

MNUtil.log(obj1 === obj2);  // false - æ˜¯ä¸åŒå¯¹è±¡ï¼
MNUtil.log(obj2 === obj3);  // false - æ¯æ¬¡éƒ½æ˜¯æ–°å¯¹è±¡ï¼
MNUtil.log("å¯¹è±¡æ•°é‡ï¼š", "æ¯æ¬¡ new éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„");
```

#### å½¢è±¡å¯¹æ¯”

| ç‰¹æ€§ | å•ä¾‹æ¨¡å¼ | new æ“ä½œ |
|------|----------|-----------|
| **æ¦‚å¿µ** | æ ¡é•¿åŠå…¬å®¤ï¼ˆå…¨æ ¡å”¯ä¸€ï¼‰ | ç›–æˆ¿å­ï¼ˆæƒ³ç›–å¤šå°‘ç›–å¤šå°‘ï¼‰ |
| **å®ä¾‹æ•°é‡** | æ°¸è¿œåªæœ‰1ä¸ª | æ¯æ¬¡ new åˆ›å»º1ä¸ª |
| **è·å–æ–¹å¼** | `Class.sharedInstance()` | `new Class()` |
| **å†…å­˜ä½¿ç”¨** | èŠ‚çœï¼ˆå…±äº«ä¸€ä¸ªå¯¹è±¡ï¼‰ | æ¯ä¸ªå¯¹è±¡å ç”¨ç‹¬ç«‹å†…å­˜ |
| **çŠ¶æ€ç®¡ç†** | å…¨å±€å…±äº«çŠ¶æ€ | æ¯ä¸ªå®ä¾‹ç‹¬ç«‹çŠ¶æ€ |

#### MarginNote ä¸­çš„å•ä¾‹å®¶æ—

åœ¨ MarginNote æ’ä»¶å¼€å‘ä¸­ï¼Œæœ‰å¾ˆå¤šé‡è¦çš„å•ä¾‹ï¼š

```javascript
// ğŸ¢ åº”ç”¨ç®¡ç†å‘˜ - ç®¡ç†æ•´ä¸ª MarginNote åº”ç”¨
const app = Application.sharedInstance();
app.showHUD("Hello World!", app.focusWindow, 2);

// ğŸ—ƒï¸ æ•°æ®åº“ç®¡ç†å‘˜ - ç®¡ç†æ‰€æœ‰ç¬”è®°å’Œæ–‡æ¡£
const db = Database.sharedInstance();
const note = db.getNoteById("some-note-id");

// ğŸ”§ è®¾ç½®ç®¡ç†å‘˜ - ç®¡ç†ç”¨æˆ·åå¥½è®¾ç½®
const settings = NSUserDefaults.standardUserDefaults();
settings.setObjectForKey("my-value", "my-key");

// ğŸ“¢ æ¶ˆæ¯ä¸­å¿ƒ - ç®¡ç†åº”ç”¨å†…é€šä¿¡
const center = NSNotificationCenter.defaultCenter();
center.addObserverSelectorName(self, "onSomeEvent:", "SomeEvent");
```

#### ä¸ºä»€ä¹ˆ MarginNote è¦ç”¨å•ä¾‹ï¼Ÿ

1. **é¿å…å†²çª**ï¼š
   ```javascript
   // âŒ å¦‚æœæœ‰å¤šä¸ªåº”ç”¨å®ä¾‹ï¼Œä¼šå¾ˆæ··ä¹±
   const app1 = new Application();  // å‡è®¾å¯ä»¥è¿™æ ·åš
   const app2 = new Application();  // åˆåˆ›å»ºäº†ä¸€ä¸ªï¼Ÿ
   app1.showHUD("æ¶ˆæ¯1");            // åœ¨å“ªä¸ªåº”ç”¨æ˜¾ç¤ºï¼Ÿ
   app2.showHUD("æ¶ˆæ¯2");            // åˆåœ¨å“ªä¸ªæ˜¾ç¤ºï¼Ÿ
   
   // âœ… å•ä¾‹æ¨¡å¼é¿å…äº†è¿™ä¸ªé—®é¢˜
   const app = Application.sharedInstance();  // æ€»æ˜¯åŒä¸€ä¸ª
   app.showHUD("æ¶ˆæ¯");                       // æ˜ç¡®åœ¨å½“å‰åº”ç”¨æ˜¾ç¤º
   ```

2. **å…¨å±€çŠ¶æ€ç®¡ç†**ï¼š
   ```javascript
   // æ‰€æœ‰æ’ä»¶éƒ½èƒ½è®¿é—®åŒä¸€ä¸ªæ•°æ®åº“
   const db = Database.sharedInstance();
   
   // æ’ä»¶A åˆ›å»ºç¬”è®°
   const newNote = db.createNote("æ ‡é¢˜");
   
   // æ’ä»¶B ç«‹å³èƒ½çœ‹åˆ°æ’ä»¶Aåˆ›å»ºçš„ç¬”è®°
   const sameNote = db.getNoteById(newNote.noteId);
   ```

3. **èµ„æºå…±äº«**ï¼š
   ```javascript
   // æ‰€æœ‰æ’ä»¶å…±äº«åŒä¸€ä¸ªè®¾ç½®ç³»ç»Ÿ
   const settings = NSUserDefaults.standardUserDefaults();
   
   // æ’ä»¶A ä¿å­˜è®¾ç½®
   settings.setObjectForKey("dark", "theme");
   
   // æ’ä»¶B èƒ½è¯»å–æ’ä»¶Açš„è®¾ç½®
   const theme = settings.objectForKey("theme");  // "dark"
   ```

#### å®æˆ˜ä¸­çš„å¸¸è§é”™è¯¯

```javascript
// âŒ é”™è¯¯æ€ç»´ï¼šæƒ³è¦"åˆ›å»º"åº”ç”¨
const myApp = new Application();  // è¿™æ ·åšä¸äº†ï¼MarginNoteä¸å…è®¸

// âœ… æ­£ç¡®æ€ç»´ï¼šè·å–å·²å­˜åœ¨çš„åº”ç”¨
const app = Application.sharedInstance();  // è·å–ç³»ç»Ÿæä¾›çš„å”¯ä¸€å®ä¾‹

// âŒ é”™è¯¯ï¼šé‡å¤è·å–å¹¶æ‹…å¿ƒæ€§èƒ½
const app1 = Application.sharedInstance();
const app2 = Application.sharedInstance();  // æ‹…å¿ƒï¼šè¿™ä¼šåˆ›å»ºç¬¬äºŒä¸ªå—ï¼Ÿ
// ç­”æ¡ˆï¼šä¸ä¼šï¼å®ƒä»¬æ˜¯åŒä¸€ä¸ªå¯¹è±¡

// âœ… æ­£ç¡®ï¼šæ”¾å¿ƒä½¿ç”¨ï¼Œå¯ä»¥å¤šæ¬¡è·å–
function showMessage(msg) {
  Application.sharedInstance().showHUD(msg, 
    Application.sharedInstance().focusWindow, 2);
  // ä¸¤æ¬¡è°ƒç”¨è¿”å›çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ²¡æœ‰æ€§èƒ½é—®é¢˜
}
```

#### ğŸ’¡ è®°å¿†æŠ€å·§

è®°ä½è¿™ä¸ªå£è¯€ï¼š**"shared è¡¨ç¤ºå…±äº«ï¼ŒInstance è¡¨ç¤ºå®ä¾‹ï¼ŒsharedInstance å°±æ˜¯å¤§å®¶å…±äº«çš„é‚£ä¸€ä¸ªå®ä¾‹"**

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šç‰¹æ®Šè¯­æ³•

### 3.1 å¼‚æ­¥ç¼–ç¨‹ - async/await çš„åº”ç”¨

#### ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ï¼Ÿ

è®©æˆ‘ä»¬ä»æœ€åŸºç¡€çš„æ¦‚å¿µå¼€å§‹ç†è§£ï¼š

##### åŒæ­¥ vs å¼‚æ­¥

**åŒæ­¥**ï¼šä¸€ä»¶äº‹åšå®Œå†åšä¸‹ä¸€ä»¶äº‹
```javascript
MNUtil.log("ç¬¬1æ­¥");
MNUtil.log("ç¬¬2æ­¥"); 
MNUtil.log("ç¬¬3æ­¥");
// æŒ‰é¡ºåºæ‰§è¡Œï¼š1â†’2â†’3
```

**å¼‚æ­¥**ï¼šä¸ç­‰ç¬¬ä¸€ä»¶äº‹åšå®Œï¼Œå°±å¯ä»¥åšå…¶ä»–äº‹
```javascript
MNUtil.log("ç¬¬1æ­¥");
setTimeout(() => MNUtil.log("ç¬¬2æ­¥"), 1000); // 1ç§’åæ‰§è¡Œ
MNUtil.log("ç¬¬3æ­¥");
// å®é™…æ‰§è¡Œé¡ºåºï¼š1â†’3â†’(1ç§’å)2
```

æƒ³è±¡ä½ åœ¨é¤å…ç‚¹é¤ï¼š
- **åŒæ­¥**ï¼šç‚¹å®Œèœç«™åœ¨é‚£é‡Œç­‰ï¼Œèœå¥½äº†æ‰èƒ½åšå…¶ä»–äº‹ï¼ˆæµªè´¹æ—¶é—´ï¼‰
- **å¼‚æ­¥**ï¼šç‚¹å®Œèœå»æ‰¾åº§ä½ï¼Œèœå¥½äº†æœåŠ¡å‘˜ä¼šå«ä½ ï¼ˆé«˜æ•ˆï¼‰

åœ¨ç¼–ç¨‹ä¸­ï¼Œç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ã€å®šæ—¶å™¨ç­‰è€—æ—¶æ“ä½œéƒ½åº”è¯¥å¼‚æ­¥æ‰§è¡Œã€‚

#### ç†è§£ Promise - å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒ

##### Promise æ˜¯ä»€ä¹ˆï¼Ÿ

Promise å°±æ˜¯ä¸€ä¸ª**"ç›’å­"**ï¼Œè¿™ä¸ªç›’å­ç”¨æ¥è£…"æœªæ¥çš„ç»“æœ"ï¼š

```javascript
// Promise = ä¸€ä¸ªè£…æœªæ¥ç»“æœçš„ç›’å­
let ç›’å­ = new Promise((resolve, reject) => {
  // è¿™é‡Œå†³å®šä»€ä¹ˆæ—¶å€™å¾€ç›’å­é‡Œæ”¾ä¸œè¥¿
  
  setTimeout(() => {
    resolve("ç¤¼ç‰©");  // 1ç§’åï¼Œå¾€ç›’å­é‡Œæ”¾"ç¤¼ç‰©"
  }, 1000);
});

// æ‰“å¼€ç›’å­çœ‹ç»“æœ
ç›’å­.then(é‡Œé¢çš„ä¸œè¥¿ => {
  MNUtil.log(é‡Œé¢çš„ä¸œè¥¿);  // "ç¤¼ç‰©"
});
```

##### Promise çš„ä¸‰ç§çŠ¶æ€

1. **ç­‰å¾…ä¸­**ï¼ˆpendingï¼‰ï¼šç›’å­æ˜¯ç©ºçš„ï¼Œåœ¨ç­‰ä¸œè¥¿
2. **æˆåŠŸ**ï¼ˆresolvedï¼‰ï¼šç›’å­é‡Œè£…äº†ç»“æœ
3. **å¤±è´¥**ï¼ˆrejectedï¼‰ï¼šç›’å­é‡Œè£…äº†é”™è¯¯ä¿¡æ¯

##### resolve å’Œ reject æ˜¯ä»€ä¹ˆï¼Ÿ

`resolve` å’Œ `reject` ä¸æ˜¯ç‰¹æ®Šå‡½æ•°ï¼Œåªæ˜¯å‚æ•°åï¼š

```javascript
// è¿™ä¸¤ä¸ªå†™æ³•å®Œå…¨ç­‰ä»·
new Promise((resolve, reject) => {
  resolve("æˆåŠŸ");
  reject("å¤±è´¥");
});

new Promise((æˆåŠŸå‡½æ•°, å¤±è´¥å‡½æ•°) => {
  æˆåŠŸå‡½æ•°("æˆåŠŸ");
  å¤±è´¥å‡½æ•°("å¤±è´¥");
});
```

- ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆé€šå¸¸å« resolveï¼‰= æˆåŠŸæ—¶è°ƒç”¨
- ç¬¬äºŒä¸ªå‚æ•°ï¼ˆé€šå¸¸å« rejectï¼‰= å¤±è´¥æ—¶è°ƒç”¨

##### å‚æ•°çš„ä½œç”¨å’Œä¼ é€’

```javascript
function è¯»å–æ–‡ä»¶(æ–‡ä»¶å) {
  return new Promise((resolve, reject) => {
    if (æ–‡ä»¶å­˜åœ¨) {
      resolve("æ–‡ä»¶å†…å®¹");  // æŠŠ"æ–‡ä»¶å†…å®¹"ä¼ å‡ºå»
    } else {
      reject("æ–‡ä»¶ä¸å­˜åœ¨");  // æŠŠé”™è¯¯ä¿¡æ¯ä¼ å‡ºå»
    }
  });
}

// æ¥æ”¶å‚æ•° - æ–¹å¼1ï¼šç”¨ await
try {
  let ç»“æœ = await è¯»å–æ–‡ä»¶("test.txt");
  MNUtil.log(ç»“æœ);  // "æ–‡ä»¶å†…å®¹" â† resolveçš„å‚æ•°
} catch(é”™è¯¯) {
  MNUtil.log(é”™è¯¯);  // "æ–‡ä»¶ä¸å­˜åœ¨" â† rejectçš„å‚æ•°
}

// æ¥æ”¶å‚æ•° - æ–¹å¼2ï¼šç”¨ .then()
è¯»å–æ–‡ä»¶("test.txt")
  .then(ç»“æœ => {
    MNUtil.log(ç»“æœ);  // "æ–‡ä»¶å†…å®¹" â† resolveçš„å‚æ•°
  })
  .catch(é”™è¯¯ => {
    MNUtil.log(é”™è¯¯);  // "æ–‡ä»¶ä¸å­˜åœ¨" â† rejectçš„å‚æ•°
  });
```

#### å›è°ƒåœ°ç‹±é—®é¢˜åŠè§£å†³

##### ä¼ ç»Ÿå›è°ƒçš„é—®é¢˜

```javascript
// ä¼ ç»Ÿå›è°ƒå†™æ³• - å±‚å±‚åµŒå¥—ï¼Œéš¾ä»¥é˜…è¯»
delay(1, function() {
  MNUtil.log("1ç§’å");
  delay(1, function() {
    MNUtil.log("å†1ç§’å");
    delay(1, function() {
      MNUtil.log("å†å†1ç§’å");
      // è¶ŠåµŒè¶Šæ·±ï¼Œåƒåœ°ç‹±ä¸€æ ·
    });
  });
});
```

##### Promise é“¾å¼è°ƒç”¨

```javascript
// Promise é“¾å¼è°ƒç”¨ - ç¨å¥½ä¸€äº›
delay(1)
  .then(() => {
    MNUtil.log("1ç§’å");
    return delay(1);
  })
  .then(() => {
    MNUtil.log("2ç§’å");
    return delay(1);
  })
  .then(() => {
    MNUtil.log("3ç§’å");
  });
```

#### MarginNote ä¸­çš„ delay å‡½æ•°è¯¦è§£

è®©æˆ‘ä»¬æ·±å…¥ç†è§£ MNUtil.delay å‡½æ•°ï¼š

```javascript
// mnutils.js ä¸­çš„å®é™…ä»£ç 
static async delay(seconds) {
  return new Promise((resolve, reject) => {
    // NSTimer æ˜¯ MarginNote æä¾›çš„å®šæ—¶å™¨
    NSTimer.scheduledTimerWithTimeInterval(seconds, false, function() {
      resolve();  // æ—¶é—´åˆ°äº†ï¼Œè°ƒç”¨ resolve è¡¨ç¤º"å®Œæˆ"
    });
  });
}
```

**è¿™ä¸ªå‡½æ•°åœ¨åšä»€ä¹ˆï¼Ÿ**
1. åˆ›å»ºä¸€ä¸ª Promiseï¼ˆæ‰¿è¯ºï¼‰
2. è®¾ç½® NSTimer å®šæ—¶å™¨ç­‰å¾… X ç§’
3. æ—¶é—´åˆ°äº†ï¼Œè°ƒç”¨ resolve() å‘Šè¯‰ Promise "å®Œæˆäº†"
4. æ³¨æ„ï¼šresolve() æ²¡æœ‰å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦"ç­‰å¾…å®Œæˆ"çš„ä¿¡å·

**ä¸ºä»€ä¹ˆè¦åŒ…è£…æˆ Promiseï¼Ÿ**
- NSTimer ä½¿ç”¨å›è°ƒæ–¹å¼ï¼Œä¸æ”¯æŒ await
- åŒ…è£…æˆ Promise åï¼Œå°±å¯ä»¥ç”¨ç°ä»£çš„ async/await è¯­æ³•

#### async å’Œ await è¯¦è§£

##### await æ˜¯ä»€ä¹ˆï¼Ÿ

`await` = "ç­‰å¾…"ï¼Œè®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ï¼š

```javascript
// ä¸ç”¨ await - ä¸ä¼šç­‰å¾…
delay(1);
MNUtil.log("ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰1ç§’");

// ç”¨ await - ä¼šç­‰å¾…
await delay(1);
MNUtil.log("1ç§’åæ‰æ‰§è¡Œ");
```

##### async å‡½æ•°çš„è¦æ±‚

å‡½æ•°é‡Œç”¨äº† `await`ï¼Œå°±å¿…é¡»æ ‡è®°ä¸º `async`ï¼š

```javascript
// âŒ é”™è¯¯ï¼šæ™®é€šå‡½æ•°ä¸èƒ½ç”¨ await
function myFunction() {
  await delay(1);  // æŠ¥é”™ï¼
}

// âœ… æ­£ç¡®ï¼šasync å‡½æ•°æ‰èƒ½ç”¨ await
async function myFunction() {
  await delay(1);  // æ­£ç¡®
}
```

##### å®Œæ•´å¯¹æ¯”ç¤ºä¾‹

```javascript
// è€æ–¹å¼ï¼ˆå›è°ƒåœ°ç‹±ï¼‰
NSTimer.scheduledTimerWithTimeInterval(1, false, function() {
  MNUtil.log("1ç§’å");
  NSTimer.scheduledTimerWithTimeInterval(1, false, function() {
    MNUtil.log("2ç§’å");
    NSTimer.scheduledTimerWithTimeInterval(1, false, function() {
      MNUtil.log("3ç§’å");
    });
  });
});

// æ–°æ–¹å¼ï¼ˆasync/awaitï¼‰
async function æ¼”ç¤º() {
  await MNUtil.delay(1);
  MNUtil.log("1ç§’å");
  await MNUtil.delay(1);
  MNUtil.log("2ç§’å");
  await MNUtil.delay(1);
  MNUtil.log("3ç§’å");
}
```

#### é”™è¯¯å¤„ç†

##### å¤„ç† reject çš„æƒ…å†µ

```javascript
// å¦‚æœ Promise è°ƒç”¨äº† reject
static async delay(seconds) {
  return new Promise((resolve, reject) => {
    NSTimer.scheduledTimerWithTimeInterval(seconds, false, function() {
      reject("è¶…æ—¶äº†");  // å‡è®¾æ”¹æˆ reject
    });
  });
}

// ä½¿ç”¨æ—¶ä¼šè§¦å‘é”™è¯¯
try {
  await delay(1);  
  MNUtil.log("æˆåŠŸç­‰å¾…1ç§’");  // âŒ ä¸ä¼šæ‰§è¡Œ
} catch(error) {
  MNUtil.log("å‡ºé”™äº†ï¼š" + error);  // âœ… ä¼šæ‰§è¡Œè¿™é‡Œï¼
}
```

#### å®é™…ä»£ç ä¾‹å­

```javascript
// mntoolbar/xdyy_custom_actions_registry.js
global.registerCustomAction("fetchData", async function(context) {
  try {
    // æ˜¾ç¤ºåŠ è½½æç¤º
    MNUtil.showHUD("æ­£åœ¨è·å–æ•°æ®...");
    
    // å¼‚æ­¥è¯·æ±‚æ•°æ®ï¼ˆç­‰å¾…ç»“æœï¼‰
    const response = await fetch("https://api.example.com/data");
    const data = await response.json();
    
    // å¤„ç†æ•°æ®
    MNUtil.showHUD("è·å–æˆåŠŸï¼š" + data.length + " æ¡æ•°æ®");
    
    // å¼‚æ­¥å»¶è¿Ÿ
    await MNUtil.delay(0.5);  // ç­‰å¾…0.5ç§’
    
    // ç»§ç»­å¤„ç†...
    
  } catch (error) {
    MNUtil.showHUD("è·å–å¤±è´¥ï¼š" + error.message);
  }
});
```

#### åœ¨ MarginNote æ’ä»¶ä¸­çš„åº”ç”¨

```javascript
// æ‰¹é‡å¤„ç†ç¬”è®°çš„ä¾‹å­
async function processNotes() {
  const notes = MNNote.getFocusNotes();
  
  for (const note of notes) {
    note.appendComment("å¤„ç†ä¸­...");
    await MNUtil.delay(0.1);  // æ¯ä¸ªç¬”è®°ä¹‹é—´å»¶è¿Ÿ0.1ç§’
  }
  
  MNUtil.showHUD("å…¨éƒ¨å¤„ç†å®Œæˆï¼");
}

// å¸¦è¿›åº¦æ˜¾ç¤ºçš„æ‰¹é‡å¤„ç†
async function processNotesWithProgress() {
  const notes = MNNote.getFocusNotes();
  const total = notes.length;
  
  for (let i = 0; i < notes.length; i++) {
    const note = notes[i];
    
    // æ˜¾ç¤ºè¿›åº¦
    MNUtil.showHUD(`å¤„ç†ä¸­ ${i+1}/${total}`);
    
    // å¤„ç†ç¬”è®°
    note.appendComment(`å·²å¤„ç† - ${new Date().toLocaleTimeString()}`);
    
    // å»¶è¿Ÿï¼Œé¿å…å¤„ç†å¤ªå¿«
    await MNUtil.delay(0.2);
  }
  
  MNUtil.showHUD("âœ… å…¨éƒ¨å¤„ç†å®Œæˆï¼");
}
```

#### æ ¸å¿ƒæ¦‚å¿µæ€»ç»“

1. **å¼‚æ­¥** = ä¸ç­‰ç»“æœï¼Œå…ˆåšå…¶ä»–äº‹
2. **Promise** = è£…"æœªæ¥ç»“æœ"çš„ç›’å­
3. **resolve/reject** = å¾€ç›’å­é‡Œæ”¾æˆåŠŸ/å¤±è´¥ç»“æœ
4. **await** = ç­‰å¾… Promise å®Œæˆ
5. **async** = èƒ½ä½¿ç”¨ await çš„å‡½æ•°æ ‡è®°
6. **try/catch** = å¤„ç†å¼‚æ­¥é”™è¯¯

#### ğŸ’¡ è®°å¿†æŠ€å·§

- Promise = "æ‰¿è¯ºå°†æ¥ç»™ä½ ç»“æœ"
- resolve = "æˆåŠŸå…‘ç°æ‰¿è¯º"
- reject = "æ‰¿è¯ºå¤±è´¥äº†"
- await = "ç­‰ç­‰ï¼Œè®©æˆ‘å…ˆæ‹¿åˆ°ç»“æœ"
- async = "è¿™ä¸ªå‡½æ•°ä¼šç­‰å¾…"

---

### 3.2 é—­åŒ…å’Œä½œç”¨åŸŸ - å˜é‡çš„"è®°å¿†ç›’å­"

#### å…ˆç†è§£ä½œç”¨åŸŸ - å˜é‡çš„å¯è§èŒƒå›´

æƒ³è±¡å˜é‡å°±åƒæ”¾åœ¨ä¸åŒæˆ¿é—´é‡Œçš„ç‰©å“ï¼š

```javascript
let global_item = "å®¢å…çš„é¥æ§å™¨";  // å®¢å… - æ‰€æœ‰äººéƒ½èƒ½çœ‹è§

function bedroom() {
  let private_item = "å§å®¤çš„æ—¥è®°æœ¬";  // å§å®¤ - åªæœ‰åœ¨å§å®¤é‡Œæ‰èƒ½çœ‹è§
  
  MNUtil.showHUD(global_item);   // âœ… èƒ½çœ‹è§å®¢å…çš„é¥æ§å™¨
  MNUtil.showHUD(private_item);  // âœ… èƒ½çœ‹è§å§å®¤çš„æ—¥è®°æœ¬
}

bedroom();
MNUtil.showHUD(global_item);   // âœ… èƒ½çœ‹è§å®¢å…çš„é¥æ§å™¨  
// MNUtil.showHUD(private_item);  // âŒ é”™è¯¯ï¼å®¢å…é‡Œçœ‹ä¸è§å§å®¤çš„æ—¥è®°æœ¬
```

#### ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿç”¨ä¿é™©ç®±æ¥ç†è§£

**é—­åŒ…å°±åƒä¸€ä¸ªç¥å¥‡çš„ä¿é™©ç®±**ï¼š
- æŠŠä¸€äº›é‡è¦ç‰©å“ï¼ˆå˜é‡ï¼‰æ”¾è¿›å»
- ç»™ä½ ä¸€æŠŠé’¥åŒ™ï¼ˆå‡½æ•°ï¼‰æ¥è®¿é—®è¿™äº›ç‰©å“
- å°±ç®—ä¿é™©ç®±"æ¶ˆå¤±"äº†ï¼Œé’¥åŒ™ä¾ç„¶èƒ½æ‰“å¼€å¹¶ä½¿ç”¨é‡Œé¢çš„ç‰©å“

```javascript
// æœ€ç®€å•çš„é—­åŒ…ä¾‹å­
function createNoteManager() {
  let savedNote = null;  // ä¿é™©ç®±é‡Œçš„ç‰©å“
  
  // è¿”å›é’¥åŒ™ï¼ˆå‡½æ•°ï¼‰
  return function(note) {
    if (note) {
      savedNote = note;  // å­˜è¿›ä¿é™©ç®±
      MNUtil.showHUD("ç¬”è®°å·²ä¿å­˜");
    } else {
      return savedNote;  // ä»ä¿é™©ç®±å–å‡º
    }
  };
}

// åˆ›å»ºä¸€ä¸ªä¿é™©ç®±å¹¶æ‹¿åˆ°é’¥åŒ™
let noteManager = createNoteManager();

// ä½¿ç”¨é’¥åŒ™æ“ä½œä¿é™©ç®±é‡Œçš„ç‰©å“
noteManager(MNNote.getFocusNote());  // å­˜å…¥å½“å‰ç¬”è®°
let myNote = noteManager();          // å–å‡ºç¬”è®°
```

**ç¥å¥‡çš„åœ°æ–¹**ï¼š
- `createNoteManager` å‡½æ•°æ‰§è¡Œå®Œäº†ï¼ŒæŒ‰ç†è¯´ `savedNote` åº”è¯¥æ¶ˆå¤±
- ä½†æ˜¯é—­åŒ…è®© `savedNote` ä¸€ç›´"æ´»ç€"ï¼Œåªèƒ½é€šè¿‡é‚£ä¸ªå‡½æ•°è®¿é—®

#### MN æ’ä»¶ä¸­çš„å®é™…åº”ç”¨

##### åœºæ™¯1ï¼šä¿å­˜æ’ä»¶çŠ¶æ€

```javascript
function createPluginManager() {
  let isEnabled = false;        // æ’ä»¶æ˜¯å¦å¯ç”¨
  let processedNotes = [];     // å·²å¤„ç†çš„ç¬”è®°IDåˆ—è¡¨
  
  return {
    toggle: function() {
      isEnabled = !isEnabled;
      MNUtil.showHUD(isEnabled ? "æ’ä»¶å·²å¯ç”¨" : "æ’ä»¶å·²ç¦ç”¨");
    },
    
    addProcessedNote: function(noteId) {
      if (isEnabled && processedNotes.indexOf(noteId) === -1) {
        processedNotes.push(noteId);
        MNUtil.showHUD("ç¬”è®° " + noteId + " å·²å¤„ç†");
      }
    },
    
    isProcessed: function(noteId) {
      return processedNotes.indexOf(noteId) !== -1;
    },
    
    getStatus: function() {
      return {
        enabled: isEnabled,
        processedCount: processedNotes.length
      };
    }
  };
}

// åˆ›å»ºæ’ä»¶ç®¡ç†å™¨
let pluginManager = createPluginManager();

// ä½¿ç”¨ - å¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—® isEnabled å’Œ processedNotes
pluginManager.toggle();                               // å¯ç”¨æ’ä»¶
pluginManager.addProcessedNote("note123");           // æ·»åŠ å·²å¤„ç†ç¬”è®°
MNUtil.copy(pluginManager.getStatus());              // æŸ¥çœ‹çŠ¶æ€
```

##### åœºæ™¯2ï¼šåˆ›å»ºä¸“é—¨çš„å·¥å…·å‡½æ•°

```javascript
function createNoteHelper(notebook) {
  let currentNotebook = notebook;  // é—­åŒ…ä¿å­˜ç¬”è®°æœ¬ä¿¡æ¯
  let operationCount = 0;          // è®°å½•æ“ä½œæ¬¡æ•°
  
  return {
    addTextComment: function(note, text) {
      note.appendTextComment(text);
      operationCount++;
      MNUtil.showHUD("åœ¨ " + currentNotebook.title + " ä¸­æ·»åŠ è¯„è®º (#" + operationCount + ")");
    },
    
    changeColor: function(note, colorIndex) {
      note.colorIndex = colorIndex;
      operationCount++;
      MNUtil.showHUD("åœ¨ " + currentNotebook.title + " ä¸­ä¿®æ”¹é¢œè‰² (#" + operationCount + ")");
    },
    
    getStats: function() {
      return currentNotebook.title + " å·²æ‰§è¡Œ " + operationCount + " æ¬¡æ“ä½œ";
    }
  };
}

// ä¸ºä¸åŒç¬”è®°æœ¬åˆ›å»ºä¸“é—¨çš„åŠ©æ‰‹
let mathHelper = createNoteHelper({title: "æ•°å­¦ç¬”è®°æœ¬"});
let historyHelper = createNoteHelper({title: "å†å²ç¬”è®°æœ¬"});

// æ¯ä¸ªåŠ©æ‰‹éƒ½æœ‰è‡ªå·±çš„"è®°å¿†"
mathHelper.addTextComment(someNote, "è¿™æ˜¯æ•°å­¦å…¬å¼");     // æ•°å­¦ç¬”è®°æœ¬ #1
historyHelper.changeColor(anotherNote, 5);             // å†å²ç¬”è®°æœ¬ #1  
mathHelper.changeColor(someNote, 2);                   // æ•°å­¦ç¬”è®°æœ¬ #2

MNUtil.showHUD(mathHelper.getStats());    // "æ•°å­¦ç¬”è®°æœ¬ å·²æ‰§è¡Œ 2 æ¬¡æ“ä½œ"
MNUtil.showHUD(historyHelper.getStats()); // "å†å²ç¬”è®°æœ¬ å·²æ‰§è¡Œ 1 æ¬¡æ“ä½œ"
```

#### é—­åŒ…çš„ä»·å€¼

1. **æ•°æ®ä¿æŠ¤**ï¼šå¤–éƒ¨æ— æ³•ç›´æ¥ä¿®æ”¹å†…éƒ¨å˜é‡ï¼Œåªèƒ½é€šè¿‡æä¾›çš„æ–¹æ³•
2. **çŠ¶æ€ä¿æŒ**ï¼šå‡½æ•°æ‰§è¡Œå®Œåï¼Œç›¸å…³æ•°æ®ä¾ç„¶ä¿å­˜ç€
3. **åˆ›å»ºä¸“ç”¨å·¥å…·**ï¼šæ¯æ¬¡è°ƒç”¨éƒ½ç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„ã€æœ‰è®°å¿†çš„å·¥å…·å‡½æ•°

**è®°ä½**ï¼šé—­åŒ…å°±æ˜¯è®©å‡½æ•°æ‹¥æœ‰"è®°å¿†åŠ›"çš„æŠ€æœ¯ï¼

---

## ç¬¬å››éƒ¨åˆ†ï¼šå®æˆ˜æ¡ˆä¾‹åˆ†æ

### 4.1 å®Œæ•´åŠŸèƒ½åˆ†æï¼šä»æŒ‰é’®ç‚¹å‡»åˆ°åŠŸèƒ½æ‰§è¡Œ

è®©æˆ‘ä»¬åˆ†æä¸€ä¸ªå®Œæ•´çš„åŠŸèƒ½ï¼š**æ·»åŠ æ—¶é—´æˆ³**

#### ç¬¬1æ­¥ï¼šæ³¨å†ŒæŒ‰é’®ï¼ˆxdyy_button_registry.jsï¼‰

```javascript
// å‘Šè¯‰ç³»ç»Ÿï¼šæˆ‘è¦æ·»åŠ ä¸€ä¸ªæŒ‰é’®
global.registerButton("custom15", {
  name: "æ—¶é—´æˆ³",              // æŒ‰é’®æ˜¾ç¤ºçš„æ–‡å­—
  image: "custom15",           // ä½¿ç”¨ custom15.png ä½œä¸ºå›¾æ ‡
  templateName: "menu_timestamp"  // ç‚¹å‡»åæ˜¾ç¤ºçš„èœå•
});
```

#### ç¬¬2æ­¥ï¼šå®šä¹‰èœå•ï¼ˆxdyy_menu_registry.jsï¼‰

```javascript
// å®šä¹‰èœå•çš„å†…å®¹å’Œè¡Œä¸º
global.registerMenuTemplate("menu_timestamp", {
  action: "addTimestamp",      // é»˜è®¤åŠ¨ä½œï¼šç›´æ¥ç‚¹å‡»æ‰§è¡Œ
  
  onLongPress: {              // é•¿æŒ‰æ˜¾ç¤ºå­èœå•
    action: "menu",
    menuWidth: 200,
    menuItems: [
      {
        action: "addTimestampToTitle",
        menuTitle: "æ·»åŠ åˆ°æ ‡é¢˜"
      },
      {
        action: "addTimestampToComment",
        menuTitle: "æ·»åŠ ä¸ºè¯„è®º"
      }
    ]
  }
});
```

#### ç¬¬3æ­¥ï¼šå®ç°åŠŸèƒ½ï¼ˆxdyy_custom_actions_registry.jsï¼‰

```javascript
// å®ç°å…·ä½“çš„åŠŸèƒ½
global.registerCustomAction("addTimestamp", async function(context) {
  // 1. è·å–å½“å‰é€‰ä¸­çš„ç¬”è®°
  const focusNote = MNNote.getFocusNote();
  
  // 2. æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­ç¬”è®°
  if (!focusNote) {
    MNUtil.showHUD("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°");
    return;
  }
  
  // 3. ç”Ÿæˆæ—¶é—´æˆ³
  const now = new Date();
  const timestamp = `${now.getFullYear()}-${
    String(now.getMonth() + 1).padStart(2, '0')
  }-${
    String(now.getDate()).padStart(2, '0')
  } ${
    String(now.getHours()).padStart(2, '0')
  }:${
    String(now.getMinutes()).padStart(2, '0')
  }`;
  
  // 4. æ·»åŠ åˆ°ç¬”è®°
  MNUtil.undoGrouping(() => {
    // ä½¿ç”¨æ’¤é”€ç»„ï¼Œè®©æ“ä½œå¯ä»¥ä¸€é”®æ’¤é”€
    if (focusNote.noteTitle) {
      focusNote.noteTitle = `${focusNote.noteTitle} [${timestamp}]`;
    } else {
      focusNote.noteTitle = timestamp;
    }
  });
  
  // 5. æ˜¾ç¤ºæˆåŠŸæç¤º
  MNUtil.showHUD(`å·²æ·»åŠ æ—¶é—´æˆ³ï¼š${timestamp}`);
});
```

#### æ‰§è¡Œæµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
    â†“
ç³»ç»ŸæŸ¥æ‰¾ custom15 é…ç½®
    â†“
æ‰¾åˆ° templateName: "menu_timestamp"
    â†“
æŸ¥æ‰¾ menu_timestamp æ¨¡æ¿
    â†“
æ‰¾åˆ° action: "addTimestamp"
    â†“
æ‰§è¡Œ global.customActions["addTimestamp"]
    â†“
åŠŸèƒ½ä»£ç æ‰§è¡Œ
    â†“
æ˜¾ç¤ºç»“æœ
```

---

### 4.2 å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

#### é”™è¯¯1ï¼šundefined å’Œ null

```javascript
// âŒ å¸¸è§é”™è¯¯
const note = MNNote.getFocusNote();
note.appendComment("è¯„è®º");  // å¦‚æœæ²¡æœ‰é€‰ä¸­ç¬”è®°ï¼Œnote æ˜¯ nullï¼Œä¼šæŠ¥é”™

// âœ… æ­£ç¡®åšæ³•
const note = MNNote.getFocusNote();
if (note) {  // å…ˆæ£€æŸ¥
  note.appendComment("è¯„è®º");
} else {
  MNUtil.showHUD("è¯·å…ˆé€‰æ‹©ç¬”è®°");
}
```

#### é”™è¯¯2ï¼šthis æŒ‡å‘é—®é¢˜

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
class MyClass {
  name = "æµ‹è¯•";
  
  showName() {
    setTimeout(function() {
      MNUtil.log(this.name);  // undefinedï¼this ä¸æ˜¯ MyClass å®ä¾‹
    }, 1000);
  }
}

// âœ… è§£å†³æ–¹æ¡ˆ1ï¼šç®­å¤´å‡½æ•°
class MyClass {
  name = "æµ‹è¯•";
  
  showName() {
    setTimeout(() => {
      MNUtil.log(this.name);  // "æµ‹è¯•"ï¼Œç®­å¤´å‡½æ•°ä¿æŒ this
    }, 1000);
  }
}

// âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä¿å­˜ this
class MyClass {
  name = "æµ‹è¯•";
  
  showName() {
    const that = this;  // ä¿å­˜ this
    setTimeout(function() {
      MNUtil.log(that.name);  // "æµ‹è¯•"
    }, 1000);
  }
}
```

#### é”™è¯¯3ï¼šå¼‚æ­¥é™·é˜± - for...of vs forEach çš„å…³é”®åŒºåˆ«

**æ ¸å¿ƒé—®é¢˜**ï¼šä¸ºä»€ä¹ˆ forEach ä¸èƒ½ç”¨ awaitï¼Œè€Œ for...of å¯ä»¥ï¼Ÿ

```javascript
// âŒ é”™è¯¯ï¼šåœ¨ forEach ä¸­ä½¿ç”¨ await
async function processNotes() {
  const notes = MNNote.getFocusNotes();
  
  notes.forEach(async note => {  // æ³¨æ„ï¼šè¿™é‡Œçš„ async æ²¡ç”¨ï¼
    await MNUtil.delay(1);       // await ä¸ä¼šå½±å“å¤–éƒ¨å‡½æ•°
    note.appendComment("å¤„ç†å®Œæˆ");
  });
  
  MNUtil.showHUD("å…¨éƒ¨å®Œæˆ");  // ç«‹å³æ‰§è¡Œï¼ä¸ç­‰å¾…ä»»ä½•æ“ä½œ
}
```

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ**

æƒ³è±¡ä½ æ˜¯ç­ä¸»ä»»ï¼Œè¦ç»™æ¯ä¸ªå­¦ç”Ÿå‘å¥–çŠ¶ï¼š

```javascript
// forEach çš„å·¥ä½œæ–¹å¼ï¼šåŒæ—¶å«æ‰€æœ‰å­¦ç”Ÿä¸Šå°
students.forEach(async student => {
  await giveAward(student);  // æ¯ä¸ªå­¦ç”Ÿç‹¬ç«‹é¢†å¥–
});
console.log("å‘å¥–å®Œæˆ");  // é©¬ä¸Šæ‰§è¡Œï¼Œä¸ç­‰å­¦ç”Ÿé¢†å®Œ

// å®é™…æƒ…å†µï¼š
// å­¦ç”Ÿ1ï¼šæ­£åœ¨é¢†å¥–...ï¼ˆ3ç§’ï¼‰
// å­¦ç”Ÿ2ï¼šæ­£åœ¨é¢†å¥–...ï¼ˆ3ç§’ï¼‰  
// å­¦ç”Ÿ3ï¼šæ­£åœ¨é¢†å¥–...ï¼ˆ3ç§’ï¼‰
// ç­ä¸»ä»»ï¼šå‘å¥–å®Œæˆï¼ï¼ˆç«‹å³è¯´å‡ºï¼Œä¸ç­‰ä»»ä½•äººï¼‰
```

```javascript
// for...of çš„å·¥ä½œæ–¹å¼ï¼šé€ä¸ªå«å­¦ç”Ÿä¸Šå°
for (const student of students) {
  await giveAward(student);  // ç­‰è¿™ä¸ªå­¦ç”Ÿé¢†å®Œï¼Œå†å«ä¸‹ä¸€ä¸ª
}
console.log("å‘å¥–å®Œæˆ");  // ç­‰æ‰€æœ‰å­¦ç”Ÿéƒ½é¢†å®Œæ‰æ‰§è¡Œ

// å®é™…æƒ…å†µï¼š
// å­¦ç”Ÿ1ï¼šé¢†å¥–ä¸­...ï¼ˆç­‰å¾…3ç§’ï¼‰â†’ å®Œæˆ
// å­¦ç”Ÿ2ï¼šé¢†å¥–ä¸­...ï¼ˆç­‰å¾…3ç§’ï¼‰â†’ å®Œæˆ  
// å­¦ç”Ÿ3ï¼šé¢†å¥–ä¸­...ï¼ˆç­‰å¾…3ç§’ï¼‰â†’ å®Œæˆ
// ç­ä¸»ä»»ï¼šå‘å¥–å®Œæˆï¼ï¼ˆç­‰æ‰€æœ‰äººéƒ½å®Œæˆäº†æ‰è¯´ï¼‰
```

**å®Œæ•´å¯¹æ¯”**ï¼š

```javascript
// âŒ forEachï¼šå¹¶è¡Œæ‰§è¡Œï¼Œå¤–éƒ¨å‡½æ•°ä¸ç­‰å¾…
async function processWithForEach() {
  const notes = MNNote.getFocusNotes();
  
  console.log("å¼€å§‹å¤„ç†");
  notes.forEach(async (note, index) => {
    console.log(`å¼€å§‹å¤„ç†ç¬”è®° ${index + 1}`);
    await MNUtil.delay(1);  // å»¶è¿Ÿ1ç§’
    note.appendComment("å¤„ç†å®Œæˆ");
    console.log(`å®Œæˆå¤„ç†ç¬”è®° ${index + 1}`);
  });
  console.log("å‡½æ•°ç»“æŸ");  // ç«‹å³æ‰§è¡Œï¼
  
  // è¾“å‡ºé¡ºåºï¼š
  // "å¼€å§‹å¤„ç†"
  // "å¼€å§‹å¤„ç†ç¬”è®° 1"
  // "å¼€å§‹å¤„ç†ç¬”è®° 2" 
  // "å¼€å§‹å¤„ç†ç¬”è®° 3"
  // "å‡½æ•°ç»“æŸ"  â† ç«‹å³å‡ºç°ï¼
  // (1ç§’å) "å®Œæˆå¤„ç†ç¬”è®° 1"
  // (1ç§’å) "å®Œæˆå¤„ç†ç¬”è®° 2"
  // (1ç§’å) "å®Œæˆå¤„ç†ç¬”è®° 3"
}

// âœ… for...ofï¼šé¡ºåºæ‰§è¡Œï¼Œå¤–éƒ¨å‡½æ•°ç­‰å¾…
async function processWithForOf() {
  const notes = MNNote.getFocusNotes();
  
  console.log("å¼€å§‹å¤„ç†");
  for (let i = 0; i < notes.length; i++) {
    const note = notes[i];
    console.log(`å¼€å§‹å¤„ç†ç¬”è®° ${i + 1}`);
    await MNUtil.delay(1);  // ç­‰å¾…1ç§’
    note.appendComment("å¤„ç†å®Œæˆ");
    console.log(`å®Œæˆå¤„ç†ç¬”è®° ${i + 1}`);
  }
  console.log("å‡½æ•°ç»“æŸ");  // ç­‰æ‰€æœ‰å¤„ç†å®Œæˆåæ‰æ‰§è¡Œ
  
  // è¾“å‡ºé¡ºåºï¼š
  // "å¼€å§‹å¤„ç†"
  // "å¼€å§‹å¤„ç†ç¬”è®° 1"
  // (1ç§’å) "å®Œæˆå¤„ç†ç¬”è®° 1"
  // "å¼€å§‹å¤„ç†ç¬”è®° 2"
  // (1ç§’å) "å®Œæˆå¤„ç†ç¬”è®° 2"
  // "å¼€å§‹å¤„ç†ç¬”è®° 3"
  // (1ç§’å) "å®Œæˆå¤„ç†ç¬”è®° 3"
  // "å‡½æ•°ç»“æŸ"  â† æœ€åå‡ºç°
}
```

**å®é™…åº”ç”¨åœºæ™¯**ï¼š

```javascript
// åœºæ™¯1ï¼šæ‰¹é‡å¤„ç†ç¬”è®°ï¼Œéœ€è¦æ˜¾ç¤ºè¿›åº¦
async function processNotesWithProgress() {
  const notes = MNNote.getFocusNotes();
  const total = notes.length;
  
  for (let i = 0; i < notes.length; i++) {
    const note = notes[i];
    
    // æ˜¾ç¤ºè¿›åº¦
    MNUtil.showHUD(`å¤„ç†è¿›åº¦: ${i + 1}/${total}`);
    
    // å¤„ç†ç¬”è®°
    await MNUtil.delay(0.5);  // ç¨å¾®å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°è¿›åº¦
    note.appendComment(`å¤„ç†æ—¶é—´: ${new Date().toLocaleTimeString()}`);
  }
  
  MNUtil.showHUD("âœ… å…¨éƒ¨å¤„ç†å®Œæˆï¼");
}

// åœºæ™¯2ï¼šéœ€è¦æŒ‰é¡ºåºæ‰§è¡Œï¼Œåé¢ä¾èµ–å‰é¢çš„ç»“æœ
async function processNotesSequentially() {
  const notes = MNNote.getFocusNotes();
  let processedCount = 0;
  
  for (const note of notes) {
    // æ¯ä¸ªç¬”è®°çš„å¤„ç†ä¾èµ–å‰é¢çš„è®¡æ•°
    processedCount++;
    note.appendComment(`åºå·: ${processedCount}`);
    
    // ç­‰å¾…ä¸€å®šæ—¶é—´ï¼Œé¿å…å¤„ç†å¤ªå¿«
    await MNUtil.delay(0.2);
  }
  
  MNUtil.showHUD(`æŒ‰é¡ºåºå¤„ç†äº† ${processedCount} ä¸ªç¬”è®°`);
}
```

**ä½•æ—¶ç”¨å“ªä¸ªï¼Ÿ**

| åœºæ™¯ | ä½¿ç”¨ | åŸå›  |
|-----|------|------|
| éœ€è¦ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ | `for...of` + `await` | é¡ºåºæ‰§è¡Œï¼Œå¯ä»¥ç­‰å¾… |
| éœ€è¦æ˜¾ç¤ºå¤„ç†è¿›åº¦ | `for...of` + `await` | èƒ½æ§åˆ¶æ‰§è¡Œé¡ºåº |
| åé¢æ“ä½œä¾èµ–å‰é¢ç»“æœ | `for...of` + `await` | ç¡®ä¿é¡ºåºå®Œæˆ |
| çº¯æ•°æ®è½¬æ¢ï¼ˆæ— å¼‚æ­¥ï¼‰ | `forEach` æˆ– `map` | æ›´ç®€æ´ï¼Œæ€§èƒ½æ›´å¥½ |
| åŒæ—¶è§¦å‘å¤šä¸ªç‹¬ç«‹æ“ä½œ | `Promise.all` | çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œ |

**è®°å¿†å£è¯€**ï¼š
- "forEach ä¸ç­‰å¾…ï¼Œfor...of è¦ç­‰å¾…"
- "éœ€è¦é¡ºåºç”¨ for...ofï¼Œè½¬æ¢æ•°æ®ç”¨ forEach"

---

### 4.3 è°ƒè¯•æŠ€å·§

#### 1. ä½¿ç”¨ MNUtil.log è¾“å‡ºæ—¥å¿—

```javascript
function debugFunction() {
  MNUtil.log("=== å¼€å§‹æ‰§è¡Œ ===");
  
  const note = MNNote.getFocusNote();
  MNUtil.log("è·å–çš„ç¬”è®°ï¼š" + note);
  
  if (note) {
    MNUtil.log("ç¬”è®°æ ‡é¢˜ï¼š" + note.noteTitle);
    MNUtil.log("ç¬”è®°IDï¼š" + note.noteId);
  }
  
  MNUtil.log("=== æ‰§è¡Œç»“æŸ ===");
}
```

#### 2. ä½¿ç”¨ try-catch æ•è·é”™è¯¯

```javascript
async function safeFunction(context) {
  try {
    // å¯èƒ½å‡ºé”™çš„ä»£ç 
    const note = MNNote.getFocusNote();
    note.appendComment("æµ‹è¯•");
    
  } catch (error) {
    // é”™è¯¯å¤„ç†
    MNUtil.log("é”™è¯¯ï¼š" + error.message);
    MNUtil.log("é”™è¯¯æ ˆï¼š" + error.stack);
    MNUtil.showHUD("æ“ä½œå¤±è´¥ï¼š" + error.message);
  }
}
```

#### 3. ä½¿ç”¨ MNUtil.copy å¤åˆ¶å¯¹è±¡ä¿¡æ¯

```javascript
function inspectObject() {
  const note = MNNote.getFocusNote();
  
  if (note) {
    // å¤åˆ¶ç¬”è®°ä¿¡æ¯åˆ°å‰ªè´´æ¿
    MNUtil.copyJSON({
      id: note.noteId,
      title: note.noteTitle,
      color: note.colorIndex,
      commentCount: note.comments.length
    });
    
    MNUtil.showHUD("ç¬”è®°ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
  }
}
```

---

## â— å¸¸è§é”™è¯¯è§£è¯» - çœ‹æ‡‚é”™è¯¯ä¿¡æ¯ï¼Œå¿«é€Ÿè§£å†³é—®é¢˜

åˆå­¦è€…æœ€å¤´ç–¼çš„å°±æ˜¯çœ‹åˆ°ä¸€å †çº¢è‰²é”™è¯¯ä¿¡æ¯ä¸çŸ¥é“ä»€ä¹ˆæ„æ€ã€‚å­¦ä¼š"è¯»æ‡‚"é”™è¯¯ä¿¡æ¯æ˜¯ç¼–ç¨‹çš„é‡è¦æŠ€èƒ½ï¼

### ğŸ” é”™è¯¯ä¿¡æ¯çš„ç»“æ„

```
TypeError: Cannot read property 'noteId' of null
    at Object.addComment (main.js:45:12)
    at Object.onButtonClick (main.js:23:5)
```

**è§£è¯»**ï¼š
- `TypeError`ï¼šé”™è¯¯ç±»å‹ - ç±»å‹é”™è¯¯
- `Cannot read property 'noteId' of null`ï¼šé”™è¯¯æè¿° - è¯•å›¾è¯»å– null çš„ noteId å±æ€§
- `main.js:45:12`ï¼šé”™è¯¯ä½ç½® - æ–‡ä»¶å:è¡Œå·:åˆ—å·

### ğŸ“š æœ€å¸¸è§çš„ 5 ç§é”™è¯¯

#### 1. **TypeError: Cannot read property 'xxx' of null**

```javascript
// âŒ é”™è¯¯ä»£ç 
let note = MNNote.getFocusNote();  // è¿”å› nullï¼ˆæ²¡é€‰ä¸­ç¬”è®°ï¼‰
note.noteId;  // è¯•å›¾è¯»å– null çš„å±æ€§ â†’ æŠ¥é”™ï¼

// âœ… æ­£ç¡®ä¿®å¤
let note = MNNote.getFocusNote();
if (note) {  // å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºç©º
  let id = note.noteId;
} else {
  MNUtil.showHUD("è¯·å…ˆé€‰æ‹©ç¬”è®°");
}
```

**è®°å¿†å£è¯€**ï¼š"å…ˆæ£€æŸ¥ï¼Œå†ä½¿ç”¨"

#### 2. **ReferenceError: xxx is not defined**

```javascript
// âŒ é”™è¯¯ä»£ç 
MNutil.showHUD("Hello");  // æ‹¼å†™é”™è¯¯ï¼åº”è¯¥æ˜¯ MNUtil

// âŒ å¦ä¸€ä¸ªä¾‹å­
function myFunction() {
  showMessage("test");  // showMessage å‡½æ•°æ²¡æœ‰å®šä¹‰
}

// âœ… æ­£ç¡®ä¿®å¤
MNUtil.showHUD("Hello");  // æ³¨æ„å¤§å°å†™

// âœ… å…ˆå®šä¹‰å†ä½¿ç”¨
function showMessage(text) {
  MNUtil.showHUD(text);
}

function myFunction() {
  showMessage("test");  // ç°åœ¨å¯ä»¥æ­£å¸¸è°ƒç”¨äº†
}
```

**è®°å¿†å£è¯€**ï¼š"æ£€æŸ¥æ‹¼å†™ï¼Œå…ˆå®šä¹‰åä½¿ç”¨"

#### 3. **TypeError: xxx is not a function**

```javascript
// âŒ é”™è¯¯ä»£ç 
let note = MNNote.getFocusNote();
note.appendComment = "è¿™æ˜¯è¯„è®º";  // é”™è¯¯ï¼æŠŠæ–¹æ³•å½“æˆäº†å±æ€§
note.appendComment("æ–°è¯„è®º");     // è¯•å›¾è°ƒç”¨å­—ç¬¦ä¸² â†’ æŠ¥é”™ï¼

// âŒ å¦ä¸€ä¸ªä¾‹å­
let utils = MNUtil;
utils.showHud("æ¶ˆæ¯");  // æ‹¼å†™é”™è¯¯ï¼åº”è¯¥æ˜¯ showHUD

// âœ… æ­£ç¡®ä¿®å¤
let note = MNNote.getFocusNote();
note.appendComment("è¿™æ˜¯è¯„è®º");   // æ­£ç¡®è°ƒç”¨æ–¹æ³•

let utils = MNUtil;
utils.showHUD("æ¶ˆæ¯");  // æ³¨æ„æ–¹æ³•åçš„å¤§å°å†™
```

**è®°å¿†å£è¯€**ï¼š"æ–¹æ³•è¦è°ƒç”¨ï¼Œæ³¨æ„å¤§å°å†™"

#### 4. **SyntaxError: Unexpected token**

```javascript
// âŒ é”™è¯¯ä»£ç 
if (note {  // ç¼ºå°‘å³æ‹¬å·
  MNUtil.log("æœ‰ç¬”è®°");
}

// âŒ å¦ä¸€ä¸ªä¾‹å­
let config = {
  theme: "dark",
  version: 1.0  // æœ€åä¸€é¡¹åé¢ä¸èƒ½æœ‰é€—å·ï¼ˆåœ¨æŸäº›ç¯å¢ƒä¸­ï¼‰
,};

// âœ… æ­£ç¡®ä¿®å¤
if (note) {  // æ‹¬å·é…å¯¹
  MNUtil.log("æœ‰ç¬”è®°");
}

let config = {
  theme: "dark",
  version: 1.0  // ç§»é™¤å¤šä½™é€—å·
};
```

**è®°å¿†å£è¯€**ï¼š"æ‹¬å·é…å¯¹ï¼Œé€—å·æ£€æŸ¥"

#### 5. **TypeError: Cannot access 'xxx' before initialization**

```javascript
// âŒ é”™è¯¯ä»£ç 
sayHello();  // è¯•å›¾åœ¨å£°æ˜å‰è°ƒç”¨

let sayHello = function() {  // å‡½æ•°è¡¨è¾¾å¼ä¸ä¼šæå‡
  MNUtil.showHUD("Hello");
};

// âœ… æ­£ç¡®ä¿®å¤1ï¼šæ”¹ä¸ºå‡½æ•°å£°æ˜
function sayHello() {  // å‡½æ•°å£°æ˜ä¼šæå‡ï¼Œå¯ä»¥åœ¨å£°æ˜å‰è°ƒç”¨
  MNUtil.showHUD("Hello");
}

sayHello();  // ç°åœ¨å¯ä»¥æ­£å¸¸è°ƒç”¨

// âœ… æ­£ç¡®ä¿®å¤2ï¼šåœ¨å£°æ˜åè°ƒç”¨
let sayHello = function() {
  MNUtil.showHUD("Hello");
};

sayHello();  // åœ¨å£°æ˜åè°ƒç”¨
```

**è®°å¿†å£è¯€**ï¼š"å…ˆå£°æ˜ï¼Œå†è°ƒç”¨"ï¼ˆé™¤éä½¿ç”¨ function å£°æ˜ï¼‰

### ğŸ”§ è°ƒè¯•æŠ€å·§

#### 1. ä½¿ç”¨ console.log/MNUtil.log è¿½è¸ªå˜é‡

```javascript
function processNote() {
  let note = MNNote.getFocusNote();
  MNUtil.log("è·å–çš„ç¬”è®°ï¼š", note);  // æ£€æŸ¥æ˜¯å¦ä¸º null
  
  if (note) {
    MNUtil.log("ç¬”è®° IDï¼š", note.noteId);  // æ£€æŸ¥å±æ€§å€¼
    note.appendComment("å¤„ç†å®Œæˆ");
    MNUtil.log("è¯„è®ºå·²æ·»åŠ ");
  }
}
```

#### 2. ä½¿ç”¨ try-catch æ•è·é”™è¯¯

```javascript
function safeFunction() {
  try {
    // å¯èƒ½å‡ºé”™çš„ä»£ç 
    let note = MNNote.getFocusNote();
    note.appendComment("æµ‹è¯•");
    
  } catch (error) {
    // é”™è¯¯å¤„ç†
    MNUtil.log("é”™è¯¯ç±»å‹ï¼š" + error.name);
    MNUtil.log("é”™è¯¯ä¿¡æ¯ï¼š" + error.message);
    MNUtil.log("é”™è¯¯å †æ ˆï¼š" + error.stack);
    MNUtil.showHUD("æ“ä½œå¤±è´¥ï¼š" + error.message);
  }
}
```

#### 3. åˆ†æ­¥éª¤æ‰§è¡Œå¤æ‚æ“ä½œ

```javascript
// âŒ å¤æ‚çš„é“¾å¼è°ƒç”¨ï¼Œéš¾ä»¥è°ƒè¯•
note.getComments()[0].getText().substring(0, 10).toUpperCase();

// âœ… åˆ†æ­¥éª¤ï¼Œæ¯æ­¥éƒ½å¯ä»¥æ£€æŸ¥
let comments = note.getComments();
MNUtil.log("è¯„è®ºæ•°é‡ï¼š", comments.length);

if (comments.length > 0) {
  let firstComment = comments[0];
  MNUtil.log("ç¬¬ä¸€æ¡è¯„è®ºï¼š", firstComment);
  
  let text = firstComment.getText();
  MNUtil.log("è¯„è®ºæ–‡æœ¬ï¼š", text);
  
  let shortText = text.substring(0, 10);
  let result = shortText.toUpperCase();
  MNUtil.log("æœ€ç»ˆç»“æœï¼š", result);
}
```

### ğŸ’¡ é”™è¯¯é¢„é˜²çš„æœ€ä½³å®è·µ

1. **æ€»æ˜¯æ£€æŸ¥è¿”å›å€¼**ï¼š
   ```javascript
   let note = MNNote.getFocusNote();
   if (!note) return;  // æå‰é€€å‡º
   ```

2. **ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å**ï¼š
   ```javascript
   // âŒ éš¾ç†è§£
   let n = MNNote.getFocusNote();
   let c = n.getComments();
   
   // âœ… å®¹æ˜“ç†è§£
   let focusNote = MNNote.getFocusNote();
   let noteComments = focusNote.getComments();
   ```

3. **ä¿æŒå‡½æ•°ç®€å•**ï¼š
   ```javascript
   // âŒ ä¸€ä¸ªå‡½æ•°åšå¤ªå¤šäº‹
   function processEverything() {
     // 100 è¡Œä»£ç ...
   }
   
   // âœ… æ‹†åˆ†æˆå°å‡½æ•°
   function getNoteData() { }
   function processData() { }
   function saveResults() { }
   ```

**è®°ä½**ï¼šé”™è¯¯ä¸å¯æ€•ï¼Œçœ‹ä¸æ‡‚é”™è¯¯æ‰å¯æ€•ã€‚å­¦ä¼šè¯»æ‡‚é”™è¯¯ä¿¡æ¯ï¼Œä½ å°±æˆåŠŸäº†ä¸€åŠï¼

---

## ğŸ“ ç»ƒä¹ é¢˜

### åŸºç¡€ç»ƒä¹ 

1. **å˜é‡å’Œæ•°æ®ç±»å‹**
   - åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä½ çš„å§“åï¼ˆå­—ç¬¦ä¸²ï¼‰ã€å¹´é¾„ï¼ˆæ•°å­—ï¼‰ã€æ˜¯å¦æ˜¯å­¦ç”Ÿï¼ˆå¸ƒå°”å€¼ï¼‰
   - åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«5ä¸ªä½ å–œæ¬¢çš„é¢œè‰²

2. **å‡½æ•°ç»ƒä¹ **
   - å†™ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸¤ä¸ªæ•°å­—å‚æ•°ï¼Œè¿”å›å®ƒä»¬çš„å’Œ
   - ç”¨ç®­å¤´å‡½æ•°é‡å†™ä¸Šé¢çš„å‡½æ•°

3. **ç±»çš„ç»ƒä¹ **
   - åˆ›å»ºä¸€ä¸ª Book ç±»ï¼Œæœ‰ title å’Œ author å±æ€§
   - æ·»åŠ ä¸€ä¸ª getInfo() æ–¹æ³•ï¼Œè¿”å› "ã€Šæ ‡é¢˜ã€‹by ä½œè€…"
   - åˆ›å»ºä¸¤ä¸ª Book å®ä¾‹

### è¿›é˜¶ç»ƒä¹ 

1. **static æ–¹æ³•**
   - ç»™ Book ç±»æ·»åŠ ä¸€ä¸ªé™æ€æ–¹æ³• `static createFromString(str)`
   - è¯¥æ–¹æ³•æ¥æ”¶ "æ ‡é¢˜-ä½œè€…" æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œè¿”å› Book å®ä¾‹

2. **å¼‚æ­¥ç¼–ç¨‹**
   - å†™ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œä½¿ç”¨ MNUtil.delay å®ç°å€’è®¡æ—¶åŠŸèƒ½
   - ä» 3 å€’æ•°åˆ° 1ï¼Œæ¯ç§’æ˜¾ç¤ºä¸€æ¬¡

3. **å®æˆ˜åŠŸèƒ½**
   - å®ç°ä¸€ä¸ª"æ‰¹é‡æ·»åŠ æ ‡ç­¾"çš„åŠŸèƒ½
   - è·å–æ‰€æœ‰é€‰ä¸­çš„ç¬”è®°ï¼Œç»™æ¯ä¸ªç¬”è®°æ·»åŠ  "å·²å¤„ç†" æ ‡ç­¾

---

## ğŸ¯ æ€»ç»“

### ä½ å·²ç»å­¦ä¼šäº†

1. **JavaScript åŸºç¡€**
   - å˜é‡å’Œæ•°æ®ç±»å‹
   - å‡½æ•°çš„ä¸‰ç§å½¢å¼
   - å¯¹è±¡å’Œç±»çš„æ¦‚å¿µ

2. **é¢å‘å¯¹è±¡ç¼–ç¨‹**
   - ç±»å’Œå®ä¾‹çš„å…³ç³»
   - static æ–¹æ³• vs å®ä¾‹æ–¹æ³•
   - prototype åŸå‹é“¾
   - æ„é€ å‡½æ•°å’Œ this

3. **MarginNote ç‰¹æ®Šè¯­æ³•**
   - JSB.defineClass çš„ä½¿ç”¨
   - å¼‚æ­¥ç¼–ç¨‹ async/await
   - é—­åŒ…å’Œä½œç”¨åŸŸ

4. **å®æˆ˜æŠ€èƒ½**
   - å®Œæ•´çš„åŠŸèƒ½å¼€å‘æµç¨‹
   - å¸¸è§é”™è¯¯çš„è§£å†³
   - è°ƒè¯•æŠ€å·§

### ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

1. **é˜…è¯»æºç **ï¼šæ‰“å¼€ mnutils.jsï¼Œè¯•ç€ç†è§£æ¯ä¸ªç±»çš„è®¾è®¡
2. **ä¿®æ”¹ç°æœ‰æ’ä»¶**ï¼šå…ˆä»å°ä¿®æ”¹å¼€å§‹ï¼Œæ¯”å¦‚æ”¹å˜æŒ‰é’®åç§°
3. **å¼€å‘ç®€å•åŠŸèƒ½**ï¼šå®ç°ä¸€ä¸ªè‡ªå·±éœ€è¦çš„å°åŠŸèƒ½
4. **å‚ä¸ç¤¾åŒº**ï¼šåˆ†äº«ä½ çš„ä»£ç ï¼Œå‘å…¶ä»–å¼€å‘è€…å­¦ä¹ 

### æ¨èèµ„æº

- **MNUtils API æ–‡æ¡£**ï¼š`mnutils/MNUtils_API_Guide.md`
- **MNToolbar å®Œæ•´æŒ‡å—**ï¼š`mntoolbar/mntoolbar_complete_guide.md`
- **JavaScript MDN æ–‡æ¡£**ï¼šhttps://developer.mozilla.org/zh-CN/docs/Web/JavaScript

---

## ğŸ™ ç»“è¯­

ç¼–ç¨‹å°±åƒå­¦ä¹ ä¸€é—¨æ–°è¯­è¨€ï¼Œéœ€è¦æ—¶é—´å’Œç»ƒä¹ ã€‚ä¸è¦å®³æ€•çŠ¯é”™ï¼Œæ¯ä¸ªé”™è¯¯éƒ½æ˜¯å­¦ä¹ çš„æœºä¼šã€‚MarginNote æ’ä»¶å¼€å‘æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ï¼Œå› ä¸ºä½ å¯ä»¥ç«‹å³çœ‹åˆ°ä»£ç çš„æ•ˆæœï¼Œè§£å†³è‡ªå·±çš„å®é™…éœ€æ±‚ã€‚

è®°ä½ï¼š**æ¯ä¸ªä¸“å®¶éƒ½æ›¾æ˜¯åˆå­¦è€…**ã€‚ä¿æŒå¥½å¥‡å¿ƒï¼ŒæŒç»­å­¦ä¹ ï¼Œä½ ä¹Ÿèƒ½æˆä¸ºæ’ä»¶å¼€å‘é«˜æ‰‹ï¼

ç¥ä½ åœ¨ MarginNote æ’ä»¶å¼€å‘çš„é“è·¯ä¸Šè¶Šèµ°è¶Šè¿œï¼ğŸš€

---

*æœ¬æ–‡æ¡£åŸºäº MarginNote 4 æ’ä»¶å®é™…ä»£ç ç¼–å†™ï¼Œæ‰€æœ‰ç¤ºä¾‹å‡æ¥è‡ªçœŸå®æ’ä»¶ã€‚*

*æ–‡æ¡£ç‰ˆæœ¬ï¼š1.0.0 | æ›´æ–°æ—¥æœŸï¼š2025-01-20*