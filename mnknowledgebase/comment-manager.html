<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MNKnowledgeBase - è¯„è®ºç®¡ç†å™¨</title>
  <style>
    :root {
      /* è¯„è®ºç®¡ç†ä¸“ç”¨é…è‰² */
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --primary-color: #6366f1;      /* é›è“ */
      --success-color: #10b981;      /* ç»¿è‰²ï¼ˆæå–ï¼‰*/
      --danger-color: #ef4444;       /* çº¢è‰²ï¼ˆåˆ é™¤ï¼‰*/
      --warning-color: #f59e0b;      /* æ©™è‰²ï¼ˆç§»åŠ¨ï¼‰*/
      --muted: #64748b;
      --border-color: #e2e8f0;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 4px 12px rgba(99, 102, 241, 0.15);

      /* è¯„è®ºç±»å‹é¢œè‰² */
      --color-text: #3b82f6;         /* è“è‰²ï¼ˆæ–‡æœ¬ï¼‰*/
      --color-image: #8b5cf6;        /* ç´«è‰²ï¼ˆå›¾ç‰‡ï¼‰*/
      --color-link: #10b981;         /* ç»¿è‰²ï¼ˆé“¾æ¥ï¼‰*/
      --color-drawing: #f59e0b;      /* æ©™è‰²ï¼ˆæ‰‹å†™ï¼‰*/
      --color-html: #ec4899;         /* ç²‰è‰²ï¼ˆHTMLï¼‰*/
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: #1e293b;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    /* ========== å¸ƒå±€å®¹å™¨ ========== */
    .container {
      display: flex;
      flex-direction: row;  /* æ”¹ä¸ºæ¨ªå‘å¸ƒå±€ */
      height: 100vh;
    }

    /* ========== å·¦ä¾§å·¥å…·æ  ========== */
    .sidebar {
      width: 180px;
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 16px 12px;
      gap: 20px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .tool-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tool-group-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding-left: 4px;
    }

    /* å³ä¾§ä¸»å†…å®¹åŒº */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ========== é¡¶éƒ¨æ  ========== */
    .topbar {
      flex-shrink: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(250, 250, 250, 0.95));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .topbar-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
    }

    .topbar-icon {
      font-size: 24px;
    }

    .note-title {
      font-size: 14px;
      color: var(--muted);
      font-weight: 400;
      max-width: 400px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: #fee2e2;
      color: var(--danger-color);
      border-color: var(--danger-color);
    }

    /* ========== çŠ¶æ€æ  ========== */
    .statusbar {
      flex-shrink: 0;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }

    .status-info {
      display: flex;
      gap: 24px;
      color: var(--muted);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-value {
      font-weight: 600;
      color: var(--primary-color);
    }

    /* ========== å¿«æ·æ“ä½œï¼ˆå·²åºŸå¼ƒï¼Œåˆå¹¶åˆ°å·¦ä¾§è¾¹æ ï¼‰========== */
    /* å¿«æ·æ“ä½œæŒ‰é’®ç°åœ¨ä½¿ç”¨ .tool-btn æ ·å¼ */

    /* ========== è¯„è®ºåˆ—è¡¨åŒºåŸŸ ========== */
    .comments-section {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      scroll-behavior: smooth;
    }

    .comments-section::-webkit-scrollbar {
      width: 8px;
    }

    .comments-section::-webkit-scrollbar-track {
      background: transparent;
    }

    .comments-section::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    .comments-section::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .comments-list {
      max-width: 900px;
      margin: 0 auto;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* ========== è¯„è®ºå¡ç‰‡ ========== */
    .comment-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid var(--primary-color);
      box-shadow: var(--shadow);
      transition: all 0.2s ease;
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .comment-card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    .comment-card:active {
      transform: translateY(0) scale(0.99);
    }

    .comment-card.selected {
      border-left-width: 6px;
      background: linear-gradient(to right, #eef2ff, #ffffff);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.2);
    }

    /* è¯„è®ºç±»å‹é¢œè‰² */
    .comment-card[data-type="textComment"] { border-left-color: var(--color-text); }
    .comment-card[data-type="imageComment"] { border-left-color: var(--color-image); }
    .comment-card[data-type="linkComment"] { border-left-color: var(--color-link); }
    .comment-card[data-type="drawingComment"] { border-left-color: var(--color-drawing); }
    .comment-card[data-type="HtmlComment"] { border-left-color: var(--color-html); }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .comment-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--primary-color);
    }

    .comment-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .comment-index {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      min-width: 24px;
    }

    .comment-type-label {
      font-size: 12px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 12px;
      background: #f1f5f9;
      color: #64748b;
    }

    .comment-content {
      padding-left: 44px;
    }

    .comment-preview {
      font-size: 14px;
      line-height: 1.6;
      color: #334155;
      word-break: break-word;
    }

    .comment-preview.collapsed {
      max-height: 60px;
      overflow: hidden;
      position: relative;
    }

    .comment-preview.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(to bottom, transparent, var(--card-bg));
    }

    .expand-btn {
      margin-top: 8px;
      padding: 4px 12px;
      border: none;
      background: #f1f5f9;
      color: var(--primary-color);
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .expand-btn:hover {
      background: #e0e7ff;
    }

    /* å›¾ç‰‡ç¼©ç•¥å›¾ */
    .thumbnail {
      max-width: 200px;
      max-height: 150px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-top: 8px;
    }

    /* åˆå¹¶å†…å®¹çš„å›¾ç‰‡ç¼©ç•¥å›¾ï¼ˆæ›´å¤§å°ºå¯¸ï¼‰ */
    .merged-thumbnail {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
    }

    .merged-image-preview {
      text-align: center;
    }

    /* OCR æ–‡æœ¬è¾…åŠ©åŒºåŸŸ */
    .ocr-text-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--border-color);
    }

    .ocr-text-label {
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 4px;
    }

    .ocr-text-content {
      font-size: 13px;
      line-height: 1.5;
      color: #64748b;
      word-break: break-word;
    }

    .ocr-text-content.collapsed {
      max-height: 40px;
      overflow: hidden;
      position: relative;
    }

    .ocr-text-content.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 15px;
      background: linear-gradient(to bottom, transparent, var(--card-bg));
    }

    .ocr-expand-btn {
      font-size: 11px;
      padding: 2px 8px;
      margin-top: 4px;
    }

    /* é“¾æ¥ç›®æ ‡ */
    .link-target {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #f0fdf4;
      color: #059669;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 8px;
    }

    .link-arrow {
      font-size: 16px;
    }

    /* ========== åº•éƒ¨æ“ä½œåŒº ========== */
    .footer {
      flex-shrink: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      padding: 16px 20px;
      box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.04);
    }

    .main-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      max-width: 600px;
      margin: 0 auto;
    }

    .main-action-btn {
      flex: 1;
      padding: 14px 24px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      user-select: none;
    }

    .main-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .main-action-btn.move {
      background: linear-gradient(135deg, #fb923c, #f59e0b);
      color: white;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .main-action-btn.move:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
    }

    .main-action-btn.extract {
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .main-action-btn.extract:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    .main-action-btn.delete {
      background: linear-gradient(135deg, #f87171, #ef4444);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .main-action-btn.delete:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }

    .main-action-btn:active:not(:disabled) {
      transform: scale(0.96);
    }

    /* ========== å·¥å…·æŒ‰é’®ï¼ˆå·¦ä¾§è¾¹æ ï¼‰========== */
    .tool-btn {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      color: #475569;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      text-align: left;
    }

    .tool-btn:hover {
      background: #f1f5f9;
      border-color: var(--border-color);
      color: var(--primary-color);
    }

    .tool-btn.active {
      background: linear-gradient(135deg, #eef2ff, #e0e7ff);
      color: var(--primary-color);
      border-color: var(--primary-color);
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    .tool-btn:active {
      transform: scale(0.98);
    }

    /* ========== èŒƒå›´é€‰æ‹©æç¤º ========== */
    .range-select-hint {
      flex-shrink: 0;
      background: linear-gradient(135deg, #dbeafe, #e0f2fe);
      border-bottom: 1px solid #93c5fd;
      padding: 12px 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
      animation: slideDown 0.3s ease;
    }

    .range-select-hint.show {
      display: flex;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .range-hint-text {
      font-size: 14px;
      font-weight: 500;
      color: #1e40af;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .range-hint-icon {
      font-size: 20px;
    }

    .range-hint-buttons {
      display: flex;
      gap: 8px;
    }

    .hint-btn {
      padding: 6px 16px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .hint-btn.confirm {
      background: #10b981;
      color: white;
    }

    .hint-btn.confirm:hover {
      background: #059669;
    }

    .hint-btn.cancel {
      background: #f3f4f6;
      color: #6b7280;
    }

    .hint-btn.cancel:hover {
      background: #e5e7eb;
    }

    /* ========== èŒƒå›´é€‰æ‹©çŠ¶æ€ ========== */
    .comment-card.range-start {
      border-left-width: 8px;
      border-left-color: #10b981 !important;
      background: linear-gradient(to right, #d1fae5, #ffffff);
      position: relative;
    }

    .comment-card.range-start::before {
      content: 'èµ·å§‹';
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 2px 8px;
      background: #10b981;
      color: white;
      font-size: 11px;
      border-radius: 4px;
      font-weight: 600;
    }

    .comment-card.in-range {
      background: linear-gradient(to right, #e0f2fe, #ffffff);
      border-left-color: #3b82f6 !important;
    }

    /* ========== æ’å…¥ç‚¹æŒ‡ç¤ºå™¨ ========== */
    .insert-point {
      height: 48px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2px 0;
      opacity: 0;
      pointer-events: none;
    }

    .insert-point.show {
      opacity: 1;
      pointer-events: all;
    }

    .insert-line {
      font-size: 12px;
      color: #cbd5e1;
      letter-spacing: 3px;
      transition: all 0.2s ease;
      padding: 8px 24px;
      border-radius: 6px;
      background: transparent;
    }

    .insert-point:hover .insert-line {
      color: #10b981;
      font-weight: 700;
      background: #f0fdf4;
      transform: scale(1.05);
      letter-spacing: 4px;
    }

    .field-hint {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 2px;
      opacity: 0;
      transition: all 0.2s ease;
    }

    .insert-point:hover .field-hint {
      opacity: 1;
      color: #10b981;
    }

    /* ç§»åŠ¨æ¨¡å¼ä¸‹çš„è¯„è®ºå¡ç‰‡ */
    .comment-card.move-mode {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ========== å­—æ®µåˆ†ç»„ ========== */
    .field-group {
      margin-bottom: 20px;
    }

    .field-header {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-left: 4px solid var(--primary-color);
      padding: 12px 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
      color: #1e293b;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .field-header:hover {
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .field-header:active {
      transform: scale(0.99);
    }

    .field-icon {
      font-size: 20px;
    }

    .field-title {
      flex: 1;
    }

    .field-count {
      font-size: 12px;
      font-weight: 500;
      color: var(--muted);
      background: white;
      padding: 4px 10px;
      border-radius: 12px;
    }

    /* ä¸åŒå­—æ®µçš„é¢œè‰² */
    .field-header[data-field="æ‘˜å½•"] { border-left-color: #3b82f6; }
    .field-header[data-field="è¯æ˜"] { border-left-color: #8b5cf6; }
    .field-header[data-field="æ‰€å±"] { border-left-color: #10b981; }
    .field-header[data-field="ç›¸å…³æ€è€ƒ"] { border-left-color: #f59e0b; }
    .field-header[data-field="åº”ç”¨"] { border-left-color: #ec4899; }
    .field-header[data-field="é»˜è®¤"] { border-left-color: #64748b; }

    .field-comments {
      padding-left: 20px;
    }

    /* ========== ç›®æ ‡é€‰æ‹©å™¨æ¨¡æ€æ¡† ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.show {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }

    .target-option {
      padding: 14px 16px;
      border-radius: 10px;
      border: 2px solid var(--border-color);
      margin-bottom: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
      background: var(--card-bg);
    }

    .target-option:hover {
      border-color: var(--primary-color);
      background: #f8fafc;
    }

    .target-option.selected {
      border-color: var(--primary-color);
      background: linear-gradient(to right, #eef2ff, #f8fafc);
    }

    .target-radio {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--primary-color);
    }

    .target-icon {
      font-size: 20px;
    }

    .target-label {
      font-size: 15px;
      font-weight: 500;
      color: #334155;
    }

    .position-selector {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .position-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .position-options {
      display: flex;
      gap: 12px;
    }

    .position-btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      background: var(--card-bg);
      color: #475569;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .position-btn:hover {
      border-color: var(--primary-color);
      background: #f8fafc;
    }

    .position-btn.active {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .modal-btn.cancel {
      background: #f1f5f9;
      color: #64748b;
    }

    .modal-btn.cancel:hover {
      background: #e2e8f0;
    }

    .modal-btn.confirm {
      background: var(--primary-color);
      color: white;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .modal-btn.confirm:hover {
      background: #4f46e5;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .modal-btn.confirm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ========== Toast æç¤º ========== */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.95);
      color: white;
      padding: 12px 24px;
      border-radius: 999px;
      font-size: 14px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 2000;
    }

    .toast.show {
      opacity: 1;
    }

    /* ========== å“åº”å¼ ========== */
    @media (max-width: 640px) {
      .topbar {
        padding: 12px 16px;
      }

      .topbar-title {
        font-size: 16px;
      }

      .note-title {
        display: none;
      }

      .statusbar {
        padding: 10px 16px;
        font-size: 13px;
      }

      .quick-actions {
        padding: 10px 16px;
        flex-wrap: wrap;
      }

      .comments-section {
        padding: 12px;
      }

      .footer {
        padding: 12px 16px;
      }

      .main-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å·¦ä¾§å·¥å…·æ  -->
    <div class="sidebar">
      <!-- é€‰æ‹©æ–¹å¼åˆ†ç»„ -->
      <div class="tool-group">
        <div class="tool-group-title">é€‰æ‹©æ–¹å¼</div>
        <button class="tool-btn active" id="manualSelectBtn" title="ç‚¹å‡»è¯„è®ºå¡ç‰‡è¿›è¡Œå•é€‰æˆ–å¤šé€‰">
          ğŸ“ æ‰‹åŠ¨ç‚¹é€‰
        </button>
        <button class="tool-btn" id="rangeSelectBtn" title="ç‚¹å‡»èµ·å§‹å’Œç»“æŸè¯„è®ºï¼Œä¸­é—´è‡ªåŠ¨å…¨é€‰">
          ğŸ“ èŒƒå›´é€‰æ‹©
        </button>
        <button class="tool-btn" id="autoNewBtn" title="è‡ªåŠ¨é€‰æ‹©æœ€è¿‘æ·»åŠ çš„è¯„è®º">
          ğŸ†• è‡ªåŠ¨æ–°å†…å®¹
        </button>
        <button class="tool-btn" id="last1Btn" title="å¿«é€Ÿé€‰æ‹©æœ€åä¸€æ¡è¯„è®º">
          ğŸ”š æœ€å1æ¡
        </button>
        <button class="tool-btn" id="last2Btn" title="å¿«é€Ÿé€‰æ‹©æœ€åä¸¤æ¡è¯„è®º">
          ğŸ”š æœ€å2æ¡
        </button>
      </div>

      <!-- å¿«æ·æ“ä½œåˆ†ç»„ -->
      <div class="tool-group">
        <div class="tool-group-title">å¿«æ·æ“ä½œ</div>
        <button class="tool-btn" id="selectAllBtn" title="é€‰æ‹©æ‰€æœ‰è¯„è®º">
          ğŸ“ å…¨é€‰
        </button>
        <button class="tool-btn" id="invertBtn" title="åå‘é€‰æ‹©">
          ğŸ”„ åé€‰
        </button>
        <button class="tool-btn" id="clearBtn" title="æ¸…ç©ºæ‰€æœ‰é€‰æ‹©">
          âŒ æ¸…ç©º
        </button>
      </div>
    </div>

    <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <!-- é¡¶éƒ¨æ  -->
      <div class="topbar">
      <div class="topbar-title">
        <span class="topbar-icon">ğŸ’¬</span>
        <div>
          <div>è¯„è®ºç®¡ç†å™¨</div>
          <div class="note-title" id="noteTitle">åŠ è½½ä¸­...</div>
        </div>
      </div>
      <button class="close-btn" id="closeBtn" title="å…³é—­">âœ•</button>
    </div>

      <!-- çŠ¶æ€æ  -->
      <div class="statusbar">
        <div class="status-info">
          <div class="status-item">
            ğŸ“Š å½“å‰å¡ç‰‡ï¼š<span class="status-value" id="totalCount">0</span> æ¡è¯„è®º
          </div>
          <div class="status-item">
            âœ… å·²é€‰æ‹©ï¼š<span class="status-value" id="selectedCount">0</span> æ¡
          </div>
        </div>
      </div>

      <!-- èŒƒå›´é€‰æ‹©æç¤º -->
      <div class="range-select-hint" id="rangeSelectHint">
        <div class="range-hint-text">
          <span class="range-hint-icon">ğŸ“</span>
          <span id="rangeHintText">è¯·ç‚¹å‡»èµ·å§‹è¯„è®º</span>
        </div>
        <div class="range-hint-buttons">
          <button class="hint-btn confirm" id="rangeConfirmBtn">âœ“ å®Œæˆ</button>
          <button class="hint-btn cancel" id="rangeCancelBtn">âœ— å–æ¶ˆ</button>
        </div>
      </div>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div class="comments-section">
      <div class="comments-list" id="commentsList">
        <!-- è¯„è®ºå¡ç‰‡å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
        <div class="empty-state">
          <div class="empty-icon">ğŸ’¬</div>
          <div>æš‚æ— è¯„è®ºæ•°æ®</div>
        </div>
      </div>
    </div>

      <!-- åº•éƒ¨æ“ä½œåŒº -->
      <div class="footer">
        <div class="main-actions">
          <button class="main-action-btn move" id="moveBtn" disabled>
            â¡ï¸ ç§»åŠ¨
          </button>
          <button class="main-action-btn extract" id="extractBtn" disabled>
            ğŸ“¤ æå–
          </button>
          <button class="main-action-btn delete" id="deleteBtn" disabled>
            ğŸ—‘ï¸ åˆ é™¤
          </button>
        </div>
      </div>
    </div> <!-- å…³é—­ .main-content -->
  </div> <!-- å…³é—­ .container -->

  <!-- ç›®æ ‡é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="targetModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">é€‰æ‹©ç›®æ ‡ä½ç½®</div>
      </div>
      <div class="modal-body" id="targetOptions">
        <!-- ç›®æ ‡é€‰é¡¹å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" id="modalCancelBtn">å–æ¶ˆ</button>
        <button class="modal-btn confirm" id="modalConfirmBtn" disabled>ç¡®è®¤</button>
      </div>
    </div>
  </div>

  <!-- Toast æç¤º -->
  <div class="toast" id="toast"></div>

  <script>
    // å‘é€ URL Scheme
    function sendURLToNative(action, params = {}) {
      const url = generateUrlScheme('mnknowledgebase', action, params);
      window.location.href = url;
    }

    // ç®€å•æ—¥å¿—å‡½æ•°ï¼Œç›´æ¥è°ƒç”¨ htmlLogï¼Œä¿è¯åœ¨ MN ç¯å¢ƒå¯è§
    function logToNativeDirect(message) {
      try {
        sendURLToNative('htmlLog', { message });
      } catch (error) {
        // å¿½ç•¥æ—¥å¿—å‘é€å¤±è´¥
      }
    }

    function debugLog(message) {
      logToNativeDirect(message);
    }

    // å®‰å…¨ HUDï¼ˆMN ç¯å¢ƒå¯ç”¨ï¼Œå¦åˆ™é™çº§ä¸º toastï¼‰
    function safeHUD(message, duration = 1.5) {
      try {
        if (window.MNUtil && typeof MNUtil.showHUD === 'function') {
          MNUtil.showHUD(message, duration);
          return;
        }
      } catch (err) {
        // ignore
      }
      showToast(message, duration * 1000);
    }

    // ========================================
    // å…¨å±€çŠ¶æ€ç®¡ç†
    // ========================================
    const state = {
      noteId: null,
      noteTitle: '',
      comments: [],
      fields: [],
      selectedIndices: new Set(),

      // é€‰æ‹©æ¨¡å¼: 'manual' | 'range' | 'auto' | 'quick'
      selectionMode: 'manual',
      rangeSelectStart: null,   // èŒƒå›´é€‰æ‹©çš„èµ·å§‹ç´¢å¼•

      // ç§»åŠ¨æ¨¡å¼
      moveMode: false,          // æ˜¯å¦å¤„äºç§»åŠ¨æ¨¡å¼

      // å·²åºŸå¼ƒï¼ˆæ”¹ç”¨å¯è§†åŒ–æ’å…¥ç‚¹ï¼‰
      targetField: null,
      toBottom: true
    };

    // ========================================
    // DOM å…ƒç´ å¼•ç”¨
    // ========================================
    const dom = {
      noteTitle: document.getElementById('noteTitle'),
      totalCount: document.getElementById('totalCount'),
      selectedCount: document.getElementById('selectedCount'),
      commentsList: document.getElementById('commentsList'),

      // é€‰æ‹©å·¥å…·æ 
      manualSelectBtn: document.getElementById('manualSelectBtn'),
      rangeSelectBtn: document.getElementById('rangeSelectBtn'),
      autoNewBtn: document.getElementById('autoNewBtn'),
      last1Btn: document.getElementById('last1Btn'),
      last2Btn: document.getElementById('last2Btn'),

      // èŒƒå›´é€‰æ‹©æç¤º
      rangeSelectHint: document.getElementById('rangeSelectHint'),
      rangeHintText: document.getElementById('rangeHintText'),
      rangeConfirmBtn: document.getElementById('rangeConfirmBtn'),
      rangeCancelBtn: document.getElementById('rangeCancelBtn'),

      // å¿«æ·æ“ä½œï¼ˆä¿ç•™ç”¨äºæ‰‹åŠ¨æ¨¡å¼ï¼‰
      selectAllBtn: document.getElementById('selectAllBtn'),
      invertBtn: document.getElementById('invertBtn'),
      clearBtn: document.getElementById('clearBtn'),

      // ä¸»è¦æ“ä½œ
      moveBtn: document.getElementById('moveBtn'),
      extractBtn: document.getElementById('extractBtn'),
      deleteBtn: document.getElementById('deleteBtn'),

      closeBtn: document.getElementById('closeBtn'),
      targetModal: document.getElementById('targetModal'),
      targetOptions: document.getElementById('targetOptions'),
      modalCancelBtn: document.getElementById('modalCancelBtn'),
      modalConfirmBtn: document.getElementById('modalConfirmBtn'),
      toast: document.getElementById('toast')
    };

    // ========================================
    // åˆå§‹åŒ–
    // ========================================
    function init() {
      // åŠ è½½æµ‹è¯•æ•°æ®ï¼ˆåç»­æ›¿æ¢ä¸ºä» MN è¯»å–ï¼‰
      loadTestData();

      // ç»‘å®šäº‹ä»¶
      attachEventListeners();

      // æ¸²æŸ“ç•Œé¢
      renderComments();
      updateUI();

      // å…¨å±€é”™è¯¯ä¸ŠæŠ¥ï¼Œæ–¹ä¾¿å®šä½æ— å“åº”é—®é¢˜
      window.onerror = function(message, source, lineno, colno, error) {
        const stack = error && error.stack ? `\nstack: ${error.stack}` : '';
        const errMsg = `[HTML Error] ${message} @ ${source}:${lineno}:${colno}${stack}`;
        console.error(errMsg, error);
        debugLog(errMsg);
        return false; // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
      };

      // Promise æœªæ•è·é”™è¯¯
      window.addEventListener('unhandledrejection', function(event) {
        const reason = event.reason || {};
        const stack = reason && reason.stack ? `\nstack: ${reason.stack}` : '';
        const errMsg = `[HTML UnhandledRejection] ${reason.message || reason} ${stack}`;
        debugLog(errMsg);
      });
    }

    // ========================================
    // äº‹ä»¶ç›‘å¬
    // ========================================
    function attachEventListeners() {
      // é€‰æ‹©å·¥å…·æ 
      dom.manualSelectBtn.addEventListener('click', () => setSelectionMode('manual'));
      dom.rangeSelectBtn.addEventListener('click', () => setSelectionMode('range'));
      dom.autoNewBtn.addEventListener('click', selectAutoNewContent);
      dom.last1Btn.addEventListener('click', () => selectLastN(1));
      dom.last2Btn.addEventListener('click', () => selectLastN(2));

      // èŒƒå›´é€‰æ‹©ç¡®è®¤/å–æ¶ˆ
      dom.rangeConfirmBtn.addEventListener('click', confirmRangeSelect);
      dom.rangeCancelBtn.addEventListener('click', cancelRangeSelect);

      // å¿«æ·æ“ä½œï¼ˆä»…åœ¨æ‰‹åŠ¨æ¨¡å¼ä¸‹æœ‰æ•ˆï¼‰
      dom.selectAllBtn.addEventListener('click', selectAll);
      dom.invertBtn.addEventListener('click', invertSelection);
      dom.clearBtn.addEventListener('click', clearSelection);

      // ä¸»è¦æ“ä½œ
      dom.moveBtn.addEventListener('click', () => handleAction('move'));
      dom.extractBtn.addEventListener('click', () => handleAction('extract'));
      dom.deleteBtn.addEventListener('click', () => handleAction('delete'));

      // å…³é—­æŒ‰é’®
      dom.closeBtn.addEventListener('click', closeWindow);

      // æ¨¡æ€æ¡†ï¼ˆç§»åŠ¨åŠŸèƒ½å·²é‡æ„ï¼Œè¿™ä¸ªå¯èƒ½ä¸å†éœ€è¦ï¼‰
      dom.modalCancelBtn.addEventListener('click', closeModal);
      dom.modalConfirmBtn.addEventListener('click', confirmAction);
      dom.targetModal.addEventListener('click', (e) => {
        if (e.target === dom.targetModal) closeModal();
      });
    }

    // ========================================
    // æ•°æ®åŠ è½½ï¼ˆæµ‹è¯•ç”¨ï¼‰
    // ========================================
    function loadTestData() {
      // æµ‹è¯•æ•°æ®ï¼ˆä»…åŒ…å«æ–‡æœ¬ã€é“¾æ¥ã€HTML è¯„è®ºï¼‰
      // å›¾ç‰‡å’Œæ‰‹å†™è¯„è®ºéœ€è¦é€šè¿‡ Native ä¼ å…¥ï¼Œä½¿ç”¨ loadDataFromNative() åŠ è½½
      state.noteId = 'test-note-id';
      state.noteTitle = 'æµ‹è¯•å¡ç‰‡ï¼šç¾¤åŒæ€åŸºæœ¬å®šç†';
      state.comments = [
        {
          index: 0,
          type: 'textComment',
          text: 'è¿™æ˜¯ç¬¬ä¸€æ¡æ–‡æœ¬è¯„è®ºï¼Œç”¨äºæµ‹è¯•è¯„è®ºç®¡ç†å™¨çš„åŸºæœ¬åŠŸèƒ½ã€‚è¿™æ¡è¯„è®ºåŒ…å«äº†è¶³å¤Ÿé•¿çš„æ–‡æœ¬æ¥æµ‹è¯•é¢„è§ˆå’Œå±•å¼€åŠŸèƒ½ã€‚'
        },
        {
          index: 1,
          type: 'linkComment',
          text: 'marginnote4app://note/38ACB470-803E-4EE8-B7DD-1BF4722AB0FE',
          linkedNoteTitle: 'å®šä¹‰ï¼šç¾¤åŒæ€'
        },
        {
          index: 2,
          type: 'HtmlComment',
          text: '<h3>è¯æ˜</h3><p>è¿™æ˜¯ä¸€ä¸ª HTML æ ¼å¼çš„è¯„è®º</p>',
          htmlText: '<h3>è¯æ˜</h3><p>è¿™æ˜¯ä¸€ä¸ª HTML æ ¼å¼çš„è¯„è®º</p>'
        },
        {
          index: 3,
          type: 'textComment',
          text: 'çŸ­è¯„è®º'
        }
      ];

      state.fields = [
        { name: 'è¯æ˜', startIndex: 2, endIndex: 2 },
        { name: 'æ‰€å±', startIndex: 3, endIndex: 3 }
      ];
    }

    // ========================================
    // Native æ•°æ®åŠ è½½æ¥å£
    // ========================================

    /**
     * ä» Native ç«¯åŠ è½½çœŸå®çš„è¯„è®ºæ•°æ®
     *
     * @param {Object} data - Native ç«¯ä¼ å…¥çš„æ•°æ®å¯¹è±¡
     * @param {string} data.noteId - å¡ç‰‡ ID
     * @param {string} data.noteTitle - å¡ç‰‡æ ‡é¢˜
     * @param {Array} data.comments - è¯„è®ºæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ï¼š
     *   - {number} index - è¯„è®ºç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰
     *   - {string} originalType - åŸå§‹è¯„è®ºç±»å‹ï¼ˆ5ç§åŸºç¡€ç±»å‹ï¼‰ï¼š
     *       * "TextNote" - æ–‡æœ¬è¯„è®º
     *       * "HtmlNote" - HTML è¯„è®º
     *       * "LinkNote" - åˆå¹¶æ‘˜å½•/é“¾æ¥è¯„è®º
     *       * "PaintNote" - ç»˜å›¾è¯„è®ºï¼ˆåŒ…æ‹¬å›¾ç‰‡å’Œæ‰‹å†™ï¼‰
     *       * "AudioNote" - éŸ³é¢‘è¯„è®º
     *   - {string} [text] - è¯„è®ºæ–‡æœ¬å†…å®¹ï¼ˆTextNote, HtmlNote, LinkNote æ—¶æœ‰æ•ˆï¼‰
     *   - {string} [htmlText] - HTML æ ¼å¼æ–‡æœ¬ï¼ˆHtmlNote æ—¶æœ‰æ•ˆï¼‰
     *   - {string} [imageBase64] - å›¾ç‰‡ Base64 æ•°æ®ï¼ˆPaintNote æ—¶æœ‰æ•ˆï¼‰
     *       æ ¼å¼ï¼šçº¯ Base64 å­—ç¬¦ä¸²ï¼ˆä¸å« data:image/jpeg;base64, å‰ç¼€ï¼‰
     *       Native ç«¯ä½¿ç”¨ï¼šMNUtil.getMediaByHash(comment.paint).base64Encoding()
     *   - {string} [linkedNoteTitle] - é“¾æ¥ç›®æ ‡å¡ç‰‡æ ‡é¢˜ï¼ˆLinkNote æ—¶æœ‰æ•ˆï¼‰
     *
     * @example
     * // Native ç«¯æ•°æ®å‡†å¤‡ç¤ºä¾‹ï¼ˆmain.jsï¼‰
     * function prepareCommentData(note) {
     *   const comments = note.comments.map((comment, index) => {
     *     const data = { index, originalType: comment.type };
     *
     *     if (comment.type === "TextNote" || comment.type === "HtmlNote") {
     *       data.text = comment.text;
     *       if (comment.type === "HtmlNote") data.htmlText = comment.text;
     *     } else if (comment.type === "PaintNote" && comment.paint) {
     *       const imageData = MNUtil.getMediaByHash(comment.paint);
     *       data.imageBase64 = imageData.base64Encoding();
     *     } else if (comment.type === "LinkNote") {
     *       data.text = comment.text;
     *       const linkedNote = MNNote.new(comment.note);
     *       data.linkedNoteTitle = linkedNote ? linkedNote.noteTitle : "æœªçŸ¥å¡ç‰‡";
     *     }
     *
     *     return data;
     *   });
     *
     *   return {
     *     noteId: note.noteId,
     *     noteTitle: note.noteTitle,
     *     comments: comments
     *   };
     * }
     */
    function loadDataFromNative(data) {
      if (!data || !data.comments) {
        safeHUD("æ•°æ®æ ¼å¼é”™è¯¯");
        return;
      }

      // è®¾ç½®åŸºæœ¬ä¿¡æ¯
      state.noteId = data.noteId;
      state.noteTitle = data.noteTitle;

      // è½¬æ¢è¯„è®ºæ•°æ®ï¼šåŸå§‹ç±»å‹ â†’ ç»†åˆ†ç±»å‹
      state.comments = data.comments.map(comment => {
        const converted = {
          index: comment.index,
          type: detectDetailedType(comment),  // è½¬æ¢ä¸ºç»†åˆ†ç±»å‹
          text: comment.text || null
        };

        // æ ¹æ®ç±»å‹æ·»åŠ é¢å¤–å­—æ®µ
        if (comment.htmlText) {
          converted.htmlText = comment.htmlText;
        }

        if (comment.imageBase64) {
          // æ·»åŠ  data URI å‰ç¼€
          converted.imageBase64 = `data:image/jpeg;base64,${comment.imageBase64}`;
        }

        if (comment.linkedNoteTitle) {
          converted.linkedNoteTitle = comment.linkedNoteTitle;
        }

        return converted;
      });

      // æ¸…ç©ºé€‰æ‹©çŠ¶æ€
      state.selectedIndices.clear();

      // æ¸²æŸ“ç•Œé¢
      renderComments();
      updateUI();

      safeHUD(`å·²åŠ è½½ ${state.comments.length} æ¡è¯„è®º`);
    }

    /**
     * å°†åŸå§‹è¯„è®ºç±»å‹è½¬æ¢ä¸ºç»†åˆ†ç±»å‹
     * å‚è€ƒ mnsnipaste çš„å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
     *
     * @param {Object} comment - åŒ…å« originalType çš„è¯„è®ºå¯¹è±¡
     * @returns {string} ç»†åˆ†åçš„è¯„è®ºç±»å‹
     */
    function detectDetailedType(comment) {
      const originalType = comment.originalType;

      switch (originalType) {
        case "TextNote":
          // ç©ºæ–‡æœ¬
          if (!comment.text || comment.text.trim() === "") {
            return "blankTextComment";
          }

          // ç‰¹æ®Šï¼šé“¾æ¥åˆ°å…¶ä»–ç¬”è®°
          if (/^marginnote\dapp:\/\//.test(comment.text)) {
            return "linkToNote";
          }

          // æ™®é€šæ–‡æœ¬
          return "textComment";

        case "PaintNote":
          // å›¾ç‰‡è¯„è®ºï¼ˆåŒ…æ‹¬æ‰‹å†™ï¼Œç»Ÿä¸€å¤„ç†ï¼‰
          return comment.imageBase64 ? "imageComment" : "blankImageComment";

        case "HtmlNote":
          return "HtmlComment";

        case "LinkNote":
          // åˆå¹¶è¯„è®ºï¼šä¼˜å…ˆåˆ¤æ–­æ˜¯å¦æœ‰å›¾ç‰‡
          if (comment.imageBase64) {
            return "mergedImageComment";
          }
          // çº¯é“¾æ¥è¯„è®ºï¼ˆæ²¡æœ‰å›¾ç‰‡ä¹Ÿæ²¡æœ‰æ–‡æœ¬ï¼‰
          return "linkComment";

        case "AudioNote":
          return "audioComment";

        default:
          return "textComment";
      }
    }

    // ========================================
    // å­—æ®µè¯†åˆ«åŠŸèƒ½
    // ========================================
    /**
     * è§£æå¡ç‰‡è¯„è®ºï¼Œè¯†åˆ«å­—æ®µç»“æ„
     * å‚è€ƒ utils.js çš„ parseNoteComments() å‡½æ•°å®ç°
     *
     * @returns {Array} å­—æ®µæ•°ç»„ï¼Œæ¯ä¸ªå­—æ®µåŒ…å«ï¼š
     *   - name: å­—æ®µåç§°
     *   - index: å­—æ®µæ ‡é¢˜çš„è¯„è®ºç´¢å¼•
     *   - startIndex: å­—æ®µå†…å®¹èµ·å§‹ç´¢å¼•ï¼ˆä¸åŒ…å«å­—æ®µæ ‡é¢˜ï¼‰
     *   - endIndex: å­—æ®µå†…å®¹ç»“æŸç´¢å¼•
     *   - comments: å­—æ®µä¸‹çš„è¯„è®ºæ•°ç»„
     */
    function parseFieldsFromComments() {
      const fields = [];
      const htmlCommentIndices = [];

      // ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ‰€æœ‰ HtmlComment çš„ç´¢å¼•å’Œå†…å®¹
      state.comments.forEach((comment, index) => {
        if (comment.type === 'HtmlComment') {
          // ä¼˜å…ˆä½¿ç”¨ htmlTextï¼Œå¹¶å»é™¤ HTML æ ‡ç­¾
          let fieldName = formatHtmlPreview(comment.htmlText || comment.text || '') || 'HTMLå­—æ®µ';

          htmlCommentIndices.push({
            index: index,
            name: fieldName
          });
        }
      });

      // å¦‚æœæ²¡æœ‰å­—æ®µï¼Œæ‰€æœ‰è¯„è®ºå±äº"é»˜è®¤"å­—æ®µ
      if (htmlCommentIndices.length === 0) {
        if (state.comments.length > 0) {
          const defaultField = {
            name: 'é»˜è®¤',
            index: -1,
            startIndex: 0,
            endIndex: state.comments.length - 1,
            comments: state.comments
          };
          defaultField.uid = getFieldUID(defaultField);
          fields.push({
            ...defaultField
          });
        }
        return fields;
      }

      // å¤„ç†ç¬¬ä¸€ä¸ªå­—æ®µä¹‹å‰çš„è¯„è®ºï¼Œå½’å…¥"é»˜è®¤"åˆ†ç»„
      if (htmlCommentIndices[0].index > 0) {
        const headComments = [];
        for (let j = 0; j < htmlCommentIndices[0].index; j++) {
          headComments.push(state.comments[j]);
        }
        const defaultField = {
          name: 'é»˜è®¤',
          index: -1,
          startIndex: 0,
          endIndex: htmlCommentIndices[0].index - 1,
          comments: headComments,
        };
        defaultField.uid = getFieldUID(defaultField);
        fields.push(defaultField);
      }

      // ç¬¬äºŒæ­¥ï¼šè®¡ç®—æ¯ä¸ªå­—æ®µçš„èŒƒå›´
      for (let i = 0; i < htmlCommentIndices.length; i++) {
        const currentField = htmlCommentIndices[i];
        const fieldComments = [];
        let startIndex, endIndex;

        if (i === htmlCommentIndices.length - 1) {
          // æœ€åä¸€ä¸ªå­—æ®µï¼šä»å½“å‰å­—æ®µçš„ä¸‹ä¸€æ¡åˆ°è¯„è®ºæœ«å°¾
          startIndex = currentField.index + 1;
          endIndex = state.comments.length - 1;
        } else {
          // ä¸­é—´å­—æ®µï¼šä»å½“å‰å­—æ®µçš„ä¸‹ä¸€æ¡åˆ°ä¸‹ä¸€ä¸ªå­—æ®µä¹‹å‰
          const nextField = htmlCommentIndices[i + 1];
          startIndex = currentField.index + 1;
          endIndex = nextField.index - 1;
        }

        // æ”¶é›†å­—æ®µå†…çš„è¯„è®º
        for (let j = startIndex; j <= endIndex; j++) {
          if (j >= 0 && j < state.comments.length) {
            fieldComments.push(state.comments[j]);
          }
        }

        // æ·»åŠ å­—æ®µï¼ˆå³ä½¿æ²¡æœ‰å†…å®¹ä¹Ÿè¦æ·»åŠ ï¼Œç”¨æˆ·éœ€è¦ç§»åŠ¨è¯„è®ºåˆ°ç©ºå­—æ®µï¼‰
        const field = {
          name: currentField.name,
          index: currentField.index,
          startIndex: startIndex,
          endIndex: endIndex,
          comments: fieldComments
        };
        field.uid = getFieldUID(field);
        fields.push(field);
      }

      return fields;
    }

    function getFieldUID(field) {
      // ä½¿ç”¨å­—æ®µæ ‡é¢˜ç´¢å¼•ä½œä¸ºç¨³å®šæ ‡è¯†ï¼Œé»˜è®¤åŒºç”¨ fixed id
      if (typeof field.index === 'number' && field.index >= 0) {
        return `field-${field.index}`;
      }
      return 'field-default';
    }

    function getFieldNameByIndex(index) {
      const fields = parseFieldsFromComments();
      for (let field of fields) {
        if (index >= field.startIndex && index <= field.endIndex) {
          return field.name;
        }
      }
      return 'æœªçŸ¥å­—æ®µ';
    }

    // ========================================
    // æ¸²æŸ“è¯„è®ºåˆ—è¡¨ï¼ˆæŒ‰å­—æ®µåˆ†ç»„ï¼‰
    // ========================================
    function renderComments() {
      if (state.comments.length === 0) {
        dom.commentsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ’¬</div>
            <div>æš‚æ— è¯„è®ºæ•°æ®</div>
          </div>
        `;
        return;
      }

      const fragment = document.createDocumentFragment();
      const fields = parseFieldsFromComments();

      // æŒ‰å­—æ®µåˆ†ç»„æ¸²æŸ“
      fields.forEach(field => {
        // åˆ›å»ºå­—æ®µåˆ†ç»„å®¹å™¨
        const fieldGroup = document.createElement('div');
        fieldGroup.className = 'field-group';
        fieldGroup.dataset.field = field.name;  // å…¼å®¹æ—§æ ·å¼
        fieldGroup.dataset.fieldId = getFieldUID(field);  // ç¨³å®š IDï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜

        // åˆ›å»ºå­—æ®µæ ‡é¢˜
        const fieldHeader = document.createElement('div');
        fieldHeader.className = 'field-header';
        fieldHeader.dataset.field = field.name;
        fieldHeader.dataset.fieldId = getFieldUID(field);

        const fieldIconMap = {
          'æ‘˜å½•': 'ğŸ“',
          'è¯æ˜': 'ğŸ”',
          'æ‰€å±': 'ğŸ“¦',
          'ç›¸å…³æ€è€ƒ': 'ğŸ’­',
          'åº”ç”¨': 'ğŸ¯',
          'é»˜è®¤': 'ğŸ“„'
        };

        fieldHeader.innerHTML = `
          <span class="field-icon">${fieldIconMap[field.name] || 'ğŸ“„'}</span>
          <span class="field-title">${field.name}</span>
          <span class="field-count">${field.comments.length} æ¡</span>
        `;
        fieldHeader.title = 'ç‚¹å‡»å…¨é€‰è¯¥å­—æ®µä¸‹çš„è¯„è®º';

        // ç‚¹å‡»å­—æ®µå¤´éƒ¨ï¼Œå…¨é€‰è¯¥å­—æ®µä¸‹çš„æ‰€æœ‰è¯„è®º
        fieldHeader.addEventListener('click', () => {
          selectFieldComments(field);
        });

        fieldGroup.appendChild(fieldHeader);

        // åˆ›å»ºå­—æ®µå†…è¯„è®ºå®¹å™¨
        const fieldComments = document.createElement('div');
        fieldComments.className = 'field-comments';
        fieldComments.dataset.fieldId = getFieldUID(field);

        // æ¸²æŸ“è¯¥å­—æ®µçš„æ‰€æœ‰è¯„è®º
        field.comments.forEach(comment => {
          const card = createCommentCard(comment);
          fieldComments.appendChild(card);
        });

        fieldGroup.appendChild(fieldComments);
        fragment.appendChild(fieldGroup);
      });

      dom.commentsList.innerHTML = '';
      dom.commentsList.appendChild(fragment);
    }

    // ========================================
    // åˆ›å»ºè¯„è®ºå¡ç‰‡
    // ========================================
    function createCommentCard(comment) {
      const card = document.createElement('div');
      card.className = 'comment-card';
      card.dataset.index = comment.index;
      card.dataset.type = comment.type;

      // æ ¹æ®ç±»å‹ç”Ÿæˆå†…å®¹
      let contentHTML = '';
      switch (comment.type) {
        case 'textComment':
          contentHTML = createTextCardContent(comment);
          break;
        case 'imageComment':
          contentHTML = createImageCardContent(comment);
          break;
        case 'linkComment':
        case 'linkToNote':  // æ–°å¢ï¼šé“¾æ¥åˆ°å…¶ä»–ç¬”è®°
          contentHTML = createLinkCardContent(comment);
          break;
        case 'mergedImageComment':  // æ–°å¢ï¼šåˆå¹¶è¯„è®º
          contentHTML = createMergedCardContent(comment);
          break;
        case 'drawingComment':
          contentHTML = createDrawingCardContent(comment);
          break;
        case 'HtmlComment':
          contentHTML = createHtmlCardContent(comment);
          break;
        case 'audioComment':  // æ–°å¢ï¼šéŸ³é¢‘è¯„è®º
          contentHTML = createAudioCardContent(comment);
          break;
        default:
          contentHTML = createTextCardContent(comment);
      }

      card.innerHTML = contentHTML;

      // ç»‘å®šäº‹ä»¶
      const checkbox = card.querySelector('.comment-checkbox');

      // å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨æ‰‹åŠ¨æ¨¡å¼ä¸‹ï¼‰
      checkbox.addEventListener('change', (e) => {
        if (state.selectionMode === 'manual') {
          toggleSelection(comment.index);
        } else {
          e.preventDefault();
          checkbox.checked = state.selectedIndices.has(comment.index);
        }
      });

      // å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆæ ¹æ®æ¨¡å¼å†³å®šè¡Œä¸ºï¼‰
      card.addEventListener('click', (e) => {
        if (e.target !== checkbox) {
          if (state.selectionMode === 'range') {
            // èŒƒå›´é€‰æ‹©æ¨¡å¼
            handleRangeSelect(comment.index);
          } else if (state.selectionMode === 'manual') {
            // æ‰‹åŠ¨æ¨¡å¼
            checkbox.checked = !checkbox.checked;
            toggleSelection(comment.index);
          }
        }
      });

      // å±•å¼€/æ”¶èµ·æŒ‰é’®
      const expandBtn = card.querySelector('.expand-btn');
      if (expandBtn) {
        expandBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const preview = card.querySelector('.comment-preview');
          preview.classList.toggle('collapsed');
          expandBtn.textContent = preview.classList.contains('collapsed') ? 'å±•å¼€' : 'æ”¶èµ·';
        });
      }

      return card;
    }

    // ========================================
    // åˆ›å»ºä¸åŒç±»å‹çš„å¡ç‰‡å†…å®¹
    // ========================================
    function createTextCardContent(comment) {
      const typeInfo = getTypeInfo('textComment');
      const text = comment.text || '';
      const needExpand = text.length > 100;

      return `
        <div class="comment-header">
          <input type="checkbox" class="comment-checkbox">
          <span class="comment-icon">${typeInfo.icon}</span>
          <span class="comment-index">${comment.index}</span>
          <span class="comment-type-label">${typeInfo.label}</span>
        </div>
        <div class="comment-content">
          <div class="comment-preview ${needExpand ? 'collapsed' : ''}">
            ${escapeHtml(text)}
          </div>
          ${needExpand ? '<button class="expand-btn">å±•å¼€</button>' : ''}
        </div>
      `;
    }

    function createImageCardContent(comment) {
      const typeInfo = getTypeInfo('imageComment');

      // æ·»åŠ  data URI å‰ç¼€ï¼ˆå‚è€ƒ mnsnipaste çš„å®ç°ï¼‰
      const imageSrc = comment.imageBase64
        ? `data:image/jpeg;base64,${comment.imageBase64}`
        : '';

      return `
        <div class="comment-header">
          <input type="checkbox" class="comment-checkbox">
          <span class="comment-icon">${typeInfo.icon}</span>
          <span class="comment-index">${comment.index}</span>
          <span class="comment-type-label">${typeInfo.label}</span>
        </div>
        <div class="comment-content">
          <div class="comment-preview">
            ${imageSrc ? `<img src="${imageSrc}" class="thumbnail" alt="å›¾ç‰‡è¯„è®º" onerror="this.parentElement.innerHTML='å›¾ç‰‡åŠ è½½å¤±è´¥'">` : 'å›¾ç‰‡æ•°æ®ç¼ºå¤±'}
          </div>
        </div>
      `;
    }

    function createLinkCardContent(comment) {
      // å¤„ç†é“¾æ¥åˆ°å…¶ä»–ç¬”è®°çš„ç‰¹æ®Šæƒ…å†µ
      if (comment.type === "linkToNote") {
        return `
          <div class="comment-header">
            <input type="checkbox" class="comment-checkbox">
            <span class="comment-icon">ğŸ”—</span>
            <span class="comment-index">${comment.index}</span>
            <span class="comment-type-label">é“¾æ¥ç¬”è®°</span>
          </div>
          <div class="comment-content">
            <div class="comment-preview">
              <div class="link-target">
                <span class="link-arrow">â†’</span>
                <span>é“¾æ¥åˆ°ï¼š${escapeHtml(comment.linkedNoteTitle || 'æœªçŸ¥å¡ç‰‡')}</span>
              </div>
            </div>
          </div>
        `;
      }

      // æ™®é€šé“¾æ¥è¯„è®ºï¼ˆåˆå¹¶æ‘˜å½•ï¼‰
      const typeInfo = getTypeInfo('linkComment');

      return `
        <div class="comment-header">
          <input type="checkbox" class="comment-checkbox">
          <span class="comment-icon">${typeInfo.icon}</span>
          <span class="comment-index">${comment.index}</span>
          <span class="comment-type-label">${typeInfo.label}</span>
        </div>
        <div class="comment-content">
          <div class="comment-preview">
            <div class="link-target">
              <span class="link-arrow">â†’</span>
              <span>é“¾æ¥åˆ°ï¼š${escapeHtml(comment.linkedNoteTitle || 'æœªçŸ¥å¡ç‰‡')}</span>
            </div>
          </div>
        </div>
      `;
    }

    function createDrawingCardContent(comment) {
      const typeInfo = getTypeInfo('drawingComment');

      // æ·»åŠ  data URI å‰ç¼€
      const imageSrc = comment.imageBase64
        ? `data:image/jpeg;base64,${comment.imageBase64}`
        : '';

      return `
        <div class="comment-header">
          <input type="checkbox" class="comment-checkbox">
          <span class="comment-icon">${typeInfo.icon}</span>
          <span class="comment-index">${comment.index}</span>
          <span class="comment-type-label">${typeInfo.label}</span>
        </div>
        <div class="comment-content">
          <div class="comment-preview">
            ${imageSrc ? `<img src="${imageSrc}" class="thumbnail" alt="æ‰‹å†™å†…å®¹" onerror="this.parentElement.innerHTML='æ‰‹å†™å†…å®¹åŠ è½½å¤±è´¥'">` : 'æ‰‹å†™æ•°æ®ç¼ºå¤±'}
          </div>
        </div>
      `;
    }

    function createHtmlCardContent(comment) {
      const typeInfo = getTypeInfo('HtmlComment');
      const text = formatHtmlPreview(comment.htmlText || comment.text || '');
      const needExpand = text.length > 100;

      return `
        <div class="comment-header">
          <input type="checkbox" class="comment-checkbox">
          <span class="comment-icon">${typeInfo.icon}</span>
          <span class="comment-index">${comment.index}</span>
          <span class="comment-type-label">${typeInfo.label}</span>
        </div>
        <div class="comment-content">
          <div class="comment-preview ${needExpand ? 'collapsed' : ''}">
            ${escapeHtml(text)}
          </div>
          ${needExpand ? '<button class="expand-btn">å±•å¼€</button>' : ''}
        </div>
      `;
    }

    function createMergedCardContent(comment) {
      const typeInfo = getTypeInfo('mergedImageComment');

      // ä¼˜å…ˆæ˜¾ç¤ºå›¾ç‰‡ï¼Œå›¾ç‰‡ä¸‹æ–¹å¯é€‰æ˜¾ç¤º OCR æ–‡æœ¬ä½œä¸ºè¾…åŠ©ä¿¡æ¯
      let content = '';

      if (comment.imageBase64) {
        // imageBase64 å·²ç»åŒ…å«å®Œæ•´çš„ data URI å‰ç¼€ï¼ˆåœ¨ loadDataFromNative ä¸­æ·»åŠ ï¼‰
        content = `
          <div class="comment-preview merged-image-preview">
            <img src="${comment.imageBase64}" class="thumbnail merged-thumbnail" alt="åˆå¹¶å†…å®¹">
          </div>
        `;

        // å¦‚æœåŒæ—¶æœ‰ OCR æ–‡æœ¬ï¼Œåœ¨å›¾ç‰‡ä¸‹æ–¹æ˜¾ç¤ºä½œä¸ºè¾…åŠ©ä¿¡æ¯
        if (comment.text) {
          const needExpand = comment.text.length > 80;
          content += `
            <div class="ocr-text-section">
              <div class="ocr-text-label">OCR æ–‡æœ¬ï¼š</div>
              <div class="ocr-text-content ${needExpand ? 'collapsed' : ''}">
                ${escapeHtml(comment.text)}
              </div>
              ${needExpand ? '<button class="expand-btn ocr-expand-btn">å±•å¼€</button>' : ''}
            </div>
          `;
        }
      } else if (comment.text) {
        // åªæœ‰æ–‡æœ¬æ²¡æœ‰å›¾ç‰‡çš„æƒ…å†µ
        const needExpand = comment.text.length > 100;
        content = `
          <div class="comment-preview ${needExpand ? 'collapsed' : ''}">
            ${escapeHtml(comment.text)}
          </div>
          ${needExpand ? '<button class="expand-btn">å±•å¼€</button>' : ''}
        `;
      } else {
        content = '<div class="comment-preview">ï¼ˆç©ºå†…å®¹ï¼‰</div>';
      }

      return `
        <div class="comment-header">
          <input type="checkbox" class="comment-checkbox">
          <span class="comment-icon">${typeInfo.icon}</span>
          <span class="comment-type-label">${typeInfo.label}</span>
        </div>
        <div class="comment-content">
          ${content}
        </div>
      `;
    }

    function createAudioCardContent(comment) {
      const typeInfo = getTypeInfo('audioComment');

      return `
        <div class="comment-header">
          <input type="checkbox" class="comment-checkbox">
          <span class="comment-icon">${typeInfo.icon}</span>
          <span class="comment-index">${comment.index}</span>
          <span class="comment-type-label">${typeInfo.label}</span>
        </div>
        <div class="comment-content">
          <div class="comment-preview">
            ${escapeHtml(comment.text || '(éŸ³é¢‘è¯„è®º)')}
          </div>
        </div>
      `;
    }

    // ========================================
    // è¾…åŠ©å‡½æ•°ï¼šè·å–ç±»å‹ä¿¡æ¯
    // ========================================
    function getTypeInfo(type) {
      const typeMap = {
        'textComment': { icon: 'ğŸ“', label: 'æ–‡æœ¬' },
        'imageComment': { icon: 'ğŸ–¼ï¸', label: 'å›¾ç‰‡' },
        'linkComment': { icon: 'ğŸ”—', label: 'åŒå‘é“¾æ¥' },
        'linkToNote': { icon: 'ğŸ”—', label: 'é“¾æ¥ç¬”è®°' },  // æ–°å¢
        'mergedImageComment': { icon: 'ğŸ–¼ï¸', label: 'æ‘˜å½•' },  // æ–°å¢
        'drawingComment': { icon: 'âœï¸', label: 'æ‰‹å†™' },
        'HtmlComment': { icon: 'ğŸ“„', label: 'HTML' },
        'audioComment': { icon: 'ğŸµ', label: 'éŸ³é¢‘' },  // æ–°å¢
        'blankTextComment': { icon: 'â¬œ', label: 'ç©ºæ–‡æœ¬' },  // æ–°å¢
        'blankImageComment': { icon: 'â¬œ', label: 'ç©ºå›¾ç‰‡' }  // æ–°å¢
      };

      return typeMap[type] || { icon: 'ğŸ’¬', label: 'è¯„è®º' };
    }

    // ========================================
    // é€‰æ‹©æ“ä½œ
    // ========================================
    function toggleSelection(index) {
      if (state.selectedIndices.has(index)) {
        state.selectedIndices.delete(index);
      } else {
        state.selectedIndices.add(index);
      }

      updateUI();
    }

    function selectAll() {
      state.selectedIndices.clear();
      state.comments.forEach((c) => state.selectedIndices.add(c.index));
      updateUI();
    }

    // é€‰ä¸­/å–æ¶ˆé€‰ä¸­æŒ‡å®šå­—æ®µä¸‹çš„æ‰€æœ‰è¯„è®ºï¼ˆåˆ‡æ¢æ¨¡å¼ï¼‰
    function selectFieldComments(field) {
      // æ£€æŸ¥è¯¥å­—æ®µä¸‹çš„è¯„è®ºæ˜¯å¦å…¨éƒ¨å·²é€‰ä¸­
      let allSelected = true;
      for (let i = field.startIndex; i <= field.endIndex; i++) {
        if (i >= 0 && i < state.comments.length) {
          if (!state.selectedIndices.has(i)) {
            allSelected = false;
            break;
          }
        }
      }

      if (allSelected) {
        // å¦‚æœå…¨éƒ¨å·²é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­è¯¥å­—æ®µçš„æ‰€æœ‰è¯„è®º
        for (let i = field.startIndex; i <= field.endIndex; i++) {
          if (i >= 0 && i < state.comments.length) {
            state.selectedIndices.delete(i);
          }
        }
      } else {
        // å¦åˆ™ï¼Œé€‰ä¸­è¯¥å­—æ®µçš„æ‰€æœ‰è¯„è®ºï¼ˆä¸æ¸…ç©ºå…¶ä»–å­—æ®µçš„é€‰æ‹©ï¼‰
        for (let i = field.startIndex; i <= field.endIndex; i++) {
          if (i >= 0 && i < state.comments.length) {
            state.selectedIndices.add(i);
          }
        }
      }

      updateUI();
    }

    function invertSelection() {
      const newSet = new Set();
      state.comments.forEach((c) => {
        if (!state.selectedIndices.has(c.index)) {
          newSet.add(c.index);
        }
      });
      state.selectedIndices = newSet;
      updateUI();
    }

    function clearSelection() {
      state.selectedIndices.clear();
      updateUI();
    }

    // ========================================
    // é€‰æ‹©æ¨¡å¼ç®¡ç†
    // ========================================
    function setSelectionMode(mode) {
      // åˆ‡æ¢é€‰æ‹©æ¨¡å¼å‰ï¼Œæ¸…ç†ä¸Šä¸€ä¸ªæ¨¡å¼çš„çŠ¶æ€
      if (state.selectionMode === 'range') {
        cancelRangeSelect();
      }

      state.selectionMode = mode;

      // æ›´æ–°å·¥å…·æ æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));

      switch (mode) {
        case 'manual':
          dom.manualSelectBtn.classList.add('active');
          break;
        case 'range':
          dom.rangeSelectBtn.classList.add('active');
          enterRangeSelectMode();
          break;
      }
    }

    // ========================================
    // èŒƒå›´é€‰æ‹©åŠŸèƒ½
    // ========================================
    function enterRangeSelectMode() {
      // æ¸…ç©ºå½“å‰é€‰æ‹©
      state.selectedIndices.clear();
      state.rangeSelectStart = null;

      // æ˜¾ç¤ºæç¤ºæ¡
      dom.rangeSelectHint.classList.add('show');
      dom.rangeHintText.textContent = 'è¯·ç‚¹å‡»èµ·å§‹è¯„è®º';

      // æ›´æ–°UI
      updateUI();
    }

    function handleRangeSelect(index) {
      if (state.rangeSelectStart === null) {
        // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šè®¾ç½®èµ·å§‹ç‚¹
        state.rangeSelectStart = index;
        dom.rangeHintText.textContent = `å·²é€‰æ‹©èµ·å§‹ #${index}ï¼Œè¯·ç‚¹å‡»ç»“æŸè¯„è®º`;

        // é«˜äº®èµ·å§‹å¡ç‰‡
        updateRangeSelection();
      } else {
        // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šè®¾ç½®ç»“æŸç‚¹å¹¶é€‰ä¸­èŒƒå›´
        const start = Math.min(state.rangeSelectStart, index);
        const end = Math.max(state.rangeSelectStart, index);

        // é€‰ä¸­èŒƒå›´å†…çš„æ‰€æœ‰è¯„è®º
        state.selectedIndices.clear();
        for (let i = start; i <= end; i++) {
          state.selectedIndices.add(i);
        }

        // è‡ªåŠ¨ç¡®è®¤èŒƒå›´é€‰æ‹©ï¼ˆä¸éœ€è¦ç”¨æˆ·å†ç‚¹å‡»ç¡®è®¤æŒ‰é’®ï¼‰
        showToast(`å·²é€‰æ‹© ${state.selectedIndices.size} æ¡è¯„è®ºï¼ˆ#${start} ~ #${end}ï¼‰`);

        // é€€å‡ºèŒƒå›´é€‰æ‹©æ¨¡å¼
        dom.rangeSelectHint.classList.remove('show');
        state.rangeSelectStart = null;

        // æ¸…é™¤èŒƒå›´é€‰æ‹©æ ·å¼
        document.querySelectorAll('.comment-card').forEach(card => {
          card.classList.remove('range-start', 'in-range');
        });

        // åˆ‡å›æ‰‹åŠ¨æ¨¡å¼ï¼ˆä½†ä¿æŒé€‰æ‹©ï¼‰
        state.selectionMode = 'manual';

        // æ›´æ–°å·¥å…·æ æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
        dom.manualSelectBtn.classList.add('active');

        // é‡è¦ï¼šæ›´æ–°UIä»¥æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
        updateUI();
      }
    }

    function updateRangeSelection() {
      // æ¸…é™¤æ‰€æœ‰èŒƒå›´é€‰æ‹©æ ·å¼
      document.querySelectorAll('.comment-card').forEach(card => {
        card.classList.remove('range-start', 'in-range');
      });

      if (state.rangeSelectStart !== null) {
        // æ ‡è®°èµ·å§‹å¡ç‰‡
        const startCard = document.querySelector(`.comment-card[data-index="${state.rangeSelectStart}"]`);
        if (startCard) {
          startCard.classList.add('range-start');
        }

        // å¦‚æœå·²ç»é€‰ä¸­äº†èŒƒå›´ï¼Œæ ‡è®°èŒƒå›´å†…çš„å¡ç‰‡
        if (state.selectedIndices.size > 0) {
          state.selectedIndices.forEach(index => {
            const card = document.querySelector(`.comment-card[data-index="${index}"]`);
            if (card && index !== state.rangeSelectStart) {
              card.classList.add('in-range');
            }
          });
        }
      }

      updateUI();
    }

    function confirmRangeSelect() {
      if (state.selectedIndices.size === 0) {
        showToast('è¯·å…ˆé€‰æ‹©è¯„è®ºèŒƒå›´');
        return;
      }

      // é€€å‡ºèŒƒå›´é€‰æ‹©æ¨¡å¼
      dom.rangeSelectHint.classList.remove('show');
      state.rangeSelectStart = null;

      // æ¸…é™¤èŒƒå›´é€‰æ‹©æ ·å¼
      document.querySelectorAll('.comment-card').forEach(card => {
        card.classList.remove('range-start', 'in-range');
      });

      // åˆ‡å›æ‰‹åŠ¨æ¨¡å¼ï¼ˆä½†ä¿æŒé€‰æ‹©ï¼‰
      setSelectionMode('manual');

      showToast(`å·²é€‰æ‹© ${state.selectedIndices.size} æ¡è¯„è®º`);
    }

    function cancelRangeSelect() {
      // æ¸…ç©ºé€‰æ‹©
      state.selectedIndices.clear();
      state.rangeSelectStart = null;

      // éšè—æç¤ºæ¡
      dom.rangeSelectHint.classList.remove('show');

      // æ¸…é™¤èŒƒå›´é€‰æ‹©æ ·å¼
      document.querySelectorAll('.comment-card').forEach(card => {
        card.classList.remove('range-start', 'in-range');
      });

      // æ›´æ–°UI
      updateUI();
    }

    // ========================================
    // å¿«æ·é€‰æ‹©åŠŸèƒ½
    // ========================================
    function selectLastN(n) {
      const totalComments = state.comments.length;
      if (totalComments === 0) {
        showToast('æ²¡æœ‰è¯„è®ºå¯é€‰æ‹©');
        return;
      }

      // ç»™æŒ‰é’®ä¸€ä¸ªè§†è§‰åé¦ˆ
      const btnId = n === 1 ? 'last1Btn' : 'last2Btn';
      flashButton(btnId);

      state.selectedIndices.clear();

      const startIndex = Math.max(0, totalComments - n);
      for (let i = startIndex; i < totalComments; i++) {
        state.selectedIndices.add(i);
      }

      updateUI();
      showToast(`å·²é€‰æ‹©æœ€å ${n} æ¡è¯„è®º`);
    }

    function selectAutoNewContent() {
      // ç»™æŒ‰é’®ä¸€ä¸ªè§†è§‰åé¦ˆ
      flashButton('autoNewBtn');

      if (!state.noteId) {
        showToast('ç¼ºå°‘å¡ç‰‡ ID');
        return;
      }

      debugLog('[HTML] request auto new content');
      Bridge.requestAutoNewContent(state.noteId);
      showToast('æ­£åœ¨æ£€æµ‹æ–°å†…å®¹...');
    }

    // æŒ‰é’®é—ªçƒæ•ˆæœ
    function flashButton(btnId) {
      const btn = document.getElementById(btnId);
      if (!btn) return;

      btn.classList.add('active');
      setTimeout(() => {
        btn.classList.remove('active');
      }, 300);
    }

    // ========================================
    // æ›´æ–° UI
    // ========================================
    function updateUI() {
      // æ›´æ–°æ ‡é¢˜
      dom.noteTitle.textContent = state.noteTitle;

      // æ›´æ–°è®¡æ•°
      dom.totalCount.textContent = state.comments.length;
      dom.selectedCount.textContent = state.selectedIndices.size;

      // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
      document.querySelectorAll('.comment-card').forEach((card) => {
        const index = parseInt(card.dataset.index);
        const checkbox = card.querySelector('.comment-checkbox');
        checkbox.checked = state.selectedIndices.has(index);

        if (state.selectedIndices.has(index)) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });

      // æ›´æ–°æ“ä½œæŒ‰é’®çŠ¶æ€
      const hasSelection = state.selectedIndices.size > 0;
      dom.moveBtn.disabled = !hasSelection;
      dom.extractBtn.disabled = !hasSelection;
      dom.deleteBtn.disabled = !hasSelection;
    }

    // ========================================
    // æ“ä½œå¤„ç†
    // ========================================
    function handleAction(actionType) {
      const indices = Array.from(state.selectedIndices);

      debugLog(`[HTML] handleAction ${actionType} -> indices=${indices}`);

      if (indices.length === 0) {
        showToast('è¯·å…ˆé€‰æ‹©è¯„è®º');
        return;
      }

      switch (actionType) {
        case 'move':
          enterMoveMode(indices);
          break;
        case 'extract':
          confirmExtract(indices);
          break;
        case 'delete':
          confirmDelete(indices);
          break;
      }
    }

    // ========================================
    // ç§»åŠ¨æ¨¡å¼ï¼ˆå¯è§†åŒ–æ’å…¥ç‚¹ï¼‰
    // ========================================
    function enterMoveMode(indices) {
      state.moveMode = true;

      // å°†é€‰ä¸­çš„è¯„è®ºå¡ç‰‡æ ‡è®°ä¸ºç§»åŠ¨æ¨¡å¼
      document.querySelectorAll('.comment-card').forEach(card => {
        const index = parseInt(card.dataset.index);
        if (indices.includes(index)) {
          card.classList.add('move-mode');
        }
      });

      // æ¸²æŸ“æ’å…¥ç‚¹æŒ‡ç¤ºå™¨
      renderInsertPoints();

      // éšè—ä¸»è¦æ“ä½œæŒ‰é’®ï¼Œæ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
      dom.moveBtn.disabled = true;
      dom.extractBtn.disabled = true;
      dom.deleteBtn.disabled = true;

      showToast('è¯·ç‚¹å‡»è¦ç§»åŠ¨åˆ°çš„ä½ç½®');
    }

    function exitMoveMode() {
      state.moveMode = false;

      // ç§»é™¤æ‰€æœ‰æ’å…¥ç‚¹
      document.querySelectorAll('.insert-point').forEach(point => {
        point.remove();
      });

      // ç§»é™¤ç§»åŠ¨æ¨¡å¼æ ·å¼
      document.querySelectorAll('.comment-card.move-mode').forEach(card => {
        card.classList.remove('move-mode');
      });

      // æ¢å¤æŒ‰é’®çŠ¶æ€
      updateUI();
    }

    function renderInsertPoints() {
      const fields = parseFieldsFromComments();
      const commentsListEl = document.getElementById('commentsList');

      // è®°å½•å­—æ®µæ ‡é¢˜çš„åŸå§‹ HtmlComment ç´¢å¼•ï¼Œæ–¹ä¾¿åœ¨å­—æ®µå‰æ’å…¥
      const htmlCommentIndices = [];
      state.comments.forEach((comment) => {
        if (comment.type === 'HtmlComment') {
          let fieldName = stripHtml(comment.htmlText || comment.text || 'å­—æ®µ');
          htmlCommentIndices.push({ index: comment.index, name: fieldName });
        }
      });
      htmlCommentIndices.sort((a, b) => a.index - b.index);

      // 1) å¡ç‰‡ç½®é¡¶æ’å…¥ç‚¹ï¼ˆæ‰€æœ‰è¯„è®ºä¹‹å‰ï¼‰
      if (commentsListEl) {
        const topPoint = createInsertPoint(0, 'å¡ç‰‡é¡¶éƒ¨', 'ç½®é¡¶');
        topPoint.classList.add('insert-point-global');
        commentsListEl.insertBefore(topPoint, commentsListEl.firstChild);
      }

      // 2) ç¬¬ä¸€ä¸ªå­—æ®µæ ‡é¢˜ä¹‹å‰çš„æ’å…¥ç‚¹
      if (htmlCommentIndices.length > 0 && commentsListEl) {
        const firstFieldHeader = htmlCommentIndices[0];
        const firstFieldGroup = commentsListEl.querySelector('.field-group');
        if (firstFieldGroup) {
          const beforeFieldPoint = createInsertPoint(
            firstFieldHeader.index,
            firstFieldHeader.name || 'å­—æ®µ',
            'å­—æ®µä¸Šæ–¹'
          );
          beforeFieldPoint.classList.add('insert-point-global');
          commentsListEl.insertBefore(beforeFieldPoint, firstFieldGroup);
        }
      }

      fields.forEach(field => {
        const fieldId = getFieldUID(field);
        const fieldGroup = Array.from(document.querySelectorAll('.field-group'))
          .find(group => group.dataset.fieldId === fieldId);
        const fieldCommentsContainer = fieldGroup
          ? fieldGroup.querySelector('.field-comments')
          : null;

        if (!fieldCommentsContainer) return;

        const commentCards = Array.from(fieldCommentsContainer.querySelectorAll('.comment-card'));

        // å¤„ç†ç©ºå­—æ®µï¼šç›´æ¥æ·»åŠ ä¸€ä¸ªæ’å…¥ç‚¹
        if (commentCards.length === 0) {
          const insertPoint = createInsertPoint(field.startIndex, field.name, 'ç©ºå­—æ®µ');
          fieldCommentsContainer.appendChild(insertPoint);
          return;
        }

        // åœ¨æ¯ä¸¤æ¡è¯„è®ºä¹‹é—´æ·»åŠ æ’å…¥ç‚¹
        commentCards.forEach((card, idx) => {
          // åœ¨å¡ç‰‡å‰æ·»åŠ æ’å…¥ç‚¹ï¼ˆç¬¬ä¸€å¼ å¡ç‰‡å‰ï¼‰
          if (idx === 0) {
            const insertPoint = createInsertPoint(field.comments[0].index, field.name, 'å¼€å§‹');
            card.parentNode.insertBefore(insertPoint, card);
          }

          // åœ¨å¡ç‰‡åæ·»åŠ æ’å…¥ç‚¹
          const nextIndex = idx < commentCards.length - 1
            ? field.comments[idx + 1].index
            : field.endIndex + 1;

          const insertPoint = createInsertPoint(nextIndex, field.name, idx === commentCards.length - 1 ? 'ç»“æŸ' : null);
          card.after(insertPoint);
        });
      });
    }

    function createInsertPoint(targetIndex, fieldName, position) {
      const insertPoint = document.createElement('div');
      insertPoint.className = 'insert-point show';
      insertPoint.dataset.targetIndex = targetIndex;

      const positionHint = position ? ` (${position})` : '';
      const fieldHint = fieldName !== 'é»˜è®¤' ? `ã€Œ${fieldName}ã€åŒº${positionHint}` : positionHint;

      insertPoint.innerHTML = `
        <div class="insert-line">â”â”â” ç§»åˆ°è¿™é‡Œ â”â”â”</div>
        <div class="field-hint">${fieldHint}</div>
      `;

      insertPoint.addEventListener('click', () => {
        handleInsertPointClick(targetIndex);
      });

      return insertPoint;
    }

    function handleInsertPointClick(targetIndex) {
      const selectedIndices = Array.from(state.selectedIndices).sort((a, b) => a - b);

      // æ‰§è¡Œç§»åŠ¨æ“ä½œï¼ˆè°ƒç”¨ Native Bridgeï¼‰
      if (!state.noteId) {
        showToast('é”™è¯¯ï¼šç¼ºå°‘å¡ç‰‡ ID');
        return;
      }

      // è°ƒç”¨ Bridge æ–¹æ³•ç§»åŠ¨è¯„è®ºåˆ°æŒ‡å®šç´¢å¼•
      Bridge.logToNative && Bridge.logToNative(`[HTML] moveComments -> ${selectedIndices} -> ${targetIndex}`);
      Bridge.moveComments(state.noteId, selectedIndices, targetIndex);

      // æ˜¾ç¤ºæ“ä½œæç¤º
      showToast(`æ­£åœ¨ç§»åŠ¨ ${selectedIndices.length} æ¡è¯„è®º...`);

      // é€€å‡ºç§»åŠ¨æ¨¡å¼
      exitMoveMode();

      // æ¸…ç©ºé€‰æ‹©
      clearSelection();

      // æ³¨æ„ï¼šNative ç«¯ä¼šåœ¨æ“ä½œå®Œæˆåè‡ªåŠ¨è°ƒç”¨ Bridge.loadCommentData() åˆ·æ–°æ•°æ®
    }

    // ========================================
    // ç›®æ ‡é€‰æ‹©å™¨ï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ç”¨å¯è§†åŒ–æ’å…¥ç‚¹ï¼‰
    // ========================================
    function showTargetSelector(indices) {
      state.currentAction = 'move';
      state.pendingIndices = indices;

      // æ¸²æŸ“ç›®æ ‡é€‰é¡¹
      renderTargetOptions();

      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      dom.targetModal.classList.add('show');
    }

    function renderTargetOptions() {
      const fields = parseFieldsFromComments();
      const options = [
        { value: 'top', icon: 'ğŸ”', label: 'å¡ç‰‡æœ€é¡¶ç«¯' },
        { value: 'excerpt', icon: 'ğŸ“¦', label: 'æ‘˜å½•åŒº' },
        ...fields.map(f => ({ value: f.name, icon: 'ğŸ“¦', label: f.name }))
      ];

      let html = '';
      options.forEach((opt, index) => {
        html += `
          <div class="target-option" data-value="${opt.value}">
            <input type="radio" name="target" class="target-radio" id="target-${index}" value="${opt.value}">
            <label for="target-${index}" class="target-icon">${opt.icon}</label>
            <label for="target-${index}" class="target-label">${opt.label}</label>
          </div>
        `;
      });

      // æ·»åŠ ä½ç½®é€‰æ‹©å™¨
      html += `
        <div class="position-selector">
          <div class="position-label">å­—æ®µå†…ä½ç½®</div>
          <div class="position-options">
            <button class="position-btn" data-position="top">
              ğŸ” ç§»åˆ°é¡¶éƒ¨
            </button>
            <button class="position-btn active" data-position="bottom">
              ğŸ”½ ç§»åˆ°åº•éƒ¨
            </button>
          </div>
        </div>
      `;

      dom.targetOptions.innerHTML = html;

      // ç»‘å®šäº‹ä»¶
      document.querySelectorAll('.target-option').forEach((opt) => {
        opt.addEventListener('click', () => {
          const radio = opt.querySelector('.target-radio');
          radio.checked = true;

          document.querySelectorAll('.target-option').forEach((o) => o.classList.remove('selected'));
          opt.classList.add('selected');

          state.targetField = opt.dataset.value;
          dom.modalConfirmBtn.disabled = false;
        });
      });

      document.querySelectorAll('.position-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.position-btn').forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          state.toBottom = btn.dataset.position === 'bottom';
        });
      });
    }

    function closeModal() {
      dom.targetModal.classList.remove('show');
      state.targetField = null;
      state.toBottom = true;
      dom.modalConfirmBtn.disabled = true;
    }

    function confirmAction() {
      if (!state.targetField) {
        showToast('è¯·é€‰æ‹©ç›®æ ‡ä½ç½®');
        return;
      }

      // æ„é€ æ“ä½œæ•°æ®
      const actionData = {
        action: 'move',
        selectedIndices: state.pendingIndices,
        targetField: state.targetField,
        toBottom: state.toBottom
      };

      // å‘é€åˆ° Nativeï¼ˆåç»­å®ç°ï¼‰
      console.log('æ‰§è¡Œæ“ä½œ:', actionData);

      // æš‚æ—¶æ˜¾ç¤ºæç¤º
      showToast(`å·²ç§»åŠ¨ ${state.pendingIndices.length} æ¡è¯„è®ºåˆ° ${state.targetField}`);

      // å…³é—­æ¨¡æ€æ¡†
      closeModal();

      // æ¸…ç©ºé€‰æ‹©
      clearSelection();
    }

    // ========================================
    // ç¡®è®¤æå–
    // ========================================
    function confirmExtract(indices) {
      const sorted = [...indices].sort((a, b) => a - b);

      // å–æ¶ˆå¼¹çª—ï¼Œç›´æ¥æ‰§è¡Œï¼Œä¿è¯è¯·æ±‚å‘å‡º
      debugLog(`[HTML] extractConfirmed -> indices=${sorted}`);

      // è°ƒç”¨ Bridge æ–¹æ³•
      Bridge.extractComments(state.noteId, sorted);

      // æ˜¾ç¤ºæ“ä½œæç¤º
      showToast(`æ­£åœ¨æå– ${sorted.length} æ¡è¯„è®º...`);

      // æ¸…ç©ºé€‰æ‹©
      clearSelection();
    }

    // ========================================
    // ç¡®è®¤åˆ é™¤
    // ========================================
    function confirmDelete(indices) {
      const sorted = [...indices].sort((a, b) => a - b);

      // å–æ¶ˆå¼¹çª—ï¼Œç›´æ¥æ‰§è¡Œï¼Œä¿è¯è¯·æ±‚å‘å‡º
      debugLog(`[HTML] deleteConfirmed -> indices=${sorted}`);

      // æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆè°ƒç”¨ Native Bridgeï¼‰
      if (!state.noteId) {
        showToast('é”™è¯¯ï¼šç¼ºå°‘å¡ç‰‡ ID');
        return;
      }

      // è°ƒç”¨ Bridge æ–¹æ³•åˆ é™¤è¯„è®º
      Bridge.deleteComments(state.noteId, sorted);

      // æ˜¾ç¤ºæ“ä½œæç¤º
      showToast(`æ­£åœ¨åˆ é™¤ ${sorted.length} æ¡è¯„è®º...`);

      // æ¸…ç©ºé€‰æ‹©
      clearSelection();

      // æ³¨æ„ï¼šNative ç«¯ä¼šåœ¨æ“ä½œå®Œæˆåè‡ªåŠ¨è°ƒç”¨ Bridge.loadCommentData() åˆ·æ–°æ•°æ®
    }

    // ========================================
    // Toast æç¤º
    // ========================================
    let toastTimer = null;
    function showToast(message, duration = 2000) {
      dom.toast.textContent = message;
      dom.toast.classList.add('show');

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        dom.toast.classList.remove('show');
      }, duration);
    }

    // ========================================
    // å…³é—­çª—å£
    // ========================================
    function closeWindow() {
      // åç»­å®ç°ï¼šé€šçŸ¥ Native å…³é—­
      if (confirm('ç¡®å®šè¦å…³é—­è¯„è®ºç®¡ç†å™¨å—ï¼Ÿ')) {
        window.close();
      }
    }

    // ========================================
    // å·¥å…·å‡½æ•°
    // ========================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function stripHtml(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent || div.innerText || '';
    }

    function removeCssPrefix(text) {
      if (!text) return '';
      const parts = text.split('}');
      if (parts.length === 1) return text.trim();
      for (let i = parts.length - 1; i >= 0; i--) {
        const piece = parts[i].trim();
        if (piece) return piece;
      }
      return text.trim();
    }

    function formatHtmlPreview(html) {
      if (!html) return '';
      // ç§»é™¤ style/script æ ‡ç­¾
      const cleaned = html.replace(/<style[\s\S]*?<\/style>/gi, '').replace(/<script[\s\S]*?<\/script>/gi, '');
      const plain = stripHtml(cleaned).trim();
      return removeCssPrefix(plain);
    }

    // ========================================
    // URL Scheme ç”Ÿæˆå·¥å…·å‡½æ•°
    // ========================================

    /**
     * ç”Ÿæˆ MarginNote URL Scheme
     * @param {string} scheme - URL scheme (e.g., 'mnknowledgebase')
     * @param {string} path - URL path (e.g., 'moveCommentsToField')
     * @param {Object} params - Query parameters
     * @returns {string} å®Œæ•´çš„ URL Scheme
     */
    function generateUrlScheme(scheme, path, params) {
      let url = `${scheme}://${path || ''}`;
      const keys = Object.keys(params || {});
      if (keys.length > 0) {
        const query = keys.map((key) => {
          const value = params[key];
          const serialised = typeof value === 'object' ? JSON.stringify(value) : value;
          return `${encodeURIComponent(key)}=${encodeURIComponent(serialised)}`;
        }).join('&');
        url += query ? `?${query}` : '';
      }
      return url;
    }

    // ========================================
    // Bridge å¯¹è±¡ - Native ä¸ JavaScript é€šä¿¡æ¡¥æ¢
    // ========================================

    /**
     * Bridge å¯¹è±¡æä¾› Native è°ƒç”¨ JavaScript çš„æ¥å£
     *
     * è°ƒç”¨æ–¹å¼ï¼ˆNative ç«¯ï¼‰ï¼š
     * const script = `window.Bridge.loadCommentData(${JSON.stringify(data)})`
     * await this.runJavaScript(script)
     */
    window.Bridge = {
      /**
       * ä» Native ç«¯åŠ è½½è¯„è®ºæ•°æ®
       * @param {Object} data - è¯„è®ºæ•°æ®å¯¹è±¡
       */
      loadCommentData: function(data) {
        try {
          loadDataFromNative(data);
        } catch (error) {
          console.error('Bridge.loadCommentData å¤±è´¥:', error);
          this.logToNative('Bridge.loadCommentData å¤±è´¥: ' + error.message);
        }
      },

      /**
       * ç§»åŠ¨è¯„è®ºåˆ°æŒ‡å®šå­—æ®µ
       * @param {string} noteId - å¡ç‰‡ ID
       * @param {Array<number>} indexArr - è¯„è®ºç´¢å¼•æ•°ç»„
       * @param {string} fieldName - ç›®æ ‡å­—æ®µå
       * @param {boolean} toBottom - æ˜¯å¦ç§»åŠ¨åˆ°å­—æ®µåº•éƒ¨
       */
      moveCommentsToField: function(noteId, indexArr, fieldName, toBottom) {
        try {
          postToNative('moveCommentsToField', {
            id: noteId,
            indexArr: JSON.stringify(indexArr),
            fieldName: fieldName,
            toBottom: toBottom
          });
        } catch (error) {
          console.error('Bridge.moveCommentsToField å¤±è´¥:', error);
          showToast('ç§»åŠ¨å¤±è´¥: ' + error.message);
        }
      },

      /**
       * ç§»åŠ¨è¯„è®ºåˆ°æŒ‡å®šç´¢å¼•ä½ç½®
       * @param {string} noteId - å¡ç‰‡ ID
       * @param {Array<number>} indexArr - è¯„è®ºç´¢å¼•æ•°ç»„
       * @param {number} targetIndex - ç›®æ ‡ç´¢å¼•ä½ç½®
       */
      moveComments: function(noteId, indexArr, targetIndex) {
        try {
          postToNative('moveComments', {
            id: noteId,
            indexArr: JSON.stringify(indexArr),
            targetIndex: targetIndex
          });
        } catch (error) {
          console.error('Bridge.moveComments å¤±è´¥:', error);
          showToast('ç§»åŠ¨å¤±è´¥: ' + error.message);
        }
      },

      /**
       * åˆ é™¤è¯„è®º
       * @param {string} noteId - å¡ç‰‡ ID
       * @param {Array<number>} indexArr - è¯„è®ºç´¢å¼•æ•°ç»„
       */
      deleteComments: function(noteId, indexArr) {
        try {
          postToNative('deleteComments', {
            id: noteId,
            indexArr: JSON.stringify(indexArr)
          });
          console.log('[Bridge] deleteComments', noteId, indexArr);
        } catch (error) {
          console.error('Bridge.deleteComments å¤±è´¥:', error);
          showToast('åˆ é™¤å¤±è´¥: ' + error.message);
        }
      },

      /**
       * æå–è¯„è®ºåˆ›å»ºå­å¡ç‰‡
       * @param {string} noteId - å¡ç‰‡ ID
       * @param {Array<number>} indexArr - è¯„è®ºç´¢å¼•æ•°ç»„
       */
      extractComments: function(noteId, indexArr) {
        try {
          postToNative('extractComments', {
            id: noteId,
            indexArr: JSON.stringify(indexArr)
          });
          console.log('[Bridge] extractComments', noteId, indexArr);
        } catch (error) {
          console.error('Bridge.extractComments å¤±è´¥:', error);
          showToast('æå–å¤±è´¥: ' + error.message);
        }
      },

      /**
       * è¯·æ±‚ Native è®¡ç®—â€œè‡ªåŠ¨æ–°å†…å®¹â€ç´¢å¼•
       * @param {string} noteId
       */
      requestAutoNewContent: function(noteId) {
        try {
          postToNative('autoNewContent', { id: noteId });
        } catch (error) {
          console.error('Bridge.requestAutoNewContent å¤±è´¥:', error);
          showToast('è‡ªåŠ¨æ–°å†…å®¹è¯·æ±‚å¤±è´¥: ' + error.message);
        }
      },

      /**
       * å‘é€æ—¥å¿—åˆ° Native ç«¯
       * @param {string} message - æ—¥å¿—æ¶ˆæ¯
       */
      logToNative: function(message) {
        try {
          sendURLToNative('htmlLog', { message });
        } catch (error) {
          console.error('Bridge.logToNative å¤±è´¥:', error);
        }
      },

      /**
       * Native è¿”å›è‡ªåŠ¨æ£€æµ‹çš„æ–°å†…å®¹ç´¢å¼•
       * @param {Array<number>} indexArr
       */
      applyAutoNewSelection: function(indexArr) {
        try {
          const indices = Array.isArray(indexArr) ? indexArr.map(i => parseInt(i, 10)).filter(i => !isNaN(i)) : [];
          debugLog(`[HTML] applyAutoNewSelection -> ${indices}`);

          state.selectedIndices.clear();
          indices.forEach(i => state.selectedIndices.add(i));

          updateUI();

          if (indices.length === 0) {
            showToast('æœªæ£€æµ‹åˆ°æ–°å†…å®¹');
          } else {
            showToast(`å·²é€‰ä¸­ ${indices.length} æ¡æ–°å†…å®¹`);
          }
        } catch (error) {
          debugLog(`[HTML Error] applyAutoNewSelection å¤±è´¥: ${error.message}`);
          showToast('è‡ªåŠ¨é€‰æ‹©å¤±è´¥');
        }
      }
    };

    // é¡µé¢åŠ è½½æ—¶å‘é€å°±ç»ªä¿¡å·
    window.addEventListener('load', () => {
      try {
        postToNative('ready', {});
      } catch (error) {
        console.error('å‘é€å°±ç»ªä¿¡å·å¤±è´¥:', error);
      }
    });

    // ç»Ÿä¸€çš„ Native è°ƒç”¨å¸®åŠ©å‡½æ•°ï¼ˆå‚è€ƒçŸ¥è¯†åº“æœç´¢é¡µï¼‰
    function postToNative(action, params = {}) {
      debugLog(`[HTML] postToNative ${action} -> ${JSON.stringify(params)}`);
      sendURLToNative(action, params);
    }

    // ========================================
    // å¯åŠ¨
    // ========================================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
