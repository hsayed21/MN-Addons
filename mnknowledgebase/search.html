<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MNKnowledgeBase - æœç´¢å¯è§†åŒ–æ¡†æ¶</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --card-bg: #fff;
      --accent: #2b7cff;
      --muted: #666;
      --pill-bg: #eef5ff;
      --pill-active-bg: #cfe1ff;
      --negative-bg: #ffeef4;
      --negative-active-bg: #ffdfee;
      --type-pill-bg: #e7f4ee;
      --type-pill-active-bg: #c4e6d5;
      --type-pill-color: #1c8054;
      --toggle-bg: #f0f3f9;
      --toggle-border: #d2d9e5;
      --toggle-active-bg: #2b7cff;
      --toggle-active-color: #fff;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      --topbar-height: 64px;
      --toolbar-gap: 78px;
      --preset-max-height: 220px;
      --negative-height: 78px;
      --spacing-buffer: 20px;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: #111;
      -webkit-font-smoothing: antialiased;
      touch-action: manipulation;
      overscroll-behavior: contain;
    }

    /* å›ºå®šé¡¶éƒ¨æœç´¢æ  */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 130;
      backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(250, 250, 250, 0.9));
      border-bottom: 1px solid #e6e9ef;
      padding: 14px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      min-height: var(--topbar-height);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .topbar-main {
      flex: 1 1 640px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      min-width: 0;
    }

    .topbar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .topbar-dataset-slot {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .btn.ghost {
      background: transparent;
      border-color: transparent;
      color: #4d5e78;
      box-shadow: none;
    }

    .btn.ghost:hover {
      background: rgba(43, 124, 255, 0.08);
      border-color: rgba(43, 124, 255, 0.12);
      color: #2b7cff;
    }

    .btn.ghost:active {
      transform: scale(0.97);
    }

    .filter-toggle {
      position: relative;
      padding-right: 32px;
    }

    .filter-toggle::after {
      content: 'â–¾';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: currentColor;
      transition: transform 0.2s ease;
    }

    .filter-toggle.collapsed::after {
      transform: translateY(-50%) rotate(-90deg);
    }

    .topbar.hidden {
      transform: translateY(-100%);
      opacity: 0;
      pointer-events: none;
    }

    .filters-panel {
      position: relative;
      z-index: 80;
      transition: opacity 0.25s ease;
    }

    .filters-panel__section {
      margin-bottom: 18px;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .filters-panel__section-title {
      font-size: 12px;
      font-weight: 600;
      color: #5b6a80;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filters-panel__dataset {
      display: none;
    }

    .filters-panel__dataset .dataset-toggle {
      width: 100%;
      justify-content: space-between;
      gap: 6px;
    }

    #filtersPanel[data-layout="compact"] .filters-panel__dataset {
      display: block;
    }

    .search-input-wrap {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 1;
      min-width: 240px;
    }

    .search-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #d6dbe8;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      font-size: 15px;
    }

    .search-count {
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }

    .index-mode-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .index-mode-badge--full {
      background: rgba(43, 124, 255, 0.1);
      color: #2b7cff;
      border: 1px solid rgba(43, 124, 255, 0.3);
    }

    .index-mode-badge--light {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
      border: 1px solid rgba(107, 114, 128, 0.3);
    }

    .index-mode-badge--legacy {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .dataset-toggle {
      display: inline-flex;
      background: var(--toggle-bg);
      border: 1px solid var(--toggle-border);
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      align-items: center;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
      flex-wrap: wrap;
    }

    [data-variant="primary"].dataset-toggle {
      flex-wrap: nowrap;
    }

    [data-variant="overlay"].dataset-toggle button {
      flex: 1 1 calc(50% - 6px);
      min-width: 120px;
      text-align: center;
    }

    .dataset-toggle button {
      appearance: none;
      border: none;
      background: transparent;
      color: #4d5e78;
      font-size: 13px;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    .dataset-toggle button.active {
      background: var(--toggle-active-bg);
      color: var(--toggle-active-color);
      box-shadow: 0 6px 14px rgba(43, 124, 255, 0.18);
    }

    .dataset-toggle button:focus-visible {
      outline: 2px solid rgba(43, 124, 255, 0.4);
      outline-offset: 2px;
    }

    /* å·¥å…·æ èƒ¶å›Š */
    .pill-section {
      position: fixed;
      left: 0;
      right: 0;
      z-index: 80;
      background: linear-gradient(180deg, rgba(247, 248, 251, 0.95), rgba(247, 248, 251, 0.78));
      padding: 10px 20px 14px;
      backdrop-filter: blur(4px);
      transition: transform 0.3s ease, opacity 0.3s ease, max-height 0.3s ease, padding 0.3s ease;
    }

    .pill-section.hidden {
      transform: translateY(-100%);
      opacity: 0;
      pointer-events: none;
    }

    .pill-section--type {
      top: var(--topbar-height);
    }

    .pill-section--classification {
      top: calc(var(--topbar-height) + var(--toolbar-gap));
    }

    .pill-section--negative {
      top: var(--negative-top, calc(var(--topbar-height) + var(--toolbar-gap) * 2));
    }

    .pill-section--preset {
      top: var(--preset-top, calc(var(--topbar-height) + var(--toolbar-gap) * 3));
      max-height: var(--preset-max-height);
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }

    .pill-section--preset::-webkit-scrollbar {
      width: 6px;
    }

    .pill-section--preset::-webkit-scrollbar-track {
      background: transparent;
    }

    .pill-section--preset::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .pill-section--preset::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    .pill-section__header {
      margin-bottom: 8px;
    }

    .pill-section__label-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill-section__label {
      font-size: 12px;
      font-weight: 600;
      color: #5b6a80;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-section__label::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.45;
    }

    /* æŠ˜å /å±•å¼€æŒ‰é’® */
    .pill-section__toggle-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: rgba(43, 124, 255, 0.08);
      border: 1px solid rgba(43, 124, 255, 0.2);
      border-radius: 6px;
      color: #2b7cff;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-left: auto;
    }

    .pill-section__toggle-btn:hover {
      background: rgba(43, 124, 255, 0.15);
      transform: scale(1.05);
    }

    .pill-section__toggle-btn.collapsed {
      transform: rotate(180deg);
    }

    /* å¯æŠ˜å å†…å®¹åŒº */
    .pill-section__content {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }

    .pill-section__content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    .pill-section__clear-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(255, 59, 48, 0.08);
      border: 1px solid rgba(255, 59, 48, 0.25);
      border-radius: 12px;
      color: #ff3b30;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      min-height: 28px;
      min-width: 60px;
    }

    .pill-section__clear-btn .clear-icon {
      font-size: 14px;
      font-weight: 600;
    }

    .pill-section__clear-btn:hover:not(.disabled) {
      background: rgba(255, 59, 48, 0.15);
      border-color: rgba(255, 59, 48, 0.4);
      transform: translateY(-1px);
    }

    .pill-section__clear-btn:active:not(.disabled) {
      transform: translateY(0) scale(0.96);
    }

    .pill-section__clear-btn.disabled {
      opacity: 0.35;
      cursor: not-allowed;
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.1);
      color: #999;
    }

    body.filters-collapsed {
      --toolbar-gap: 18px;
      --preset-max-height: 0px;
      --negative-height: 0px;
      --spacing-buffer: 12px;
    }

    body.filters-overlay {
      overflow: hidden;
    }

    body.filters-collapsed .topbar {
      box-shadow: 0 12px 30px rgba(20, 50, 100, 0.12);
      border-bottom-color: transparent;
    }

    body.filters-collapsed .filters-panel {
      pointer-events: none;
      opacity: 0;
    }

    body.filters-collapsed .pill-section {
      opacity: 0;
      pointer-events: none;
      max-height: 0 !important;
      padding-top: 0;
      padding-bottom: 0;
      transform: translateY(-12px);
      overflow: hidden;
      border-bottom-color: transparent;
    }

    body.filters-collapsed .filters-panel__section {
      pointer-events: none;
      opacity: 0;
      transform: translateY(-12px);
    }

    body.filters-collapsed .filters-panel__dataset {
      max-height: 0;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    body.filters-collapsed .pill-section__header,
    body.filters-collapsed .pill-section__content {
      opacity: 0;
    }

    body.filters-collapsed .pill-section__content {
      max-height: 0 !important;
    }

    /* é¢„è®¾åˆ†ç»„æ ·å¼ */
    .preset-group {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .preset-group:last-child {
      border-bottom: none;
      margin-bottom: 6px;
      padding-bottom: 0;
    }

    .preset-group__label {
      font-size: 12px;
      font-weight: 600;
      color: #5b6a80;
      margin-bottom: 8px;
      padding-left: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* æœ€è¿‘ä½¿ç”¨åˆ†ç»„ç‰¹æ®Šæ ·å¼ */
    .preset-group--recent .preset-group__label {
      color: #2b7cff;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;  /* å…è®¸æ¢è¡Œï¼Œç¡®ä¿å­è¡Œå¯ä»¥ç‹¬ç«‹æˆè¡Œ */
      gap: 10px;
      align-items: center;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .pill-row::-webkit-scrollbar {
      display: none;
    }

    .pill {
      background: var(--pill-bg);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      border: 1px solid transparent;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      user-select: none;
    }

    .pill:active {
      transform: scale(0.96);
    }

    .pill.active {
      background: var(--pill-active-bg);
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 2px 6px rgba(43, 124, 255, 0.12);
    }

    .type-bar .pill {
      background: var(--type-pill-bg);
      color: var(--type-pill-color);
    }

    .type-bar .pill.active {
      background: var(--type-pill-active-bg);
      border-color: rgba(21, 122, 82, 0.4);
      color: #0d5c39;
      box-shadow: 0 2px 6px rgba(21, 122, 82, 0.14);
    }

    .pill.negative {
      background: var(--negative-bg);
      color: #c23b6b;
    }

    .pill.negative.active {
      background: var(--negative-active-bg);
      border-color: #f0b6d0;
      box-shadow: 0 2px 6px rgba(194, 59, 107, 0.08);
    }

    /* ========== åˆ†å±‚é¢„è®¾æ ·å¼ ========== */

    /* å¯å±•å¼€çš„ pill */
    .pill--expandable {
      font-weight: 500;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0;
      padding: 0;
    }

    .pill--expandable:hover {
      background: #e7f5ff;
      border-color: #339af0;
      transform: translateY(-1px);
    }

    /* å¯å±•å¼€ pill çš„æ–‡æœ¬åŒºåŸŸï¼ˆå¯ç‚¹å‡»é€‰ä¸­ï¼‰ */
    .pill__text {
      flex: 1;
      cursor: pointer;
      user-select: none;
      padding: 8px 4px 8px 12px;
    }

    .pill__text:hover {
      opacity: 0.8;
    }

    /* å¯å±•å¼€ pill çš„å±•å¼€æŒ‰é’®ï¼ˆå¯ç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼‰ */
    .pill__toggle {
      flex-shrink: 0;
      cursor: pointer;
      user-select: none;
      opacity: 0.7;
      font-size: 14px;
      padding: 8px 12px 8px 4px;
      min-width: 28px;
      min-height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: opacity 0.2s ease, transform 0.2s ease, background-color 0.2s ease;
    }

    .pill__toggle:hover {
      opacity: 1;
      transform: scale(1.1);
      background-color: rgba(51, 154, 240, 0.1);
    }

    .pill__toggle:active {
      transform: scale(0.95);
      background-color: rgba(51, 154, 240, 0.15);
    }

    /* å­çº§è¡Œå®¹å™¨ */
    .pill-row--child {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid #dee2e6;
      flex-basis: 100%;  /* å¼ºåˆ¶å­è¡Œå æ®å®Œæ•´å®½åº¦ï¼Œç‹¬ç«‹æˆè¡Œ */
    }

    /* Level 2 å­çº§ */
    .pill-row--level-2 {
      margin-left: 20px;
      background: #f8f9fa;
      border-left-color: #adb5bd;
    }

    /* Level 3 å­çº§ */
    .pill-row--level-3 {
      margin-left: 40px;
      background: #f1f3f5;
      border-left-color: #868e96;
    }

    /* Level 4 å­çº§ */
    .pill-row--level-4 {
      margin-left: 60px;
      background: #e9ecef;
      border-left-color: #495057;
    }

    /* å­çº§ pill æ ·å¼å¾®è°ƒ */
    .pill[data-level="2"],
    .pill[data-level="3"],
    .pill[data-level="4"] {
      background: white;
      font-size: 0.9em;
      padding: 6px 10px;
    }

    .pill[data-level="2"]:hover {
      background: #e7f5ff;
      border-color: #74c0fc;
    }

    .pill[data-level="3"]:hover {
      background: #d0ebff;
      border-color: #4dabf7;
    }

    .pill[data-level="4"]:hover {
      background: #a5d8ff;
      border-color: #339af0;
    }

    /* å­çº§ pill é€‰ä¸­çŠ¶æ€ */
    .pill[data-level="2"].active,
    .pill[data-level="3"].active,
    .pill[data-level="4"].active {
      background: var(--pill-active-bg);
      border-color: var(--accent);
      color: var(--accent);
      font-weight: 500;
    }

    /* ========== åˆ†å±‚é¢„è®¾æ ·å¼ç»“æŸ ========== */

    /* ä¸»ä½“å¸ƒå±€ */
    .main-layout {
      display: flex;
      height: 100vh;
      padding-top: var(--main-padding-top, calc(var(--topbar-height) + var(--toolbar-gap) * 2 + var(--negative-height) + var(--preset-max-height) + var(--spacing-buffer)));
      overflow: hidden;
      transition: padding-top 0.3s ease;
    }

    body.toolbar-hidden .main-layout {
      padding-top: 0;
    }

    /* å·¦ä¾§æ“ä½œé¢æ¿ */
    .sidebar {
      width: 280px;
      flex-shrink: 0;
      background: var(--card-bg);
      border-right: 1px solid #e6e9ef;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      position: sticky;
      top: 0;
      height: 100%;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #e6e9ef;
      background: linear-gradient(180deg, #fafbfc, #fff);
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 600;
      color: #5b6a80;
      margin-bottom: 8px;
    }

    .selected-card-info {
      font-size: 14px;
      color: #2a3a52;
      line-height: 1.5;
      padding: 10px;
      background: #f7f9fc;
      border-radius: 8px;
      border-left: 3px solid var(--accent);
      max-height: 80px;
      overflow-y: auto;
    }

    .selected-card-info.empty {
      color: var(--muted);
      font-style: italic;
      border-left-color: #d6dbe8;
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid #f0f2f5;
    }

    /* æ˜Ÿæ ‡å¸¸ç”¨åŠŸèƒ½åŒº - æ›´çªå‡ºçš„æ ·å¼ */
    .sidebar-section--starred {
      padding: 20px 16px;
      border-bottom: 2px solid #fbbf24;
      background: linear-gradient(180deg, #fffbeb, #fef3c7, #fff);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .sidebar-section--starred .sidebar-section-title {
      font-size: 14px;
      font-weight: 700;
      color: #d97706;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: none;
      letter-spacing: 0;
    }

    .sidebar-section--starred .sidebar-btn {
      padding: 14px 18px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #78350f;
      border: 2px solid #fbbf24;
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
      margin-bottom: 0;
    }

    .sidebar-section--starred .sidebar-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border-color: #f59e0b;
      transform: translateX(3px) translateY(-2px);
      box-shadow: 0 8px 24px rgba(251, 191, 36, 0.5);
    }

    .sidebar-section--starred .sidebar-btn:active:not(:disabled) {
      transform: scale(0.97);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .sidebar-section--starred .sidebar-btn:disabled {
      background: linear-gradient(135deg, #fde68a, #fcd34d);
      color: #92400e;
      opacity: 0.6;
      box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
    }

    .sidebar-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #5b6a80;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sidebar-btn {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 8px;
      background: var(--card-bg);
      border: 1px solid #e3e6ee;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      text-align: left;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-btn:hover:not(:disabled) {
      background: #f7f9fc;
      border-color: var(--accent);
      transform: translateX(2px);
    }

    .sidebar-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .sidebar-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .sidebar-btn.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(43, 124, 255, 0.2);
    }

    .sidebar-btn.primary:hover:not(:disabled) {
      background: #1b6cef;
      transform: translateX(2px);
    }

    /* ä¾§è¾¹æ æŒ‰é’®åˆ†ç»„ */
    .sidebar-btn-group {
      margin-bottom: 16px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 8px;
      border-left: 3px solid #d6dbe8;
    }

    .sidebar-btn-group:last-child {
      margin-bottom: 0;
    }

    /* åˆ†ç»„é…è‰² */
    .sidebar-btn-group--merge {
      background: #f0f9ff;
      border-left-color: #3b82f6;
    }

    .sidebar-btn-group--move {
      background: #f0fdf4;
      border-left-color: #10b981;
    }

    .sidebar-btn-group--template {
      background: #faf5ff;
      border-left-color: #a855f7;
    }

    .sidebar-btn-group-label {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 8px;
      padding-left: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sidebar-btn-group--merge .sidebar-btn-group-label {
      color: #2563eb;
    }

    .sidebar-btn-group--move .sidebar-btn-group-label {
      color: #059669;
    }

    .sidebar-btn-group--template .sidebar-btn-group-label {
      color: #9333ea;
    }

    .sidebar-btn--grouped {
      margin-bottom: 6px;
      font-size: 13px;
    }

    .sidebar-btn--grouped:last-child {
      margin-bottom: 0;
    }

    /* å³ä¾§å¡ç‰‡åŒºåŸŸ */
    .container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* æ“ä½œå·¥å…·æ  */
    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--card-bg);
      border: 1px solid #e3e6ee;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 16px rgba(43, 124, 255, 0.16);
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* ç»“æœåˆ—è¡¨ */
    .results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      border-left: 6px solid transparent;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 90px;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      position: relative;
    }

    .card.selected {
      box-shadow: 0 12px 28px rgba(43, 124, 255, 0.18);
      transform: translateY(-4px);
      border-left-width: 10px;
    }

    /* å¡ç‰‡æ“ä½œå›¾æ ‡å®¹å™¨ - 2x3 ç½‘æ ¼å¸ƒå±€ */
    .card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: grid;
      grid-template-columns: repeat(3, 32px);
      grid-template-rows: repeat(2, 32px);
      gap: 6px;
      z-index: 10;
    }

    /* å•ä¸ªæ“ä½œå›¾æ ‡ */
    .card-action-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      opacity: 1;
      transform: scale(1);
      transition: all 0.2s ease;
    }

    /* æ–‡å­—å›¾æ ‡æ ·å¼ */
    .card-action-icon.text-icon {
      font-size: 10px;
      line-height: 1.2;
      padding: 2px;
      text-align: center;
      font-weight: 500;
    }

    .card-action-icon:hover {
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      transform: scale(1.05);
    }

    .card-action-icon:active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 4px 12px rgba(43, 124, 255, 0.3);
      transform: scale(0.95);
    }

    .card-title {
      font-weight: 600;
      line-height: 1.4;
      word-break: break-word;
      padding-right: 130px;  /* ä¸ºå³ä¾§å›¾æ ‡ç•™å‡ºç©ºé—´,é¿å…é®æŒ¡ (3åˆ—: 32*3 + 6*2 + 8*2 = 124px) */
    }

    .card-snippet {
      font-size: 13px;
      color: #444;
      line-height: 1.4;
      word-break: break-word;
    }

    .match-count {
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
    }

    mark.matched {
      background: rgba(255, 230, 120, 0.9);
      color: #111;
      padding: 0 2px;
      border-radius: 2px;
    }

    .card-meta {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .card-type {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #fff;
      align-items: center;
      gap: 6px;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }

    .classification-subtype {
      background: rgba(32, 52, 87, 0.08);
      color: #2f466b;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 0.2px;
    }

    .classification-bar .pill {
      background: #eef1ff;
      color: #2f4a8a;
    }

    .classification-bar .pill.active {
      background: #4d6cff;
      color: #fff;
      border-color: rgba(77, 108, 255, 0.6);
      box-shadow: 0 4px 12px rgba(77, 108, 255, 0.18);
    }

    .card-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-score {
      background: rgba(43, 124, 255, 0.08);
      color: #2b7cff;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 6px;
    }

    .component-hidden {
      display: none !important;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(33, 33, 33, 0.88);
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 120;
    }

    .toast.show {
      opacity: 1;
    }

    /* è¿”å›é¡¶éƒ¨æŒ‰é’® */
    .scroll-to-top {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 56px;
      height: 56px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 50%;
      box-shadow: 0 8px 24px rgba(43, 124, 255, 0.35);
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 110;
      transition: opacity 0.3s ease, transform 0.3s ease;
      opacity: 0;
      pointer-events: none;
      transform: scale(0.8);
    }

    .scroll-to-top.show {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    .scroll-to-top:hover {
      background: #1b6cef;
      transform: scale(1.1);
    }

    .scroll-to-top:active {
      transform: scale(0.95);
    }

    /* å“åº”å¼è®¾è®¡ - ä¸­ç­‰å±å¹•ï¼ˆiPad ç«–å±ï¼‰*/
    @media (min-width: 768px) and (max-width: 1024px) {
      /* ç±»å‹ç­›é€‰å§‹ç»ˆæ˜¾ç¤º */
      .pill-section--type .pill-section__toggle-btn {
        display: inline-flex;
      }

      /* é¢„è®¾å’Œæ’é™¤é»˜è®¤æŠ˜å  */
      .pill-section--preset .pill-section__toggle-btn,
      .pill-section--negative .pill-section__toggle-btn {
        display: inline-flex;
      }

      /* å½’ç±»å­ç±»å‹æ˜¾ç¤ºæ—¶ä¹Ÿå¯æŠ˜å  */
      .pill-section--classification .pill-section__toggle-btn {
        display: inline-flex;
      }
    }

    /* å°å±å¹•è®¾å¤‡ï¼ˆæ‰‹æœºå’Œå°å¹³æ¿ï¼‰*/
    @media (max-width: 767px) {
      .pill-section__toggle-btn {
        display: inline-flex !important;
      }
    }

    /* iPad ç«–å±å’Œå°å±å¹•è®¾å¤‡ */
    @media (max-width: 1024px) {
      .topbar-dataset-slot {
        display: none;
      }

      .filters-panel {
        position: fixed;
        top: calc(var(--topbar-height) + 12px);
        left: 16px;
        right: 16px;
        z-index: 120;
        background: rgba(255, 255, 255, 0.96);
        border-radius: 16px;
        padding: 16px 18px 18px;
        box-shadow: 0 20px 44px rgba(30, 52, 92, 0.18);
        overflow-y: auto;
        max-height: calc(100vh - var(--topbar-height) - 40px);
        pointer-events: auto;
        transform: translateY(0);
        opacity: 1;
        transition: opacity 0.25s ease, transform 0.25s ease;
      }

      body.filters-collapsed .filters-panel {
        opacity: 0;
        pointer-events: none;
        transform: translateY(-14px);
      }

      .filters-panel .pill-section {
        position: static;
        background: transparent;
        padding: 0;
        border: none;
        backdrop-filter: none;
        transform: none;
      }

      .filters-panel .pill-section + .pill-section {
        margin-top: 16px;
        padding-top: 14px;
        border-top: 1px solid rgba(210, 217, 229, 0.5);
      }

      .filters-panel .pill-section__header {
        margin-bottom: 10px;
      }

      .filters-panel .pill-section__content {
        max-height: 1000px;
        opacity: 1;
        padding-bottom: 0;
      }

      .filters-panel .pill-section__content.collapsed {
        max-height: 0;
        opacity: 0;
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: var(--topbar-height);
        height: calc(100vh - var(--topbar-height));
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.show {
        transform: translateX(0);
        box-shadow: 4px 0 16px rgba(0, 0, 0, 0.15);
      }

      .container {
        margin-left: 0;
      }

      /* Sidebar åˆ‡æ¢æŒ‰é’® */
      .sidebar-toggle {
        position: fixed;
        left: 16px;
        bottom: 24px;
        width: 56px;
        height: 56px;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 50%;
        box-shadow: 0 8px 24px rgba(43, 124, 255, 0.35);
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 90;
        transition: transform 0.2s ease;
      }

      .sidebar-toggle:active {
        transform: scale(0.92);
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: 95;
        backdrop-filter: blur(2px);
      }

      .sidebar-overlay.show {
        display: block;
      }
    }

    @media (max-width: 640px) {
      :root {
        --topbar-height: 56px;
        --toolbar-gap: 40px;
      }

      .topbar {
        padding: 12px 14px;
        align-items: stretch;
      }

      .topbar-main {
        flex-direction: column;
        align-items: stretch;
        min-width: 100%;
        gap: 10px;
      }

      .topbar-actions {
        width: 100%;
        justify-content: flex-end;
      }

      .pill-row {
        padding: 8px 14px;
      }

      .container {
        padding: 0 12px 80px;
      }

      .results {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      }

      .pill-section__clear-btn {
        min-height: 32px;
        padding: 6px 12px;
      }

      .pill-section__clear-btn .clear-text {
        display: none;
      }

      .pill-section__clear-btn .clear-icon {
        font-size: 16px;
      }
    }

    /* ========================================
       AI åŠ©æ‰‹ä¾§è¾¹æ æ ·å¼
       ======================================== */

    /* AI åˆ‡æ¢æŒ‰é’® (å›ºå®šåœ¨å³ä¸Šè§’) */
    .ai-toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ai-toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    .ai-toggle-btn:active {
      transform: translateY(0);
    }

    .ai-toggle-icon {
      font-size: 18px;
    }

    /* AI ä¾§è¾¹æ å®¹å™¨ */
    .ai-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 420px;
      height: 100vh;
      background: #ffffff;
      box-shadow: -2px 0 12px rgba(0, 0, 0, 0.1);
      z-index: 190;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ai-sidebar.ai-sidebar--open {
      transform: translateX(0);
    }

    /* ä¾§è¾¹æ å¤´éƒ¨ */
    .ai-sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .ai-sidebar-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .ai-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .ai-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ä¸Šä¸‹æ–‡ä¿¡æ¯åŒºåŸŸ */
    .ai-context-info {
      padding: 12px 16px;
      background: #f8f9fc;
      border-bottom: 1px solid #e1e4e8;
      flex-shrink: 0;
    }

    .ai-context-label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
    }

    .ai-context-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .ai-context-empty {
      font-size: 12px;
      color: #999;
      font-style: italic;
    }

    .ai-context-card-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      font-size: 12px;
      color: #374151;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ai-context-card-chip .card-type-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: #e7f4ee;
      color: #1c8054;
      border-radius: 4px;
    }

    /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
    .ai-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ai-welcome-message {
      padding: 16px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .ai-welcome-message p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    .ai-welcome-message p:first-child {
      margin-top: 0;
    }

    .ai-welcome-message p:last-child {
      margin-bottom: 0;
    }

    .ai-welcome-message strong {
      color: #667eea;
      font-weight: 600;
    }

    /* æ¶ˆæ¯æ°”æ³¡ */
    .ai-message {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: 90%;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .ai-message--user {
      align-self: flex-end;
    }

    .ai-message--assistant {
      align-self: flex-start;
    }

    .ai-message-bubble {
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .ai-message--user .ai-message-bubble {
      background: #667eea;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .ai-message--assistant .ai-message-bubble {
      background: #f3f4f6;
      color: #111827;
      border-bottom-left-radius: 4px;
    }

    /* Markdown æ ·å¼ï¼ˆAI å“åº”ï¼‰*/
    .ai-message-bubble h1,
    .ai-message-bubble h2,
    .ai-message-bubble h3 {
      margin: 8px 0 4px;
      font-weight: 600;
    }

    .ai-message-bubble h1 { font-size: 16px; }
    .ai-message-bubble h2 { font-size: 15px; }
    .ai-message-bubble h3 { font-size: 14px; }

    .ai-message-bubble p {
      margin: 6px 0;
    }

    .ai-message-bubble ul,
    .ai-message-bubble ol {
      margin: 6px 0;
      padding-left: 20px;
    }

    .ai-message-bubble li {
      margin: 4px 0;
    }

    .ai-message-bubble code {
      padding: 2px 6px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .ai-message-bubble pre {
      padding: 12px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }

    .ai-message-bubble pre code {
      background: none;
      padding: 0;
    }

    .ai-message-timestamp {
      font-size: 11px;
      color: #9ca3af;
      padding: 0 4px;
    }

    /* è¾“å…¥åŒºåŸŸ */
    .ai-input-area {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      flex-shrink: 0;
    }

    .ai-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .ai-input:focus {
      border-color: #667eea;
    }

    .ai-send-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .ai-send-btn:hover {
      background: #5568d3;
    }

    .ai-send-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }

    .ai-send-icon {
      font-size: 16px;
    }

    /* åŠ è½½çŠ¶æ€ */
    .ai-loading {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      font-size: 13px;
      color: #667eea;
    }

    .ai-loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .ai-sidebar {
        width: 100%;
      }

      .ai-toggle-btn {
        top: 12px;
        right: 12px;
        padding: 8px 14px;
      }

      .ai-toggle-text {
        display: none;
      }
    }

    /* ========================================
       AI æ¨èåŒºåŸŸæ ·å¼
       ======================================== */

    /* ä¸»å®¹å™¨ï¼šåº•éƒ¨å›ºå®šé¢æ¿ */
    .ai-recommendations-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 150;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-top: 2px solid #667eea;
      box-shadow: 0 -4px 20px rgba(102, 126, 234, 0.2);
      max-height: 50vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* æ˜¾ç¤ºçŠ¶æ€ */
    .ai-recommendations-panel.show {
      transform: translateY(0);
    }

    /* å¤´éƒ¨ï¼šæ ‡é¢˜æ  */
    .ai-recommendations-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(102, 126, 234, 0.2);
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
      flex-shrink: 0;
    }

    .ai-recommendations-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
      color: #667eea;
    }

    .ai-icon {
      font-size: 20px;
    }

    .ai-title-text {
      color: #333;
    }

    .ai-count {
      font-size: 13px;
      color: #667eea;
      background: rgba(102, 126, 234, 0.1);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .ai-close-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      color: #666;
      transition: all 0.2s ease;
    }

    .ai-close-btn:hover {
      background: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
      transform: scale(1.1);
    }

    .ai-close-btn:active {
      transform: scale(0.95);
    }

    /* å†…å®¹åŒºåŸŸï¼šå¯æ»šåŠ¨å¡ç‰‡åˆ—è¡¨ */
    .ai-recommendations-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 12px;
      align-content: start;
    }

    /* æ¨èå¡ç‰‡ç‰¹æ®Šæ ·å¼ï¼ˆå¤ç”¨ .cardï¼Œä½†æ·»åŠ é«˜äº®ï¼‰ */
    .ai-recommendations-content .card {
      border-left-width: 8px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      position: relative;
    }

    .ai-recommendations-content .card::before {
      content: 'ğŸ¤– AI æ¨è';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 10px;
      font-weight: 600;
      color: #667eea;
      background: rgba(102, 126, 234, 0.1);
      padding: 4px 8px;
      border-radius: 8px;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .ai-recommendations-panel {
        max-height: 60vh;
      }

      .ai-recommendations-content {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 10px;
        padding: 12px 16px;
      }

      .ai-recommendations-header {
        padding: 12px 16px;
      }

      .ai-recommendations-title {
        font-size: 14px;
      }

      .ai-icon {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-main">
      <div class="search-input-wrap">
        <input id="searchInput" class="search-input" placeholder="æœç´¢çŸ¥è¯†åº“ï¼šè¾“å…¥å…³é”®å­—æˆ–é€‰æ‹©ä¸‹æ–¹é¢„è®¾" autocomplete="off" />
        <div id="searchCount" class="search-count">0 æ¡ç»“æœ</div>
      </div>
    </div>
    <div class="topbar-actions">
      <span id="indexModeBadge" class="index-mode-badge"></span>
      <button id="toggleFiltersBtn" class="btn ghost filter-toggle" type="button" aria-expanded="true">æ”¶èµ·ç­›é€‰</button>
      <button id="refreshBtn" class="btn" type="button">ğŸ”„ åˆ·æ–°</button>
      <button id="clearBtn" class="btn" type="button">æ¸…ç©º</button>
    </div>
  </div>

  <div class="filters-panel" id="filtersPanel" aria-label="ç­›é€‰é¢æ¿">
    <div class="pill-section pill-section--type" data-section="type">
      <div class="pill-section__header">
        <div class="pill-section__label-group">
          <div class="pill-section__label">ç±»å‹ç­›é€‰</div>
          <button class="pill-section__toggle-btn" data-toggle="type" type="button" aria-label="æŠ˜å /å±•å¼€">
            â–¼
          </button>
        </div>
      </div>
      <div class="pill-section__content" data-content="type">
        <div class="pill-row type-bar" id="typeBar" aria-label="ç±»å‹ç­›é€‰">
          <!-- ç±»å‹ç­›é€‰ pill å°†åœ¨ JS ä¸­æ¸²æŸ“ -->
        </div>
      </div>
    </div>
    <div class="pill-section pill-section--classification component-hidden" data-section="classification">
      <div class="pill-section__header">
        <div class="pill-section__label-group">
          <div class="pill-section__label">å½’ç±»å­ç±»å‹</div>
          <button class="pill-section__toggle-btn" data-toggle="classification" type="button" aria-label="æŠ˜å /å±•å¼€">
            â–¼
          </button>
        </div>
      </div>
      <div class="pill-section__content" data-content="classification">
        <div class="pill-row classification-bar" id="classificationBar" aria-label="å½’ç±»äºŒçº§ç±»å‹">
          <!-- å½’ç±»äºŒçº§ç±»å‹ pill -->
        </div>
      </div>
    </div>
    <div class="pill-section pill-section--preset" data-section="preset">
      <div class="pill-section__header">
        <div class="pill-section__label-group">
          <div class="pill-section__label">æœç´¢é¢„è®¾</div>
          <button class="pill-section__clear-btn" id="clearPresetsBtn" type="button">
            <span class="clear-icon">âœ•</span>
            <span class="clear-text">æ¸…é™¤</span>
          </button>
          <button class="pill-section__toggle-btn" data-toggle="preset" type="button" aria-label="æŠ˜å /å±•å¼€">
            â–¼
          </button>
        </div>
      </div>
      <div class="pill-section__content" data-content="preset">
        <div id="presetBar" aria-label="æœç´¢é¢„è®¾">
          <!-- é¢„è®¾åˆ†ç»„å°†åœ¨ JS ä¸­æ¸²æŸ“ -->
        </div>
      </div>
    </div>
    <div class="pill-section pill-section--negative" data-section="negative">
      <div class="pill-section__header">
        <div class="pill-section__label-group">
          <div class="pill-section__label">æ’é™¤å…³é”®è¯</div>
          <button class="pill-section__clear-btn" id="clearNegativesBtn" type="button">
            <span class="clear-icon">âœ•</span>
            <span class="clear-text">æ¸…é™¤</span>
          </button>
          <button class="pill-section__toggle-btn" data-toggle="negative" type="button" aria-label="æŠ˜å /å±•å¼€">
            â–¼
          </button>
        </div>
      </div>
      <div class="pill-section__content" data-content="negative">
        <div class="pill-row negative-bar" id="negativeBar" aria-label="æ’é™¤è¯">
          <!-- è´Ÿå‘æ’é™¤è¯ï¼ˆç²‰è‰²ï¼‰å°†åœ¨ JS ä¸­æ¸²æŸ“ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar é®ç½©å±‚ (ä»…ç§»åŠ¨ç«¯) -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar åˆ‡æ¢æŒ‰é’® (ä»…ç§»åŠ¨ç«¯) -->
  <button class="sidebar-toggle" id="sidebarToggle" type="button" style="display: none;">
    âš™ï¸
  </button>

  <div class="main-layout">
    <!-- å·¦ä¾§æ“ä½œé¢æ¿ -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">å½“å‰é€‰ä¸­</div>
        <div class="selected-card-info empty" id="selectedCardInfo">æœªé€‰ä¸­å¡ç‰‡</div>
      </div>

      <!-- â­ æ˜Ÿæ ‡å¸¸ç”¨åŠŸèƒ½åŒº -->
      <!-- æš‚æ—¶æ³¨é‡Šï¼šåŒå‘é“¾æ¥åŠŸèƒ½å·²ç§»è‡³å¡ç‰‡æ“ä½œå›¾æ ‡ -->
      <!--
      <div class="sidebar-section sidebar-section--starred">
        <div class="sidebar-section-title">â­ å¸¸ç”¨åŠŸèƒ½</div>
        <button class="sidebar-btn" id="bidirectionalLinkFromeFocusNoteToTargetNoteBtn" type="button" disabled>
          <span>ğŸ”—</span>
          <span>FocusNote ä¸é€‰ä¸­å¡ç‰‡åŒå‘é“¾æ¥</span>
        </button>
      </div>
      -->

      <!-- ä¸ focusNote äº¤äº’åŒº -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">ä¸ focusNote äº¤äº’</div>

        <!-- åˆå¹¶æ“ä½œç»„ -->
        <div class="sidebar-btn-group sidebar-btn-group--merge">
          <div class="sidebar-btn-group-label">
            <span>ğŸ”—</span>
            <span>åˆå¹¶æ“ä½œ</span>
          </div>
          <button class="sidebar-btn sidebar-btn--grouped" id="mergeFocusNoteToTargetNoteExcerptPartBtn" type="button" disabled>
            <span>åˆå¹¶ FocusNote åˆ°é€‰ä¸­å¡ç‰‡çš„æ‘˜å½•åŒº</span>
          </button>
          <button class="sidebar-btn sidebar-btn--grouped" id="clearTitleAndMergeFocusNoteToTargetNoteExcerptPartBtn" type="button" disabled>
            <span>æ¸…ç©º FocusNote æ ‡é¢˜ & åˆå¹¶åˆ°é€‰ä¸­å¡ç‰‡çš„æ‘˜å½•åŒº</span>
          </button>
        </div>

        <!-- ç§»åŠ¨æ“ä½œç»„ -->
        <div class="sidebar-btn-group sidebar-btn-group--move">
          <div class="sidebar-btn-group-label">
            <span>ğŸ—ºï¸</span>
            <span>ç§»åŠ¨æ“ä½œ</span>
          </div>
          <button class="sidebar-btn sidebar-btn--grouped" id="moveFocusNoteToTargetNoteAsChildBtn" type="button" disabled>
            <span>ç§»åŠ¨ FocusNote æˆä¸ºé€‰ä¸­å¡ç‰‡çš„å­å¡ç‰‡</span>
          </button>
          <button class="sidebar-btn sidebar-btn--grouped" id="moveFocusNoteToTargetNoteAsChildAndLocateBtn" type="button" disabled>
            <span>ç§»åŠ¨ FocusNote æˆä¸ºé€‰ä¸­å¡ç‰‡çš„å­å¡ç‰‡ & ä¸»è„‘å›¾å®šä½ FocusNote</span>
          </button>
          <button class="sidebar-btn sidebar-btn--grouped" id="moveFocusNoteToTargetNoteAsChildAndMakeNoteBtn" type="button" disabled>
            <span>ç§»åŠ¨ FocusNote æˆä¸ºé€‰ä¸­å¡ç‰‡çš„å­å¡ç‰‡ & åˆ¶å¡</span>
          </button>
          <button class="sidebar-btn sidebar-btn--grouped" id="moveFocusNoteToTargetNoteAsChildAndMakeNoteAndLocateBtn" type="button" disabled>
            <span>ç§»åŠ¨ FocusNote æˆä¸ºé€‰ä¸­å¡ç‰‡çš„å­å¡ç‰‡ & åˆ¶å¡ & ä¸»è„‘å›¾å®šä½ FocusNote</span>
          </button>
        </div>

        <!-- æ¨¡æ¿æ“ä½œç»„ -->
        <div class="sidebar-btn-group sidebar-btn-group--template">
          <div class="sidebar-btn-group-label">
            <span>ğŸ“‹</span>
            <span>æ¨¡æ¿æ“ä½œ</span>
          </div>
          <button class="sidebar-btn sidebar-btn--grouped" id="addTemplateToTargetNoteAndMoveFocusNoteAsChildBtn" type="button" disabled>
            <span>é€‰ä¸­å¡ç‰‡å¢åŠ å½’ç±»å¡ç‰‡ & æ·»åŠ  FocusNote ä¸ºæ–°å½’ç±»å¡ç‰‡çš„å­å¡ç‰‡</span>
          </button>
          <button class="sidebar-btn sidebar-btn--grouped" id="addTemplateToTargetNoteAndMoveFocusNoteAsChildAndLocateBtn" type="button" disabled>
            <span>é€‰ä¸­å¡ç‰‡å¢åŠ å½’ç±»å¡ç‰‡ & æ·»åŠ  FocusNote ä¸ºæ–°å½’ç±»å¡ç‰‡çš„å­å¡ç‰‡ & ä¸»è„‘å›¾å®šä½ FocusNote</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- å³ä¾§å¡ç‰‡åŒºåŸŸ -->
    <div class="container">
      <div class="results" id="results"></div>
      <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
      <div id="loadMoreContainer" style="display: none; text-align: center; padding: 20px 0;">
        <button id="loadMoreBtn" style="
          padding: 12px 32px;
          background: var(--accent);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.3s ease;
        " onmouseover="this.style.background='#1b6cef'" onmouseout="this.style.background='var(--accent)'">
          åŠ è½½æ›´å¤š
        </button>
        <div id="loadingIndicator" style="display: none; color: var(--accent); font-size: 14px;">
          åŠ è½½ä¸­...
        </div>
      </div>
    </div>

    <!-- AI åŠ©æ‰‹ä¾§è¾¹æ  -->
    <aside class="ai-sidebar" id="aiSidebar">
      <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
      <div class="ai-sidebar-header">
        <h3>ğŸ¤– AI åŠ©æ‰‹</h3>
        <button class="ai-close-btn" id="aiCloseBtn" type="button" aria-label="å…³é—­ AI åŠ©æ‰‹">
          âœ•
        </button>
      </div>

      <!-- ä¸Šä¸‹æ–‡ä¿¡æ¯åŒºåŸŸ -->
      <div class="ai-context-info" id="aiContextInfo">
        <div class="ai-context-label">ğŸ“š å½“å‰ä¸Šä¸‹æ–‡ï¼š</div>
        <div class="ai-context-cards" id="aiContextCards">
          <span class="ai-context-empty">æœç´¢åå°†è‡ªåŠ¨é€‰æ‹©ç›¸å…³å¡ç‰‡ä½œä¸ºä¸Šä¸‹æ–‡</span>
        </div>
      </div>

      <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
      <div class="ai-messages" id="aiMessages">
        <div class="ai-welcome-message">
          <p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯çŸ¥è¯†åº“ AI åŠ©æ‰‹ã€‚</p>
          <p>æˆ‘å¯ä»¥åŸºäºä½ çš„çŸ¥è¯†åº“å†…å®¹å›ç­”é—®é¢˜ã€‚</p>
          <p>ğŸ’¡ <strong>æç¤º</strong>ï¼šå…ˆæœç´¢ç›¸å…³å†…å®¹ï¼Œæˆ‘ä¼šè‡ªåŠ¨ä½¿ç”¨æœç´¢ç»“æœä½œä¸ºä¸Šä¸‹æ–‡æ¥å›ç­”ä½ çš„é—®é¢˜ã€‚</p>
        </div>
      </div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="ai-input-area">
        <textarea
          class="ai-input"
          id="aiInput"
          placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
          rows="2"
        ></textarea>
        <button class="ai-send-btn" id="aiSendBtn" type="button">
          <span class="ai-send-icon">ğŸ“¤</span>
          <span class="ai-send-text">å‘é€</span>
        </button>
      </div>

      <!-- åŠ è½½çŠ¶æ€ -->
      <div class="ai-loading" id="aiLoading" style="display: none;">
        <div class="ai-loading-spinner"></div>
        <span>AI æ­£åœ¨æ€è€ƒ...</span>
      </div>
    </aside>

    <!-- AI åˆ‡æ¢æŒ‰é’® (å›ºå®šåœ¨å³ä¸Šè§’) - æš‚æ—¶éšè— -->
    <button class="ai-toggle-btn" id="aiToggleBtn" type="button" aria-label="æ‰“å¼€/å…³é—­ AI åŠ©æ‰‹" style="display: none;">
      <span class="ai-toggle-icon">ğŸ¤–</span>
      <span class="ai-toggle-text">AI åŠ©æ‰‹</span>
    </button>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
  <button class="scroll-to-top" id="scrollToTopBtn" type="button" aria-label="è¿”å›é¡¶éƒ¨">
    â¬†ï¸
  </button>

  <script>
    // ========================================
    // Bridge å¯¹è±¡ - Native â†” JS é€šä¿¡æ¥å£
    // ========================================
    window.Bridge = {
      /**
       * åŠ è½½æœç´¢ç´¢å¼•æ•°æ® (Native â†’ JS)
       * @param {Object} indexData - ç´¢å¼•æ•°æ®å¯¹è±¡
       * @param {Array} indexData.cards - å¡ç‰‡æ•°ç»„
       */
      loadSearchIndex: function(indexData) {
        console.log('Bridge.loadSearchIndex è¢«è°ƒç”¨', indexData);

        // ğŸ†• ä¿å­˜ç´¢å¼•æ¨¡å¼ä¿¡æ¯å’Œå®Œæ•´ metadata
        if (indexData.metadata) {
          state.metadata = indexData.metadata; // ä¿å­˜å®Œæ•´ metadataï¼ˆåŒ…å« updateTime, totalCards ç­‰ï¼‰
          state.indexMode = indexData.metadata.mode; // "full", "light", æˆ– "legacy"
          console.log('å½“å‰ç´¢å¼•æ¨¡å¼:', state.indexMode);
          console.log('ç´¢å¼•æ›´æ–°æ—¶é—´:', state.metadata.updateTime);
          // æ›´æ–°ç•Œé¢æ˜¾ç¤º
          if (typeof updateIndexModeBadge === 'function') {
            updateIndexModeBadge();
          }
        }

        // åŠ è½½æ’é™¤è¯ç»„é…ç½®
        if (indexData.exclusionGroups) {
          state.exclusionGroups = indexData.exclusionGroups;
          console.log('å·²åŠ è½½æ’é™¤è¯ç»„é…ç½®ï¼š', state.exclusionGroups.length, 'ä¸ª');
        }

        // ä½¿ç”¨ MNKB API æˆ–ç›´æ¥è°ƒç”¨ setCardsForDataset
        if (window.MNKB && typeof window.MNKB.setSearchResults === 'function') {
          window.MNKB.setSearchResults(indexData.cards || []);
        } else if (typeof setCardsForDataset === 'function') {
          setCardsForDataset('knowledge', indexData.cards || []);
        } else {
          console.error('æ— æ³•åŠ è½½æ•°æ®ï¼šsetCardsForDataset å’Œ MNKB.setSearchResults éƒ½æœªå®šä¹‰');
        }
      },

      /**
       * åˆ·æ–°æ‰€æœ‰æ•°æ® (JS â†’ Native)
       * é€šè¿‡ URL scheme è§¦å‘å®Œæ•´çš„é‡æ–°æ‰“å¼€æµç¨‹ï¼Œç¡®ä¿æ•°æ®å®Œå…¨é‡è½½
       */
      refreshAllData: function() {
        console.log('[Bridge] refreshAllData è¢«è°ƒç”¨ - è§¦å‘å®Œæ•´é‡è½½');
        // ä½¿ç”¨ reopenSearchView è§¦å‘å®Œæ•´çš„çª—å£é‡è½½æµç¨‹
        // è¿™æ ·å¯ä»¥ç¡®ä¿ç´¢å¼•æ•°æ®ã€å¾½ç« æ—¶é—´ç­‰æ‰€æœ‰ä¿¡æ¯éƒ½æ­£ç¡®æ›´æ–°
        window.location.href = 'mnknowledgebase://reopenSearchView';
      },

      /**
       * æ›´æ–°æœç´¢ç»“æœ (Native â†’ JS)
       * @param {Array} results - æœç´¢ç»“æœæ•°ç»„
       */
      updateResults: function(results) {
        console.log('Bridge.updateResults è¢«è°ƒç”¨', results);
        // ä½¿ç”¨ MNKB API æˆ–ç›´æ¥è°ƒç”¨ setCardsForDataset
        if (window.MNKB && typeof window.MNKB.setSearchResults === 'function') {
          window.MNKB.setSearchResults(results || []);
        } else if (typeof setCardsForDataset === 'function') {
          setCardsForDataset('knowledge', results || []);
        } else {
          console.error('æ— æ³•æ›´æ–°ç»“æœï¼šsetCardsForDataset å’Œ MNKB.setSearchResults éƒ½æœªå®šä¹‰');
        }
      },

      /**
       * é€šçŸ¥åˆå§‹åŒ–å®Œæˆ (JS â†’ Native)
       */
      notifyReady: function() {
        console.log('Bridge.notifyReady è¢«è°ƒç”¨');
        try {
          window.location.href = 'mnknowledgebase://ready';
        } catch (error) {
          console.warn('notifyReady å¤±è´¥', error);
        }
      },

      /**
       * å‘é€æ—¥å¿—åˆ° Native ç«¯ (JS â†’ Native)
       * @param {string} message - æ—¥å¿—æ¶ˆæ¯
       */
      logToNative: function(message) {
        try {
          const encodedMessage = encodeURIComponent(message);
          window.location.href = `mnknowledgebase://htmlLog?message=${encodedMessage}`;
        } catch (error) {
          console.error('logToNative å¤±è´¥:', error);
        }
      },

      /**
       * è¾“å‡ºæ—¥å¿—åˆ°åŸç”Ÿå±‚ (JS â†’ Native)
       * @param {string} message - æ—¥å¿—æ¶ˆæ¯
       */
      log: function(message) {
        console.log('[Bridge.log]', message);
        try {
          // ä½¿ç”¨ postBridge å‘é€æ—¥å¿—åˆ°åŸç”Ÿå±‚
          postBridge('htmlLog', { message: '[HTML] ' + message });
        } catch (error) {
          console.warn('æ—¥å¿—è¾“å‡ºå¤±è´¥', error);
        }
      },

      /**
       * æ¥æ”¶ AI å“åº” (Native â†’ JS)
       * @param {string} response - AI çš„å“åº”æ–‡æœ¬
       */
      receiveAIResponse: function(response) {
        console.log('[Bridge] æ”¶åˆ° AI å“åº”ï¼Œé•¿åº¦:', response.length);
        if (typeof window.AIHelper !== 'undefined' && window.AIHelper.displayAssistantMessage) {
          window.AIHelper.displayAssistantMessage(response);
        } else {
          console.error('AIHelper æœªåˆå§‹åŒ–');
        }
      },

      /**
       * æ¥æ”¶ AI é”™è¯¯ (Native â†’ JS)
       * @param {string} errorMsg - é”™è¯¯æ¶ˆæ¯
       */
      receiveAIError: function(errorMsg) {
        console.error('[Bridge] AI è°ƒç”¨é”™è¯¯:', errorMsg);
        if (typeof window.AIHelper !== 'undefined' && window.AIHelper.displayErrorMessage) {
          window.AIHelper.displayErrorMessage(errorMsg);
        } else {
          console.error('AIHelper æœªåˆå§‹åŒ–');
        }
      },

      /**
       * æ˜¾ç¤º AI æ¨èçš„å¡ç‰‡ (Native â†’ JS)
       * @param {Array<string>} cardIds - æ¨èçš„å¡ç‰‡ ID æ•°ç»„
       */
      showAIRecommendations: function(cardIds) {
        const log = (msg) => window.Bridge.logToNative(msg);

        log('========================================');
        log('[Bridge] showAIRecommendations è¢«è°ƒç”¨');
        log('[Bridge] æ¥æ”¶åˆ°çš„å¡ç‰‡ ID æ•°é‡: ' + cardIds.length);
        log('[Bridge] å¡ç‰‡ ID åˆ—è¡¨: ' + JSON.stringify(cardIds));
        log('[Bridge] state.cards æ€»æ•°: ' + (state.cards ? state.cards.length : 'undefined'));

        try {
          // 1. éªŒè¯å‚æ•°
          if (!Array.isArray(cardIds) || cardIds.length === 0) {
            log('[Bridge] âŒ æ— æ•ˆçš„å¡ç‰‡ ID æ•°ç»„');
            return;
          }

          // 2. ä» state.cards ä¸­æŸ¥æ‰¾å®Œæ•´çš„å¡ç‰‡æ•°æ®
          const recommendedCards = [];
          const notFoundIds = [];

          cardIds.forEach(id => {
            const card = state.cards.find(c => c.id === id);
            if (card) {
              log('[Bridge] âœ… æ‰¾åˆ°å¡ç‰‡: ' + card.title + ' (' + id + ')');
              recommendedCards.push(card);
            } else {
              log('[Bridge] âŒ æœªæ‰¾åˆ°å¡ç‰‡ ID: ' + id);
              notFoundIds.push(id);
            }
          });

          // 3. è°ƒè¯•ä¿¡æ¯
          log('[Bridge] ğŸ“Š æ‰¾åˆ° ' + recommendedCards.length + '/' + cardIds.length + ' å¼ å¡ç‰‡');
          if (notFoundIds.length > 0) {
            log('[Bridge] âš ï¸ æœªæ‰¾åˆ°çš„å¡ç‰‡ ID: ' + JSON.stringify(notFoundIds));
          }

          if (recommendedCards.length === 0) {
            log('[Bridge] âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ¨èå¡ç‰‡');
            return;
          }

          // 4. æ¸²æŸ“æ¨èå¡ç‰‡
          log('[Bridge] ğŸ¨ å¼€å§‹æ¸²æŸ“æ¨èå¡ç‰‡...');
          renderAIRecommendations(recommendedCards);
          log('[Bridge] âœ… æ¸²æŸ“å®Œæˆ');

          // 5. æ˜¾ç¤ºæ¨èé¢æ¿
          log('[Bridge] ğŸ‘€ æ˜¾ç¤ºæ¨èé¢æ¿...');
          showAIRecommendationsPanel();

          // æ£€æŸ¥é¢æ¿æ˜¯å¦çœŸçš„æ˜¾ç¤ºäº†
          const panel = document.getElementById('aiRecommendationsPanel');
          if (panel) {
            const hasShowClass = panel.classList.contains('show');
            log('[Bridge] é¢æ¿ show class çŠ¶æ€: ' + hasShowClass);
            log('[Bridge] é¢æ¿ classList: ' + Array.from(panel.classList).join(', '));

            setTimeout(() => {
              const transform = window.getComputedStyle(panel).transform;
              log('[Bridge] é¢æ¿ transform: ' + transform);
            }, 100);
          } else {
            log('[Bridge] âŒ æ‰¾ä¸åˆ°æ¨èé¢æ¿å…ƒç´ ï¼');
          }

          log('[Bridge] âœ… showAIRecommendations æ‰§è¡Œå®Œæˆï¼Œå·²åŠ è½½ ' + recommendedCards.length + ' å¼ æ¨èå¡ç‰‡');
          log('========================================');

        } catch (error) {
          log('[Bridge] âŒ showAIRecommendations å¤±è´¥: ' + error.message);
          log('[Bridge] é”™è¯¯å †æ ˆ: ' + error.stack);
        }
      },

    };

    // å…¨å±€å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºæ˜“è¯»æ ¼å¼
    window.formatUpdateTime = function(timestamp) {
      if (!timestamp) return '';

      // å…¼å®¹ç§’çº§å’Œæ¯«ç§’çº§æ—¶é—´æˆ³
      const ms = timestamp > 10000000000 ? timestamp : timestamp * 1000;
      const date = new Date(ms);

      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');

      return `${month}-${day} ${hour}:${minute}`;
    };

    // å…¨å±€å‡½æ•°ï¼šæ›´æ–°ç´¢å¼•æ¨¡å¼å¾½ç« 
    window.updateIndexModeBadge = function() {
      const badge = document.getElementById('indexModeBadge');
      if (!badge) return;

      // æ¸…é™¤æ‰€æœ‰æ¨¡å¼æ ·å¼
      badge.classList.remove('index-mode-badge--full', 'index-mode-badge--light', 'index-mode-badge--legacy');

      if (!window.state || !window.state.indexMode) {
        badge.textContent = '';
        return;
      }

      // è·å–æ›´æ–°æ—¶é—´
      const updateTimeStr = window.state.metadata?.updateTime
        ? ` (${formatUpdateTime(window.state.metadata.updateTime)})`
        : '';

      // æ ¹æ®ç´¢å¼•æ¨¡å¼è®¾ç½®æ˜¾ç¤º
      if (window.state.indexMode === 'full') {
        badge.textContent = `ğŸ” å…¨é‡ç´¢å¼•${updateTimeStr}`;
        badge.classList.add('index-mode-badge--full');
      } else if (window.state.indexMode === 'light') {
        badge.textContent = `ğŸ” è½»é‡ç´¢å¼•${updateTimeStr}`;
        badge.classList.add('index-mode-badge--light');
      } else if (window.state.indexMode === 'legacy') {
        badge.textContent = `ğŸ” æ—§ç‰ˆç´¢å¼•${updateTimeStr}`;
        badge.classList.add('index-mode-badge--legacy');
      }
    };

    (function () {
      'use strict';

      // é»˜è®¤é…ç½® - åˆ†å±‚çº§é¢„è®¾ç»“æ„
      const DEFAULT_PRESET_GROUPS = [
        {
          name: 'å½’ç±»å…³é”®è¯',
          icon: 'ğŸ“¦',
          presets: [
            { value: 'åŸºæœ¬æ€§è´¨' },
            {
              value: 'åˆ¤å®š',
              children: [
                { value: 'åˆ¤å®šï¼šå……åˆ†æ¡ä»¶' },
                { value: 'åˆ¤å®šï¼šç­‰ä»·åˆ»ç”»/å……è¦æ¡ä»¶' }
              ]
            }
          ]
        },
        {
          name: 'ç©ºé—´',
          icon: 'ğŸŒ',
          type: 'exclusive', 
          presets: [
            { 
              value: 'æ‹“æ‰‘ç©ºé—´',
              children: [
                { value: 'å¼€é›†' },
                { value: 'é—­é›†' },
                { value: 'ç´§é›†' },
                { value: 'å†…éƒ¨' },
                { value: 'é—­åŒ…' },
                { value: 'é‚»åŸŸ' },
                { value: 'å¼€é‚»åŸŸ' },
                { value: 'è¾¹ç•Œ' },
                { value: 'ç–æœ—é›†' },
                { value: 'ç¬¬ä¸€çº²é›†' },
                { value: 'ç¬¬äºŒçº²é›†' }
              ]
            },
            { value: 'åº¦é‡ç©ºé—´',
              children: [
                { value: 'å¼€çƒ' },
                { value: 'é—­çƒ' },
                { value: 'çƒé¢' },
                { value: 'å¼€å•ä½çƒ' },
                { value: 'é—­å•ä½çƒ' },
                { value: 'å•ä½çƒé¢' },
                { value: 'å¼€é›†' },
                { value: 'é—­é›†' },
                { value: 'ç´§é›†' },
                { value: 'åˆ—ç´§é›†' },
                { value: 'ç›¸å¯¹åˆ—ç´§é›†' },
                { value: 'å†…éƒ¨' },
                { value: 'é—­åŒ…' },
                { value: 'é‚»åŸŸ' },
                { value: 'å¼€é‚»åŸŸ' },
                { value: 'è¾¹ç•Œ' },
                { value: 'ç–æœ—é›†' },
                { value: 'ç¬¬ä¸€çº²é›†' },
                { value: 'ç¬¬äºŒçº²é›†' }
              ]
            },
            {
              value: 'èµ‹èŒƒçº¿æ€§ç©ºé—´',
              children: [
                {
                  value: 'ä¹‹é—´çš„',
                  children: [
                    { value: 'çº¿æ€§ç®—å­' },
                    { value: 'æœ‰ç•Œçº¿æ€§ç®—å­' },
                    { value: 'é—­ç®—å­' },
                    { value: 'å¼€æ˜ å°„' },
                    { value: 'é—­å€¼åŸŸç®—å­' },
                  ]
                },
                {
                  value: 'åˆ°è‡ªèº«çš„ç®—å­',
                  children: [
                    { value: 'çº¿æ€§ç®—å­' },
                    { value: 'æœ‰ç•Œçº¿æ€§ç®—å­' },
                    { value: 'é—­ç®—å­' },
                    { value: 'å¼€æ˜ å°„' },
                    { value: 'é—­å€¼åŸŸç®—å­' },
                  ]
                },
              ]
            },
            { 
              value: 'Banach ç©ºé—´',
              children: [
                {
                  value: 'ä¹‹é—´çš„',
                  children: [
                    { value: 'çº¿æ€§ç®—å­' },
                    { value: 'æœ‰ç•Œçº¿æ€§ç®—å­' },
                    { value: 'é—­ç®—å­' },
                    { value: 'å¼€æ˜ å°„' },
                    { value: 'é—­å€¼åŸŸç®—å­' },
                  ]
                },
                {
                  value: 'åˆ°è‡ªèº«çš„ç®—å­',
                  children: [
                    { value: 'çº¿æ€§ç®—å­' },
                    { value: 'æœ‰ç•Œçº¿æ€§ç®—å­' },
                    { value: 'é—­ç®—å­' },
                    { value: 'å¼€æ˜ å°„' },
                    { value: 'é—­å€¼åŸŸç®—å­' },
                  ]
                },
              ]
            },
            { 
              value: 'å†…ç§¯ç©ºé—´',
              children: [
                {
                  value: 'åˆ°è‡ªèº«çš„ç®—å­',
                  children: [
                    { value: 'çº¿æ€§ç®—å­'},
                    { value: 'æœ‰ç•Œçº¿æ€§ç®—å­'},
                    { value: 'ç´§ç®—å­' },
                    { value: 'ä¼´éšç®—å­' },
                    { value: 'æ­£è§„ç®—å­' }
                  ]
                },
                {
                  value: 'ä¹‹é—´çš„',
                  children: [
                    { value: 'çº¿æ€§ç®—å­'},
                    { value: 'æœ‰ç•Œçº¿æ€§ç®—å­'},
                    { value: 'ç´§ç®—å­' },
                    { value: 'ä¼´éšç®—å­' },
                  ]
                },
              ]
            },
            { 
              value: 'Hilbert ç©ºé—´',
              children: [
                {
                  value: 'åˆ°è‡ªèº«çš„ç®—å­',
                  children: [
                    { value: 'çº¿æ€§ç®—å­'},
                    { value: 'æœ‰ç•Œçº¿æ€§ç®—å­'},
                    { value: 'ç´§ç®—å­' },
                    { value: 'ä¼´éšç®—å­' },
                    { value: 'æ­£è§„ç®—å­' }
                  ]
                },
                {
                  value: 'ä¹‹é—´çš„',
                  children: [
                    { value: 'çº¿æ€§ç®—å­'},
                    { value: 'æœ‰ç•Œçº¿æ€§ç®—å­'},
                    { value: 'ç´§ç®—å­' },
                    { value: 'ä¼´éšç®—å­' },
                  ]
                },
              ]
            }
          ]
        },
        {
          name: 'æ˜ å°„/å‡½æ•°',
          icon: 'âš¡',
          type: 'exclusive',  // äº’æ–¥ç»„
          presets: [
            {
              value: 'æ˜ å°„',
              children: [
                { value: 'çº¿æ€§æ˜ å°„' },
                { value: 'çº¿æ€§å˜æ¢' },
              ]
            },
            {
              value: 'å‡½æ•°',
              children: [
                { value: 'å®å€¼å‡½æ•°' },
                { value: 'å¤å€¼å‡½æ•°' },
                {
                  value: 'æ³›å‡½',
                  children: [
                    { value: 'å®å€¼æ³›å‡½' },
                    { value: 'å¤å€¼æ³›å‡½' },
                    {
                      value: 'çº¿æ€§æ³›å‡½',
                      children: [
                        { value: 'å®å€¼çº¿æ€§æ³›å‡½' },
                        { value: 'å¤å€¼çº¿æ€§æ³›å‡½' },
                        {
                          value: 'æœ‰ç•Œçº¿æ€§æ³›å‡½',
                          children: [
                            { value: 'å®å€¼æœ‰ç•Œçº¿æ€§æ³›å‡½' },
                            { value: 'å¤å€¼æœ‰ç•Œçº¿æ€§æ³›å‡½' }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ];

      const DEFAULT_NEGATIVE_PRESETS = [
        'å®', 'å¤',
        'èµ‹èŒƒ',
        'â„Â²', 'â„Â³', 'â„â¿'
      ];

      // å¯¹é½ SearchConfig.typePresetsï¼Œä¾¿äºåç»­ä¸ utils.js ä¿æŒä¸€è‡´
      const RAW_TYPE_LABEL = 'æœªåˆ†ç±»';

      const DEFAULT_TYPE_FILTERS = [
        { key: 'all', label: 'å…¨éƒ¨ç±»å‹', types: null },
        { key: 'classifications', label: 'å½’ç±»', types: ['å½’ç±»'] },
        { key: 'definitions', label: 'å®šä¹‰', types: ['å®šä¹‰'] },
        { key: 'definitionsAndClassifications', label: 'å®šä¹‰ä¸å½’ç±»', types: ['å®šä¹‰', 'å½’ç±»'] },
        { key: 'knowledge', label: 'çŸ¥è¯†ç‚¹å¡ç‰‡', types: ['å®šä¹‰', 'å‘½é¢˜', 'ä¾‹å­', 'åä¾‹', 'æ€æƒ³æ–¹æ³•', 'çŸ¥è¯†'] },
        { key: 'propositions', label: 'å‘½é¢˜', types: ['å‘½é¢˜'] },
        { key: 'examples', label: 'ä¾‹å­', types: ['ä¾‹å­'] },
        { key: 'counterexamples', label: 'åä¾‹', types: ['åä¾‹'] },
        { key: 'methods', label: 'æ€æƒ³æ–¹æ³•', types: ['æ€æƒ³æ–¹æ³•'] },
        { key: 'problems', label: 'é—®é¢˜', types: ['é—®é¢˜'] },
        { key: 'ideas', label: 'æ€è·¯', types: ['æ€è·¯'] },
        { key: 'research', label: 'ç ”ç©¶è¿›å±•', types: ['ç ”ç©¶è¿›å±•'] },
        { key: 'papers', label: 'è®ºæ–‡', types: ['è®ºæ–‡'] },
        { key: 'untagged', label: RAW_TYPE_LABEL, types: [RAW_TYPE_LABEL] },
      ];

      // é¢œè‰²æ˜ å°„ï¼šä¼˜å…ˆç±»å‹ã€å…¶æ¬¡é¢œè‰²ç´¢å¼•ï¼Œæœ€åå›é€€è‰²
      const TYPE_COLOR_MAP = {
        å®šä¹‰: '#7bb8ff',
        å‘½é¢˜: '#5569ff',
        ä¾‹å­: '#8f7bff',
        åä¾‹: '#ff7b7b',
        å½’ç±»: '#ffd07b',
        æ€æƒ³æ–¹æ³•: '#5bd0a9',
        é—®é¢˜: '#ffa857',
        æ€è·¯: '#50c4a4',
        ç ”ç©¶è¿›å±•: '#5fa3ff',
        ç ”ç©¶: '#5fa3ff',
        è®ºæ–‡: '#a36bff',
        ä¹¦ä½œ: '#a36bff',
        ä½œè€…: '#7bb8ff',
        æ€»ç»“: '#7d8799',
        çŸ¥è¯†: '#7bb8ff',
        æœªåˆ†ç±»: '#b7c2d0',
      };

      const COLOR_INDEX_PALETTE = {
        0: '#ffd07b',
        1: '#ffb37b',
        2: '#7bb8ff',
        3: '#ff7b7b',
        4: '#ff9db5',
        5: '#5bd0a9',
        6: '#5fa3ff',
        7: '#aa7bff',
        8: '#ff9d4d',
        9: '#339972',
        10: '#5067ff',
        11: '#a36bff',
        12: '#ff914d',
        13: '#4d9dff',
        14: '#ffbf5f',
        15: '#b5bac7',
      };

      // å‡æ•°æ®ï¼šæœ¬åœ°é¢„è§ˆç”¨ï¼ŒçœŸå®ç¯å¢ƒé€šè¿‡åŸç”Ÿæ³¨å…¥
      const FAKE_CARDS = [
        { id: 'card-1001', title: 'æœºå™¨å­¦ä¹ æ¦‚è¿°', type: 'å®šä¹‰', color: '#7bb8ff', searchText: 'æœºå™¨å­¦ä¹  åŸºæœ¬æ¦‚å¿µ ç›‘ç£å­¦ä¹  æ— ç›‘ç£å­¦ä¹ ' },
        { id: 'card-1002', title: 'æ·±åº¦å­¦ä¹ ä¸ç¥ç»ç½‘ç»œ', type: 'å‘½é¢˜', color: '#5569ff', searchText: 'æ·±åº¦å­¦ä¹  ç¥ç»ç½‘ç»œ å·ç§¯ç¥ç»ç½‘ç»œ CNN RNN è¡¨å¾ å­¦ä¹ ' },
        { id: 'card-1003', title: 'æ”¯æŒå‘é‡æœºï¼ˆSVMï¼‰', type: 'å®šä¹‰', color: '#ff7b7b', searchText: 'æ”¯æŒå‘é‡æœº SVM åˆ†ç±» ç®—æ³•' },
        { id: 'card-1004', title: 'è‡ªç„¶è¯­è¨€å¤„ç†ç®€ä»‹', type: 'æ€æƒ³æ–¹æ³•', color: '#5bd0a9', searchText: 'è‡ªç„¶è¯­è¨€å¤„ç† NLP è¯å‘é‡ BERT' },
        { id: 'card-1005', title: 'å·ç§¯ ç¥ç» ç½‘ç»œ è¯¦è§£', type: 'å½’ç±»', classificationSubtype: 'å‘½é¢˜', color: '#ffd07b', searchText: 'å·ç§¯ ç¥ç» ç½‘ç»œ å·ç§¯ æ± åŒ–' },
        { id: 'card-1006', title: 'ä¼˜åŒ–ç®—æ³•å¯¹æ¯”', type: 'æ€æƒ³æ–¹æ³•', color: '#5bd0a9', searchText: 'æ¢¯åº¦ä¸‹é™ Adam RMSprop ä¼˜åŒ– å­¦ä¹ ç‡ è°ƒåº¦' },
        { id: 'card-1007', title: 'æ£€ç´¢ç³»ç»Ÿæ¦‚å¿µ', type: 'å®šä¹‰', color: '#7bb8ff', searchText: 'ä¿¡æ¯æ£€ç´¢ æœç´¢ æ’åº å€’æ’ç´¢å¼• æŸ¥è¯¢ æ‰©å±•' },
        { id: 'card-1008', title: 'æ³¨æ„åŠ›æœºåˆ¶ï¼ˆAttentionï¼‰', type: 'å‘½é¢˜', color: '#5569ff', searchText: 'æ³¨æ„åŠ› æœºåˆ¶ Transformer è‡ªæ³¨æ„åŠ›' },
        { id: 'card-1009', title: 'åŠç›‘ç£å­¦ä¹ å®ä¾‹', type: 'ä¾‹å­', color: '#8f7bff', searchText: 'åŠç›‘ç£ å­¦ä¹  å®ä¾‹ åº”ç”¨' },
        { id: 'card-1010', title: 'Evaluation Metrics', type: 'å®šä¹‰', color: '#7bb8ff', searchText: 'precision recall F1 score æ··æ·†çŸ©é˜µ' },
        { id: 'card-1011', title: 'Neural Network Architectures', type: 'å½’ç±»', classificationSubtype: 'ä¾‹å­', color: '#ffd07b', searchText: 'MLP CNN RNN Transformer architectures' },
        { id: 'card-1012', title: 'Embedding Techniques', type: 'ä¾‹å­', color: '#8f7bff', searchText: 'è¯å‘é‡ embedding word2vec GloVe BERT' },
        { id: 'card-2001', title: 'å¤ Hilbert ç©ºé—´ ä¸­çš„æ€§è´¨', type: 'å‘½é¢˜', color: '#5569ff', searchText: 'Hilbert ç©ºé—´ å¤ æ•° çº¿æ€§ ä»£æ•° å†…ç§¯ ç©ºé—´' },
        { id: 'card-2002', title: 'å® Hilbert ç©ºé—´ ç¤ºä¾‹', type: 'å‘½é¢˜', color: '#5569ff', searchText: 'Hilbert ç©ºé—´ å® æ•° ä¾‹å­ æ­£äº¤ åŸº' },
        { id: 'card-2003', title: 'å¤šé¡¹å¼ å›å½’ çš„é²æ£’æ€§', type: 'æ€æƒ³æ–¹æ³•', color: '#5bd0a9', searchText: 'å›å½’ å¤šé¡¹å¼ å›å½’ è¿‡æ‹Ÿåˆ æ­£åˆ™åŒ–' },
        { id: 'card-2004', title: 'å™ªå£° åˆ†æ æ–¹æ³•', type: 'æ€æƒ³æ–¹æ³•', color: '#5bd0a9', searchText: 'å™ªå£° ä¿¡å· è¿‡æ»¤ å»å™ª è°± åˆ†æ' },
        { id: 'card-2005', title: 'å¼‚å¸¸ å€¼ æ£€æµ‹ æŠ€æœ¯', type: 'æ€æƒ³æ–¹æ³•', color: '#5bd0a9', searchText: 'å¼‚å¸¸ å€¼ æ£€æµ‹ å¼‚å¸¸ æ•°æ® ç¦»ç¾¤ ç‚¹' },
        { id: 'card-2101', title: 'ç»Ÿè®¡å­¦ä¹ ç†è®ºæ ¸å¿ƒé—®é¢˜', type: 'é—®é¢˜', color: '#ffa857', searchText: 'ç»Ÿè®¡ å­¦ä¹  ç†è®º æ³›åŒ– èƒ½åŠ› VC ç»´ ç»éªŒ é£é™©' },
        { id: 'card-2102', title: 'æ¢¯åº¦æ¶ˆå¤±çš„æ’æŸ¥æ€è·¯', type: 'æ€è·¯', color: '#50c4a4', searchText: 'æ¢¯åº¦ æ¶ˆå¤± æ¿€æ´» å‡½æ•° æ‰¹é‡ å½’ä¸€åŒ– æ®‹å·® è¿æ¥ æ’æŸ¥ æµç¨‹' },
        { id: 'card-2103', title: 'Transformer ç ”ç©¶å‰æ²¿', type: 'ç ”ç©¶è¿›å±•', color: '#5fa3ff', searchText: 'Transformer ç ”ç©¶ å‰æ²¿ å¤šæ¨¡æ€ è§†è§‰ Transformers å‚æ•° é«˜æ•ˆ åŒ–' },
        { id: 'card-2104', title: 'æ³¨æ„åŠ›æœºåˆ¶ç»¼è¿°è®ºæ–‡', type: 'è®ºæ–‡', color: '#a36bff', searchText: 'æ³¨æ„åŠ› æœºåˆ¶ ç»¼è¿° è®ºæ–‡ å¼•ç”¨ ç»Ÿè®¡ Transformer åŸç†' },
        { id: 'card-2105', title: 'æ–‡çŒ®é˜…è¯»æçº²ï¼šæ·±åº¦æ¦‚ç‡æ¨¡å‹', type: 'å½’ç±»', classificationSubtype: 'å®šä¹‰', color: '#ffd07b', searchText: 'æ·±åº¦ æ¦‚ç‡ æ¨¡å‹ ç»“æ„ å­¦ä¹  å˜åˆ† æ¨æ–­ ç»¼è¿° æçº²' },
        { id: 'card-2106', title: 'å­¦ä¹ æ›²çº¿ä¸æ—©åœç­–ç•¥', type: 'æ€æƒ³æ–¹æ³•', color: '#5bd0a9', searchText: 'å­¦ä¹  æ›²çº¿ æ—©åœ éªŒè¯é›† è¿‡æ‹Ÿåˆ æ¨¡å‹ é€‰æ‹©' },
        { id: 'card-2107', title: 'å¼ é‡åˆ†è§£â€”â€”å®šä¹‰ä¸ä¾‹å­', type: 'å®šä¹‰', color: '#7bb8ff', searchText: 'å¼ é‡ åˆ†è§£ å®šä¹‰ Tucker CP åˆ†è§£ é«˜é˜¶ æ•°æ®' },
        { id: 'card-2108', title: 'å¼ é‡åˆ†è§£å¸¸è§åä¾‹', type: 'åä¾‹', color: '#ff7b7b', searchText: 'å¼ é‡ åˆ†è§£ åä¾‹ å”¯ä¸€æ€§ å¤±è´¥ æƒ…å†µ åä¾‹ æ„é€ ' },
        { id: 'card-2109', title: 'æ³›å‡½åˆ†æå…¥é—¨æçº²', type: 'å½’ç±»', classificationSubtype: 'å‘½é¢˜', color: '#ffd07b', searchText: 'æ³›å‡½ åˆ†æ å…¥é—¨ æçº² çº¿æ€§ ç©ºé—´ èµ‹èŒƒ ç©ºé—´ Banach' },
        { id: 'card-2110', title: 'Hilbert ç©ºé—´çš„å…¸å‹ä¾‹å­', type: 'ä¾‹å­', color: '#8f7bff', searchText: 'Hilbert ç©ºé—´ ä¾‹å­ L2 ç©ºé—´ Fourier åŸº æ­£äº¤ ç³»' },
        { id: 'card-2111', title: 'Hilbert ç©ºé—´çš„åä¾‹', type: 'åä¾‹', color: '#ff7b7b', searchText: 'Hilbert ç©ºé—´ åä¾‹ éå®Œå¤‡ å†…ç§¯ ç©ºé—´ counterexample' },
        { id: 'card-2112', title: 'ç»Ÿè®¡æ¨æ–­çš„å…³é”®å®šä¹‰', type: 'å®šä¹‰', color: '#7bb8ff', searchText: 'ç»Ÿè®¡ æ¨æ–­ å®šä¹‰ å‚æ•° ä¼°è®¡ å‡è®¾ æ£€éªŒ ç½®ä¿¡ åŒºé—´' },
        { id: 'card-2113', title: 'è´å¶æ–¯æ¨æ–­çš„æ€æƒ³æ–¹æ³•', type: 'æ€æƒ³æ–¹æ³•', color: '#5bd0a9', searchText: 'è´å¶æ–¯ æ¨æ–­ å…ˆéªŒ åéªŒ å…±è½­ åˆ†å¸ƒ ä¸ç¡®å®šæ€§' },
        { id: 'card-2114', title: 'æ¨¡å‹å‹ç¼©ç ”ç©¶è·¯çº¿', type: 'æ€è·¯', color: '#50c4a4', searchText: 'æ¨¡å‹ å‹ç¼© å‰ªæ é‡åŒ– çŸ¥è¯† è’¸é¦ ç ”ç©¶ è·¯çº¿' },
        { id: 'card-2115', title: 'å­¦ä¹ ç‡è°ƒåº¦å™¨å¯¹æ¯”', type: 'æ€æƒ³æ–¹æ³•', color: '#5bd0a9', searchText: 'å­¦ä¹ ç‡ è°ƒåº¦ ä½™å¼¦ é€€ç« çƒ­é‡å¯ å¾ªç¯ å­¦ä¹ ç‡ SEA' },
        { id: 'card-2116', title: 'ResNet è®¾è®¡æ¼”åŒ–å²', type: 'ç ”ç©¶è¿›å±•', color: '#5fa3ff', searchText: 'ResNet æ®‹å·® ç½‘ç»œ è®¾è®¡ æ¼”åŒ– å†å² å¤šåˆ†æ”¯ æ¶æ„' },
        { id: 'card-2117', title: 'æ·±åº¦å­¦ä¹ å¤±è´¥æ¡ˆä¾‹æ”¶é›†', type: 'åä¾‹', color: '#ff7b7b', searchText: 'æ·±åº¦ å­¦ä¹  å¤±è´¥ æ¡ˆä¾‹ æ¨¡å‹ å´©æºƒ å¯¹æŠ— æ ·æœ¬' },
      ];

      const FAKE_INTERMEDIATE = [
        { id: 'mid-3001', title: 'å¾…æ•´ç†ï¼šæµ‹åº¦è®ºé˜…è¯»æ€è·¯', type: 'æ€è·¯', color: '#50c4a4', searchText: 'æµ‹åº¦è®º é˜…è¯» æçº² ä»»åŠ¡ æ¸…å•', isTemplated: false },
        { id: 'mid-3002', title: 'å¾…æ€»ç»“ï¼šæ³›å‡½åˆ†ææœ¯è¯­', type: 'é—®é¢˜', color: '#ffa857', searchText: 'æ³›å‡½ åˆ†æ æœ¯è¯­ å¾…æ•´ç† åˆ—è¡¨', isTemplated: false },
        { id: 'mid-3003', title: 'è‰ç¨¿ï¼šHilbert ç©ºé—´è¯¾å ‚ç¬”è®°', searchText: 'Hilbert ç©ºé—´ è¯¾å ‚ ç¬”è®° è‰ç¨¿ éœ€è¦è¡¥å……', isTemplated: false },
        { id: 'mid-3004', title: 'å¾…ç¡®è®¤ï¼šæ³¨æ„åŠ›æœºåˆ¶èµ„æ–™æ”¶é›†', type: 'çŸ¥è¯†', color: '#5569ff', searchText: 'æ³¨æ„åŠ› æœºåˆ¶ èµ„æ–™ æ”¶é›† å‚è€ƒ é“¾æ¥ å¾…ç¡®è®¤', isTemplated: false },
        { id: 'mid-3005', title: 'ä¸´æ—¶ï¼šæ¢¯åº¦æ¶ˆå¤±å®éªŒè®°å½•', searchText: 'æ¢¯åº¦ æ¶ˆå¤± å®éªŒ è®°å½• å¾…æ€»ç»“ ç»“æœ', isTemplated: false },
        { id: 'mid-3006', title: 'å°šæœªåˆ†ç±»ï¼šéšæœºæƒ³æ³•å¤‡å¿˜', searchText: 'éšæœº æƒ³æ³• å¤‡å¿˜ ä¸´æ—¶ æ¡ç›® éœ€è¦ åˆ†ç±»', isTemplated: false },
      ];

      // åˆ†é¡µç›¸å…³å¸¸é‡
      const PAGE_SIZE = 50; // æ¯é¡µæ˜¾ç¤º50æ¡æ•°æ®
      const INITIAL_PAGE_SIZE = 100; // åˆå§‹åŠ è½½100æ¡ï¼Œæä¾›æ›´å¥½çš„åˆå§‹ä½“éªŒ

      // æš´éœ²åˆ° window ä»¥ä¾¿åŸç”Ÿå±‚è®¿é—®
      window.state = {
        config: {
          presetGroups: JSON.parse(JSON.stringify(DEFAULT_PRESET_GROUPS)),
          negativePresets: DEFAULT_NEGATIVE_PRESETS.slice(),
          typeFilters: DEFAULT_TYPE_FILTERS.slice(),
          typeColors: { ...TYPE_COLOR_MAP },
          colorIndexPalette: { ...COLOR_INDEX_PALETTE },
        },
        recentPresets: [],
        cards: FAKE_CARDS.slice(),
        filteredCards: [],
        activePresets: new Set(),
        activeNegativePresets: new Set(),
        expandedPresets: new Set(),  // è®°å½•å±•å¼€çš„é¢„è®¾é¡¹
        selectedCardId: null,
        userInput: '',
        currentTypeKey: 'all',
        classificationOptions: [],
        currentClassificationSubtype: 'all',
        lastQueryPayload: null,
        // åˆ†é¡µç›¸å…³çŠ¶æ€
        currentPage: 1,
        displayedCards: [],
        hasMore: false,
        isLoadingMore: false,
        // æ’é™¤è¯ç›¸å…³çŠ¶æ€
        exclusionGroups: [],  // å­˜å‚¨æ’é™¤è¯ç»„é…ç½®
        activeExclusions: null,  // å½“å‰æ¿€æ´»çš„æ’é™¤è¯ä¿¡æ¯
        // ç´¢å¼•æ¨¡å¼çŠ¶æ€
        indexMode: null,  // å½“å‰ç´¢å¼•æ¨¡å¼ï¼š"full"ï¼ˆå…¨é‡ï¼‰ã€"light"ï¼ˆè½»é‡ï¼‰ã€"legacy"ï¼ˆæ—§ç‰ˆï¼‰
        metadata: null  // å®Œæ•´çš„ metadata å¯¹è±¡ï¼ˆåŒ…å« updateTime, totalCards ç­‰ï¼‰
      };

      // æš´éœ²åˆ° window ä»¥ä¾¿è°ƒè¯•å’ŒåŸç”Ÿå±‚è®¿é—®
      window.dom = {
        typeSection: document.querySelector('[data-section="type"]'),
        presetSection: document.querySelector('[data-section="preset"]'),
        negativeSection: document.querySelector('[data-section="negative"]'),
        classificationSection: document.querySelector('[data-section="classification"]'),
        filtersPanel: document.getElementById('filtersPanel'),
        presetBar: document.getElementById('presetBar'),
        typeBar: document.getElementById('typeBar'),
        classificationBar: document.getElementById('classificationBar'),
        negativeBar: document.getElementById('negativeBar'),
        results: document.getElementById('results'),
        searchInput: document.getElementById('searchInput'),
        searchCount: document.getElementById('searchCount'),
        selectedCardInfo: document.getElementById('selectedCardInfo'),
        clearBtn: document.getElementById('clearBtn'),
        refreshBtn: document.getElementById('refreshBtn'),
        toggleFiltersBtn: document.getElementById('toggleFiltersBtn'),
        clearPresetsBtn: document.getElementById('clearPresetsBtn'),
        clearNegativesBtn: document.getElementById('clearNegativesBtn'),
        toast: document.getElementById('toast'),
        sidebar: document.getElementById('sidebar'),
        sidebarToggle: document.getElementById('sidebarToggle'),
        sidebarOverlay: document.getElementById('sidebarOverlay'),
        // Sidebar æŒ‰é’®ï¼ˆå·²ç§»é™¤ focusCardInFloatMindMapBtn å’Œ copyMarkdownLinkBtnï¼‰
        mergeFocusNoteToTargetNoteExcerptPartBtn: document.getElementById('mergeFocusNoteToTargetNoteExcerptPartBtn'),
        clearTitleAndMergeFocusNoteToTargetNoteExcerptPartBtn: document.getElementById('clearTitleAndMergeFocusNoteToTargetNoteExcerptPartBtn'),
        bidirectionalLinkFromeFocusNoteToTargetNoteBtn: document.getElementById('bidirectionalLinkFromeFocusNoteToTargetNoteBtn'),
        moveFocusNoteToTargetNoteAsChildBtn: document.getElementById('moveFocusNoteToTargetNoteAsChildBtn'),
        moveFocusNoteToTargetNoteAsChildAndLocateBtn: document.getElementById('moveFocusNoteToTargetNoteAsChildAndLocateBtn'),
        moveFocusNoteToTargetNoteAsChildAndMakeNoteBtn: document.getElementById('moveFocusNoteToTargetNoteAsChildAndMakeNoteBtn'),
        moveFocusNoteToTargetNoteAsChildAndMakeNoteAndLocateBtn: document.getElementById('moveFocusNoteToTargetNoteAsChildAndMakeNoteAndLocateBtn'),
        addTemplateToTargetNoteAndMoveFocusNoteAsChildBtn: document.getElementById('addTemplateToTargetNoteAndMoveFocusNoteAsChildBtn'),
        addTemplateToTargetNoteAndMoveFocusNoteAsChildAndLocateBtn: document.getElementById('addTemplateToTargetNoteAndMoveFocusNoteAsChildAndLocateBtn'),
        scrollToTopBtn: document.getElementById('scrollToTopBtn'),
        topbar: document.querySelector('.topbar'),
        container: document.querySelector('.container'),
        // åŠ è½½æ›´å¤šç›¸å…³
        loadMoreContainer: document.getElementById('loadMoreContainer'),
        loadMoreBtn: document.getElementById('loadMoreBtn'),
        loadingIndicator: document.getElementById('loadingIndicator'),
      };

      let toastTimer = null;
      let lastScrollY = 0;
      let isToolbarHidden = false;
      let isFilterPanelCollapsed = false;
      let isFilterPanelManuallySet = false;
      const debouncedInputHandler = debounce(handleSearchInputChange, 180);
      const isCompactLayout = () => window.innerWidth <= 1024;

      // ========== è¾…åŠ©å‡½æ•° ==========

      // æ ¼å¼å…¼å®¹ï¼šæ”¯æŒæ—§çš„æ•°ç»„æ ¼å¼å’Œæ–°çš„åˆ†ç»„æ ¼å¼
      function normalizePresetConfig(config) {
        if (!config) return [];
        if (Array.isArray(config)) {
          // æ—§æ ¼å¼ï¼š["è¯1", "è¯2"]
          if (config.length > 0 && typeof config[0] === 'string') {
            return [{ name: 'å¸¸ç”¨', presets: config }];
          }
          // æ–°æ ¼å¼ï¼š[{ name, presets }]
          return config;
        }
        return [];
      }

      // è·å–åŒ…å«"æœ€è¿‘ä½¿ç”¨"çš„åˆ†ç»„åˆ—è¡¨
      function getPresetGroupsWithRecent() {
        const groups = state.config.presetGroups ? [...state.config.presetGroups] : [];
        if (state.recentPresets && state.recentPresets.length > 0) {
          groups.unshift({
            name: 'æœ€è¿‘ä½¿ç”¨',
            icon: 'â±ï¸',
            presets: [...state.recentPresets],
            isRecent: true
          });
        }
        return groups;
      }

      // æ›´æ–°æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
      function updateRecentPresets(preset) {
        if (!preset) return;
        // ç§»é™¤æ—§è®°å½•
        state.recentPresets = state.recentPresets.filter(p => p !== preset);
        // æ·»åŠ åˆ°æœ€å‰é¢
        state.recentPresets.unshift(preset);
        // é™åˆ¶é•¿åº¦ä¸º 8
        if (state.recentPresets.length > 8) {
          state.recentPresets = state.recentPresets.slice(0, 8);
        }
        // ä¿å­˜åˆ° localStorage
        saveRecentPresets();
      }

      // ä¿å­˜æœ€è¿‘ä½¿ç”¨åˆ° localStorage
      function saveRecentPresets() {
        try {
          localStorage.setItem('mnkb_recent_presets', JSON.stringify(state.recentPresets));
        } catch (error) {
          console.warn('ä¿å­˜æœ€è¿‘ä½¿ç”¨å¤±è´¥', error);
        }
      }

      // ä» localStorage åŠ è½½æœ€è¿‘ä½¿ç”¨
      function loadRecentPresets() {
        try {
          const saved = localStorage.getItem('mnkb_recent_presets');
          if (saved) {
            state.recentPresets = JSON.parse(saved);
          }
        } catch (error) {
          console.warn('åŠ è½½æœ€è¿‘ä½¿ç”¨å¤±è´¥', error);
          state.recentPresets = [];
        }
      }

      // ========== åˆå§‹åŒ– ==========

      function init() {
        refreshClassificationOptions();
        renderPresetBar();
        renderTypeBar();
        renderNegativeBar();
        attachEventListeners();
        registerBridge();
        applyFilters(buildQueryPayload());
        loadToolbarStates(); // åŠ è½½å·¥å…·æ æŠ˜å çŠ¶æ€
        loadFilterPanelState(); // æ ¹æ®è§†å£è‡ªåŠ¨æŠ˜å ç­›é€‰é¢æ¿
        setupResponsive();
        setupScrollBehavior();
      }

      // ç»Ÿä¸€åˆå§‹åŒ–å‡½æ•°ï¼šç¡®ä¿ DOM å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
      function initAll() {
        // 1. ä¸»åº”ç”¨åˆå§‹åŒ–
        loadRecentPresets();
        init();

        // 2. AI åŠ©æ‰‹åˆå§‹åŒ–ï¼ˆç¡®ä¿åœ¨ä¸»åº”ç”¨åˆå§‹åŒ–ä¹‹åï¼‰
        if (window.AIHelper && typeof window.AIHelper.init === 'function') {
          window.AIHelper.init();
        }
      }

      // ç­‰å¾… DOM å°±ç»ªåç»Ÿä¸€åˆå§‹åŒ–
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAll);
      } else {
        initAll();
      }

      function setupResponsive() {
        // æ£€æµ‹æ˜¯å¦æ˜¯ç§»åŠ¨ç«¯æˆ– iPad ç«–å±
        const checkMobile = () => window.innerWidth <= 1024;
        const handleViewportChange = () => {
          applyFilterPanelState(isFilterPanelCollapsed, { skipSave: true });
        };

        // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
        if (dom.sidebarToggle) {
          dom.sidebarToggle.style.display = checkMobile() ? 'flex' : 'none';
        }
        handleViewportChange();

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
          if (dom.sidebarToggle) {
            dom.sidebarToggle.style.display = checkMobile() ? 'flex' : 'none';
          }
          if (!checkMobile()) {
            closeSidebar();
          }
          handleViewportChange();
        });
      }

      function setupScrollBehavior() {
        if (!dom.container) return;

        // ç®€åŒ–æ»šåŠ¨è¡Œä¸ºï¼šåªå¤„ç†è¿”å›é¡¶éƒ¨æŒ‰é’®çš„æ˜¾ç¤º/éšè—
        // ç§»é™¤äº†è‡ªåŠ¨éšè—æœç´¢æ çš„é€»è¾‘ï¼Œé¿å…é®æŒ¡å†…å®¹
        const handleScroll = () => {
          const currentScrollY = dom.container.scrollTop;

          // åªæ›´æ–°æ»šåŠ¨åˆ°é¡¶éƒ¨æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
          if (currentScrollY > 200) {
            dom.scrollToTopBtn?.classList.add('show');
          } else {
            dom.scrollToTopBtn?.classList.remove('show');
          }
        };

        // ç›‘å¬å®¹å™¨æ»šåŠ¨äº‹ä»¶ï¼ˆä½¿ç”¨é˜²æŠ–å¤„ç†ï¼‰
        let scrollTimer = null;
        dom.container.addEventListener('scroll', () => {
          if (scrollTimer) clearTimeout(scrollTimer);
          scrollTimer = setTimeout(handleScroll, 50);
        }, { passive: true });

        // è¿”å›é¡¶éƒ¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        dom.scrollToTopBtn?.addEventListener('click', scrollToTop);

        // åŠ è½½æ›´å¤šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        dom.loadMoreBtn?.addEventListener('click', loadMore);
      }

      function hideToolbars() {
        isToolbarHidden = true;

        // æ·»åŠ å…¨å±€éšè—çŠ¶æ€,è§¦å‘ padding-top çš„è¿‡æ¸¡
        document.body.classList.add('toolbar-hidden');

        // éšè—é¡¶éƒ¨æœç´¢æ 
        dom.topbar?.classList.add('hidden');

        // éšè—æ‰€æœ‰å·¥å…·æ 
        const toolbars = [
          dom.typeSection,
          dom.classificationSection,
          dom.presetSection,
          dom.negativeSection
        ];

        toolbars.forEach(toolbar => {
          if (toolbar && !toolbar.classList.contains('component-hidden')) {
            toolbar.classList.add('hidden');
          }
        });
      }

      function showToolbars() {
        isToolbarHidden = false;

        // ç§»é™¤å…¨å±€éšè—çŠ¶æ€,æ¢å¤ padding-top
        document.body.classList.remove('toolbar-hidden');

        // æ˜¾ç¤ºé¡¶éƒ¨æœç´¢æ 
        dom.topbar?.classList.remove('hidden');

        // æ˜¾ç¤ºæ‰€æœ‰å·¥å…·æ 
        const toolbars = [
          dom.typeSection,
          dom.classificationSection,
          dom.presetSection,
          dom.negativeSection
        ];

        toolbars.forEach(toolbar => {
          if (toolbar) {
            toolbar.classList.remove('hidden');
          }
        });
      }

      function scrollToTop() {
        if (!dom.container) return;

        // å¹³æ»‘æ»šåŠ¨åˆ°é¡¶éƒ¨
        dom.container.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      }

      // åŠ è½½æ›´å¤šåŠŸèƒ½
      function loadMore() {
        if (state.isLoadingMore || !state.hasMore) return;

        state.isLoadingMore = true;

        // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
        if (dom.loadMoreBtn) dom.loadMoreBtn.style.display = 'none';
        if (dom.loadingIndicator) dom.loadingIndicator.style.display = 'block';

        // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½ï¼ˆå®é™…æ˜¯åŒæ­¥çš„ï¼Œä½†ä½¿ç”¨ setTimeout é¿å…é˜»å¡UIï¼‰
        setTimeout(() => {
          const startIndex = state.displayedCards.length;
          const endIndex = Math.min(startIndex + PAGE_SIZE, state.filteredCards.length);
          const newCards = state.filteredCards.slice(startIndex, endIndex);

          // æ·»åŠ åˆ°æ˜¾ç¤ºåˆ—è¡¨
          state.displayedCards = [...state.displayedCards, ...newCards];
          state.hasMore = state.displayedCards.length < state.filteredCards.length;

          // è¿½åŠ æ¸²æŸ“æ–°å¡ç‰‡ï¼ˆè€Œä¸æ˜¯é‡æ–°æ¸²æŸ“å…¨éƒ¨ï¼‰
          appendCards(newCards);

          // æ›´æ–°åŠ è½½æ›´å¤šæŒ‰é’®çŠ¶æ€
          state.isLoadingMore = false;
          updateLoadMoreButton();
        }, 100);
      }

      // è¿½åŠ æ¸²æŸ“å¡ç‰‡ï¼ˆç”¨äºåŠ è½½æ›´å¤šï¼‰
      function appendCards(cards) {
        const fragment = document.createDocumentFragment();

        cards.forEach((card) => {
          const element = createCardElement(card);
          fragment.appendChild(element);
        });

        dom.results.appendChild(fragment);
        updateSearchCount(state.displayedCards.length);
      }

      // æ›´æ–°åŠ è½½æ›´å¤šæŒ‰é’®çŠ¶æ€
      function updateLoadMoreButton() {
        if (!dom.loadMoreContainer) return;

        if (state.hasMore && state.filteredCards.length > 0) {
          dom.loadMoreContainer.style.display = 'block';
          if (dom.loadMoreBtn) dom.loadMoreBtn.style.display = 'inline-block';
          if (dom.loadingIndicator) dom.loadingIndicator.style.display = 'none';

          // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå‰©ä½™æ•°é‡
          const remaining = state.filteredCards.length - state.displayedCards.length;
          if (dom.loadMoreBtn && remaining > 0) {
            dom.loadMoreBtn.textContent = `åŠ è½½æ›´å¤š (å‰©ä½™ ${remaining} é¡¹)`;
          }
        } else {
          dom.loadMoreContainer.style.display = 'none';
        }
      }

      function toggleSidebar() {
        if (!dom.sidebar) return;

        const isShow = dom.sidebar.classList.contains('show');
        if (isShow) {
          closeSidebar();
        } else {
          openSidebar();
        }
      }

      function openSidebar() {
        dom.sidebar?.classList.add('show');
        dom.sidebarOverlay?.classList.add('show');
      }

      function closeSidebar() {
        dom.sidebar?.classList.remove('show');
        dom.sidebarOverlay?.classList.remove('show');
      }

      // å¤„ç†å·¥å…·æ æŠ˜å /å±•å¼€
      function handleToolbarToggle(event) {
        const btn = event.currentTarget;
        const sectionName = btn.dataset.toggle;
        if (!sectionName) return;

        const content = document.querySelector(`[data-content="${sectionName}"]`);
        if (!content) return;

        const isCollapsed = content.classList.contains('collapsed');

        if (isCollapsed) {
          // å±•å¼€
          content.classList.remove('collapsed');
          btn.classList.remove('collapsed');
        } else {
          // æŠ˜å 
          content.classList.add('collapsed');
          btn.classList.add('collapsed');
        }

        // åŠ¨æ€è°ƒæ•´ main-layout çš„ padding-top
        updateMainPaddingTop();

        // ä¿å­˜æŠ˜å çŠ¶æ€åˆ° localStorage
        saveToolbarState(sectionName, !isCollapsed);
      }

      // åŠ¨æ€è®¡ç®—å¹¶æ›´æ–° main-layout çš„ padding-top
      function updateMainPaddingTop() {
        const topbarHeight = dom.topbar ? (dom.topbar.offsetHeight || 64) : 64;

        if (document.body.classList.contains('filters-collapsed') || isCompactLayout()) {
          document.documentElement.style.setProperty('--main-padding-top', `${topbarHeight + 20}px`);
          return;
        }

        let totalHeight = topbarHeight;

        // æ‰€æœ‰æ˜¾ç¤ºä¸”æœªæŠ˜å çš„å·¥å…·æ 
        document.querySelectorAll('.pill-section').forEach((section) => {
          if (section.classList.contains('component-hidden')) return;

          const content = section.querySelector('.pill-section__content');
          if (content && !content.classList.contains('collapsed')) {
            totalHeight += section.offsetHeight || 0;
          } else if (!content) {
            // æ²¡æœ‰å†…å®¹åŒ…è£…å™¨çš„ï¼Œç›´æ¥è®¡ç®—æ•´ä¸ª section
            totalHeight += section.offsetHeight || 0;
          } else {
            // æŠ˜å çŠ¶æ€ï¼Œåªè®¡ç®— header é«˜åº¦
            const header = section.querySelector('.pill-section__header');
            if (header) {
              totalHeight += header.offsetHeight || 0;
            }
          }
        });

        // æ·»åŠ ç¼“å†²ç©ºé—´
        totalHeight += 20;

        // æ›´æ–° CSS å˜é‡
        document.documentElement.style.setProperty('--main-padding-top', `${totalHeight}px`);
      }

      // ä¿å­˜å·¥å…·æ æŠ˜å çŠ¶æ€
      function saveToolbarState(sectionName, isCollapsed) {
        try {
          const states = JSON.parse(localStorage.getItem('mnkb_toolbar_states') || '{}');
          states[sectionName] = isCollapsed;
          localStorage.setItem('mnkb_toolbar_states', JSON.stringify(states));
        } catch (error) {
          console.warn('ä¿å­˜å·¥å…·æ çŠ¶æ€å¤±è´¥', error);
        }
      }

      // åŠ è½½å·¥å…·æ æŠ˜å çŠ¶æ€
      function loadToolbarStates() {
        try {
          const states = JSON.parse(localStorage.getItem('mnkb_toolbar_states') || '{}');
          Object.entries(states).forEach(([sectionName, isCollapsed]) => {
            if (isCollapsed) {
              const content = document.querySelector(`[data-content="${sectionName}"]`);
              const btn = document.querySelector(`[data-toggle="${sectionName}"]`);
              if (content) {
                content.classList.add('collapsed');
              }
              if (btn) {
                btn.classList.add('collapsed');
              }
            }
          });

          // åˆå§‹åŒ–åæ›´æ–° padding
          updateMainPaddingTop();
        } catch (error) {
          console.warn('åŠ è½½å·¥å…·æ çŠ¶æ€å¤±è´¥', error);
        }
      }

      function applyFilterPanelState(collapsed, options = {}) {
        const { skipSave = false } = options;
        isFilterPanelCollapsed = collapsed;
        document.body.classList.toggle('filters-collapsed', collapsed);
        const compact = isCompactLayout();
        document.body.classList.toggle('filters-overlay', !collapsed && compact);
        if (dom.filtersPanel) {
          dom.filtersPanel.setAttribute('aria-hidden', collapsed ? 'true' : 'false');
          dom.filtersPanel.dataset.layout = compact ? 'compact' : 'wide';
        }
        if (dom.toggleFiltersBtn) {
          dom.toggleFiltersBtn.setAttribute('aria-expanded', (!collapsed).toString());
          dom.toggleFiltersBtn.textContent = collapsed ? 'å±•å¼€ç­›é€‰' : 'æ”¶èµ·ç­›é€‰';
          dom.toggleFiltersBtn.setAttribute('aria-label', collapsed ? 'å±•å¼€ç­›é€‰å·¥å…·æ ' : 'æ”¶èµ·ç­›é€‰å·¥å…·æ ');
          dom.toggleFiltersBtn.classList.toggle('collapsed', collapsed);
        }
        updateMainPaddingTop();
        if (!skipSave) {
          saveFilterPanelState(collapsed);
        }
      }

      function saveFilterPanelState(collapsed) {
        try {
          localStorage.setItem('mnkb_filter_panel_collapsed', JSON.stringify(collapsed));
        } catch (error) {
          console.warn('ä¿å­˜ç­›é€‰é¢æ¿çŠ¶æ€å¤±è´¥', error);
        }
      }

      function loadFilterPanelState() {
        try {
          const stored = localStorage.getItem('mnkb_filter_panel_collapsed');
          if (stored !== null) {
            const parsed = JSON.parse(stored);
            if (typeof parsed === 'boolean') {
              isFilterPanelManuallySet = true;
              applyFilterPanelState(parsed, { skipSave: true });
              return;
            }
          }
        } catch (error) {
          console.warn('åŠ è½½ç­›é€‰é¢æ¿çŠ¶æ€å¤±è´¥ï¼Œå³å°†ä½¿ç”¨é»˜è®¤è¡Œä¸º', error);
        }
        applyFilterPanelState(true, { skipSave: true });
      }

      // è¾“å…¥æ¡†èšç„¦æ—¶è‡ªåŠ¨å±•å¼€ç­›é€‰é¢æ¿
      function expandFiltersForSearchInput() {
        if (!isFilterPanelCollapsed) return;
        isFilterPanelManuallySet = false;
        applyFilterPanelState(false, { skipSave: true });
      }

      // å¤„ç†æœç´¢æ¡†èšç„¦äº‹ä»¶çš„ç»¼åˆå‡½æ•°
      function handleSearchInputFocus() {
        // 1. å±•å¼€ç­›é€‰é¢æ¿ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
        expandFiltersForSearchInput();

        // 2. åœ¨çª„æ¨¡å¼ä¸‹è‡ªåŠ¨å…³é—­ sidebar
        if (isCompactLayout()) {
          const isSidebarOpen = dom.sidebar?.classList.contains('show');
          if (isSidebarOpen) {
            closeSidebar();
          }
        }
      }

      // é€‰ä¸­å¡ç‰‡åè‡ªåŠ¨æ”¶èµ·ç­›é€‰é¢æ¿
      function collapseFiltersAfterCardSelection() {
        if (isFilterPanelCollapsed) return;
        isFilterPanelManuallySet = false;
        applyFilterPanelState(true, { skipSave: true });
      }

      function attachEventListeners() {
        dom.searchInput.addEventListener('input', debouncedInputHandler, { passive: true });
        dom.searchInput.addEventListener('focus', handleSearchInputFocus);
        dom.clearBtn.addEventListener('click', handleClearFilters);
        dom.clearPresetsBtn?.addEventListener('click', handleClearPresets);
        dom.clearNegativesBtn?.addEventListener('click', handleClearNegatives);

        // Sidebar æŒ‰é’®äº‹ä»¶ï¼ˆåŒå‡»è§¦å‘ï¼Œé˜²æ­¢è¯¯è§¦ï¼‰
        const sidebarButtons = [
          { btn: dom.mergeFocusNoteToTargetNoteExcerptPartBtn, action: 'mergeFocusNoteToTargetNoteExcerptPart' },
          { btn: dom.clearTitleAndMergeFocusNoteToTargetNoteExcerptPartBtn, action: 'clearTitleAndMergeFocusNoteToTargetNoteExcerptPart' },
          { btn: dom.bidirectionalLinkFromeFocusNoteToTargetNoteBtn, action: 'bidirectionalLinkFromeFocusNoteToTargetNote' },
          { btn: dom.moveFocusNoteToTargetNoteAsChildBtn, action: 'moveFocusNoteToTargetNoteAsChild' },
          { btn: dom.moveFocusNoteToTargetNoteAsChildAndLocateBtn, action: 'moveFocusNoteToTargetNoteAsChildAndLocate' },
          { btn: dom.moveFocusNoteToTargetNoteAsChildAndMakeNoteBtn, action: 'moveFocusNoteToTargetNoteAsChildAndMakeNote' },
          { btn: dom.moveFocusNoteToTargetNoteAsChildAndMakeNoteAndLocateBtn, action: 'moveFocusNoteToTargetNoteAsChildAndMakeNoteAndLocate' },
          { btn: dom.addTemplateToTargetNoteAndMoveFocusNoteAsChildBtn, action: 'addTemplateToTargetNoteAndMoveFocusNoteAsChild' },
          { btn: dom.addTemplateToTargetNoteAndMoveFocusNoteAsChildAndLocateBtn, action: 'addTemplateToTargetNoteAndMoveFocusNoteAsChildAndLocate' }
        ];

        // ä½¿ç”¨ WeakMap å­˜å‚¨æ¯ä¸ªæŒ‰é’®çš„ç‚¹å‡»çŠ¶æ€
        const buttonClickStates = new WeakMap();

        sidebarButtons.forEach(({ btn, action }) => {
          if (!btn) return;

          // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
          buttonClickStates.set(btn, { timer: null, clickCount: 0 });

          // è‡ªå®šä¹‰åŒå‡»æ£€æµ‹é€»è¾‘
          btn.addEventListener('click', () => {
            if (btn.disabled) return;

            const state = buttonClickStates.get(btn);
            state.clickCount++;

            // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            if (state.timer) {
              clearTimeout(state.timer);
            }

            if (state.clickCount === 1) {
              // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šæ˜¾ç¤ºæç¤ºï¼Œç­‰å¾…ç¬¬äºŒæ¬¡ç‚¹å‡»
              showToast('ğŸ‘† å†æ¬¡ç‚¹å‡»ä»¥æ‰§è¡Œæ“ä½œ', 1000);

              // è®¾ç½® 300ms è¶…æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç¬¬äºŒæ¬¡ç‚¹å‡»åˆ™é‡ç½®
              state.timer = setTimeout(() => {
                state.clickCount = 0;
                state.timer = null;
              }, 300);
            } else if (state.clickCount === 2) {
              // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šæ‰§è¡Œæ“ä½œ
              state.clickCount = 0;
              state.timer = null;
              handleSidebarAction(action);
            }
          });
        });

        // åˆ·æ–°æŒ‰é’®äº‹ä»¶
        dom.refreshBtn?.addEventListener('click', () => {
          showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...');
          if (window.Bridge && typeof window.Bridge.refreshAllData === 'function') {
            window.Bridge.refreshAllData();
          } else {
            console.error('Bridge.refreshAllData æ–¹æ³•ä¸å­˜åœ¨');
            showToast('åˆ·æ–°åŠŸèƒ½ä¸å¯ç”¨');
          }
        });

        dom.toggleFiltersBtn?.addEventListener('click', () => {
          isFilterPanelManuallySet = true;
          applyFilterPanelState(!isFilterPanelCollapsed);
        });

        // Sidebar åˆ‡æ¢
        dom.sidebarToggle?.addEventListener('click', toggleSidebar);
        dom.sidebarOverlay?.addEventListener('click', closeSidebar);

        // å·¥å…·æ æŠ˜å æŒ‰é’®
        document.querySelectorAll('.pill-section__toggle-btn').forEach((btn) => {
          btn.addEventListener('click', handleToolbarToggle);
        });

        // AI æ¨èé¢æ¿å…³é—­æŒ‰é’®
        const aiCloseBtn = document.getElementById('aiCloseRecommendationsBtn');
        if (aiCloseBtn) {
          aiCloseBtn.addEventListener('click', hideAIRecommendationsPanel);
        }
      }

      function handleSearchInputChange() {
        state.userInput = dom.searchInput.value.trim();
        scheduleSearch();
      }

      function handleClearFilters() {
        dom.searchInput.value = '';
        state.userInput = '';
        state.activePresets.clear();
        state.activeNegativePresets.clear();
        state.currentTypeKey = state.config.typeFilters[0]?.key || 'all';
        state.currentClassificationSubtype = 'all';
        refreshClassificationOptions();
        renderPresetBar();
        renderTypeBar();
        renderClassificationBar();
        renderNegativeBar();
        clearSelection();
        scheduleSearch();

        // æ¸…ç©ºåç«‹å³è¿›å…¥è¾“å…¥çŠ¶æ€
        // 1. å±•å¼€ç­›é€‰é¢æ¿
        expandFiltersForSearchInput();

        // 2. åœ¨çª„æ¨¡å¼ä¸‹å…³é—­ä¾§è¾¹æ 
        if (isCompactLayout()) {
          const isSidebarOpen = dom.sidebar?.classList.contains('show');
          if (isSidebarOpen) {
            closeSidebar();
          }
        }

        // 3. èšç„¦åˆ°æœç´¢è¾“å…¥æ¡†
        dom.searchInput.focus();
      }

      function handleClearPresets() {
        if (state.activePresets.size === 0) return;

        state.activePresets.clear();
        renderPresetBar();
        scheduleSearch();
        showToast('å·²æ¸…é™¤æ‰€æœ‰é¢„è®¾');
      }

      function handleClearNegatives() {
        if (state.activeNegativePresets.size === 0) return;

        state.activeNegativePresets.clear();
        renderNegativeBar();
        scheduleSearch();
        showToast('å·²æ¸…é™¤æ‰€æœ‰æ’é™¤è¯');
      }

      function updateClearPresetsButton() {
        if (!dom.clearPresetsBtn) return;

        if (state.activePresets.size === 0) {
          dom.clearPresetsBtn.classList.add('disabled');
        } else {
          dom.clearPresetsBtn.classList.remove('disabled');
        }
      }

      function updateClearNegativesButton() {
        if (!dom.clearNegativesBtn) return;

        if (state.activeNegativePresets.size === 0) {
          dom.clearNegativesBtn.classList.add('disabled');
        } else {
          dom.clearNegativesBtn.classList.remove('disabled');
        }
      }

      /**
       * æ›´æ–°å¡ç‰‡æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼šç›´æ¥æ›´æ–° state.cardsï¼‰
       * @param {Array} cards - å¡ç‰‡æ•°ç»„
       * @param {Object} options - é€‰é¡¹
       * @param {boolean} options.replace - æ˜¯å¦æ›¿æ¢ï¼ˆtrueï¼‰æˆ–åˆå¹¶ï¼ˆfalseï¼‰
       */
      function updateCards(cards, { replace = true } = {}) {
        console.log(`ğŸ”„ updateCards è¢«è°ƒç”¨:`, {
          cardsLength: cards?.length,
          replace,
          currentCardsLength: state.cards.length
        });

        const sanitized = Array.isArray(cards) ? cards.filter(Boolean) : [];

        if (replace) {
          // æ›¿æ¢æ¨¡å¼:ç›´æ¥ä½¿ç”¨æ–°å¡ç‰‡æ•°ç»„
          state.cards = sanitized.slice();
        } else {
          // åˆå¹¶æ¨¡å¼:ä¿ç•™ç°æœ‰å¡ç‰‡,æ·»åŠ æ–°å¡ç‰‡
          const cardMap = new Map(state.cards.map((item) => [item.id, item]));
          sanitized.forEach((item) => {
            if (!item || !item.id || cardMap.has(item.id)) return;
            cardMap.set(item.id, item);
          });
          state.cards = Array.from(cardMap.values());
        }

        console.log(`âœ… å¡ç‰‡æ•°æ®æ›´æ–°å®Œæˆ,å½“å‰å¡ç‰‡æ•°: ${state.cards.length}`);

        clearSelection();
        refreshClassificationOptions();
        scheduleSearch({ triggerNative: false });
      }

      /**
       * åˆ›å»ºé¢„è®¾ pill å…ƒç´ 
       * @param {Object|String} item - é¢„è®¾é¡¹ï¼ˆå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–å¯¹è±¡ï¼‰
       * @param {Number} level - å±‚çº§ï¼ˆ1-4ï¼‰
       * @param {Object} group - æ‰€å±åˆ†ç»„ï¼ˆç”¨äºäº’æ–¥ç»„é€»è¾‘ï¼‰
       * @returns {HTMLElement} pill å…ƒç´ 
       */
      function createPresetPill(item, level, group) {
        const preset = typeof item === 'string' ? item : item.value;
        const hasChildren = item.children && item.children.length > 0;

        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.setAttribute('data-level', level);
        pill.setAttribute('data-preset', preset);
        pill.tabIndex = 0;

        // è®¾ç½®é€‰ä¸­çŠ¶æ€
        if (state.activePresets.has(preset)) {
          pill.classList.add('active');
        }

        if (hasChildren) {
          // å¯å±•å¼€çš„ pillï¼ˆåŒæ—¶æ”¯æŒé€‰ä¸­å’Œå±•å¼€ï¼‰
          pill.classList.add('pill--expandable');
          const isExpanded = state.expandedPresets.has(preset);

          // åˆ›å»ºæ–‡æœ¬åŒºåŸŸï¼ˆç”¨äºé€‰ä¸­ï¼‰
          const textSpan = document.createElement('span');
          textSpan.className = 'pill__text';
          textSpan.textContent = preset;

          // åˆ›å»ºå±•å¼€æŒ‰é’®ï¼ˆç”¨äºå±•å¼€/æ”¶èµ·ï¼‰
          const toggleSpan = document.createElement('span');
          toggleSpan.className = 'pill__toggle';
          toggleSpan.textContent = isExpanded ? 'â–¼' : 'â–¶';

          pill.appendChild(textSpan);
          pill.appendChild(toggleSpan);

          // é€‰ä¸­/å–æ¶ˆé€‰ä¸­é€»è¾‘
          const toggleSelection = () => {
            if (state.activePresets.has(preset)) {
              state.activePresets.delete(preset);
            } else {
              state.activePresets.add(preset);
              updateRecentPresets(preset);
            }
            renderPresetBar();
            scheduleSearch();
          };

          // æ–‡æœ¬åŒºåŸŸï¼šç‚¹å‡»é€‰ä¸­/å–æ¶ˆé€‰ä¸­
          textSpan.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSelection();
          });

          // å±•å¼€æŒ‰é’®ï¼šç‚¹å‡»å±•å¼€/æ”¶èµ·
          toggleSpan.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleExpand(item, group);
          });

          // é˜»æ­¢ pill æœ¬èº«çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼ˆå¤„ç† padding å’Œ gap åŒºåŸŸçš„ç‚¹å‡»ï¼‰
          pill.addEventListener('click', (e) => {
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ textSpan æˆ– toggleSpanï¼Œé˜»æ­¢å†’æ³¡
            if (e.target === pill) {
              e.stopPropagation();
            }
          });

          // é”®ç›˜æ”¯æŒ
          pill.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              toggleSelection();
            } else if (event.key === 'ArrowRight' && !isExpanded) {
              event.preventDefault();
              toggleExpand(item, group);
            } else if (event.key === 'ArrowLeft' && isExpanded) {
              event.preventDefault();
              toggleExpand(item, group);
            }
          });
        } else {
          // æ™®é€š pillï¼ˆå¯é€‰ä¸­ï¼‰
          pill.textContent = preset;

          const toggle = () => {
            if (state.activePresets.has(preset)) {
              state.activePresets.delete(preset);
            } else {
              state.activePresets.add(preset);
              updateRecentPresets(preset);
            }
            renderPresetBar();
            scheduleSearch();
          };

          pill.addEventListener('click', toggle);
          pill.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              toggle();
            }
          });
        }

        return pill;
      }

      /**
       * åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
       * @param {Object} item - é¢„è®¾é¡¹
       * @param {Object} group - æ‰€å±åˆ†ç»„
       */
      function toggleExpand(item, group) {
        const preset = item.value;
        const isExpanded = state.expandedPresets.has(preset);

        // åˆ¤æ–­å½“å‰é¡¹æ˜¯å¦æ˜¯åˆ†ç»„çš„ç›´æ¥å­é¡¹
        const isDirectChild = group?.presets?.some(p => p.value === preset);

        // åªæœ‰ç›´æ¥å­é¡¹æ‰è§¦å‘äº’æ–¥é€»è¾‘ï¼ˆé¿å…å­å­™é¡¹è¯¯è§¦å‘ï¼‰
        if (group?.type === 'exclusive' && !isExpanded && isDirectChild) {
          group.presets.forEach(p => {
            if (p.value !== preset) {
              state.expandedPresets.delete(p.value);
              // é€’å½’æ¸…é™¤æ‰€æœ‰å­é¡¹çš„å±•å¼€çŠ¶æ€
              clearChildrenExpanded(p);
            }
          });
        }

        // åˆ‡æ¢å½“å‰é¡¹
        if (isExpanded) {
          state.expandedPresets.delete(preset);
          // æ”¶èµ·æ—¶ä¹Ÿæ¸…é™¤å­é¡¹çš„å±•å¼€çŠ¶æ€
          clearChildrenExpanded(item);
        } else {
          state.expandedPresets.add(preset);
        }

        renderPresetBar();
      }

      /**
       * é€’å½’æ¸…é™¤å­é¡¹çš„å±•å¼€çŠ¶æ€
       * @param {Object} item - é¢„è®¾é¡¹
       */
      function clearChildrenExpanded(item) {
        if (!item.children) return;
        item.children.forEach(child => {
          state.expandedPresets.delete(child.value);
          clearChildrenExpanded(child);
        });
      }

      /**
       * é€’å½’æ¸²æŸ“é¢„è®¾é¡¹åŠå…¶å­é¡¹
       * @param {Array} items - é¢„è®¾é¡¹æ•°ç»„
       * @param {HTMLElement} container - å®¹å™¨å…ƒç´ 
       * @param {Number} level - å±‚çº§
       * @param {Object} group - æ‰€å±åˆ†ç»„
       */
      function renderPresetItems(items, container, level, group) {
        items.forEach(item => {
          const preset = typeof item === 'string' ? item : item.value;
          const hasChildren = item.children && item.children.length > 0;

          // åˆ›å»ºå½“å‰å±‚çº§çš„ pill
          const pill = createPresetPill(item, level, group);
          container.appendChild(pill);

          // å¦‚æœæœ‰å­é¡¹ä¸”å·²å±•å¼€ï¼Œåˆ›å»ºå­è¡Œå¹¶é€’å½’æ¸²æŸ“
          if (hasChildren && state.expandedPresets.has(preset)) {
            const childRow = document.createElement('div');
            childRow.className = `pill-row pill-row--child pill-row--level-${level + 1}`;
            childRow.setAttribute('data-level', level + 1);

            // é€’å½’æ¸²æŸ“å­é¡¹åˆ°å­è¡Œï¼ˆç»Ÿä¸€é€»è¾‘ï¼Œé¿å…é‡å¤ï¼‰
            renderPresetItems(item.children, childRow, level + 1, group);

            container.appendChild(childRow);
          }
        });
      }

      /**
       * æ¸²æŸ“é¢„è®¾æ ï¼ˆä¸»å‡½æ•°ï¼‰
       */
      function renderPresetBar() {
        const groups = getPresetGroupsWithRecent();
        dom.presetBar.innerHTML = '';

        if (!groups.length) {
          dom.presetSection?.classList.add('component-hidden');
          return;
        }
        dom.presetSection?.classList.remove('component-hidden');

        groups.forEach((group) => {
          if (!group || !group.presets || !group.presets.length) return;

          // åˆ›å»ºåˆ†ç»„å®¹å™¨
          const groupDiv = document.createElement('div');
          groupDiv.className = 'preset-group';
          if (group.isRecent) {
            groupDiv.classList.add('preset-group--recent');
          }

          // åˆ›å»ºåˆ†ç»„æ ‡ç­¾
          const label = document.createElement('div');
          label.className = 'preset-group__label';
          const labelText = (group.icon ? group.icon + ' ' : '') + group.name;
          label.textContent = labelText;
          groupDiv.appendChild(label);

          // åˆ›å»ºçˆ¶çº§é¢„è®¾è¡Œ
          const pillRow = document.createElement('div');
          pillRow.className = 'pill-row';

          // æ¸²æŸ“é¢„è®¾é¡¹ï¼ˆæ”¯æŒé€’å½’å±•å¼€ï¼‰
          renderPresetItems(group.presets, pillRow, 1, group);

          groupDiv.appendChild(pillRow);
          dom.presetBar.appendChild(groupDiv);
        });

        updateClearPresetsButton();
      }

      function renderNegativeBar() {
        const presets = state.config.negativePresets || [];
        dom.negativeBar.innerHTML = '';
        if (!presets.length) {
          dom.negativeSection?.classList.add('component-hidden');
          return;
        }
        dom.negativeSection?.classList.remove('component-hidden');

        presets.forEach((preset) => {
          const pill = document.createElement('div');
          pill.className = 'pill negative';
          if (state.activeNegativePresets.has(preset)) pill.classList.add('active');
          pill.textContent = preset;
          pill.tabIndex = 0;
          const toggle = () => {
            if (state.activeNegativePresets.has(preset)) {
              state.activeNegativePresets.delete(preset);
            } else {
              state.activeNegativePresets.add(preset);
            }
            renderNegativeBar();
            scheduleSearch();
          };
          pill.addEventListener('click', toggle);
          pill.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              toggle();
            }
          });
          dom.negativeBar.appendChild(pill);
        });

        updateClearNegativesButton();
      }

      function renderTypeBar() {
        const filters = state.config.typeFilters || [];
        dom.typeBar.innerHTML = '';
        if (!filters.length) {
          dom.typeSection?.classList.add('component-hidden');
          return;
        }
        dom.typeSection?.classList.remove('component-hidden');

        filters.forEach((filter) => {
          const pill = document.createElement('div');
          pill.className = 'pill';
          if (filter.key === state.currentTypeKey) pill.classList.add('active');
          pill.textContent = filter.label || filter.key;
          pill.dataset.key = filter.key;
          pill.tabIndex = 0;
          const select = () => {
            state.currentTypeKey = filter.key;
            renderTypeBar();
            renderClassificationBar();
            scheduleSearch();
          };
          pill.addEventListener('click', select);
          pill.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              select();
            }
          });
          dom.typeBar.appendChild(pill);
        });

        renderClassificationBar();
      }

      function refreshClassificationOptions() {
        const options = new Set();
        (state.cards || []).forEach((card) => {
          if (!card) return;
          if (card.type === 'å½’ç±»' && card.classificationSubtype) {
            options.add(card.classificationSubtype);
          }
        });
        state.classificationOptions = Array.from(options).sort();
        if (
          state.currentClassificationSubtype !== 'all' &&
          !state.classificationOptions.includes(state.currentClassificationSubtype)
        ) {
          state.currentClassificationSubtype = 'all';
        }
        renderClassificationBar();
      }

      function shouldShowClassificationFilter() {
        if (!dom.classificationSection || !state.classificationOptions.length) return false;
        const preset = getCurrentTypePreset();
        const types = preset.types;
        return Array.isArray(types) && types.includes('å½’ç±»');
      }

      function renderClassificationBar() {
        if (!dom.classificationBar || !dom.classificationSection) return;
        if (!shouldShowClassificationFilter()) {
          dom.classificationSection.classList.add('component-hidden');
          dom.classificationBar.innerHTML = '';
          state.currentClassificationSubtype = 'all';

          // å½’ç±»åŒºåŸŸéšè—æ—¶ï¼Œè°ƒæ•´æ’é™¤å’Œé¢„è®¾åŒºåŸŸçš„ä½ç½®
          if (!document.body.classList.contains('filters-collapsed')) {
            document.documentElement.style.setProperty('--negative-top', 'calc(var(--topbar-height) + var(--toolbar-gap))');
            document.documentElement.style.setProperty('--preset-top', 'calc(var(--topbar-height) + var(--toolbar-gap) * 2)');
            document.documentElement.style.setProperty('--main-padding-top', 'calc(var(--topbar-height) + var(--toolbar-gap) + var(--negative-height) + var(--preset-max-height) + var(--spacing-buffer))');
          }
          updateMainPaddingTop();
          return;
        }

        dom.classificationSection.classList.remove('component-hidden');
        dom.classificationBar.innerHTML = '';

        // å½’ç±»åŒºåŸŸæ˜¾ç¤ºæ—¶ï¼Œæ¢å¤æ’é™¤å’Œé¢„è®¾åŒºåŸŸçš„é»˜è®¤ä½ç½®
        if (!document.body.classList.contains('filters-collapsed')) {
          document.documentElement.style.setProperty('--negative-top', 'calc(var(--topbar-height) + var(--toolbar-gap) * 2)');
          document.documentElement.style.setProperty('--preset-top', 'calc(var(--topbar-height) + var(--toolbar-gap) * 3)');
          document.documentElement.style.setProperty('--main-padding-top', 'calc(var(--topbar-height) + var(--toolbar-gap) * 2 + var(--negative-height) + var(--preset-max-height) + var(--spacing-buffer))');
        }

        const options = ['all', ...state.classificationOptions];
        options.forEach((option) => {
          const pill = document.createElement('div');
          pill.className = 'pill';
          const isAll = option === 'all';
          const value = isAll ? 'all' : option;
          if (state.currentClassificationSubtype === value) pill.classList.add('active');
          pill.textContent = isAll ? 'å…¨éƒ¨å­ç±»å‹' : option;
          pill.dataset.subtype = value;
          pill.tabIndex = 0;
          const select = () => {
            state.currentClassificationSubtype = value;
            renderClassificationBar();
            scheduleSearch({ triggerNative: false });
          };
          pill.addEventListener('click', select);
          pill.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              select();
            }
          });
          dom.classificationBar.appendChild(pill);
        });

        updateMainPaddingTop();
      }

      function scheduleSearch(options = {}) {
        const payload = buildQueryPayload();
        state.lastQueryPayload = payload;

        const shouldNotifyNative = options.triggerNative !== false;
        if (shouldNotifyNative && window.MNKBBridge && typeof window.MNKBBridge.performSearch === 'function') {
          try {
            window.MNKBBridge.performSearch(payload);
          } catch (error) {
            console.warn('performSearch è°ƒç”¨å¤±è´¥', error);
          }
        }

        applyFilters(payload);
      }

      function buildQueryPayload() {
        const currentType = getCurrentTypePreset();
        const includePresets = Array.from(state.activePresets);
        const excludePresets = Array.from(state.activeNegativePresets);
        const highlightTokens = deriveTokens(state.userInput, includePresets);

        return {
          rawInput: state.userInput,
          includePresets,
          excludePresets,
          typeKey: currentType.key,
          typeList: currentType.types ? currentType.types.slice() : null,
          classificationSubtype: state.currentClassificationSubtype,
          highlightTokens,
          tokensLower: highlightTokens.map((token) => token.toLowerCase()),
          timestamp: Date.now(),
        };
      }

      /**
       * è¯†åˆ«å¹¶æ ‡å‡†åŒ–æ•°å­¦åŒºé—´ç¬¦å·
       * æ”¯æŒæ ¼å¼ï¼š[a, b]ã€(a, b)ã€[a, b)ã€(a, b]
       * @param {string} text - å¾…å¤„ç†çš„æ–‡æœ¬
       * @returns {Object} { normalized: æ ‡å‡†åŒ–åçš„æ–‡æœ¬, intervals: æå–çš„åŒºé—´æ•°ç»„ }
       */
      function normalizeIntervals(text) {
        if (!text) return { normalized: text, intervals: [] };

        const intervals = [];
        const placeholders = new Map();
        let counter = 0;

        // åŒ¹é…æ•°å­¦åŒºé—´ï¼š[\(\[].*?[\)\]]
        // æ”¯æŒ [...]ã€(...)ã€[...)ã€(...] å››ç§æ ¼å¼
        const intervalRegex = /[\[\(][^\[\]\(\)]*?[\]\)]/g;

        const normalized = text.replace(intervalRegex, (match) => {
          // æ ‡å‡†åŒ–åŒºé—´å†…éƒ¨ï¼šç§»é™¤é€—å·å’Œåˆ†å·å‘¨å›´çš„ç©ºæ ¼
          const standardized = match.replace(/\s*([,;])\s*/g, '$1');

          // å¦‚æœæ ‡å‡†åŒ–åä¸åŸå§‹ä¸åŒï¼Œè®°å½•ä¸‹æ¥
          if (standardized !== match) {
            const placeholder = `__INTERVAL_${counter}__`;
            placeholders.set(placeholder, standardized);
            intervals.push({ original: match, normalized: standardized });
            counter++;
            return placeholder;
          }

          return match;
        });

        // è¿˜åŸå ä½ç¬¦
        let result = normalized;
        placeholders.forEach((value, key) => {
          result = result.replace(key, value);
        });

        return { normalized: result, intervals };
      }

      function deriveTokens(rawInput, includePresets) {
        const tokens = [];

        // æ™ºèƒ½ç©ºæ ¼åˆ†éš”ï¼šæ£€æµ‹æ˜¯å¦æœ‰åŒç©ºæ ¼
        if (rawInput) {
          // ğŸ¯ æ–°å¢ï¼šå…ˆå¯¹æ•°å­¦åŒºé—´è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†
          const { normalized } = normalizeIntervals(rawInput);

          let parts;
          if (/\s{2,}/.test(normalized)) {
            // æœ‰åŒç©ºæ ¼ï¼šæŒ‰åŒç©ºæ ¼åˆ†å‰²ï¼Œä¿ç•™å•ç©ºæ ¼ä½œä¸ºçŸ­è¯­çš„ä¸€éƒ¨åˆ†
            parts = normalized.split(/\s{2,}/);
          } else {
            // æ— åŒç©ºæ ¼ï¼šæŒ‰å•ç©ºæ ¼åˆ†å‰²
            parts = normalized.split(/\s+/);
          }

          parts.forEach((part) => {
            const value = part.trim();
            if (value && !tokens.includes(value)) tokens.push(value);
          });
        }

        // é¢„è®¾è¯å§‹ç»ˆä½œä¸ºç‹¬ç«‹ token
        (includePresets || []).forEach((part) => {
          const value = part.trim();
          if (value && !tokens.includes(value)) tokens.push(value);
        });

        return tokens;
      }

      function getCurrentTypePreset() {
        const filters = state.config.typeFilters || [];
        const fallback = filters[0] || { key: 'all', label: 'å…¨éƒ¨ç±»å‹', types: null };
        return filters.find((filter) => filter.key === state.currentTypeKey) || fallback;
      }

      function applyFilters(payload) {
        try {
          const query = payload || state.lastQueryPayload || buildQueryPayload();

          // è®¡ç®—å½“å‰æœç´¢æ¿€æ´»çš„æ’é™¤è¯ç»„
          state.activeExclusions = getActiveExclusions(query.tokensLower);

        const allowedTypes = query.typeList ? new Set(query.typeList) : null;
        const negatives = query.excludePresets.map((word) => word.toLowerCase());
        const tokensLower = query.tokensLower;
        const highlightTokens = query.highlightTokens;

        const results = [];
        const availableIds = new Set();
        const subtypeFilter = query.classificationSubtype;
        const enforceSubtype = subtypeFilter && subtypeFilter !== 'all';

        (state.cards || []).forEach((card) => {
          if (!card || !card.id) return;

          const normalizedType = card.type && String(card.type).trim() ? card.type : RAW_TYPE_LABEL;
          availableIds.add(card.id);

          if (allowedTypes && allowedTypes.size > 0 && !allowedTypes.has(normalizedType)) {
            return;
          }

          if (enforceSubtype && normalizedType === 'å½’ç±»') {
            if (!card.classificationSubtype || card.classificationSubtype !== subtypeFilter) {
              return;
            }
          }

          if (!passesNegativeFilter(card, negatives)) return;

          // æ’é™¤è¯è¿‡æ»¤
          if (state.activeExclusions && state.activeExclusions.groups.length > 0) {
            if (shouldExcludeCard(card, state.activeExclusions)) {
              return;  // æ’é™¤è¿™å¼ å¡ç‰‡
            }
          }

          const evaluation = evaluateCard({ ...card, type: normalizedType }, tokensLower);
          // AND é€»è¾‘ï¼šæ‰€æœ‰å…³é”®è¯å¿…é¡»åŒ¹é…
          if (tokensLower.length > 0 && evaluation.matchCount < tokensLower.length) return;

          const prepared = { ...card, type: normalizedType };
          prepared.matchCount = evaluation.matchCount;
          prepared.score = typeof card.score === 'number' ? card.score : evaluation.score;
          if (!card.type) prepared.isRaw = true;

          // å§‹ç»ˆé‡æ–°ç”Ÿæˆé«˜äº®ï¼Œé¿å…ä½¿ç”¨å¯èƒ½åŒ…å«å ä½ç¬¦çš„æ—§æ•°æ®
          prepared.titleHtml = highlightTextWithTokens(prepared.title || '', highlightTokens);

          const sourceText = prepared.snippet || prepared.searchText || prepared.title || '';
          const snippet = extractSnippet(sourceText, tokensLower);
          prepared.snippetHtml = highlightTextWithTokens(snippet, highlightTokens);

          results.push(prepared);
        });

        pruneSelections(availableIds);

        results.sort((a, b) => {
          const scoreDiff = (b.score || 0) - (a.score || 0);
          if (scoreDiff !== 0) return scoreDiff;
          return (a.title || '').localeCompare(b.title || '');
        });

        state.filteredCards = results;

        // é‡ç½®åˆ†é¡µçŠ¶æ€
        state.currentPage = 1;
        state.displayedCards = [];
        state.hasMore = results.length > INITIAL_PAGE_SIZE;

        // åˆå§‹åŠ è½½ç¬¬ä¸€æ‰¹æ•°æ®
        const initialCards = results.slice(0, INITIAL_PAGE_SIZE);
        state.displayedCards = initialCards;

          renderResults(initialCards);

          // å¦‚æœæœ‰æ›´å¤šæ•°æ®ï¼Œæ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
          updateLoadMoreButton();
        } catch (error) {
          console.error('åº”ç”¨ç­›é€‰å™¨å¤±è´¥:', error);
          showToast('ç­›é€‰å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      }

      function passesNegativeFilter(card, negativeTokens) {
        if (!negativeTokens || negativeTokens.length === 0) return true;

        if (card.excludedGroups && Array.isArray(card.excludedGroups) && card.excludedGroups.length > 0) {
          const hit = card.excludedGroups.some((group) => {
            if (!group) return false;
            const pool = [
              group.groupName || '',
              ...(group.excludeWords || []),
              ...(group.affectedTriggers || []),
            ]
              .join(' ')
              .toLowerCase();
            return negativeTokens.some((token) => pool.includes(token));
          });
          if (hit) return false;
        }

        const text = [
          card.title || '',
          card.searchText || '',
          card.snippet || '',
          card.content || '',
        ]
          .join(' ')
          .toLowerCase();

        return !negativeTokens.some((token) => token && text.includes(token));
      }

      /**
       * è·å–æ¿€æ´»çš„æ’é™¤è¯ç»„ä¿¡æ¯
       * @param {Array<string>} keywords - æœç´¢å…³é”®è¯æ•°ç»„
       * @returns {Object} åŒ…å« excludeWords å’Œ groups çš„å¯¹è±¡
      */
      function getActiveExclusions(keywords) {
        const keywordSet = new Set((keywords || []).filter(Boolean));
        if (keywordSet.size === 0 || !state.exclusionGroups || state.exclusionGroups.length === 0) {
          return { excludeWords: [], groups: [] };
        }

        const exclusions = new Set();
        const groupMap = new Map();

        for (const keyword of keywordSet) {
          for (const group of state.exclusionGroups) {
            if (!group || group.enabled === false) continue;

            const matchedTrigger = (group.triggerWords || []).find((trigger) => {
              const triggerLower = (trigger || '').toLowerCase();
              if (!triggerLower) return false;
              if (keyword === triggerLower) return true;
              if (keyword.includes(triggerLower)) return true;
              if (triggerLower.includes(keyword)) return true;
              return false;
            });

            if (!matchedTrigger) continue;

            const cleanedExcludeWords = (group.excludeWords || []).filter((word) => {
              if (!word) return false;
              return !keywordSet.has(word.toLowerCase());
            });

            if (cleanedExcludeWords.length === 0) continue;

            cleanedExcludeWords.forEach((word) => exclusions.add(word));

            const groupKey =
              group.id ||
              group.name ||
              (group.triggerWords || []).join('|') ||
              JSON.stringify(group);

            const existing = groupMap.get(groupKey);
            if (existing) {
              existing.excludeWords = Array.from(new Set([...existing.excludeWords, ...cleanedExcludeWords]));
            } else {
              groupMap.set(groupKey, {
                ...group,
                excludeWords: cleanedExcludeWords.slice(),
              });
            }
          }
        }

        return {
          excludeWords: Array.from(exclusions),
          groups: Array.from(groupMap.values()),
        };
      }

      /**
       * å®æ—¶åˆ¤æ–­å¡ç‰‡æ˜¯å¦åº”è¯¥è¢«æ’é™¤ï¼ˆé™çº§é€»è¾‘ï¼Œç”¨äºç¼ºå°‘ excludedGroups å­—æ®µçš„å¡ç‰‡ï¼‰
       * @param {Object} card - å¡ç‰‡å¯¹è±¡
       * @param {Object} activeExclusions - æ¿€æ´»çš„æ’é™¤è¯ä¿¡æ¯
       * @returns {boolean} true è¡¨ç¤ºåº”è¯¥æ’é™¤
       */
      function shouldExcludeCardRealtime(card, activeExclusions) {
        if (!activeExclusions || activeExclusions.excludeWords.length === 0) {
          return false;
        }

        // æ”¶é›†å¡ç‰‡çš„æ‰€æœ‰æ–‡æœ¬å†…å®¹
        const searchText = [
          card.title || '',
          card.searchText || '',
          card.snippet || '',
          card.content || ''
        ].join(' ').toLowerCase();

        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ’é™¤è¯
        const excludeWords = Array.isArray(activeExclusions.excludeWords)
          ? activeExclusions.excludeWords
          : [];

        const containsExcludeWord = excludeWords.some((excludeWord) => {
          if (!excludeWord) return false;
          return searchText.includes(excludeWord.toLowerCase());
        });

        if (!containsExcludeWord) {
          return false;  // ä¸åŒ…å«æ’é™¤è¯ï¼Œä¸æ’é™¤
        }

        // å¦‚æœåŒ…å«æ’é™¤è¯ï¼Œè¿˜è¦æ£€æŸ¥è§¦å‘è¯æ˜¯å¦ç‹¬ç«‹å­˜åœ¨
        // å³æ’é™¤è¯ä¸èƒ½æ˜¯è§¦å‘è¯çš„ä¸€éƒ¨åˆ†
        const activeGroups = Array.isArray(activeExclusions.groups)
          ? activeExclusions.groups
          : [];

        const containsTriggerIndependently = activeGroups.some((group) => {
          const triggerWords = Array.isArray(group?.triggerWords)
            ? group.triggerWords
            : [];
          const groupExcludeWords = Array.isArray(group?.excludeWords)
            ? group.excludeWords
            : [];

          let tempText = searchText;
          groupExcludeWords
            .map((word) => (word || '').toLowerCase())
            .filter(Boolean)
            .forEach((excludeWord) => {
              let index = tempText.indexOf(excludeWord);
              while (index !== -1) {
                tempText =
                  tempText.slice(0, index) +
                  tempText.slice(index + excludeWord.length);
                index = tempText.indexOf(excludeWord, index);
              }
            });

          return triggerWords.some((trigger) => {
            const triggerLower = (trigger || '').toLowerCase();
            if (!triggerLower) return false;
            return tempText.includes(triggerLower);
          });
        });

        // å¦‚æœè§¦å‘è¯ä¸ç‹¬ç«‹å­˜åœ¨ï¼ˆè¢«æ’é™¤è¯æ›¿æ¢åå°±æ‰¾ä¸åˆ°äº†ï¼‰ï¼Œåˆ™åº”è¯¥æ’é™¤
        return !containsTriggerIndependently;
      }

      /**
       * åˆ¤æ–­å¡ç‰‡æ˜¯å¦åº”è¯¥è¢«æ’é™¤
       * @param {Object} card - å¡ç‰‡å¯¹è±¡
       * @param {Object} activeExclusions - æ¿€æ´»çš„æ’é™¤è¯ä¿¡æ¯
       * @returns {boolean} true è¡¨ç¤ºåº”è¯¥æ’é™¤
       */
      function shouldExcludeCard(card, activeExclusions) {
        // æ–°å¢ï¼šå¦‚æœå¡ç‰‡æ²¡æœ‰é¢„å¤„ç†çš„ excludedGroups å­—æ®µï¼Œä½¿ç”¨å®æ—¶åŒ¹é…
        if (!card.excludedGroups || card.excludedGroups.length === 0) {
          return shouldExcludeCardRealtime(card, activeExclusions);
        }

        // ========================================
        // ğŸ” æœç´¢æ—¶çš„æ’é™¤è¯åŒ¹é…é€»è¾‘ï¼ˆæ–°ç‰ˆæœ¬å®ç°ï¼‰
        // ========================================
        //
        // åˆ¤æ–­æµç¨‹ï¼š
        // 1. è·å–æ¿€æ´»çš„æ’é™¤è¯ç»„ï¼ˆactiveExclusions.groupsï¼Œæ¥è‡ªç”¨æˆ·æœç´¢çš„å…³é”®è¯ï¼‰
        // 2. éå†å¡ç‰‡çš„é¢„å¤„ç†æ’é™¤è¯ç»„ï¼ˆcard.excludedGroupsï¼Œæ¥è‡ªç´¢å¼•æ„å»ºï¼‰
        // 3. æ£€æŸ¥ä¸¤è€…æ˜¯å¦åŒ¹é…ï¼ˆé€šè¿‡ groupId æˆ– triggerWordsï¼‰
        // 4. å…³é”®æ£€æŸ¥ï¼šç”¨æˆ·æœç´¢çš„è§¦å‘è¯æ˜¯å¦åœ¨å¡ç‰‡çš„ affectedTriggers ä¸­
        //
        // ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ affectedTriggersï¼Ÿ
        // - åœºæ™¯1ï¼ˆåº”æ’é™¤ï¼‰ï¼šå¡ç‰‡åªæœ‰"é—­å•ä½åœ†ç›˜"ï¼Œç”¨æˆ·æœç´¢"å•ä½åœ†ç›˜"
        //   â†’ affectedTriggers åŒ…å«"å•ä½åœ†ç›˜" â†’ æ’é™¤ï¼ˆå®Œå…¨æ±¡æŸ“ï¼‰
        //
        // - åœºæ™¯2ï¼ˆåº”ä¿ç•™ï¼‰ï¼šå¡ç‰‡æœ‰"é—­å•ä½åœ†ç›˜æ˜¯å•ä½åœ†ç›˜çš„é—­åŒ…"ï¼Œç”¨æˆ·æœç´¢"å•ä½åœ†ç›˜"
        //   â†’ affectedTriggers ä¸ºç©º â†’ ä¿ç•™ï¼ˆè§¦å‘è¯ç‹¬ç«‹å­˜åœ¨ï¼‰
        //
        // ä¸¤ä¸ªå…³é”®å­—æ®µçš„åŒºåˆ«ï¼š
        // - activeGroup.triggerWordsï¼šç”¨æˆ·æœç´¢æ¿€æ´»çš„è§¦å‘è¯ï¼ˆæ¥è‡ªæœç´¢æŸ¥è¯¢ï¼‰
        // - cardGroup.affectedTriggersï¼šå¡ç‰‡ä¸­è¢«æ±¡æŸ“çš„è§¦å‘è¯ï¼ˆæ¥è‡ªé¢„å¤„ç†ï¼‰
        //
        // åªæœ‰å½“"ç”¨æˆ·æœç´¢çš„è§¦å‘è¯"åœ¨"å¡ç‰‡è¢«æ±¡æŸ“çš„è§¦å‘è¯"ä¸­æ—¶ï¼Œæ‰æ’é™¤å¡ç‰‡ã€‚
        //
        for (const activeGroup of activeExclusions.groups) {
          for (const cardGroup of card.excludedGroups) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºåŒä¸€ä¸ªæ’é™¤è¯ç»„ï¼ˆé€šè¿‡ ID æˆ– triggerWords æ¯”å¯¹ï¼‰
            if (cardGroup.groupId === activeGroup.id) {
              // ğŸ¯ æ ¸å¿ƒåˆ¤æ–­ï¼šç”¨æˆ·æœç´¢çš„è§¦å‘è¯æ˜¯å¦åœ¨å¡ç‰‡çš„æ±¡æŸ“åˆ—è¡¨ä¸­
              const hasAffectedTrigger = activeGroup.triggerWords.some(trigger =>
                (cardGroup.affectedTriggers || []).includes(trigger)
              );

              if (hasAffectedTrigger) {
                return true;  // âŒ åº”è¯¥æ’é™¤ï¼ˆå®Œå…¨æ±¡æŸ“ï¼‰
              }
              // âœ… å¦åˆ™ä¿ç•™ï¼ˆéƒ¨åˆ†æ±¡æŸ“æˆ–æ— æ±¡æŸ“ï¼‰
            }
          }
        }

        return false;  // ä¸æ’é™¤
      }

      function evaluateCard(card, tokensLower) {
        if (!tokensLower || tokensLower.length === 0) {
          return { score: card.score || 0, matchCount: 0, matchedTokens: new Set() };
        }

        const baseScore = typeof card.score === 'number' ? card.score : 0;
        let score = baseScore;
        const matchedTokens = new Set();

        // ğŸ¯ è¾…åŠ©å‡½æ•°ï¼šæ ‡å‡†åŒ–å­—æ®µæ–‡æœ¬ï¼ˆåŒ…æ‹¬åŒºé—´æ ‡å‡†åŒ–ï¼‰
        const normalizeFieldText = (text) => {
          if (!text) return '';
          const lower = text.toLowerCase();
          const { normalized } = normalizeIntervals(lower);
          return normalized;
        };

        // å®šä¹‰æ‰€æœ‰å¯æœç´¢å­—æ®µåŠå…¶åŸºç¡€æƒé‡
        const fields = {
          title: { text: normalizeFieldText(card.title), baseWeight: 60 },
          searchText: { text: normalizeFieldText(card.searchText), baseWeight: 25 },
          keywords: { text: normalizeFieldText(card.keywords), baseWeight: 20 },
          prefix: { text: normalizeFieldText(card.prefix), baseWeight: 18 },
          subtype: { text: normalizeFieldText(card.classificationSubtype), baseWeight: 14 },
          type: { text: normalizeFieldText(card.type), baseWeight: 12 },
          snippet: { text: normalizeFieldText(card.snippet), baseWeight: 8 }
        };

        // ç»Ÿè®¡æ¯ä¸ªtokençš„å‡ºç°æ¬¡æ•°ï¼ˆç”¨äºè¡°å‡è®¡ç®—ï¼‰
        const tokenOccurrences = new Map();

        tokensLower.forEach((token) => {
          if (!token) return;
          let hit = false;

          // éå†æ‰€æœ‰å­—æ®µè¿›è¡ŒåŒ¹é…
          Object.entries(fields).forEach(([fieldName, fieldData]) => {
            const { text: fieldText, baseWeight } = fieldData;

            if (!fieldText || !fieldText.includes(token)) return;

            // ========== ğŸ¯ æ”¹è¿›1: è®¡ç®—åŒ¹é…å¯†åº¦ ==========
            const matchedLength = token.length;
            const totalLength = fieldText.length;
            const density = totalLength > 0 ? matchedLength / totalLength : 0;

            // å¯†åº¦å€å¢å™¨ï¼šæ ¹æ®åŒ¹é…å æ¯”è°ƒæ•´æƒé‡
            // å¯†åº¦ < 10%: 0.8å€ï¼ˆæƒ©ç½šç¨€ç–åŒ¹é…ï¼‰
            // å¯†åº¦ 10-30%: 1.0å€ï¼ˆæ­£å¸¸ï¼‰
            // å¯†åº¦ 30-50%: 1.0-1.5å€ï¼ˆçº¿æ€§å¢é•¿ï¼‰
            // å¯†åº¦ > 50%: 1.5-2.5å€ï¼ˆé«˜åº¦ç›¸å…³ï¼‰
            let densityMultiplier;
            if (density < 0.1) {
              densityMultiplier = 0.8;
            } else if (density < 0.3) {
              densityMultiplier = 1.0;
            } else if (density < 0.5) {
              densityMultiplier = 1.0 + (density - 0.3) * 2.5; // 0.3â†’1.0, 0.5â†’1.5
            } else {
              densityMultiplier = 1.5 + density; // 0.5â†’2.0, 1.0â†’2.5
            }

            // ========== ğŸ¯ æ”¹è¿›2: å­—æ®µé•¿åº¦å½’ä¸€åŒ– ==========
            // çŸ­å­—æ®µä¸­çš„åŒ¹é…æ›´æœ‰ä»·å€¼ï¼Œé•¿å­—æ®µé€‚å½“å‡æƒ
            let lengthBonus;
            if (totalLength < 20) {
              lengthBonus = 1.3; // çŸ­å­—æ®µåŠ æƒ30%
            } else if (totalLength > 100) {
              lengthBonus = 0.85; // é•¿å­—æ®µå‡æƒ15%
            } else {
              lengthBonus = 1.0;
            }

            // ========== ğŸ¯ æ”¹è¿›3: é‡å¤tokenè¡°å‡ ==========
            // é˜²æ­¢é€šè¿‡å †ç Œå…³é”®è¯è·å¾—é«˜åˆ†
            const occurrenceCount = (tokenOccurrences.get(token) || 0) + 1;
            tokenOccurrences.set(token, occurrenceCount);

            let decayFactor;
            if (occurrenceCount === 1) {
              decayFactor = 1.0;   // ç¬¬1æ¬¡å‡ºç°ï¼š100%
            } else if (occurrenceCount === 2) {
              decayFactor = 0.6;   // ç¬¬2æ¬¡å‡ºç°ï¼š60%
            } else if (occurrenceCount === 3) {
              decayFactor = 0.4;   // ç¬¬3æ¬¡å‡ºç°ï¼š40%
            } else {
              decayFactor = 0.2;   // ç¬¬4+æ¬¡å‡ºç°ï¼š20%
            }

            // ========== è®¡ç®—æœ€ç»ˆæƒé‡ ==========
            const finalWeight = baseWeight * densityMultiplier * lengthBonus * decayFactor;
            score += finalWeight;
            hit = true;
          });

          if (hit) matchedTokens.add(token);
        });

        // ========== ğŸ¯ æ”¹è¿›4: è¦†ç›–ç‡å¥–åŠ± ==========
        // åŒ¹é…äº†æ‰€æœ‰æœç´¢è¯çš„å¡ç‰‡é¢å¤–åŠ åˆ†
        const coverageRatio = matchedTokens.size / tokensLower.length;
        const coverageBonus = coverageRatio * 30; // æœ€é«˜30åˆ†
        score += coverageBonus;

        return {
          score,
          matchCount: matchedTokens.size,
          matchedTokens,
          coverageRatio // ç”¨äºè°ƒè¯•ï¼ˆä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰
        };
      }

      function extractSnippet(text, tokensLower) {
        if (!text) return '';
        if (!tokensLower || tokensLower.length === 0) {
          return text.length > 120 ? `${text.slice(0, 120)}â€¦` : text;
        }

        const lower = text.toLowerCase();
        let firstIndex = -1;
        tokensLower.forEach((token) => {
          const idx = lower.indexOf(token);
          if (idx !== -1 && (firstIndex === -1 || idx < firstIndex)) {
            firstIndex = idx;
          }
        });

        if (firstIndex === -1) {
          return text.length > 120 ? `${text.slice(0, 120)}â€¦` : text;
        }

        const start = Math.max(0, firstIndex - 30);
        const end = Math.min(text.length, firstIndex + 80);
        const prefix = start > 0 ? 'â€¦' : '';
        const suffix = end < text.length ? 'â€¦' : '';
        return `${prefix}${text.slice(start, end)}${suffix}`;
      }

      function renderResults(items) {
        try {
          dom.results.innerHTML = '';
          const fragment = document.createDocumentFragment();

          items.forEach((card) => {
            try {
          const element = document.createElement('div');
          element.className = 'card';
          element.dataset.id = card.id;

          if (state.selectedCardId === card.id) {
            element.classList.add('selected');
          }

          const color = resolveTypeColor(card);
          element.style.borderLeftColor = color;

          // åˆ›å»ºæ“ä½œå›¾æ ‡å®¹å™¨
          const actionsContainer = document.createElement('div');
          actionsContainer.className = 'card-actions';

          // å›¾æ ‡1: åœ¨ä¸»è„‘å›¾å®šä½
          const mindMapIcon = document.createElement('div');
          mindMapIcon.className = 'card-action-icon';
          mindMapIcon.textContent = 'ğŸ“';
          mindMapIcon.title = 'åœ¨ä¸»è„‘å›¾å®šä½';
          mindMapIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            handleCardFocus(card.id);
          });

          // å›¾æ ‡2: åœ¨æµ®çª—ä¸­å®šä½
          const floatMapIcon = document.createElement('div');
          floatMapIcon.className = 'card-action-icon';
          floatMapIcon.textContent = 'ğŸ¯';
          floatMapIcon.title = 'åœ¨æµ®çª—ä¸­å®šä½';
          floatMapIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!postBridge('focusCardInFloatMindMap', { id: card.id })) {
              showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šåœ¨æµ®çª—ä¸­å®šä½');
            }
          });

          // å›¾æ ‡3: å¤åˆ¶è¡Œå†…é“¾æ¥
          const copyMarkdownLinkIcon = document.createElement('div');
          copyMarkdownLinkIcon.className = 'card-action-icon text-icon';
          copyMarkdownLinkIcon.innerHTML = 'è¡Œå†…<br>é“¾æ¥';
          copyMarkdownLinkIcon.title = 'å¤åˆ¶è¡Œå†…é“¾æ¥';
          copyMarkdownLinkIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!postBridge('copyMarkdownLink', { id: card.id })) {
              showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šå¤åˆ¶è¡Œå†…é“¾æ¥');
            } else {
              showToast('å·²å¤åˆ¶è¡Œå†…é“¾æ¥');
            }
          });

          // å›¾æ ‡4: å¤åˆ¶ URL
          const copyURLIcon = document.createElement('div');
          copyURLIcon.className = 'card-action-icon text-icon';
          copyURLIcon.innerHTML = 'å¤åˆ¶<br>URL';
          copyURLIcon.title = 'å¤åˆ¶å¡ç‰‡ URL';
          copyURLIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!postBridge('copyNoteURL', { id: card.id })) {
              showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šå¤åˆ¶ URL');
            } else {
              showToast('å·²å¤åˆ¶ URL');
            }
          });

          // å›¾æ ‡5: åŒå‘é“¾æ¥ï¼ˆåŒå‡»è§¦å‘ï¼‰
          const bidirectionalLinkIcon = document.createElement('div');
          bidirectionalLinkIcon.className = 'card-action-icon';
          bidirectionalLinkIcon.textContent = 'ğŸ”—';
          bidirectionalLinkIcon.title = 'åŒå‘é“¾æ¥ï¼ˆåŒå‡»æ‰§è¡Œï¼‰';

          // åŒå‡»æ£€æµ‹é€»è¾‘
          let clickCount = 0;
          let clickTimer = null;

          bidirectionalLinkIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            clickCount++;

            if (clickTimer) clearTimeout(clickTimer);

            if (clickCount === 1) {
              // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šæ˜¾ç¤ºæç¤º
              showToast('ğŸ‘† å†æ¬¡ç‚¹å‡»ä»¥å»ºç«‹åŒå‘é“¾æ¥', 800);
              clickTimer = setTimeout(() => {
                clickCount = 0;
              }, 300);
            } else if (clickCount === 2) {
              // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šæ‰§è¡Œæ“ä½œ
              clickCount = 0;
              if (!postBridge('bidirectionalLinkFromeFocusNoteToTargetNote', { id: card.id })) {
                showToast('æ“ä½œå¤±è´¥');
              } else {
                showToast('âœ… å·²å»ºç«‹åŒå‘é“¾æ¥');
              }
            }
          });

          // å°†å›¾æ ‡æ·»åŠ åˆ°å®¹å™¨ï¼ˆ2x3å¸ƒå±€ï¼šç¬¬1è¡Œ - ä¸»è„‘å›¾/æµ®çª—/åŒå‘é“¾æ¥ï¼Œç¬¬2è¡Œ - è¡Œå†…é“¾æ¥/å¤åˆ¶URL/é¢„ç•™ï¼‰
          actionsContainer.appendChild(mindMapIcon);
          actionsContainer.appendChild(floatMapIcon);
          actionsContainer.appendChild(bidirectionalLinkIcon);
          actionsContainer.appendChild(copyMarkdownLinkIcon);
          actionsContainer.appendChild(copyURLIcon);

          const title = document.createElement('div');
          title.className = 'card-title';
          title.innerHTML = card.titleHtml || escapeHtml(card.title || '');

          const meta = document.createElement('div');
          meta.className = 'card-meta';

          const typeBadge = document.createElement('span');
          typeBadge.className = 'card-type';
          typeBadge.style.background = color;
          typeBadge.textContent = card.type || 'æœªçŸ¥ç±»å‹';
          meta.appendChild(typeBadge);

          if (card.type === 'å½’ç±»' && card.classificationSubtype) {
            const subBadge = document.createElement('span');
            subBadge.className = 'classification-subtype';
            subBadge.textContent = card.classificationSubtype;
            meta.appendChild(subBadge);
          }

          // éšè— matchCount
          // if (typeof card.matchCount === 'number' && card.matchCount > 0) {
          //   const mc = document.createElement('span');
          //   mc.className = 'match-count';
          //   mc.textContent = `åŒ¹é… ${card.matchCount}`;
          //   meta.appendChild(mc);
          // }

          // éšè— score
          // if (typeof card.score === 'number') {
          //   const scoreChip = document.createElement('span');
          //   scoreChip.className = 'chip-score';
          //   scoreChip.textContent = `score ${Math.round(card.score)}`;
          //   meta.appendChild(scoreChip);
          // }

          element.appendChild(actionsContainer);
          element.appendChild(title);
          element.appendChild(meta);

          // éšè— snippetHtml
          // if (card.snippetHtml) {
          //   const snippet = document.createElement('div');
          //   snippet.className = 'card-snippet';
          //   snippet.innerHTML = card.snippetHtml;
          //   element.appendChild(snippet);
          // }

          element.addEventListener('click', () => toggleSelection(card.id, element));
          element.addEventListener('dblclick', () => {
            const isMobile = window.innerWidth <= 1024;
            if (isMobile) {
              // ç¡®ä¿å·²é€‰ä¸­
              if (state.selectedCardId !== card.id) {
                toggleSelection(card.id, element);
              }
              // å±•å¼€ä¾§è¾¹æ 
              openSidebar();
            }
          });
          fragment.appendChild(element);
            } catch (cardError) {
              console.error('æ¸²æŸ“å¡ç‰‡å¤±è´¥:', cardError, card);
              // ç»§ç»­æ¸²æŸ“å…¶ä»–å¡ç‰‡
            }
          });

          dom.results.appendChild(fragment);
          updateSearchCount(items.length);
          updateSelectionInfo();
          updateActionButtonsState();
        } catch (error) {
          console.error('æ¸²æŸ“ç»“æœå¤±è´¥:', error);
          showToast('æ¸²æŸ“å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
        }
      }

      // åˆ›å»ºå•ä¸ªå¡ç‰‡å…ƒç´ ï¼ˆæå–å‡ºæ¥ç”¨äºå¤ç”¨ï¼‰
      function createCardElement(card) {
        try {
          const element = document.createElement('div');
        element.className = 'card';
        element.dataset.id = card.id;

        if (state.selectedCardId === card.id) {
          element.classList.add('selected');
        }

        const color = resolveTypeColor(card);
        element.style.borderLeftColor = color;

        // åˆ›å»ºæ“ä½œå›¾æ ‡å®¹å™¨
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'card-actions';

        // å›¾æ ‡1: åœ¨ä¸»è„‘å›¾å®šä½
        const mindMapIcon = document.createElement('div');
        mindMapIcon.className = 'card-action-icon';
        mindMapIcon.textContent = 'ğŸ“';
        mindMapIcon.title = 'åœ¨ä¸»è„‘å›¾å®šä½';
        mindMapIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          handleCardFocus(card.id);
        });

        // å›¾æ ‡2: åœ¨æµ®çª—ä¸­å®šä½
        const floatMapIcon = document.createElement('div');
        floatMapIcon.className = 'card-action-icon';
        floatMapIcon.textContent = 'ğŸ¯';
        floatMapIcon.title = 'åœ¨æµ®çª—ä¸­å®šä½';
        floatMapIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!postBridge('focusCardInFloatMindMap', { id: card.id })) {
            showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šåœ¨æµ®çª—ä¸­å®šä½');
          }
        });

        // å›¾æ ‡3: å¤åˆ¶è¡Œå†…é“¾æ¥
        const copyMarkdownLinkIcon = document.createElement('div');
        copyMarkdownLinkIcon.className = 'card-action-icon text-icon';
        copyMarkdownLinkIcon.innerHTML = 'è¡Œå†…<br>é“¾æ¥';
        copyMarkdownLinkIcon.title = 'å¤åˆ¶è¡Œå†…é“¾æ¥';
        copyMarkdownLinkIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!postBridge('copyMarkdownLink', { id: card.id })) {
            showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šå¤åˆ¶è¡Œå†…é“¾æ¥');
          } else {
            showToast('å·²å¤åˆ¶è¡Œå†…é“¾æ¥');
          }
        });

        // å›¾æ ‡4: åœ¨æµ®çª—ä¸­å®šä½
        const copyURLIcon = document.createElement('div');
        copyURLIcon.className = 'card-action-icon text-icon';
        copyURLIcon.innerHTML = 'å¤åˆ¶<br>URL';
        copyURLIcon.title = 'å¤åˆ¶å¡ç‰‡ URL';
        copyURLIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!postBridge('copyNoteURL', { id: card.id })) {
            showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šå¤åˆ¶ URL');
          } else {
            showToast('å·²å¤åˆ¶ URL');
          }
        });

        // å›¾æ ‡5: åŒå‘é“¾æ¥ï¼ˆåŒå‡»è§¦å‘ï¼‰
        const bidirectionalLinkIcon = document.createElement('div');
        bidirectionalLinkIcon.className = 'card-action-icon';
        bidirectionalLinkIcon.textContent = 'ğŸ”—';
        bidirectionalLinkIcon.title = 'åŒå‘é“¾æ¥ï¼ˆåŒå‡»æ‰§è¡Œï¼‰';

        // åŒå‡»æ£€æµ‹é€»è¾‘
        let clickCount = 0;
        let clickTimer = null;

        bidirectionalLinkIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          clickCount++;

          if (clickTimer) clearTimeout(clickTimer);

          if (clickCount === 1) {
            // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šæ˜¾ç¤ºæç¤º
            showToast('ğŸ‘† å†æ¬¡ç‚¹å‡»ä»¥å»ºç«‹åŒå‘é“¾æ¥', 800);
            clickTimer = setTimeout(() => {
              clickCount = 0;
            }, 300);
          } else if (clickCount === 2) {
            // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šæ‰§è¡Œæ“ä½œ
            clickCount = 0;
            if (!postBridge('bidirectionalLinkFromeFocusNoteToTargetNote', { id: card.id })) {
              showToast('æ“ä½œå¤±è´¥');
            } else {
              showToast('âœ… å·²å»ºç«‹åŒå‘é“¾æ¥');
            }
          }
        });

        // å°†å›¾æ ‡æ·»åŠ åˆ°å®¹å™¨ï¼ˆ2x3å¸ƒå±€ï¼šç¬¬1è¡Œ - ä¸»è„‘å›¾/æµ®çª—/åŒå‘é“¾æ¥ï¼Œç¬¬2è¡Œ - è¡Œå†…é“¾æ¥/å¤åˆ¶URL/é¢„ç•™ï¼‰
        actionsContainer.appendChild(mindMapIcon);
        actionsContainer.appendChild(floatMapIcon);
        actionsContainer.appendChild(bidirectionalLinkIcon);
        actionsContainer.appendChild(copyMarkdownLinkIcon);
        actionsContainer.appendChild(copyURLIcon);

        const title = document.createElement('div');
        title.className = 'card-title';
        title.innerHTML = card.titleHtml || escapeHtml(card.title || '');

        const meta = document.createElement('div');
        meta.className = 'card-meta';

        const typeBadge = document.createElement('span');
        typeBadge.className = 'card-type';
        typeBadge.style.background = color;
        typeBadge.textContent = card.type || 'æœªçŸ¥ç±»å‹';
        meta.appendChild(typeBadge);

        if (card.type === 'å½’ç±»' && card.classificationSubtype) {
          const subBadge = document.createElement('span');
          subBadge.className = 'classification-subtype';
          subBadge.textContent = card.classificationSubtype;
          meta.appendChild(subBadge);
        }

        // éšè— matchCount
        // if (typeof card.matchCount === 'number' && card.matchCount > 0) {
        //   const mc = document.createElement('span');
        //   mc.className = 'match-count';
        //   mc.textContent = `åŒ¹é… ${card.matchCount}`;
        //   meta.appendChild(mc);
        // }

        // éšè— score
        // if (typeof card.score === 'number') {
        //   const scoreChip = document.createElement('span');
        //   scoreChip.className = 'chip-score';
        //   scoreChip.textContent = `score ${Math.round(card.score)}`;
        //   meta.appendChild(scoreChip);
        // }

        element.appendChild(actionsContainer);
        element.appendChild(title);
        element.appendChild(meta);

        // éšè— snippetHtml
        // if (card.snippetHtml) {
        //   const snippet = document.createElement('div');
        //   snippet.className = 'card-snippet';
        //   snippet.innerHTML = card.snippetHtml;
        //   element.appendChild(snippet);
        // }

        element.addEventListener('click', () => toggleSelection(card.id, element));
        element.addEventListener('dblclick', () => {
          const isMobile = window.innerWidth <= 1024;
          if (isMobile) {
            // ç¡®ä¿å·²é€‰ä¸­
            if (state.selectedCardId !== card.id) {
              toggleSelection(card.id, element);
            }
            // å±•å¼€ä¾§è¾¹æ 
            openSidebar();
          }
        });
        return element;
        } catch (error) {
          console.error('åˆ›å»ºå¡ç‰‡å…ƒç´ å¤±è´¥:', error, card);
          // è¿”å›ä¸€ä¸ªç®€å•çš„é”™è¯¯å ä½å…ƒç´ 
          const errorElement = document.createElement('div');
          errorElement.className = 'card';
          errorElement.style.borderLeftColor = '#ff6b6b';
          errorElement.innerHTML = '<div class="card-title">âš ï¸ å¡ç‰‡æ¸²æŸ“å¤±è´¥</div>';
          return errorElement;
        }
      }

      function resolveTypeColor(card) {
        if (card.color && /^#/.test(card.color)) return card.color;
        if (typeof card.colorIndex === 'number' && state.config.colorIndexPalette[card.colorIndex]) {
          return state.config.colorIndexPalette[card.colorIndex];
        }
        if (card.type && state.config.typeColors[card.type]) {
          return state.config.typeColors[card.type];
        }
        return '#d4d9e6';
      }

      function toggleSelection(cardId, element) {
        if (!cardId) return;

        const isMobile = window.innerWidth <= 1024;
        const wasAlreadySelected = (state.selectedCardId === cardId);

        if (wasAlreadySelected) {
          // å†æ¬¡ç‚¹å‡»å·²é€‰ä¸­å¡ç‰‡
          if (isMobile) {
            // ç§»åŠ¨ç«¯ï¼šå±•å¼€ä¾§è¾¹æ ï¼ˆä¿æŒé€‰ä¸­çŠ¶æ€ï¼‰
            openSidebar();
            return;
          }
          // æ¡Œé¢ç«¯ï¼šå–æ¶ˆé€‰ä¸­
          state.selectedCardId = null;
          if (element) element.classList.remove('selected');
        } else {
          // é€‰ä¸­æ–°å¡ç‰‡
          state.selectedCardId = cardId;
          dom.results.querySelectorAll('.card.selected').forEach((node) => node.classList.remove('selected'));
          if (element) element.classList.add('selected');
        }

        updateSelectionInfo();
        updateActionButtonsState();
        if (state.selectedCardId) {
          collapseFiltersAfterCardSelection();
        }
      }

      function pruneSelections(availableIds) {
        if (state.selectedCardId && !availableIds.has(state.selectedCardId)) {
          state.selectedCardId = null;
          updateSelectionInfo();
          updateActionButtonsState();
        }
      }

      function clearSelection() {
        if (!state.selectedCardId) return;
        state.selectedCardId = null;
        dom.results.querySelectorAll('.card.selected').forEach((node) => node.classList.remove('selected'));
        updateSelectionInfo();
        updateActionButtonsState();
      }

      function updateSearchCount(count) {
        dom.searchCount.textContent = `${count} æ¡ç»“æœ`;
      }

      // formatUpdateTime å’Œ updateIndexModeBadge å·²ç§»è‡³å…¨å±€ä½œç”¨åŸŸï¼ˆwindow å¯¹è±¡ï¼‰

      function updateSelectionInfo() {
        if (!state.selectedCardId) {
          dom.selectedCardInfo.textContent = 'æœªé€‰ä¸­å¡ç‰‡';
          dom.selectedCardInfo.classList.add('empty');
          return;
        }

        const selected = state.cards.find((item) => item.id === state.selectedCardId) ||
                        state.filteredCards.find((item) => item.id === state.selectedCardId);

        if (selected) {
          const title = selected.title || '(æ— æ ‡é¢˜)';
          const type = selected.type || 'æœªåˆ†ç±»';

          // æ„å»ºç±»å‹æ˜¾ç¤ºæ–‡æœ¬
          let typeDisplay = type;
          if (type === 'å½’ç±»' && selected.classificationSubtype) {
            typeDisplay = `${type} - ${selected.classificationSubtype}`;
          }

          dom.selectedCardInfo.innerHTML = `<strong>${title}</strong><br><small>${typeDisplay}</small>`;
          dom.selectedCardInfo.classList.remove('empty');
        } else {
          dom.selectedCardInfo.textContent = 'å·²é€‰ 1 é¡¹';
          dom.selectedCardInfo.classList.remove('empty');
        }
      }

      function updateActionButtonsState() {
        const disabled = !state.selectedCardId;

        // æ›´æ–°æ‰€æœ‰ Sidebar æŒ‰é’®çŠ¶æ€ï¼ˆå·²ç§»é™¤ focusCardInFloatMindMapBtn å’Œ copyMarkdownLinkBtnï¼‰
        const sidebarButtons = [
          dom.mergeFocusNoteToTargetNoteExcerptPartBtn,
          dom.clearTitleAndMergeFocusNoteToTargetNoteExcerptPartBtn,
          dom.bidirectionalLinkFromeFocusNoteToTargetNoteBtn,
          dom.moveFocusNoteToTargetNoteAsChildBtn,
          dom.moveFocusNoteToTargetNoteAsChildAndLocateBtn,
          dom.moveFocusNoteToTargetNoteAsChildAndMakeNoteBtn,
          dom.moveFocusNoteToTargetNoteAsChildAndMakeNoteAndLocateBtn,
          dom.addTemplateToTargetNoteAndMoveFocusNoteAsChildBtn,
          dom.addTemplateToTargetNoteAndMoveFocusNoteAsChildAndLocateBtn,
        ];

        sidebarButtons.forEach((btn) => {
          if (btn) btn.disabled = disabled;
        });
      }

      function handleCardFocus(cardId) {
        if (!cardId) return;

        if (!postBridge('focusCardInMindMap', { id: cardId })) {
          showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šåœ¨ä¸»è„‘å›¾å®šä½');
        }
      }

      function handleSidebarAction(action) {
        if (!state.selectedCardId) {
          showToast('è¯·å…ˆé€‰æ‹©å¡ç‰‡');
          return;
        }

        const id = state.selectedCardId;
        const card = state.cards.find((item) => item.id === id) ||
                     state.filteredCards.find((item) => item.id === id) ||
                     { title: id };

        switch (action) {
          case 'focusCardInFloatMindMap':
            if (!postBridge('focusCardInFloatMindMap', { id })) {
              showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šåœ¨æµ®çª—ä¸­å®šä½');
            }
            break;

          case 'copyMarkdownLink': {
            if (!postBridge('copyMarkdownLink', { id })) {
              showToast('åŠŸèƒ½å¼€å‘ä¸­ï¼šå¤åˆ¶è¡Œå†…é“¾æ¥');
            } else {
              showToast('å¤åˆ¶è¡Œå†…é“¾æ¥');
            }
            break;
          }

          case 'mergeFocusNoteToTargetNoteExcerptPart':
            if (!postBridge('mergeFocusNoteToTargetNoteExcerptPart', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          case 'clearTitleAndMergeFocusNoteToTargetNoteExcerptPart':
            if (!postBridge('clearTitleAndMergeFocusNoteToTargetNoteExcerptPart', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          case 'bidirectionalLinkFromeFocusNoteToTargetNote':
            if (!postBridge('bidirectionalLinkFromeFocusNoteToTargetNote', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          case 'moveFocusNoteToTargetNoteAsChild':
            if (!postBridge('moveFocusNoteToTargetNoteAsChild', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          case 'moveFocusNoteToTargetNoteAsChildAndLocate':
            if (!postBridge('moveFocusNoteToTargetNoteAsChildAndLocate', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          case 'moveFocusNoteToTargetNoteAsChildAndMakeNote':
            if (!postBridge('moveFocusNoteToTargetNoteAsChildAndMakeNote', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          case 'moveFocusNoteToTargetNoteAsChildAndMakeNoteAndLocate':
            if (!postBridge('moveFocusNoteToTargetNoteAsChildAndMakeNoteAndLocate', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          case 'addTemplateToTargetNoteAndMoveFocusNoteAsChild':
            if (!postBridge('addTemplateToTargetNoteAndMoveFocusNoteAsChild', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          case 'addTemplateToTargetNoteAndMoveFocusNoteAsChildAndLocate':
            if (!postBridge('addTemplateToTargetNoteAndMoveFocusNoteAsChildAndLocate', { id })) {
              showToast('æ“ä½œå¤±è´¥');
            }
            break;

          default:
            showToast('æœªçŸ¥æ“ä½œ');
            break;
        }
      }

      function registerBridge() {
        const api = {
          setSearchResults(results, options = {}) {
            const datasetKey = options.datasetKey || state.currentDatasetKey;
            setCardsForDataset(datasetKey, results, options);
          },
          appendSearchResults(results, options = {}) {
            const datasetKey = options.datasetKey || state.currentDatasetKey;
            setCardsForDataset(datasetKey, results, { replace: false });
          },
          setPresets(presets) {
            if (!presets) return;
            // æ”¯æŒæ–°æ—§ä¸¤ç§æ ¼å¼
            state.config.presetGroups = normalizePresetConfig(presets);
            state.activePresets.clear();
            renderPresetBar();
            scheduleSearch({ triggerNative: false });
          },
          setNegativePresets(presets) {
            if (!Array.isArray(presets)) return;
            state.config.negativePresets = Array.from(new Set(presets.filter(Boolean)));
            state.activeNegativePresets.clear();
            renderNegativeBar();
            scheduleSearch({ triggerNative: false });
          },
          setTypeFilters(filters) {
            if (!Array.isArray(filters) || !filters.length) return;
            state.config.typeFilters = filters
              .map((filter, index) => ({
                key: filter.key || filter.value || `preset-${index}`,
                label: filter.label || filter.name || filter.key || `ç±»å‹ ${index + 1}`,
                types: Array.isArray(filter.types) ? filter.types.slice() : null,
              }))
              .filter(Boolean);

            state.currentTypeKey = state.config.typeFilters[0]?.key || 'all';
            renderTypeBar();
            scheduleSearch({ triggerNative: false });
          },
          updateConfig(config) {
            if (!config || typeof config !== 'object') return;
            if (config.typeColors) {
              state.config.typeColors = { ...state.config.typeColors, ...config.typeColors };
            }
            if (config.colorIndexPalette) {
              state.config.colorIndexPalette = { ...state.config.colorIndexPalette, ...config.colorIndexPalette };
            }
            scheduleSearch({ triggerNative: false });
          },
          resetSelection() {
            clearSelection();
          },
          switchDataset(datasetKey) {
            setActiveDataset(datasetKey, { requestIfEmpty: true });
          },
          showToast,
          postMessage: postBridge,
        };

        window.MNKB = Object.assign({}, window.MNKB || {}, api);

        if (!window.MNKBBridge) {
          window.MNKBBridge = {};
        }
        if (typeof window.MNKBBridge.performSearch !== 'function') {
          window.MNKBBridge.performSearch = function () {
            return false;
          };
        }
        if (typeof window.MNKBBridge.postMessage !== 'function') {
          window.MNKBBridge.postMessage = function (action, params) {
            postToAddon(action, params);
          };
        }

        // é€šçŸ¥ Native ç«¯ WebView åˆå§‹åŒ–å®Œæˆ
        if (window.Bridge && typeof window.Bridge.notifyReady === 'function') {
          window.Bridge.notifyReady();
        }
      }

      /**
       * è®¾ç½®å¡ç‰‡æ•°æ®ï¼ˆå…¼å®¹æ—§æ¥å£ï¼Œå¿½ç•¥ datasetKeyï¼‰
       * @param {string} datasetKey - æ•°æ®é›†é”®ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼‰
       * @param {Array} results - å¡ç‰‡æ•°ç»„
       * @param {Object} options - é€‰é¡¹
       */
      function setCardsForDataset(datasetKey, results, options = {}) {
        console.log(`ğŸ“¥ setCardsForDataset è¢«è°ƒç”¨ (datasetKey å·²å¿½ç•¥):`, datasetKey);
        updateCards(results, { replace: options.replace !== false });
      }

      function postBridge(action, params = {}) {
        try {
          if (window.MNKBBridge && typeof window.MNKBBridge.postMessage === 'function') {
            window.MNKBBridge.postMessage(action, params);
            return true;
          }
        } catch (error) {
          console.warn('postMessage è°ƒç”¨å¤±è´¥', error);
        }

        try {
          postToAddon(action, params);
          return true;
        } catch (error) {
          console.warn('postToAddon è°ƒç”¨å¤±è´¥', error);
        }

        return false;
      }

      function postToAddon(action, params = {}) {
        const scheme = 'mnknowledgebase';
        const url = generateUrlScheme(scheme, action, params);
        window.location.href = url;
      }

      function generateUrlScheme(scheme, path, params) {
        let url = `${scheme}://${path || ''}`;
        const keys = Object.keys(params || {});
        if (keys.length > 0) {
          const query = keys
            .map((key) => {
              const value = params[key];
              const serialised = typeof value === 'object' ? JSON.stringify(value) : value;
              return `${encodeURIComponent(key)}=${encodeURIComponent(serialised)}`;
            })
            .join('&');
          url += query ? `?${query}` : '';
        }
        return url;
      }

      function showToast(message, duration = 1600) {
        if (!dom.toast) return;
        dom.toast.textContent = message;
        dom.toast.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          dom.toast.classList.remove('show');
        }, duration);
      }

      function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      function highlightTextWithTokens(text, tokens) {
        if (!text) return '';

        // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å ä½ç¬¦ï¼ˆé˜²å¾¡æ€§æªæ–½ï¼‰
        text = text.replace(/__HL_\d+_\d+__/g, '');

        // ç§»é™¤é«˜äº®åŠŸèƒ½ï¼Œç›´æ¥è¿”å›è½¬ä¹‰åçš„æ–‡æœ¬
        if (/<[^>]+>/.test(text)) {
          // å¦‚æœå·²ç»åŒ…å« HTML æ ‡ç­¾ï¼Œç›´æ¥è¿”å›
          return text;
        }

        // è¿”å› HTML è½¬ä¹‰åçš„çº¯æ–‡æœ¬ï¼Œç¡®ä¿å®‰å…¨æ€§
        return escapeHtml(text);
      }

      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\$&');
      }

      function debounce(fn, wait) {
        let timer = null;
        return function (...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      // ========================================
      // AI æ¨èå¡ç‰‡åŠŸèƒ½
      // ========================================

      /**
       * æ¸²æŸ“ AI æ¨èå¡ç‰‡åˆ°ä¸“ç”¨åŒºåŸŸ
       * @param {Array} cards - æ¨èçš„å¡ç‰‡æ•°ç»„
       */
      function renderAIRecommendations(cards) {
        const log = (msg) => window.Bridge.logToNative(msg);
        log('[renderAIRecommendations] å¼€å§‹æ¸²æŸ“ï¼Œå¡ç‰‡æ•°: ' + cards.length);

        const panel = document.getElementById('aiRecommendationsPanel');
        const content = document.getElementById('aiRecommendationsContent');
        const countEl = document.getElementById('aiRecommendationsCount');

        log('[renderAIRecommendations] å…ƒç´ æ£€æŸ¥:');
        log('  - panel: ' + (panel ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
        log('  - content: ' + (content ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
        log('  - countEl: ' + (countEl ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));

        if (!panel || !content || !countEl) {
          log('[renderAIRecommendations] âŒ æ¨èé¢æ¿å…ƒç´ æœªæ‰¾åˆ°');
          return;
        }

        // æ¸…ç©ºæ—§å†…å®¹
        content.innerHTML = '';
        log('[renderAIRecommendations] å·²æ¸…ç©ºæ—§å†…å®¹');

        // æ›´æ–°æ•°é‡
        countEl.textContent = cards.length + ' å¼ ';
        log('[renderAIRecommendations] å·²æ›´æ–°æ•°é‡æ˜¾ç¤º');

        // æ¸²æŸ“å¡ç‰‡
        const fragment = document.createDocumentFragment();
        cards.forEach((card, index) => {
          log('[renderAIRecommendations] æ¸²æŸ“ç¬¬ ' + (index + 1) + ' å¼ å¡ç‰‡: ' + card.title);
          // å¤ç”¨ç°æœ‰çš„ createCardElement å‡½æ•°
          const cardElement = createCardElement(card);

          // ç‚¹å‡»åèšç„¦åˆ°è„‘å›¾ï¼ˆè¦†ç›–åŸæœ‰çš„é€‰ä¸­é€»è¾‘ï¼‰
          cardElement.onclick = () => {
            log('[renderAIRecommendations] å¡ç‰‡è¢«ç‚¹å‡»: ' + card.title + ' (' + card.id + ')');
            handleCardFocus(card.id);
          };

          fragment.appendChild(cardElement);
        });

        content.appendChild(fragment);
        log('[renderAIRecommendations] âœ… æ‰€æœ‰å¡ç‰‡å·²æ·»åŠ åˆ° DOM');
      }

      /**
       * æ˜¾ç¤º AI æ¨èé¢æ¿
       */
      function showAIRecommendationsPanel() {
        const log = (msg) => window.Bridge.logToNative(msg);
        log('[showAIRecommendationsPanel] å¼€å§‹æ˜¾ç¤ºé¢æ¿');

        const panel = document.getElementById('aiRecommendationsPanel');

        if (panel) {
          log('[showAIRecommendationsPanel] âœ… æ‰¾åˆ°é¢æ¿å…ƒç´ ');
          log('[showAIRecommendationsPanel] æ·»åŠ  show class å‰: ' + panel.classList.contains('show'));

          panel.classList.add('show');

          log('[showAIRecommendationsPanel] æ·»åŠ  show class å: ' + panel.classList.contains('show'));
          log('[showAIRecommendationsPanel] classList: ' + Array.from(panel.classList).join(', '));

          // å»¶è¿Ÿæ£€æŸ¥ transform å±æ€§
          setTimeout(() => {
            const computedStyle = window.getComputedStyle(panel);
            log('[showAIRecommendationsPanel] transform å€¼: ' + computedStyle.transform);
            log('[showAIRecommendationsPanel] display å€¼: ' + computedStyle.display);
            log('[showAIRecommendationsPanel] visibility å€¼: ' + computedStyle.visibility);
          }, 100);
        } else {
          log('[showAIRecommendationsPanel] âŒ æ‰¾ä¸åˆ°é¢æ¿å…ƒç´ ï¼');
        }
      }

      /**
       * éšè— AI æ¨èé¢æ¿
       */
      function hideAIRecommendationsPanel() {
        const panel = document.getElementById('aiRecommendationsPanel');
        if (panel) {
          panel.classList.remove('show');
        }
      }

      // ========================================
      // AI åŠ©æ‰‹åŠŸèƒ½
      // ========================================

      /**
       * AI åŠ©æ‰‹å¯¹è±¡
       * ç®¡ç† AI ä¾§è¾¹æ çš„æ‰€æœ‰äº¤äº’é€»è¾‘
       */
      window.AIHelper = {
        // DOM å…ƒç´ å¼•ç”¨
        sidebar: null,
        toggleBtn: null,
        closeBtn: null,
        sendBtn: null,
        input: null,
        messages: null,
        contextCards: null,
        loading: null,

        // çŠ¶æ€
        isOpen: false,
        currentContext: [],

        /**
         * åˆå§‹åŒ– AI åŠ©æ‰‹
         */
        init: function() {
          console.log('[AIHelper] åˆå§‹åŒ–å¼€å§‹');

          // è·å– DOM å…ƒç´ 
          this.sidebar = document.getElementById('aiSidebar');
          this.toggleBtn = document.getElementById('aiToggleBtn');
          this.closeBtn = document.getElementById('aiCloseBtn');
          this.sendBtn = document.getElementById('aiSendBtn');
          this.input = document.getElementById('aiInput');
          this.messages = document.getElementById('aiMessages');
          this.contextCards = document.getElementById('aiContextCards');
          this.loading = document.getElementById('aiLoading');

          if (!this.sidebar || !this.toggleBtn) {
            console.error('[AIHelper] å…³é”®å…ƒç´ æœªæ‰¾åˆ°');
            return;
          }

          // ç»‘å®šäº‹ä»¶
          this.toggleBtn.addEventListener('click', () => this.toggleSidebar());
          this.closeBtn.addEventListener('click', () => this.closeSidebar());
          this.sendBtn.addEventListener('click', () => this.sendQuestion());

          // è¾“å…¥æ¡†å›è½¦å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰
          this.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              this.sendQuestion();
            }
          });

          console.log('[AIHelper] åˆå§‹åŒ–å®Œæˆ');
        },

        /**
         * åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
         */
        toggleSidebar: function() {
          if (this.isOpen) {
            this.closeSidebar();
          } else {
            this.openSidebar();
          }
        },

        /**
         * æ‰“å¼€ä¾§è¾¹æ 
         */
        openSidebar: function() {
          this.sidebar.classList.add('ai-sidebar--open');
          this.isOpen = true;
          console.log('[AIHelper] ä¾§è¾¹æ å·²æ‰“å¼€');

          // æ›´æ–°ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨å½“å‰æœç´¢ç»“æœçš„ top 5ï¼‰
          this.updateContext();
        },

        /**
         * å…³é—­ä¾§è¾¹æ 
         */
        closeSidebar: function() {
          this.sidebar.classList.remove('ai-sidebar--open');
          this.isOpen = false;
          console.log('[AIHelper] ä¾§è¾¹æ å·²å…³é—­');
        },

        /**
         * æ›´æ–°ä¸Šä¸‹æ–‡ï¼ˆä»å½“å‰æœç´¢ç»“æœä¸­æå– top 5ï¼‰
         */
        updateContext: function() {
          try {
            // è·å–å½“å‰æ˜¾ç¤ºçš„å¡ç‰‡ï¼ˆé™åˆ¶ top 5ï¼‰
            const visibleCards = Array.from(document.querySelectorAll('.item:not(.item--hidden)'))
              .slice(0, 5)
              .map(cardEl => {
                const titleEl = cardEl.querySelector('.title');
                const typeEl = cardEl.querySelector('.type');
                const descEl = cardEl.querySelector('.desc');

                return {
                  id: cardEl.dataset.id || '',
                  title: titleEl ? titleEl.textContent.trim() : '(æ— æ ‡é¢˜)',
                  type: typeEl ? typeEl.textContent.trim() : '',
                  searchText: descEl ? descEl.textContent.trim() : ''
                };
              });

            this.currentContext = visibleCards;

            // æ›´æ–° UI æ˜¾ç¤º
            this.displayContext();

            console.log('[AIHelper] ä¸Šä¸‹æ–‡å·²æ›´æ–°ï¼Œå¡ç‰‡æ•°:', visibleCards.length);
          } catch (error) {
            console.error('[AIHelper] æ›´æ–°ä¸Šä¸‹æ–‡å¤±è´¥:', error);
          }
        },

        /**
         * æ˜¾ç¤ºä¸Šä¸‹æ–‡å¡ç‰‡
         */
        displayContext: function() {
          if (this.currentContext.length === 0) {
            this.contextCards.innerHTML = '<span class="ai-context-empty">æœç´¢åå°†è‡ªåŠ¨é€‰æ‹©ç›¸å…³å¡ç‰‡ä½œä¸ºä¸Šä¸‹æ–‡</span>';
            return;
          }

          this.contextCards.innerHTML = this.currentContext
            .map(card => `
              <div class="ai-context-card-chip" title="${card.title}">
                ${card.type ? `<span class="card-type-badge">${card.type}</span>` : ''}
                <span>${card.title}</span>
              </div>
            `)
            .join('');
        },

        /**
         * å‘é€é—®é¢˜åˆ° AI
         */
        sendQuestion: function() {
          const question = this.input.value.trim();
          if (!question) {
            Bridge.log('[AIHelper] âš ï¸ é—®é¢˜ä¸ºç©ºï¼Œå–æ¶ˆå‘é€');
            return;
          }

          Bridge.log('========================================');
          Bridge.log('[AIHelper] ğŸš€ ç”¨æˆ·ç‚¹å‡»å‘é€æŒ‰é’®');
          Bridge.log('[AIHelper] ğŸ“ é—®é¢˜å†…å®¹: ' + question);
          Bridge.log('[AIHelper] ğŸ“š ä¸Šä¸‹æ–‡å¡ç‰‡æ•°: ' + this.currentContext.length);

          if (this.currentContext.length > 0) {
            Bridge.log('[AIHelper] ğŸ“‹ ä¸Šä¸‹æ–‡å¡ç‰‡åˆ—è¡¨:');
            this.currentContext.forEach((card, idx) => {
              Bridge.log('[AIHelper]   ' + (idx + 1) + '. [' + (card.type || 'æ— ç±»å‹') + '] ' + card.title);
            });
          }

          // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
          this.displayUserMessage(question);

          // æ¸…ç©ºè¾“å…¥æ¡†
          this.input.value = '';

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          this.showLoading();

          // è°ƒç”¨ Native å±‚
          try {
            const contextJSON = JSON.stringify(this.currentContext);
            Bridge.log('[AIHelper] ğŸ“¦ ä¸Šä¸‹æ–‡ JSON é•¿åº¦: ' + contextJSON.length);

            const url = `mnknowledgebase://askAI?question=${encodeURIComponent(question)}&context=${encodeURIComponent(contextJSON)}`;
            Bridge.log('[AIHelper] ğŸ”— URL Scheme é•¿åº¦: ' + url.length);
            Bridge.log('[AIHelper] ğŸ”— URL Scheme å‰100å­—ç¬¦: ' + url.substring(0, 100));

            // âœ… ä½¿ç”¨ <a> æ ‡ç­¾è§¦å‘å¯¼èˆªï¼ˆä¸çŸ¥è¯†ç‚¹å¡ç‰‡æŒ‰é’®ä¸€è‡´ï¼‰
            Bridge.log('[AIHelper] â³ åˆ›å»ºä¸´æ—¶ <a> æ ‡ç­¾å¹¶ç‚¹å‡»...');
            const link = document.createElement('a');
            link.href = url;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            Bridge.log('[AIHelper] âœ… <a> æ ‡ç­¾ç‚¹å‡»å®Œæˆ');

          } catch (error) {
            Bridge.log('[AIHelper] âŒ å‘é€å¤±è´¥: ' + error.message);
            Bridge.log('[AIHelper] âŒ é”™è¯¯å †æ ˆ: ' + error.stack);
            this.hideLoading();
            this.displayErrorMessage('å‘é€å¤±è´¥: ' + error.message);
          }
        },

        /**
         * æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
         */
        displayUserMessage: function(message) {
          const messageEl = document.createElement('div');
          messageEl.className = 'ai-message ai-message--user';

          const bubble = document.createElement('div');
          bubble.className = 'ai-message-bubble';
          bubble.textContent = message;

          const timestamp = document.createElement('div');
          timestamp.className = 'ai-message-timestamp';
          timestamp.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

          messageEl.appendChild(bubble);
          messageEl.appendChild(timestamp);

          // ç§»é™¤æ¬¢è¿æ¶ˆæ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const welcomeMsg = this.messages.querySelector('.ai-welcome-message');
          if (welcomeMsg) {
            welcomeMsg.remove();
          }

          this.messages.appendChild(messageEl);
          this.scrollToBottom();
        },

        /**
         * æ˜¾ç¤º AI å“åº”æ¶ˆæ¯
         */
        displayAssistantMessage: function(message) {
          this.hideLoading();

          const messageEl = document.createElement('div');
          messageEl.className = 'ai-message ai-message--assistant';

          const bubble = document.createElement('div');
          bubble.className = 'ai-message-bubble';

          // ç®€å•çš„ Markdown æ¸²æŸ“ï¼ˆå¯ä»¥åç»­ä½¿ç”¨ä¸“ä¸šåº“ï¼‰
          const htmlContent = this.renderMarkdown(message);
          bubble.innerHTML = htmlContent;

          const timestamp = document.createElement('div');
          timestamp.className = 'ai-message-timestamp';
          timestamp.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

          messageEl.appendChild(bubble);
          messageEl.appendChild(timestamp);

          this.messages.appendChild(messageEl);
          this.scrollToBottom();

          console.log('[AIHelper] AI å“åº”å·²æ˜¾ç¤º');
        },

        /**
         * æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
         */
        displayErrorMessage: function(errorMsg) {
          this.hideLoading();

          const messageEl = document.createElement('div');
          messageEl.className = 'ai-message ai-message--assistant';

          const bubble = document.createElement('div');
          bubble.className = 'ai-message-bubble';
          bubble.innerHTML = `<p style="color: #ef4444;">âŒ ${errorMsg}</p>`;

          messageEl.appendChild(bubble);

          this.messages.appendChild(messageEl);
          this.scrollToBottom();
        },

        /**
         * ç®€å•çš„ Markdown æ¸²æŸ“
         * ï¼ˆåŸºç¡€å®ç°ï¼Œå¯ä»¥åç»­ä½¿ç”¨ marked.js ç­‰ä¸“ä¸šåº“ï¼‰
         */
        renderMarkdown: function(text) {
          let html = text;

          // ä»£ç å—
          html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

          // è¡Œå†…ä»£ç 
          html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

          // ç²—ä½“
          html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

          // æ ‡é¢˜
          html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
          html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
          html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

          // åˆ—è¡¨
          html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
          html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

          // æ®µè½ï¼ˆç®€å•å¤„ç†ï¼‰
          html = html.split('\n\n').map(para => {
            if (!para.startsWith('<')) {
              return '<p>' + para + '</p>';
            }
            return para;
          }).join('\n');

          return html;
        },

        /**
         * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
         */
        showLoading: function() {
          this.loading.style.display = 'flex';
          this.sendBtn.disabled = true;
        },

        /**
         * éšè—åŠ è½½çŠ¶æ€
         */
        hideLoading: function() {
          this.loading.style.display = 'none';
          this.sendBtn.disabled = false;
        },

        /**
         * æ»šåŠ¨åˆ°åº•éƒ¨
         */
        scrollToBottom: function() {
          setTimeout(() => {
            this.messages.scrollTop = this.messages.scrollHeight;
          }, 100);
        }
      };

    })();
  </script>

  <!-- AI æ¨èåŒºåŸŸ -->
  <div class="ai-recommendations-panel" id="aiRecommendationsPanel">
    <!-- å¤´éƒ¨ï¼šæ ‡é¢˜ + å…³é—­æŒ‰é’® -->
    <div class="ai-recommendations-header">
      <div class="ai-recommendations-title">
        <span class="ai-icon">ğŸ¤–</span>
        <span class="ai-title-text">AI æ¨èå¡ç‰‡</span>
        <span class="ai-count" id="aiRecommendationsCount">0 å¼ </span>
      </div>
      <button class="ai-close-btn" id="aiCloseRecommendationsBtn" type="button" aria-label="å…³é—­æ¨è">
        âœ•
      </button>
    </div>

    <!-- å¡ç‰‡å®¹å™¨ -->
    <div class="ai-recommendations-content" id="aiRecommendationsContent">
      <!-- å¡ç‰‡å°†é€šè¿‡ JS åŠ¨æ€æ’å…¥ -->
    </div>
  </div>
</body>
</html>
