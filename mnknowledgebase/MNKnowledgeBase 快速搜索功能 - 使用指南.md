# MNKnowledgeBase 快速搜索功能 - 使用指南

## 功能概述

MNKnowledgeBase v0.2 版本新增了**快速搜索功能**，通过预构建 JSON 索引的方式，将原本需要 5-10 秒的搜索时间缩短到 100 毫秒以内，极大提升了知识库的使用体验。

### 核心特性
- ⚡ **秒级响应**：基于索引的快速搜索，响应时间 < 100ms
- 🎯 **精准匹配**：支持中英文精确包含匹配
- 📊 **智能排序**：根据匹配位置和相关性自动排序
- 🏷️ **类型过滤**：可限定搜索特定类型的卡片

## 安装方法

1. **下载插件文件**
   - 文件名：`mnknowledgebase_v0_2_快速搜索.mnaddon`

2. **安装到 MarginNote 4**
   - 双击 `.mnaddon` 文件，自动安装到 MarginNote 4
   - 或手动将文件复制到：`~/Library/Containers/QReader.MarginNoteApp/Data/Library/MarginNote Extensions/`

3. **重启 MarginNote 4**
   - 完全退出并重新打开 MarginNote 4

## 使用步骤

### 第一步：构建搜索索引（首次使用必须）

1. **打开笔记本**
   - 确保打开了包含知识库卡片的笔记本

2. **点击插件图标**
   - 在工具栏找到 MNKnowledgeBase 插件图标并点击

3. **选择"更新搜索索引"**
   - 在弹出菜单中选择 `🔄 更新搜索索引`
   - 系统会显示"正在构建索引，请稍候..."

4. **等待索引完成**
   - 根据卡片数量，通常需要几秒到几十秒
   - 完成后会显示"索引构建完成：xxx 张卡片"

> ⚠️ **重要提示**：
> - 首次使用必须先构建索引
> - 新增或修改卡片后需要重新更新索引
> - 索引文件保存在本地，下次使用无需重建

### 第二步：使用快速搜索

1. **打开搜索功能**
   - 点击插件图标
   - 选择 `🔍 快速搜索`

2. **输入搜索关键词**
   - 在弹出的输入框中输入要搜索的内容
   - 支持中文、英文、混合搜索
   - 点击"搜索"按钮

3. **查看搜索结果**
   - 系统会显示匹配的卡片列表
   - 每个结果显示：序号、类型标签、标题预览

4. **定位到卡片**
   - 点击想要查看的卡片
   - 如果在脑图视图，会自动定位到该卡片
   - 如果在文档视图，会显示卡片标题

## 搜索范围说明

快速搜索会在以下内容中查找关键词：

### 定义卡片
- **前缀内容**：【定义 >> 这里的内容】
- **标题链接词**：】后面的内容，以分号分隔

**示例**：
- 卡片标题：`【定义 >> Hilbert 空间中的一族规范正交集】; 规范正交基; 标准正交基`
- 可搜索：`Hilbert 空间`、`规范正交集`、`规范正交基`、`标准正交基`

### 命题卡片
- **前缀内容**：【命题 >> 这里的内容】
- **标题链接词**：】后面的内容
- **关键词字段**：卡片中"关键词："字段的内容

**示例**：
- 卡片标题：`【命题 >> Bessel 不等式的性质】Bessel 不等式`
- 关键词字段：`Bessel inequality; 贝塞尔不等式`
- 可搜索：`Bessel`、`不等式`、`性质`、`inequality`、`贝塞尔`

### 归类卡片
- **引号内内容**："xxx"中的 xxx
- **细分类别**：相关后面的类型（如"定义"、"命题"）

**示例**：
- 卡片标题：`"Hilbert 空间中的正交"相关定义`
- 可搜索：`Hilbert 空间`、`正交`、`定义`

## 高级功能

### 搜索结果排序

搜索结果会根据以下规则自动排序（分数从高到低）：

1. **完全匹配**（+100 分）：搜索文本完全等于关键词
2. **标题链接词匹配**（+50 分）：关键词出现在标题链接词中
3. **关键词字段匹配**（+30 分）：关键词出现在"关键词"字段
4. **前缀内容匹配**（+20 分）：关键词出现在前缀内容中
5. **基础匹配**（+10 分）：任何包含匹配

### 索引管理

#### 查看索引信息
索引文件保存在：`~/Library/Containers/QReader.MarginNoteApp/Data/Documents/MarginNote/Database/kb-search-index.json`

#### 索引更新时机
建议在以下情况更新索引：
- 批量导入新卡片后
- 修改了大量卡片标题
- 调整了卡片类型
- 每天使用前更新一次

#### 索引文件大小
- 1,000 张卡片：约 200KB
- 10,000 张卡片：约 2MB
- 100,000 张卡片：约 20MB

## 常见问题

### Q1: 为什么搜索没有结果？
**A**: 可能的原因和解决方法：
1. 未构建索引 → 执行"更新搜索索引"
2. 索引过期 → 重新更新索引
3. 关键词拼写错误 → 检查关键词
4. 卡片类型不在索引范围 → 目前只索引"定义"、"命题"、"归类"类型

### Q2: 搜索速度还是很慢？
**A**: 检查以下情况：
1. 首次搜索会加载索引到内存，需要 1-2 秒
2. 索引文件过大（超过 10MB）可能影响加载速度
3. 建议定期清理无用卡片，保持知识库精简

### Q3: 更新索引需要多长时间？
**A**: 取决于卡片数量：
- 100 张卡片：< 1 秒
- 1,000 张卡片：2-5 秒
- 10,000 张卡片：20-30 秒

### Q4: 索引会自动更新吗？
**A**: 目前版本需要手动更新。未来版本计划支持：
- 定时自动更新
- 增量更新（只更新变化的卡片）
- 后台静默更新

### Q5: 支持模糊搜索吗？
**A**: 当前版本只支持精确包含匹配。未来版本计划支持：
- 拼音搜索
- 相似词搜索
- 正则表达式

## 性能优化建议

### 1. 合理控制卡片数量
- 定期清理无用卡片
- 归档旧的知识库
- 分主题建立不同笔记本

### 2. 优化卡片标题
- 使用规范的标题格式
- 添加有意义的关键词
- 避免过长的标题（建议 < 100 字符）

### 3. 定期维护索引
- 每天首次使用前更新
- 大量修改后立即更新
- 发现搜索异常时重建索引

## 技术细节

### 索引数据结构
```json
{
  "metadata": {
    "version": "1.0",
    "lastUpdated": "2025-01-27T12:00:00",
    "totalCards": 1234,
    "targetTypes": ["定义", "命题", "归类"]
  },
  "searchData": [
    {
      "id": "卡片UUID",
      "type": "卡片类型",
      "title": "完整标题",
      "searchText": "可搜索的文本内容"
    }
  ]
}
```

### 搜索算法
- 使用 JavaScript 的 `String.includes()` 进行文本匹配
- 遍历索引数组，时间复杂度 O(n)
- 内存中操作，无需访问 MarginNote 数据库

### 兼容性
- MarginNote 4.0.0 及以上版本
- macOS 10.14 及以上版本
- 支持 iPad 版本（需要 iPadOS 13.0+）

## 反馈与支持

### 问题反馈
如遇到问题，请提供以下信息：
1. MarginNote 版本号
2. 插件版本号（当前 v0.2）
3. 卡片数量级
4. 具体问题描述和截图

### 功能建议
欢迎提出功能改进建议，特别是：
- 搜索体验优化
- 新的搜索模式
- 性能提升方案

### 开发计划
下一版本（v0.3）计划功能：
- [ ] 支持更多卡片类型
- [ ] 增量索引更新
- [ ] 搜索历史记录
- [ ] 高级过滤选项
- [ ] 导出搜索结果

## 更新日志

### v0.2 - 2025-01-27
- ✨ 新增：快速搜索功能
- ✨ 新增：JSON 索引构建
- ✨ 新增：搜索结果排序
- 🎨 优化：菜单界面布局

### v0.1 - 2025-01-26
- 🎉 初始版本发布
- ✨ 实现基础框架
- ✨ JSON 读写测试功能

---

*最后更新：2025-01-27*  
*作者：Claude (AI Assistant) & xiakangwei*