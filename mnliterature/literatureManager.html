<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="filename" content="MarginNote_Literature_Manager.html">
  <title>MarginNote 文献管理系统</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --card-bg: #fff;
      --accent: #2b7cff;
      --muted: #666;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      --topbar-height: 64px;
      --tabs-height: 52px;
      --filter-height: 0px;

      /* 文献类型颜色 */
      --article-color: #5569ff;
      --conference-color: #ff9d4d;
      --book-color: #a36bff;
      --thesis-color: #5bd0a9;
      --other-color: #b7c2d0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: #111;
      -webkit-font-smoothing: antialiased;
      touch-action: manipulation;
      overscroll-behavior: contain;
    }

    /* ========== 固定顶栏 ========== */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 130;
      backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(250, 250, 250, 0.9));
      border-bottom: 1px solid #e6e9ef;
      padding: 14px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      min-height: var(--topbar-height);
      transition: transform 0.3s ease;
    }

    .topbar-main {
      flex: 1 1 640px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      min-width: 0;
    }

    .topbar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-input-wrap {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 1;
      min-width: 240px;
    }

    .search-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #d6dbe8;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      font-size: 15px;
      outline: none;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(43, 124, 255, 0.1);
    }

    .search-count {
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }

    .btn {
      background: var(--card-bg);
      border: 1px solid #e3e6ee;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .btn:hover {
      background: #f7f9fc;
      border-color: var(--accent);
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(43, 124, 255, 0.2);
    }

    .btn.primary:hover {
      background: #1b6cef;
    }

    .btn.ghost {
      background: transparent;
      border-color: transparent;
      color: #4d5e78;
      box-shadow: none;
    }

    .btn.ghost:hover {
      background: rgba(43, 124, 255, 0.08);
      border-color: rgba(43, 124, 255, 0.12);
      color: #2b7cff;
    }

    /* ========== 筛选面板 ========== */
    .filters-panel {
      position: fixed;
      top: var(--topbar-height);
      left: 0;
      right: 0;
      z-index: 80;
      background: rgba(247, 248, 251, 0.95);
      backdrop-filter: blur(4px);
      padding: 12px 20px;
      border-bottom: 1px solid #e6e9ef;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .filters-panel.show {
      max-height: 500px;
      padding: 16px 20px;
    }

    .filter-section {
      margin-bottom: 14px;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-label {
      font-size: 12px;
      font-weight: 600;
      color: #5b6a80;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-label::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.45;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .pill {
      background: #eef5ff;
      color: #2f4a8a;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      user-select: none;
      white-space: nowrap;
    }

    .pill:hover {
      background: #e0efff;
      transform: translateY(-1px);
    }

    .pill.active {
      background: var(--accent);
      color: #fff;
      border-color: rgba(43, 124, 255, 0.6);
      box-shadow: 0 4px 12px rgba(43, 124, 255, 0.18);
    }

    /* 年份范围滑块 */
    .year-range-slider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .year-range-slider input[type="range"] {
      flex: 1;
      height: 6px;
      background: #d6dbe8;
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .year-range-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(43, 124, 255, 0.3);
    }

    .year-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      min-width: 40px;
      text-align: center;
    }

    /* ========== 主内容区 ========== */
    .main-layout {
      padding-top: calc(var(--topbar-height) + var(--tabs-height));
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .main-layout.with-filters {
      padding-top: calc(var(--topbar-height) + var(--tabs-height) + var(--filter-height));
    }

    .container {
      padding: 16px 20px 80px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* ========== 文献卡片网格 ========== */
    .literature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .literature-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--other-color);
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .literature-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .literature-card.selected {
      border-left-width: 8px;
      box-shadow: 0 12px 28px rgba(43, 124, 255, 0.3), 0 0 0 3px rgba(43, 124, 255, 0.1);
      transform: translateY(-4px) scale(1.01);
      background: linear-gradient(135deg, rgba(43, 124, 255, 0.02), rgba(255, 255, 255, 1));
      animation: pulseSelection 0.5s ease-out;
    }

    @keyframes pulseSelection {
      0% {
        box-shadow: 0 12px 28px rgba(43, 124, 255, 0.3), 0 0 0 0 rgba(43, 124, 255, 0.3);
      }
      50% {
        box-shadow: 0 12px 28px rgba(43, 124, 255, 0.3), 0 0 0 8px rgba(43, 124, 255, 0);
      }
      100% {
        box-shadow: 0 12px 28px rgba(43, 124, 255, 0.3), 0 0 0 3px rgba(43, 124, 255, 0.1);
      }
    }

    .literature-card.expanded {
      grid-column: 1 / -1;
      max-width: 900px;
      margin: 0 auto;
      position: relative;
      z-index: 100;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    /* 卡片操作图标 - iPad 友好,始终可见 */
    .card-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      opacity: 1;  /* 始终可见 */
    }

    .action-icon {
      width: 40px;  /* 加大触摸区域 */
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;  /* 图标稍大 */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .action-icon:active {
      transform: scale(0.9);  /* 触摸反馈 */
    }

    /* 卡片头部 */
    .card-header {
      padding-right: 140px;  /* 为3个按钮留出空间 */
    }

    .card-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
      color: #2c3e50;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .card-authors {
      font-size: 13px;
      color: #5b6a80;
      margin-bottom: 4px;
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .meta-divider {
      width: 1px;
      height: 12px;
      background: #d6dbe8;
    }

    .card-keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .keyword-tag {
      padding: 3px 10px;
      background: rgba(43, 124, 255, 0.08);
      color: var(--accent);
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .keyword-tag:hover {
      background: rgba(43, 124, 255, 0.15);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(43, 124, 255, 0.2);
    }

    .keyword-tag:active {
      transform: translateY(0);
    }

    .keyword-tag.search-active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 8px rgba(43, 124, 255, 0.3);
    }

    /* 展开的详情 */
    .card-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .literature-card.expanded .card-details {
      max-height: 1000px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e6e9ef;
    }

    .detail-section {
      margin-bottom: 12px;
    }

    .detail-label {
      font-size: 12px;
      font-weight: 600;
      color: #5b6a80;
      margin-bottom: 6px;
    }

    .detail-content {
      font-size: 14px;
      line-height: 1.6;
      color: #2c3e50;
    }

    .detail-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e6e9ef;
    }

    /* ========== 封面图片 ========== */
    .card-cover-thumbnail {
      max-width: 150px;
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      float: left;
      margin-right: 16px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .card-cover-thumbnail:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .card-content-with-cover {
      overflow: hidden; /* 清除浮动 */
    }

    .card-cover-full {
      max-width: 100%;
      max-height: 600px;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      margin: 16px auto;
      display: block;
      cursor: zoom-in;
    }

    .card-cover-full:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    /* ========== 空状态 ========== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* ========== 加载更多 ========== */
    .load-more-container {
      text-align: center;
      padding: 24px 0;
      display: none;
    }

    .load-more-container.show {
      display: block;
    }

    /* ========== Toast 提示 ========== */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(33, 33, 33, 0.88);
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 200;
    }

    .toast.show {
      opacity: 1;
    }

    /* ========== 背景模糊遮罩 ========== */
    .backdrop-blur {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(247, 248, 251, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 90;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .backdrop-blur.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* ========== 星标功能样式 ========== */
    .action-icon.pin-icon {
      color: #fbbf24;
    }

    .action-icon.pin-icon.pinned {
      color: #f59e0b;
      background: rgba(251, 191, 36, 0.15);
    }

    /* ========== Tab导航栏 ========== */
    .view-tabs {
      position: fixed;
      top: var(--topbar-height);
      left: 0;
      right: 0;
      z-index: 120;
      background: #fff;
      border-bottom: 1px solid #e6e9ef;
      display: flex;
      padding: 0 20px;
      gap: 4px;
    }

    .tab {
      padding: 14px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #5b6a80;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      user-select: none;
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .tab:not(.disabled):active {
      transform: scale(0.95);
    }

    /* ========== 作者视图样式 ========== */
    .author-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }

    .author-card {
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      overflow: hidden;
    }

    .author-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .author-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(102, 126, 234, 0.2);
      border-color: rgba(102, 126, 234, 0.3);
    }

    .author-card:hover::before {
      opacity: 1;
    }

    .author-card.selected {
      border-color: #667eea;
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.3);
      background: linear-gradient(135deg, #f0f3ff 0%, #ffffff 100%);
    }

    .author-card.expanded {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 150;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: authorCardExpand 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-overflow-scrolling: touch;  /* iOS 平滑滚动 */
    }

    @keyframes authorCardExpand {
      from {
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    .author-card-header {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .author-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: 700;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: transform 0.3s ease;
    }

    .author-card:hover .author-avatar {
      transform: scale(1.1);
    }

    .author-info {
      flex: 1;
      min-width: 0;
    }

    .author-name {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .author-role {
      font-size: 12px;
      color: #667eea;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .author-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      padding: 16px;
      background: rgba(102, 126, 234, 0.05);
      border-radius: 12px;
    }

    .author-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px;
    }

    .author-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }

    .author-stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .author-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.1);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      z-index: 1;
    }

    .author-card.expanded .author-close-btn {
      display: flex;
    }

    .author-close-btn:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: scale(1.1);
    }

    .author-close-btn:active {
      transform: scale(0.95);
    }

    /* 作者工作单位显示 */
    .author-affiliation {
      font-size: 13px;
      color: #667eea;
      margin-top: 4px;
      line-height: 1.4;
      word-break: break-word;
    }

    /* 基本信息编辑区域 */
    .author-basic-info {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      background: rgba(102, 126, 234, 0.03);
      border-radius: 8px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .info-label {
      font-size: 13px;
      font-weight: 600;
      color: #5b6a80;
      min-width: 80px;
    }

    .info-value {
      font-size: 13px;
      color: #2c3e50;
      flex: 1;
      min-width: 0;
      word-break: break-word;
    }

    .info-value.empty {
      color: var(--muted);
      font-style: italic;
      opacity: 0.6;
    }

    /* 作者卡片详情区域 */
    .author-card-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .author-card.expanded .author-card-details {
      max-height: none;  /* 移除高度限制，自动适应内容 */
      overflow: visible;  /* 允许内容显示，不裁剪 */
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(102, 126, 234, 0.2);
    }

    /* 自定义滚动条样式 */
    .author-card.expanded::-webkit-scrollbar {
      width: 8px;
    }

    .author-card.expanded::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    .author-card.expanded::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.3);
      border-radius: 4px;
    }

    .author-card.expanded::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.5);
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-section h4 {
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .detail-section h4::before {
      content: '';
      width: 4px;
      height: 14px;
      background: linear-gradient(180deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    /* 研究趋势图表 */
    .author-trend-chart {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: rgba(102, 126, 234, 0.03);
      border-radius: 8px;
    }

    .trend-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }

    .trend-year {
      width: 50px;
      color: var(--muted);
      font-weight: 600;
    }

    .trend-bar-container {
      flex: 1;
      height: 20px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .trend-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .trend-count {
      width: 50px;
      text-align: right;
      color: #667eea;
      font-weight: 600;
    }

    /* 关键词标签云 */
    .author-keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .author-keyword-tag {
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      color: #667eea;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid rgba(102, 126, 234, 0.2);
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .author-keyword-tag:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
    }

    .keyword-count {
      font-size: 10px;
      padding: 2px 6px;
      background: rgba(102, 126, 234, 0.2);
      border-radius: 8px;
    }

    /* 文献列表预览 */
    .author-lit-preview {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .author-lit-item {
      padding: 10px 12px;
      background: rgba(102, 126, 234, 0.03);
      border-radius: 8px;
      border-left: 3px solid #667eea;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .author-lit-item:hover {
      background: rgba(102, 126, 234, 0.08);
      transform: translateX(4px);
    }

    .author-lit-title {
      color: #2c3e50;
      font-weight: 500;
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .author-lit-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    /* 合作者列表 */
    .author-coauthors {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .coauthor-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
      border-radius: 20px;
      border: 1px solid rgba(102, 126, 234, 0.15);
      font-size: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .coauthor-item:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.15);
    }

    .coauthor-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .coauthor-name {
      color: #2c3e50;
      font-weight: 500;
    }

    .coauthor-count {
      color: #667eea;
      font-size: 11px;
    }

    /* 期刊分布 */
    .author-journals {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .journal-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: rgba(102, 126, 234, 0.03);
      border-radius: 6px;
      font-size: 12px;
    }

    .journal-name {
      color: #2c3e50;
      font-weight: 500;
      flex: 1;
    }

    .journal-count {
      color: #667eea;
      font-weight: 600;
      padding: 2px 8px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 12px;
    }

    /* 操作按钮 */
    .detail-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(102, 126, 234, 0.1);
    }

    .detail-actions .btn {
      flex: 1;
    }

    .author-view-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    .author-view-back {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--accent);
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      border: none;
    }

    .author-view-back:hover {
      background: #1b6cef;
    }

    .author-view-back:active {
      transform: scale(0.97);
    }

    .author-view-info {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
    }

    /* ========== 期刊视图样式 ========== */
    .journal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }

    .journal-card {
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      overflow: hidden;
    }

    /* 期刊卡片顶部装饰条 (根据分级显示不同颜色) */
    .journal-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .journal-card.tier-t1::before {
      background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);  /* 金色 */
    }

    .journal-card.tier-t2::before {
      background: linear-gradient(90deg, #E8E8E8 0%, #A8A8A8 100%);  /* 银色 */
    }

    .journal-card.tier-t3::before {
      background: linear-gradient(90deg, #CD7F32 0%, #8B4513 100%);  /* 铜色 */
    }

    .journal-card.tier-unranked::before {
      background: linear-gradient(90deg, #B0B0B0 0%, #808080 100%);  /* 灰色 */
    }

    .journal-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(102, 126, 234, 0.2);
      border-color: rgba(102, 126, 234, 0.3);
    }

    .journal-card:hover::before {
      opacity: 1;
    }

    .journal-card.selected {
      border-color: #667eea;
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.3);
      background: linear-gradient(135deg, #f0f3ff 0%, #ffffff 100%);
    }

    .journal-card.expanded {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 150;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: journalCardExpand 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-overflow-scrolling: touch;
    }

    @keyframes journalCardExpand {
      from {
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    /* 期刊卡片头部 */
    .journal-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }

    /* 展开状态下为关闭按钮留出空间 */
    .journal-card.expanded .journal-card-header {
      padding-right: 48px;  /* 关闭按钮宽度(32px) + 间距(16px) */
    }

    .journal-info-main {
      flex: 1;
      min-width: 0;
    }

    .journal-name {
      font-size: 17px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 8px;
      line-height: 1.4;
      word-break: break-word;
    }

    /* 期刊分级徽章 */
    .journal-tier-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .journal-tier-badge.tier-t1 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
    }

    .journal-tier-badge.tier-t2 {
      background: linear-gradient(135deg, #E8E8E8, #A8A8A8);
      color: #2c3e50;
    }

    .journal-tier-badge.tier-t3 {
      background: linear-gradient(135deg, #CD7F32, #8B4513);
    }

    .journal-tier-badge.tier-unranked {
      background: linear-gradient(135deg, #B0B0B0, #808080);
    }

    /* 评分区域 */
    .journal-scores {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      min-width: 100px;
    }

    .journal-final-score {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .journal-score-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* 期刊打星组件 */
    .journal-star-rating {
      display: flex;
      gap: 3px;
      margin-top: 4px;
    }

    .star-icon {
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #d6dbe8;
      user-select: none;
    }

    .star-icon.filled {
      color: #fbbf24;
    }

    .star-icon:hover {
      transform: scale(1.2);
      color: #fbbf24;
    }

    .star-icon:active {
      transform: scale(0.9);
    }

    /* 统计卡片 */
    .journal-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 16px;
      background: rgba(102, 126, 234, 0.05);
      border-radius: 12px;
    }

    .journal-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px;
    }

    .journal-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }

    .journal-stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: center;
    }

    /* 关闭按钮 */
    .journal-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%
;
      background: rgba(0, 0, 0, 0.1);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      z-index: 1;
    }

    .journal-card.expanded .journal-close-btn {
      display: flex;
    }

    .journal-close-btn:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: scale(1.1);
    }

    .journal-close-btn:active {
      transform: scale(0.95);
    }

    /* 期刊详情区域 */
    .journal-card-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .journal-card.expanded .journal-card-details {
      max-height: none;
      overflow: visible;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(102, 126, 234, 0.2);
    }

    /* 自定义滚动条 */
    .journal-card.expanded::-webkit-scrollbar {
      width: 8px;
    }

    .journal-card.expanded::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    .journal-card.expanded::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.3);
      border-radius: 4px;
    }

    .journal-card.expanded::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.5);
    }

    /* 代表作列表 */
    .journal-rep-papers {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .journal-rep-paper-item {
      padding: 12px 14px;
      background: rgba(102, 126, 234, 0.03);
      border-radius: 8px;
      border-left: 3px solid #667eea;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .journal-rep-paper-item:hover {
      background: rgba(102, 126, 234, 0.08);
      transform: translateX(4px);
    }

    .journal-rep-paper-title {
      font-size: 14px;
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .journal-rep-paper-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    /* 年份分布图表 */
    .journal-trend-chart {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: rgba(102, 126, 234, 0.03);
      border-radius: 8px;
    }

    .journal-trend-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }

    .journal-trend-year {
      width: 50px;
      color: var(--muted);
      font-weight: 600;
    }

    .journal-trend-bar-container {
      flex: 1;
      height: 20px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .journal-trend-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .journal-trend-count {
      width: 50px;
      text-align: right;
      color: #667eea;
      font-weight: 600;
    }

    /* 操作按钮 */
    .journal-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(102, 126, 234, 0.1);
    }

    .journal-actions .btn {
      flex: 1;
    }

    /* 返回头部 */
    .journal-view-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    .journal-view-back {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--accent);
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      border: none;
    }

    .journal-view-back:hover {
      background: #1b6cef;
    }

    .journal-view-back:active {
      transform: scale(0.97);
    }

    .journal-view-info {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
    }

    /* ========== 响应式 ========== */
    @media (max-width: 1024px) {
      .literature-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }

      .literature-card.expanded {
        grid-column: auto;
      }

      .author-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .topbar {
        padding: 12px 14px;
      }

      .topbar-main {
        flex-direction: column;
        align-items: stretch;
        min-width: 100%;
        gap: 10px;
      }

      .literature-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .container {
        padding: 12px 14px 80px;
      }
    }

    /* ========== 多来源分级信息样式 ========== */
    .journal-multi-tiers {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    .tier-source-item {
      padding: 12px;
      background: rgba(102, 126, 234, 0.03);
      border-radius: 8px;
      border-left: 3px solid rgba(102, 126, 234, 0.3);
      transition: all 0.2s ease;
    }

    .tier-source-item.primary {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
      border-left-color: #667eea;
      border-left-width: 4px;
    }

    .tier-source-item:hover {
      background: rgba(102, 126, 234, 0.08);
      transform: translateX(2px);
    }

    .tier-source-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .tier-source-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tier-source-icon {
      font-size: 12px;
      opacity: 0.7;
    }

    .tier-source-title {
      font-size: 13px;
      font-weight: 600;
      color: #2c3e50;
    }

    .primary-badge {
      display: inline-block;
      padding: 2px 8px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: 10px;
      font-weight: 700;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }

    .tier-source-weight {
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
      padding: 2px 8px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 12px;
    }

    .tier-source-tier {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tier-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .tier-desc {
      font-size: 11px;
      color: var(--muted);
    }

    .tier-score {
      font-size: 11px;
      font-weight: 600;
      color: #667eea;
      padding: 2px 6px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
    }

    .tier-summary {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
      border-radius: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .tier-summary-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex: 1;
      min-width: 80px;
    }

    .tier-summary-item.highlight {
      background: rgba(102, 126, 234, 0.1);
      padding: 8px;
      border-radius: 6px;
    }

    .tier-summary-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tier-summary-value {
      font-size: 18px;
      font-weight: 700;
      color: #667eea;
    }

    .tier-summary-item.highlight .tier-summary-value {
      font-size: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ========== 高亮样式 ========== */
    mark.highlight {
      background: rgba(255, 230, 120, 0.9);
      color: #111;
      padding: 0 2px;
      border-radius: 2px;
    }

    /* ========== 现代模态弹窗系统 ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.show .modal-container {
      transform: scale(1);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e6e9ef;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
      margin: 0;
    }

    .modal-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #5b6a80;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.1);
      transform: scale(1.1);
    }

    .modal-close:active {
      transform: scale(0.95);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      -webkit-overflow-scrolling: touch;
    }

    .modal-body::-webkit-scrollbar {
      width: 8px;
    }

    .modal-body::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.3);
      border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.5);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e6e9ef;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    /* 卡片列表样式 */
    .card-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-card {
      padding: 16px;
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .option-card:hover {
      border-color: rgba(102, 126, 234, 0.3);
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .option-card:active {
      transform: translateX(2px);
    }

    .option-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .option-card.disabled:hover {
      border-color: transparent;
      transform: none;
      box-shadow: none;
    }

    .option-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .option-content {
      flex: 1;
      min-width: 0;
    }

    .option-title {
      font-size: 15px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .option-desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .option-badge {
      padding: 4px 10px;
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .option-badge.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    /* 表单样式 */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #5b6a80;
      margin-bottom: 8px;
    }

    .form-label .required {
      color: #ff6b6b;
      margin-left: 2px;
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e6e9ef;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      outline: none;
    }

    .form-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-input::placeholder {
      color: #b0b5c3;
    }

    .form-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    /* 滑块输入 */
    .slider-group {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 8px;
    }

    .form-slider {
      flex: 1;
      height: 6px;
      background: #e6e9ef;
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      transition: transform 0.2s ease;
    }

    .form-slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }

    .form-slider::-webkit-slider-thumb:active {
      transform: scale(1.05);
    }

    .slider-value {
      min-width: 60px;
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      color: #667eea;
      padding: 4px 12px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
    }

    /* 分级选择网格 */
    .tier-selector-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .tier-option {
      padding: 16px;
      background: white;
      border: 2px solid #e6e9ef;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      position: relative;
    }

    .tier-option:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .tier-option.selected {
      background: linear-gradient(135deg, #f0f3ff, #ffffff);
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    }

    .tier-option.selected::before {
      content: '✓';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .tier-option-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .tier-option-desc {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .tier-option-score {
      font-size: 11px;
      color: #667eea;
      font-weight: 600;
      margin-top: 6px;
    }

    /* 按钮样式 */
    .modal-button {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-button.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .modal-button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .modal-button.primary:active {
      transform: translateY(0);
    }

    .modal-button.secondary {
      background: white;
      color: #5b6a80;
      border: 2px solid #e6e9ef;
    }

    .modal-button.secondary:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .modal-button.danger {
      background: #ff6b6b;
      color: white;
    }

    .modal-button.danger:hover {
      background: #ff5252;
    }

    /* ==================== 动态标签输入组件样式 ==================== */

    .tag-input-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tag-input-item {
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideIn 0.2s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tag-input-field {
      flex: 1;
      padding: 10px;
      border: 2px solid #e6e9ef;
      border-radius: 8px;
      background: #fff;
      color: #2c3e50;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    .tag-input-field:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .tag-remove-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      border: none;
      border-radius: 6px;
      background: #ff6b6b;
      color: white;
      font-size: 20px;
      font-weight: bold;
      line-height: 1;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tag-remove-btn:hover {
      background: #ff5252;
      transform: scale(1.1);
    }

    .tag-remove-btn:active {
      transform: scale(0.95);
    }

    .tag-add-btn {
      padding: 8px 14px;
      border: 1px dashed #a0aec0;
      border-radius: 6px;
      background: white;
      color: #4a5568;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tag-add-btn:hover {
      border-color: #4299e1;
      color: #4299e1;
      background: rgba(66, 153, 225, 0.05);
    }

    .tag-add-btn:active {
      transform: scale(0.98);
    }

    /* ==================== 学术链接样式 ==================== */

    .academic-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .academic-link {
      display: inline-flex;
      align-items: center;
      padding: 8px 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .academic-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .academic-link:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <!-- 固定顶栏 -->
  <div class="topbar">
    <div class="topbar-main">
      <div class="search-input-wrap">
        <input id="searchInput" class="search-input" placeholder="搜索文献：标题、作者、关键词、年份..." autocomplete="off" />
        <div id="searchCount" class="search-count">0 篇文献</div>
      </div>
    </div>
    <div class="topbar-actions">
      <button id="toggleFiltersBtn" class="btn ghost" type="button">筛选</button>
      <button id="refreshBtn" class="btn" type="button">🔄 刷新</button>
      <button id="clearBtn" class="btn" type="button">清空</button>
    </div>
  </div>

  <!-- Tab 导航栏 -->
  <div class="view-tabs" id="viewTabs">
    <div class="tab active" data-view="all">📚 全部 (0)</div>
    <div class="tab" data-view="pinned">⭐ 星标 (0)</div>
    <div class="tab disabled" data-view="author">👤 作者</div>
    <div class="tab disabled" data-view="journal">📖 期刊</div>
  </div>

  <!-- 筛选面板 -->
  <div class="filters-panel" id="filtersPanel">
    <!-- 文献类型筛选 -->
    <div class="filter-section">
      <div class="filter-label">文献类型</div>
      <div class="pill-row" id="typeFilters">
        <!-- 动态渲染 -->
      </div>
    </div>

    <!-- 年份范围 -->
    <div class="filter-section">
      <div class="filter-label">年份范围</div>
      <div class="year-range-slider">
        <span class="year-label" id="yearStartLabel">2000</span>
        <input type="range" id="yearStartRange" min="1990" max="2030" value="2000" />
        <span style="color: #999;">至</span>
        <input type="range" id="yearEndRange" min="1990" max="2030" value="2030" />
        <span class="year-label" id="yearEndLabel">2030</span>
      </div>
    </div>

    <!-- 期刊/会议筛选 -->
    <div class="filter-section">
      <div class="filter-label">期刊/会议</div>
      <div class="pill-row" id="venueFilters">
        <!-- 动态渲染 -->
      </div>
    </div>
  </div>

  <!-- 主内容区 -->
  <div class="main-layout" id="mainLayout">
    <div class="container">
      <div class="literature-grid" id="literatureGrid">
        <!-- 动态渲染文献卡片 -->
      </div>

      <!-- 加载更多 -->
      <div class="load-more-container" id="loadMoreContainer">
        <button class="btn primary" id="loadMoreBtn">加载更多</button>
      </div>
    </div>
  </div>

  <!-- Toast 提示 -->
  <div class="toast" id="toast"></div>

  <!-- 背景模糊遮罩 -->
  <div class="backdrop-blur" id="backdropBlur"></div>

  <script>
    // ==================== 数据模型和状态管理 ====================

    const state = {
      // 全部文献数据
      literatures: [],
      // 筛选后的文献
      filteredLiteratures: [],
      // 显示的文献（分页）
      displayedLiteratures: [],
      // 当前选中的文献ID
      selectedId: null,
      // 当前展开的文献ID（显示详情）
      expandedId: null,
      // 搜索关键词
      searchQuery: '',
      // 筛选器状态
      filters: {
        activeType: 'all',
        yearStart: 2000,
        yearEnd: 2030,
        activeVenue: 'all'
      },
      // 分页状态
      pagination: {
        currentPage: 1,
        pageSize: 50,
        hasMore: false
      },
      // 可用的期刊/会议列表
      availableVenues: new Set(),
      // 星标文献ID集合
      pinnedLiteratures: new Set(),
      // 当前视图: 'all' | 'pinned' | 'author' | 'journal'
      currentView: 'all',
      // 作者数据 Map: authorName -> { count, years, citations, literatures }
      authors: new Map(),
      // 当前选中的作者
      selectedAuthor: null,
      // 当前展开的作者（悬浮显示）
      expandedAuthor: null,
      // 期刊数据 Map: journalName -> { name, tier, autoScore, manualStars, finalScore, count, literatures, representativePapers }
      journals: new Map(),
      // 用户对期刊的打星评分
      journalStarRatings: new Map(),
      // 当前选中的期刊
      selectedJournal: null,
      // 当前展开的期刊（悬浮显示）
      expandedJournal: null,

      // ========== 多分级来源系统 ==========
      // 分级来源定义 Map: sourceKey -> { name, shortName, weight, enabled, builtin, tiers }
      tierSources: new Map([
        ['mathJournalTiers', {
          name: '数学领域高质量科技期刊分级目录（2024年版）',
          shortName: '数学分级',
          weight: 0.5,  // 权重（0-1）
          enabled: true,
          builtin: true,  // 内置来源，不可删除
          description: '中国科协发布的数学领域权威期刊分级',
          tiers: {
            'T1': { score: 100, name: 'T1', color: '#FFD700', description: '顶级期刊' },
            'T2': { score: 80, name: 'T2', color: '#E8E8E8', description: '优秀期刊' },
            'T3': { score: 60, name: 'T3', color: '#CD7F32', description: '良好期刊' }
          }
        }]
      ]),
      // 期刊的多来源分级 Map: journalName -> { sourceKey: tierKey }
      // 例如: "ANNALS OF MATHEMATICS" -> { mathJournalTiers: "T1", fudan: "A+", user: "核心" }
      journalMultiTiers: new Map(),
      // 用户自定义分级来源（用于扩展 tierSources）
      userTierSources: new Map()
    };

    // DOM 元素引用
    const dom = {
      searchInput: document.getElementById('searchInput'),
      searchCount: document.getElementById('searchCount'),
      toggleFiltersBtn: document.getElementById('toggleFiltersBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      clearBtn: document.getElementById('clearBtn'),
      viewTabs: document.getElementById('viewTabs'),
      filtersPanel: document.getElementById('filtersPanel'),
      mainLayout: document.getElementById('mainLayout'),
      typeFilters: document.getElementById('typeFilters'),
      yearStartRange: document.getElementById('yearStartRange'),
      yearEndRange: document.getElementById('yearEndRange'),
      yearStartLabel: document.getElementById('yearStartLabel'),
      yearEndLabel: document.getElementById('yearEndLabel'),
      venueFilters: document.getElementById('venueFilters'),
      literatureGrid: document.getElementById('literatureGrid'),
      loadMoreContainer: document.getElementById('loadMoreContainer'),
      loadMoreBtn: document.getElementById('loadMoreBtn'),
      toast: document.getElementById('toast'),
      backdropBlur: document.getElementById('backdropBlur')
    };

    // ==================== Bridge 通信接口 ====================

    window.Bridge = {
      /**
       * 加载文献数据 (Native → JS)
       * @param {Object} data - 文献数据对象
       * @param {Array} data.literatures - 文献数组
       */
      loadLiteratures: function(data) {
        console.log('Bridge.loadLiteratures 被调用', data);

        if (data && Array.isArray(data.literatures)) {
          state.literatures = data.literatures;
          extractVenues();
          applyFilters();
          renderFilters();
          showToast(`已加载 ${data.literatures.length} 篇文献`);
        }
      },

      /**
       * 刷新数据 (JS → Native)
       */
      refreshData: function() {
        console.log('Bridge.refreshData 被调用');
        postBridge('refreshLiteratures');
      },

      /**
       * 通知就绪 (JS → Native)
       */
      notifyReady: function() {
        console.log('Bridge.notifyReady 被调用');
        postBridge('htmlReady');
      },

      /**
       * 接收作者工作单位更新确认 (Native → JS)
       * @param {Object} data - 更新结果
       * @param {string} data.authorName - 作者姓名
       * @param {string} data.affiliation - 工作单位
       * @param {boolean} data.success - 是否成功
       * @param {string} data.error - 错误信息（如果失败）
       * @description Native 在完成卡片更新后调用此方法通知 JS
       */
      onAuthorAffiliationUpdated: function(data) {
        console.log('Bridge.onAuthorAffiliationUpdated 被调用', data);

        if (data && data.success) {
          // 更新成功，更新 state 中的数据
          const author = state.authors.get(data.authorName);
          if (author) {
            author.affiliation = data.affiliation;
          }

          showToast(`✅ 已保存「${data.authorName}」的工作单位`);

          // 重新渲染作者列表
          if (state.currentView === 'author') {
            renderAuthors();
          }
        } else {
          showToast(`❌ 保存失败: ${data.error || '未知错误'}`);
        }
      },

      /**
       * 接收作者工作单位数据 (Native → JS)
       * @param {Object} data - 作者工作单位数据
       * @param {string} data.authorName - 作者姓名
       * @param {string} data.affiliation - 工作单位
       * @description Native 在加载卡片数据后调用此方法传递给 JS
       */
      onAuthorAffiliationLoaded: function(data) {
        console.log('Bridge.onAuthorAffiliationLoaded 被调用', data);

        if (data && data.authorName) {
          // 更新 state 中的数据
          const author = state.authors.get(data.authorName);
          if (author) {
            author.affiliation = data.affiliation || '';
          }

          // 同时更新 sessionStorage
          updateAuthorAffiliation(data.authorName, data.affiliation || '');
        }
      },

      /**
       * 批量接收作者工作单位数据 (Native → JS)
       * @param {Object} data - 批量作者数据
       * @param {Array} data.authors - 作者数组
       * @param {string} data.authors[].name - 作者姓名
       * @param {string} data.authors[].affiliation - 工作单位
       * @description Native 在初始化时调用此方法批量传递作者数据
       */
      onAuthorsDataLoaded: function(data) {
        console.log('Bridge.onAuthorsDataLoaded 被调用', data);

        if (data && Array.isArray(data.authors)) {
          data.authors.forEach(authorData => {
            const author = state.authors.get(authorData.name);
            if (author) {
              author.affiliation = authorData.affiliation || '';
            }
          });

          showToast(`已加载 ${data.authors.length} 位作者的工作单位信息`);

          // 重新渲染作者列表
          if (state.currentView === 'author') {
            renderAuthors();
          }
        }
      }
    };

    // 为了兼容控制器代码，添加别名
    window.LiteratureBridge = window.Bridge;

    // ==================== 工具函数 ====================

    /**
     * 向 Native 发送消息
     */
    function postBridge(action, params = {}) {
      try {
        const url = `mnliterature://${action}?${buildQueryString(params)}`;
        window.location.href = url;
        return true;
      } catch (error) {
        console.warn('postBridge 失败', error);
        return false;
      }
    }

    /**
     * 构建查询字符串
     */
    function buildQueryString(params) {
      return Object.keys(params)
        .map(key => {
          const value = typeof params[key] === 'object'
            ? JSON.stringify(params[key])
            : params[key];
          return `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;
        })
        .join('&');
    }

    /**
     * 显示 Toast 提示
     */
    function showToast(message, duration = 1600) {
      dom.toast.textContent = message;
      dom.toast.classList.add('show');

      clearTimeout(showToast.timer);
      showToast.timer = setTimeout(() => {
        dom.toast.classList.remove('show');
      }, duration);
    }

    /**
     * 防抖函数
     */
    function debounce(fn, wait) {
      let timer = null;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    /**
     * HTML 转义
     */
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    /**
     * 高亮关键词
     */
    function highlightText(text, query) {
      if (!text || !query) return escapeHtml(text);

      const keywords = query.trim().split(/\s+/);
      let result = escapeHtml(text);

      keywords.forEach(keyword => {
        if (!keyword) return;
        const regex = new RegExp(`(${escapeRegExp(keyword)})`, 'gi');
        result = result.replace(regex, '<mark class="highlight">$1</mark>');
      });

      return result;
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }


    /**
     * 将字符串转换为 Title Case
     */
    String.prototype.toTitleCase = function () {
      'use strict'
      let smallWords = /^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|v.?|vs.?|via)$/i;
      let alphanumericPattern = /([A-Za-z0-9\u00C0-\u00FF])/;
      /* note there is a capturing group, so the separators will also be included in the returned list */
      let wordSeparators = /([ :–—-])/;
      let lowerBar = /_/g;
      /* regular expression: remove the space character, punctuation (.,;:!?),
         dash and lower bar at both ends of the string */
      let trimBeginEndPattern = /^[\s.,;:!?_\-]*([a-zA-Z0-9].*[a-zA-Z0-9])[\s.,;:!?_\-]*$/g;
      let romanNumberPattern = /^(I|II|III|IV|V|VI|VII|VIII|IX|X)$/i;

      return this.toLowerCase().replace(trimBeginEndPattern,"$1")
        .replace(lowerBar, " ")
        .split(wordSeparators)
        .map(function (current, index, array) {
          if (
            /* Check for small words */
            current.search(smallWords) > -1 &&
            /* Skip first and last word */
            index !== 0 &&
            index !== array.length - 1 &&
            /* cope with the situation such as: 1. the conjugation operator */
            array.slice(0,index-1).join('').search(/[a-zA-Z]/) > -1 &&
            /* Ignore title end and subtitle start */
            array[index - 3] !== ':' &&
            array[index + 1] !== ':' &&
            /* Ignore small words that start a hyphenated phrase */
            (array[index + 1] !== '-' ||
              (array[index - 1] === '-' && array[index + 1] === '-'))
          ) {
            return current.toLowerCase()
          }

          /* Uppercase roman numbers */
          if (current.search(romanNumberPattern) > -1) {
            return current.toUpperCase();
          }

          /* Ignore intentional capitalization */
          if (current.substring(1).search(/[A-Z]|\../) > -1) {
            return current;
          }

          /* Ignore URLs */
          if (array[index + 1] === ':' && array[index + 2] !== '') {
            return current;
          }

          /* Capitalize the first letter */
          return current.replace(alphanumericPattern, function (match) {
            return match.toUpperCase();
          })
        })
        .join('') // convert the list into a string
    }

    /**
     * 高亮文本并应用 Title Case（用于期刊名称）
     */
    function highlightJournalName(name, query) {
      if (!name) return '';
      const titleCased = name.toTitleCase();
      return highlightText(titleCased, query);
    }

    // ==================== 作者数据管理函数 ====================

    /**
     * 更新作者工作单位（临时存储到 sessionStorage）
     * @param {string} authorName - 作者姓名
     * @param {string} affiliation - 工作单位
     * @description 将作者的工作单位信息保存到 sessionStorage
     *              关闭或刷新页面后数据会消失
     *              需要通过 saveAuthorAffiliationToMN 同步到 MarginNote 才能永久保存
     */
    function updateAuthorAffiliation(authorName, affiliation) {
      if (!authorName) return;

      // 保存到 sessionStorage
      const key = `author_affiliation_${authorName}`;
      if (affiliation && affiliation.trim()) {
        sessionStorage.setItem(key, affiliation.trim());
      } else {
        sessionStorage.removeItem(key);
      }

      // 同时更新 state.authors
      const author = state.authors.get(authorName);
      if (author) {
        author.affiliation = affiliation ? affiliation.trim() : '';
      }
    }

    /**
     * 获取作者工作单位（从 sessionStorage）
     * @param {string} authorName - 作者姓名
     * @returns {string} 工作单位信息，如果不存在返回空字符串
     * @description 从 sessionStorage 读取作者的工作单位
     *              优先返回 sessionStorage 中的值（最新编辑）
     */
    function getAuthorAffiliation(authorName) {
      if (!authorName) return '';

      const key = `author_affiliation_${authorName}`;
      return sessionStorage.getItem(key) || '';
    }

    /**
     * 保存作者工作单位到 MarginNote 卡片（通过 Bridge）
     * @param {string} authorName - 作者姓名
     * @param {string} affiliation - 工作单位
     * @description 通过 Bridge 将工作单位保存到 MarginNote 对应的作者卡片
     *              保存后数据会永久存在，下次索引时会更新到 JSON
     *              URL Scheme: mnliterature://updateAuthorAffiliation?name=xxx&affiliation=xxx
     *
     * 【第二阶段实现】
     * 实现步骤：
     * 1. 调用 postBridge('updateAuthorAffiliation', { name, affiliation })
     * 2. Native 端查找或创建作者卡片
     * 3. 在卡片的 metadata 或评论中保存 affiliation
     * 4. 更新 JSON 索引
     * 5. 通过 Bridge.onAuthorAffiliationUpdated 回调通知结果
     */
    function saveAuthorAffiliationToMN(authorName, affiliation) {
      // 第二阶段实现：Native 持久化
      // postBridge('updateAuthorAffiliation', { name: authorName, affiliation: affiliation });
      console.log('[第二阶段] saveAuthorAffiliationToMN:', authorName, affiliation);
    }

    /**
     * 从 MarginNote 卡片加载作者工作单位（通过 Bridge）
     * @param {string} authorName - 作者姓名
     * @returns {Promise<string>} 工作单位信息
     * @description 通过 Bridge 从 MarginNote 读取作者卡片的工作单位
     *              用于在页面加载时获取最新的持久化数据
     *              URL Scheme: mnliterature://getAuthorAffiliation?name=xxx
     *
     * 【第二阶段实现】
     * 实现步骤：
     * 1. 调用 postBridge('getAuthorAffiliation', { name })
     * 2. Native 端查找作者卡片
     * 3. 读取卡片的 metadata 或评论中的 affiliation
     * 4. 通过 Bridge.onAuthorAffiliationLoaded 回调返回数据
     * 5. 等待回调并返回 Promise
     */
    async function loadAuthorAffiliationFromMN(authorName) {
      // 第二阶段实现：从 Native 加载持久化数据
      // return new Promise((resolve) => {
      //   postBridge('getAuthorAffiliation', { name: authorName });
      //   // 等待 Bridge.onAuthorAffiliationLoaded 回调
      // });
      console.log('[第二阶段] loadAuthorAffiliationFromMN:', authorName);
      return '';
    }

    /**
     * 显示编辑工作单位对话框
     * @param {string} authorName - 作者姓名
     * @description 弹出模态对话框让用户编辑作者的工作单位
     *              编辑完成后会：
     *              1. 更新 state.authors 中的数据
     *              2. 保存到 sessionStorage（临时）
     *              3. 通过 Bridge 保存到 MarginNote（永久）
     *              4. 重新渲染界面
     */
    async function showEditAffiliationDialog(authorName) {
      if (!authorName) return;

      // 1. 获取当前工作单位
      const author = state.authors.get(authorName);
      if (!author) {
        showToast('❌ 未找到作者信息');
        return;
      }

      const currentAffiliation = author.affiliation || '';

      // 2. 使用 createModal 创建对话框
      const modal = createModal({
        title: '编辑工作单位',
        subtitle: authorName,
        width: '500px',
        closeOnOverlay: true
      });

      // 3. 创建表单内容
      const formHTML = `
        <div class="affiliation-form" style="padding: 10px 0;">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
              作者姓名
            </label>
            <input
              type="text"
              readonly
              value="${escapeHtml(authorName)}"
              style="width: 100%; padding: 10px; border: 1px solid var(--border);
                     border-radius: 6px; background: var(--bg-secondary);
                     color: var(--text-secondary); font-size: 14px;"
            >
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
              工作单位
            </label>
            <textarea
              id="affiliation-input"
              rows="3"
              placeholder="请输入工作单位，例如：清华大学数学系"
              style="width: 100%; padding: 10px; border: 1px solid var(--border);
                     border-radius: 6px; background: var(--bg-primary);
                     color: var(--text-primary); font-size: 14px; resize: vertical;
                     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;"
            >${escapeHtml(currentAffiliation)}</textarea>
          </div>

          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px;
                      font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
            💡 <strong>提示：</strong>当前版本数据保存在浏览器临时存储中，刷新页面后会丢失。
            完整的持久化功能将在后续版本中实现。
          </div>
        </div>
      `;

      modal.setContent(formHTML);

      // 4. 添加保存按钮
      modal.addButton('取消', 'modal-button-secondary', () => {
        modal.hide();
      });

      modal.addButton('保存', 'modal-button-primary', () => {
        // 获取输入值
        const input = document.getElementById('affiliation-input');
        const newAffiliation = input ? input.value.trim() : '';

        // 更新数据
        updateAuthorAffiliation(authorName, newAffiliation);

        // 显示提示
        showToast(`✅ 已保存「${authorName}」的工作单位`);

        // 重新渲染作者列表
        if (state.currentView === 'author') {
          renderAuthors();
        }

        // 关闭对话框
        modal.hide();
      });

      // 5. 显示对话框
      modal.show();

      // 6. 自动聚焦到输入框
      setTimeout(() => {
        const input = document.getElementById('affiliation-input');
        if (input) {
          input.focus();
          input.setSelectionRange(input.value.length, input.value.length);
        }
      }, 100);
    }

    // ==================== 动态标签输入辅助函数 ====================

    /**
     * 渲染动态标签输入组件
     * @param {string} fieldId - 字段ID
     * @param {string} label - 字段标签
     * @param {Array<string>} values - 当前值数组
     * @param {string} placeholder - 占位符文本
     * @returns {string} HTML 字符串
     */
    function renderDynamicTagsInput(fieldId, label, values = [], placeholder = '请输入') {
      const valuesHtml = values.map((value, index) => `
        <div class="tag-input-item" data-field="${fieldId}" data-index="${index}">
          <input
            type="text"
            class="tag-input-field"
            value="${escapeHtml(value)}"
            placeholder="${placeholder}"
          />
          <button
            type="button"
            class="tag-remove-btn"
            onclick="removeTagItem('${fieldId}', ${index})"
            title="删除"
          >×</button>
        </div>
      `).join('');

      return `
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
            ${label}
          </label>
          <div class="tag-input-container" id="${fieldId}-container">
            ${valuesHtml}
          </div>
          <button
            type="button"
            class="tag-add-btn"
            onclick="addTagItem('${fieldId}', '${placeholder}')"
            style="margin-top: 8px; padding: 6px 12px; border: 1px dashed #a0aec0;
                   border-radius: 6px; background: white; color: #4a5568; font-size: 12px;
                   cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.borderColor='#4299e1'; this.style.color='#4299e1';"
            onmouseout="this.style.borderColor='#a0aec0'; this.style.color='#4a5568';"
          >+ 添加${label}</button>
        </div>
      `;
    }

    /**
     * 添加标签项（全局函数，供 HTML onclick 调用）
     * @param {string} fieldId - 字段ID
     * @param {string} placeholder - 占位符
     */
    window.addTagItem = function(fieldId, placeholder) {
      const container = document.getElementById(`${fieldId}-container`);
      if (!container) return;

      const currentItems = container.querySelectorAll('.tag-input-item');
      const newIndex = currentItems.length;

      const newItem = document.createElement('div');
      newItem.className = 'tag-input-item';
      newItem.setAttribute('data-field', fieldId);
      newItem.setAttribute('data-index', newIndex);
      newItem.innerHTML = `
        <input
          type="text"
          class="tag-input-field"
          value=""
          placeholder="${placeholder}"
        />
        <button
          type="button"
          class="tag-remove-btn"
          onclick="removeTagItem('${fieldId}', ${newIndex})"
          title="删除"
        >×</button>
      `;

      container.appendChild(newItem);

      // 聚焦到新输入框
      const input = newItem.querySelector('input');
      if (input) input.focus();
    };

    /**
     * 删除标签项（全局函数，供 HTML onclick 调用）
     * @param {string} fieldId - 字段ID
     * @param {number} index - 索引
     */
    window.removeTagItem = function(fieldId, index) {
      const container = document.getElementById(`${fieldId}-container`);
      if (!container) return;

      const item = container.querySelector(`.tag-input-item[data-field="${fieldId}"][data-index="${index}"]`);
      if (item) {
        item.remove();
        // 重新编号剩余项
        const items = container.querySelectorAll('.tag-input-item');
        items.forEach((item, idx) => {
          item.setAttribute('data-index', idx);
          const removeBtn = item.querySelector('.tag-remove-btn');
          if (removeBtn) {
            removeBtn.setAttribute('onclick', `removeTagItem('${fieldId}', ${idx})`);
          }
        });
      }
    };

    /**
     * 收集标签值（全局函数）
     * @param {string} fieldId - 字段ID
     * @returns {Array<string>} 值数组
     */
    window.collectTagValues = function(fieldId) {
      const container = document.getElementById(`${fieldId}-container`);
      if (!container) return [];

      const inputs = container.querySelectorAll('.tag-input-field');
      const values = Array.from(inputs)
        .map(input => input.value.trim())
        .filter(value => value.length > 0);

      return values;
    };

    /**
     * 添加名称变体（全局函数）
     */
    window.addNameVariant = function() {
      const input = document.getElementById('edit-newVariant');
      if (!input) return;

      const newVariant = input.value.trim();
      if (!newVariant) {
        showToast('❌ 请输入名称变体');
        return;
      }

      // 获取当前作者（从模态框的 subtitle 获取）
      const modal = document.querySelector('.modal-subtitle');
      if (!modal) return;
      const authorName = modal.textContent.trim();
      const author = state.authors.get(authorName);
      if (!author) return;

      // 检查是否已存在
      if (author.nameVariants.has(newVariant)) {
        showToast('⚠️ 该变体已存在');
        return;
      }

      // 添加新变体
      author.nameVariants.add(newVariant);

      // 重新渲染变体显示区域
      const variantsContainer = input.closest('div').previousElementSibling;
      if (variantsContainer) {
        variantsContainer.innerHTML = Array.from(author.nameVariants).map(variant => `
          <span style="display: inline-block; padding: 6px 12px;
                       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                       color: white; border-radius: 16px; font-size: 13px;
                       box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);">
            ${escapeHtml(variant)}
            ${variant !== authorName ? `
              <span onclick="removeNameVariant('${escapeHtml(variant)}')"
                    style="margin-left: 6px; cursor: pointer; opacity: 0.8;
                           font-weight: bold; transition: opacity 0.2s;"
                    onmouseover="this.style.opacity='1'"
                    onmouseout="this.style.opacity='0.8'">
                ×
              </span>
            ` : ''}
          </span>
        `).join('');
      }

      // 清空输入框
      input.value = '';
      showToast('✅ 已添加名称变体');
    };

    /**
     * 删除名称变体（全局函数）
     * @param {string} variant - 要删除的变体
     */
    window.removeNameVariant = function(variant) {
      // 获取当前作者
      const modal = document.querySelector('.modal-subtitle');
      if (!modal) return;
      const authorName = modal.textContent.trim();
      const author = state.authors.get(authorName);
      if (!author) return;

      // 不能删除原始名称
      if (variant === authorName) {
        showToast('❌ 不能删除原始名称');
        return;
      }

      // 删除变体
      author.nameVariants.delete(variant);

      // 重新渲染变体显示区域
      const variantsContainer = document.querySelector('.modal-content').querySelector('div[style*="flex-wrap"]');
      if (variantsContainer) {
        variantsContainer.innerHTML = Array.from(author.nameVariants).map(v => `
          <span style="display: inline-block; padding: 6px 12px;
                       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                       color: white; border-radius: 16px; font-size: 13px;
                       box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);">
            ${escapeHtml(v)}
            ${v !== authorName ? `
              <span onclick="removeNameVariant('${escapeHtml(v)}')"
                    style="margin-left: 6px; cursor: pointer; opacity: 0.8;
                           font-weight: bold; transition: opacity 0.2s;"
                    onmouseover="this.style.opacity='1'"
                    onmouseout="this.style.opacity='0.8'">
                ×
              </span>
            ` : ''}
          </span>
        `).join('');
      }

      showToast('✅ 已删除名称变体');
    };

    /**
     * 显示编辑作者信息对话框（统一编辑所有字段）
     * @param {string} authorName - 作者姓名
     * @description 统一编辑作者的所有元数据字段
     */
    async function editAuthorInfo(authorName) {
      if (!authorName) return;

      // 1. 获取作者数据
      const author = state.authors.get(authorName);
      if (!author) {
        showToast('❌ 未找到作者信息');
        return;
      }

      // 2. 使用 createModal 创建对话框
      const modal = createModal({
        title: '编辑作者信息',
        subtitle: authorName,
        width: '600px',
        closeOnOverlay: true
      });

      // 3. 创建表单内容
      const formHTML = `
        <div class="author-info-form" style="padding: 10px 0;">
          <!-- 作者姓名（只读） -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              作者姓名
            </label>
            <input
              type="text"
              readonly
              value="${escapeHtml(authorName)}"
              style="width: 100%; padding: 10px; border: 1px solid #e6e9ef;
                     border-radius: 8px; background: #f7f9fc;
                     color: #5b6a80; font-size: 14px;"
            >
          </div>

          <!-- 显示名称（智能选择） -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              显示名称
              <span style="font-size: 11px; color: #999; font-weight: normal;">（可选：自定义显示名称，留空则自动选择）</span>
            </label>
            <input
              type="text"
              id="edit-displayName"
              placeholder="留空则根据名称变体自动智能选择"
              value="${escapeHtml(author.displayName !== author.name ? (author.displayName || '') : '')}"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
          </div>

          <!-- 名称变体 -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              名称变体
              <span style="font-size: 11px; color: #999; font-weight: normal;">（如：李白、Bai Li、Bai L.）</span>
            </label>
            <!-- 显示现有变体 -->
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; padding: 10px;
                        background: #f7f9fc; border-radius: 8px; min-height: 40px;">
              ${Array.from(author.nameVariants || [authorName]).map(variant => `
                <span style="display: inline-block; padding: 6px 12px;
                             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                             color: white; border-radius: 16px; font-size: 13px;
                             box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);">
                  ${escapeHtml(variant)}
                  ${variant !== authorName ? `
                    <span onclick="removeNameVariant('${escapeHtml(variant)}')"
                          style="margin-left: 6px; cursor: pointer; opacity: 0.8;
                                 font-weight: bold; transition: opacity 0.2s;"
                          onmouseover="this.style.opacity='1'"
                          onmouseout="this.style.opacity='0.8'">
                      ×
                    </span>
                  ` : ''}
                </span>
              `).join('')}
            </div>
            <!-- 添加新变体 -->
            <div style="display: flex; gap: 8px;">
              <input
                type="text"
                id="edit-newVariant"
                placeholder="输入新的名称变体（如拼音、英文名等）"
                style="flex: 1; padding: 10px; border: 2px solid #e6e9ef;
                       border-radius: 8px; background: #fff;
                       color: #2c3e50; font-size: 14px;
                       transition: border-color 0.2s ease;"
                onfocus="this.style.borderColor='#667eea'"
                onblur="this.style.borderColor='#e6e9ef'"
                onkeypress="if(event.key==='Enter'){event.preventDefault();addNameVariant();}"
              >
              <button
                onclick="addNameVariant()"
                style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                       color: white; border: none; border-radius: 8px;
                       font-size: 14px; font-weight: 600; cursor: pointer;
                       transition: all 0.2s ease; white-space: nowrap;
                       box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);"
                onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.3)'"
                onmouseout="this.style.transform='';this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.2)'"
              >
                + 添加
              </button>
            </div>
          </div>

          <!-- 工作单位 -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              工作单位
            </label>
            <textarea
              id="edit-affiliation"
              rows="2"
              placeholder="例如：清华大学数学系"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px; resize: vertical;
                     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >${escapeHtml(author.affiliation || '')}</textarea>
          </div>

          <!-- 职位（下拉选择） -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              职位
            </label>
            <select
              id="edit-role"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
              <option value="">请选择职位</option>
              <option value="教授" ${author.role === '教授' ? 'selected' : ''}>教授</option>
              <option value="副教授" ${author.role === '副教授' ? 'selected' : ''}>副教授</option>
              <option value="讲师" ${author.role === '讲师' ? 'selected' : ''}>讲师</option>
              <option value="助理教授" ${author.role === '助理教授' ? 'selected' : ''}>助理教授</option>
              <option value="研究员" ${author.role === '研究员' ? 'selected' : ''}>研究员</option>
              <option value="副研究员" ${author.role === '副研究员' ? 'selected' : ''}>副研究员</option>
              <option value="助理研究员" ${author.role === '助理研究员' ? 'selected' : ''}>助理研究员</option>
              <option value="博士后" ${author.role === '博士后' ? 'selected' : ''}>博士后</option>
              <option value="博士生" ${author.role === '博士生' ? 'selected' : ''}>博士生</option>
              <option value="硕士生" ${author.role === '硕士生' ? 'selected' : ''}>硕士生</option>
              <option value="本科生" ${author.role === '本科生' ? 'selected' : ''}>本科生</option>
              <option value="其他" ${author.role === '其他' ? 'selected' : ''}>其他</option>
            </select>
          </div>

          <!-- 邮箱 -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              邮箱
            </label>
            <input
              type="email"
              id="edit-email"
              placeholder="例如：author@university.edu"
              value="${escapeHtml(author.email || '')}"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
          </div>

          <!-- 个人主页 -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              个人主页
            </label>
            <input
              type="url"
              id="edit-homepage"
              placeholder="例如：https://www.university.edu/~author"
              value="${escapeHtml(author.homepage || '')}"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
          </div>

          <!-- ORCID -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              ORCID
            </label>
            <input
              type="text"
              id="edit-orcid"
              placeholder="例如：0000-0002-1234-5678"
              value="${escapeHtml(author.orcid || '')}"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
            <div style="font-size: 12px; color: #667eea; margin-top: 6px;">
              💡 ORCID 格式：xxxx-xxxx-xxxx-xxxx
            </div>
          </div>

          <!-- 备注 -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              备注
            </label>
            <textarea
              id="edit-notes"
              rows="3"
              placeholder="添加关于该作者的任何额外信息..."
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px; resize: vertical;
                     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >${escapeHtml(author.notes || '')}</textarea>
          </div>

          <!-- ==================== 学术基本信息 ==================== -->

          <!-- 研究方向（动态标签） -->
          ${renderDynamicTagsInput('edit-researchFields', '研究方向', author.researchFields || [], '例如：机器学习')}

          <!-- 最高学历（下拉选择） -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              最高学历
            </label>
            <select
              id="edit-degree"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
              <option value="">请选择学历</option>
              <option value="博士" ${author.degree === '博士' ? 'selected' : ''}>博士</option>
              <option value="硕士" ${author.degree === '硕士' ? 'selected' : ''}>硕士</option>
              <option value="学士" ${author.degree === '学士' ? 'selected' : ''}>学士</option>
              <option value="其他" ${author.degree === '其他' ? 'selected' : ''}>其他</option>
            </select>
          </div>

          <!-- 毕业/工作机构 -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              毕业/工作机构
            </label>
            <input
              type="text"
              id="edit-institution"
              placeholder="例如：清华大学"
              value="${escapeHtml(author.institution || '')}"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
          </div>

          <!-- 学术职称（下拉选择） -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              学术职称
            </label>
            <select
              id="edit-academicTitle"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
              <option value="">请选择职称</option>
              <option value="院士" ${author.academicTitle === '院士' ? 'selected' : ''}>院士</option>
              <option value="资深教授" ${author.academicTitle === '资深教授' ? 'selected' : ''}>资深教授</option>
              <option value="特聘教授" ${author.academicTitle === '特聘教授' ? 'selected' : ''}>特聘教授</option>
              <option value="教授" ${author.academicTitle === '教授' ? 'selected' : ''}>教授</option>
              <option value="副教授" ${author.academicTitle === '副教授' ? 'selected' : ''}>副教授</option>
              <option value="讲师" ${author.academicTitle === '讲师' ? 'selected' : ''}>讲师</option>
              <option value="助理教授" ${author.academicTitle === '助理教授' ? 'selected' : ''}>助理教授</option>
              <option value="研究员" ${author.academicTitle === '研究员' ? 'selected' : ''}>研究员</option>
              <option value="副研究员" ${author.academicTitle === '副研究员' ? 'selected' : ''}>副研究员</option>
              <option value="助理研究员" ${author.academicTitle === '助理研究员' ? 'selected' : ''}>助理研究员</option>
              <option value="其他" ${author.academicTitle === '其他' ? 'selected' : ''}>其他</option>
            </select>
          </div>

          <!-- ==================== 学术主页链接 ==================== -->

          <!-- Google Scholar -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              Google Scholar
            </label>
            <input
              type="url"
              id="edit-googleScholar"
              placeholder="例如：https://scholar.google.com/citations?user=xxx"
              value="${escapeHtml(author.googleScholar || '')}"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
          </div>

          <!-- ResearchGate -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 13px;">
              ResearchGate
            </label>
            <input
              type="url"
              id="edit-researchGate"
              placeholder="例如：https://www.researchgate.net/profile/xxx"
              value="${escapeHtml(author.researchGate || '')}"
              style="width: 100%; padding: 10px; border: 2px solid #e6e9ef;
                     border-radius: 8px; background: #fff;
                     color: #2c3e50; font-size: 14px;
                     transition: border-color 0.2s ease;"
              onfocus="this.style.borderColor='#667eea'"
              onblur="this.style.borderColor='#e6e9ef'"
            >
          </div>

          <!-- ==================== 荣誉与项目 ==================== -->

          <!-- 获奖情况（动态标签） -->
          ${renderDynamicTagsInput('edit-awards', '获奖情况', author.awards || [], '例如：国家自然科学奖')}

          <!-- 主持项目（动态标签） -->
          ${renderDynamicTagsInput('edit-projects', '主持项目', author.projects || [], '例如：国家重点研发计划')}

          <!-- 提示信息 -->
          <div style="padding: 12px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
                      border-radius: 8px; font-size: 13px; color: #5b6a80; line-height: 1.6;
                      border-left: 4px solid #667eea;">
            💡 <strong>提示：</strong>当前版本数据保存在浏览器临时存储中，刷新页面后会丢失。
            完整的持久化功能将在后续版本中实现。
          </div>
        </div>
      `;

      modal.setContent(formHTML);

      // 4. 添加按钮
      modal.addButton('取消', 'secondary', () => {
        modal.hide();
      });

      modal.addButton('保存', 'primary', () => {
        // 获取所有输入值
        const affiliation = document.getElementById('edit-affiliation')?.value.trim() || '';
        const role = document.getElementById('edit-role')?.value.trim() || '';
        const email = document.getElementById('edit-email')?.value.trim() || '';
        const homepage = document.getElementById('edit-homepage')?.value.trim() || '';
        const orcid = document.getElementById('edit-orcid')?.value.trim() || '';
        const notes = document.getElementById('edit-notes')?.value.trim() || '';

        // 获取新字段的值
        const researchFields = collectTagValues('edit-researchFields');
        const degree = document.getElementById('edit-degree')?.value.trim() || '';
        const institution = document.getElementById('edit-institution')?.value.trim() || '';
        const academicTitle = document.getElementById('edit-academicTitle')?.value.trim() || '';
        const googleScholar = document.getElementById('edit-googleScholar')?.value.trim() || '';
        const researchGate = document.getElementById('edit-researchGate')?.value.trim() || '';
        const awards = collectTagValues('edit-awards');
        const projects = collectTagValues('edit-projects');

        // 获取名称相关字段
        const customDisplayName = document.getElementById('edit-displayName')?.value.trim() || '';
        // nameVariants 已经在 author 对象中实时更新了（通过 addNameVariant/removeNameVariant）
        // 如果用户输入了自定义显示名称，使用它；否则使用智能选择
        const displayName = customDisplayName || literatureUtils.selectBestDisplayName(author.nameVariants);

        // ORCID 格式验证
        if (orcid && !/^\d{4}-\d{4}-\d{4}-\d{3}[\dX]$/.test(orcid)) {
          showToast('❌ ORCID 格式不正确，应为：xxxx-xxxx-xxxx-xxxx');
          return;
        }

        // 更新 state.authors 中的数据
        author.affiliation = affiliation;
        author.role = role;
        author.email = email;
        author.homepage = homepage;
        author.orcid = orcid;
        author.notes = notes;

        // 更新新字段
        author.researchFields = researchFields;
        author.degree = degree;
        author.institution = institution;
        author.academicTitle = academicTitle;
        author.googleScholar = googleScholar;
        author.researchGate = researchGate;
        author.awards = awards;
        author.projects = projects;

        // 更新名称相关字段
        author.displayName = displayName;
        // nameVariants 已经通过 addNameVariant/removeNameVariant 实时更新了

        // 保存到 sessionStorage（为每个字段单独存储）
        const keyPrefix = `author_${authorName}_`;
        sessionStorage.setItem(keyPrefix + 'affiliation', affiliation);
        sessionStorage.setItem(keyPrefix + 'role', role);
        sessionStorage.setItem(keyPrefix + 'email', email);
        sessionStorage.setItem(keyPrefix + 'homepage', homepage);
        sessionStorage.setItem(keyPrefix + 'orcid', orcid);
        sessionStorage.setItem(keyPrefix + 'notes', notes);

        // 保存新字段（数组类型需要 JSON.stringify）
        sessionStorage.setItem(keyPrefix + 'researchFields', JSON.stringify(researchFields));
        sessionStorage.setItem(keyPrefix + 'degree', degree);
        sessionStorage.setItem(keyPrefix + 'institution', institution);
        sessionStorage.setItem(keyPrefix + 'academicTitle', academicTitle);
        sessionStorage.setItem(keyPrefix + 'googleScholar', googleScholar);
        sessionStorage.setItem(keyPrefix + 'researchGate', researchGate);
        sessionStorage.setItem(keyPrefix + 'awards', JSON.stringify(awards));
        sessionStorage.setItem(keyPrefix + 'projects', JSON.stringify(projects));

        // 保存名称相关字段
        sessionStorage.setItem(keyPrefix + 'displayName', displayName);
        sessionStorage.setItem(keyPrefix + 'nameVariants', JSON.stringify(Array.from(author.nameVariants)));

        // 显示提示
        showToast(`✅ 已保存「${authorName}」的信息`);

        // 重新渲染作者列表
        if (state.currentView === 'author') {
          renderAuthors();
        }

        // 关闭对话框
        modal.hide();
      });

      // 5. 显示对话框
      modal.show();

      // 6. 自动聚焦到第一个输入框
      setTimeout(() => {
        const firstInput = document.getElementById('edit-affiliation');
        if (firstInput) {
          firstInput.focus();
          firstInput.setSelectionRange(firstInput.value.length, firstInput.value.length);
        }
      }, 100);
    }

    /**
     * 批量从 JSON 加载作者工作单位
     * @param {Object} literatureData - 文献数据对象（包含 authors 信息）
     * @description 在 Bridge.loadLiteratures 中调用
     *              从 JSON 索引中加载所有作者的工作单位信息
     *              更新到 state.authors 中
     *
     * 【第二阶段实现】
     * 实现步骤：
     * 1. 检查 literatureData.authors 是否存在
     * 2. 遍历 authors 数组，提取 name 和 affiliation
     * 3. 更新 state.authors 中对应的作者数据
     * 4. 优先级：sessionStorage > JSON（已编辑但未持久化的数据优先）
     *
     * JSON 数据格式示例：
     * {
     *   "authors": [
     *     { "name": "张三", "affiliation": "清华大学", "count": 5 },
     *     { "name": "李四", "affiliation": "北京大学", "count": 3 }
     *   ]
     * }
     */
    function loadAuthorsAffiliationFromJSON(literatureData) {
      // 第二阶段实现：从 JSON 批量加载
      // if (literatureData && literatureData.authors) {
      //   literatureData.authors.forEach(authorData => {
      //     const author = state.authors.get(authorData.name);
      //     if (author && !getAuthorAffiliation(authorData.name)) {
      //       author.affiliation = authorData.affiliation || '';
      //     }
      //   });
      // }
      console.log('[第二阶段] loadAuthorsAffiliationFromJSON:', literatureData);
    }

    /**
     * 初始化作者数据（合并 sessionStorage 和 JSON 数据）
     * @description 页面加载时调用，合并临时数据和持久化数据
     *              优先级：sessionStorage > JSON
     */
    function initializeAuthorData() {
      if (!state.authors || state.authors.size === 0) return;

      // 遍历所有作者，从 sessionStorage 恢复所有字段
      state.authors.forEach((author, authorName) => {
        const keyPrefix = `author_${authorName}_`;

        // 加载 affiliation（工作单位）
        const savedAffiliation = sessionStorage.getItem(keyPrefix + 'affiliation');
        if (savedAffiliation) {
          author.affiliation = savedAffiliation;
        }

        // 加载 role（职位）
        const savedRole = sessionStorage.getItem(keyPrefix + 'role');
        if (savedRole) {
          author.role = savedRole;
        }

        // 加载 email（邮箱）
        const savedEmail = sessionStorage.getItem(keyPrefix + 'email');
        if (savedEmail) {
          author.email = savedEmail;
        }

        // 加载 homepage（个人主页）
        const savedHomepage = sessionStorage.getItem(keyPrefix + 'homepage');
        if (savedHomepage) {
          author.homepage = savedHomepage;
        }

        // 加载 orcid（ORCID）
        const savedOrcid = sessionStorage.getItem(keyPrefix + 'orcid');
        if (savedOrcid) {
          author.orcid = savedOrcid;
        }

        // 加载 notes（备注）
        const savedNotes = sessionStorage.getItem(keyPrefix + 'notes');
        if (savedNotes) {
          author.notes = savedNotes;
        }

        // ==================== 加载新字段 ====================

        // 加载 researchFields（研究方向 - 数组）
        const savedResearchFields = sessionStorage.getItem(keyPrefix + 'researchFields');
        if (savedResearchFields) {
          try {
            author.researchFields = JSON.parse(savedResearchFields);
          } catch (e) {
            console.warn(`解析 researchFields 失败: ${authorName}`, e);
            author.researchFields = [];
          }
        }

        // 加载 degree（最高学历）
        const savedDegree = sessionStorage.getItem(keyPrefix + 'degree');
        if (savedDegree) {
          author.degree = savedDegree;
        }

        // 加载 institution（毕业/工作机构）
        const savedInstitution = sessionStorage.getItem(keyPrefix + 'institution');
        if (savedInstitution) {
          author.institution = savedInstitution;
        }

        // 加载 academicTitle（学术职称）
        const savedAcademicTitle = sessionStorage.getItem(keyPrefix + 'academicTitle');
        if (savedAcademicTitle) {
          author.academicTitle = savedAcademicTitle;
        }

        // 加载 googleScholar（Google Scholar）
        const savedGoogleScholar = sessionStorage.getItem(keyPrefix + 'googleScholar');
        if (savedGoogleScholar) {
          author.googleScholar = savedGoogleScholar;
        }

        // 加载 researchGate（ResearchGate）
        const savedResearchGate = sessionStorage.getItem(keyPrefix + 'researchGate');
        if (savedResearchGate) {
          author.researchGate = savedResearchGate;
        }

        // 加载 awards（获奖情况 - 数组）
        const savedAwards = sessionStorage.getItem(keyPrefix + 'awards');
        if (savedAwards) {
          try {
            author.awards = JSON.parse(savedAwards);
          } catch (e) {
            console.warn(`解析 awards 失败: ${authorName}`, e);
            author.awards = [];
          }
        }

        // 加载 projects（主持项目 - 数组）
        const savedProjects = sessionStorage.getItem(keyPrefix + 'projects');
        if (savedProjects) {
          try {
            author.projects = JSON.parse(savedProjects);
          } catch (e) {
            console.warn(`解析 projects 失败: ${authorName}`, e);
            author.projects = [];
          }
        }

        // ==================== 加载名称相关字段 ====================

        // 加载 displayName（显示名称）
        const savedDisplayName = sessionStorage.getItem(keyPrefix + 'displayName');
        if (savedDisplayName) {
          author.displayName = savedDisplayName;
        }

        // 加载 nameVariants（名称变体集合）
        const savedNameVariants = sessionStorage.getItem(keyPrefix + 'nameVariants');
        if (savedNameVariants) {
          try {
            const variantsArray = JSON.parse(savedNameVariants);
            author.nameVariants = new Set(variantsArray);
          } catch (e) {
            console.warn(`解析 nameVariants 失败: ${authorName}`, e);
            author.nameVariants = new Set([authorName]);
          }
        }
      });

      console.log(`✅ 已初始化 ${state.authors.size} 个作者的数据`);
    }

    // ==================== 期刊分级数据 ====================

    /**
     * 数学领域高质量科技期刊分级目录 (2024年版)
     * 数据来源: 数学领域高质量科技期刊分级目录 （2024 年版）
     */
    const mathJournalTiers = {
      // T1: 26 种期刊
      "ACTA MATHEMATICA": "T1",
      "ACTA MATHEMATICA SCIENTIA": "T1",
      "ACTA MATHEMATICA SINICA-ENGLISH SERIES": "T1",
      "ADVANCES IN MATHEMATICS": "T1",
      "AMERICAN JOURNAL OF MATHEMATICS": "T1",
      "ANNALES SCIENTIFIQUES DE L ECOLE NORMALE SUPERIEURE": "T1",
      "ANNALS OF MATHEMATICS": "T1",
      "ASTERISQUE": "T1",
      "CAMBRIDGE JOURNAL OF MATHEMATICS": "T1",
      "COMMUNICATIONS IN MATHEMATICAL PHYSICS": "T1",
      "COMMUNICATIONS ON PURE AND APPLIED MATHEMATICS": "T1",
      "COMPOSITIO MATHEMATICA": "T1",
      "DUKE MATHEMATICAL JOURNAL": "T1",
      "GEOMETRIC AND FUNCTIONAL ANALYSIS": "T1",
      "INVENTIONES MATHEMATICAE": "T1",
      "IZVESTIYA MATHEMATICS": "T1",
      "JOURNAL DE MATHEMATIQUES PURES ET APPLIQUEES": "T1",
      "JOURNAL FUR DIE REINE UND ANGEWANDTE MATHEMATIK": "T1",
      "JOURNAL OF THE AMERICAN MATHEMATICAL SOCIETY": "T1",
      "JOURNAL OF THE EUROPEAN MATHEMATICAL SOCIETY": "T1",
      "MATHEMATISCHE ANNALEN": "T1",
      "MEMOIRS OF THE AMERICAN MATHEMATICAL SOCIETY": "T1",
      "PEKING MATHEMATICAL JOURNAL": "T1",
      "PROCEEDINGS OF THE LONDON MATHEMATICAL SOCIETY": "T1",
      "PUBLICATIONS MATHEMATIQUES DE L IHES": "T1",
      "SCIENCE CHINA-MATHEMATICS": "T1",

      // T2: 78 种期刊
      "ACTA ARITHMETICA": "T2",
      "ALGEBRA & NUMBER THEORY": "T2",
      "ALGEBRAIC AND GEOMETRIC TOPOLOGY": "T2",
      "ALGEBRAIC GEOMETRY": "T2",
      "ALGEBRAS AND REPRESENTATION THEORY": "T2",
      "ANALYSIS & PDE": "T2",
      "ANALYSIS IN THEORY AND APPLICATIONS": "T2",
      "ANNALES DE L INSTITUT FOURIER": "T2",
      "ANNALES HENRI POINCARE": "T2",
      "ANNALI DELLA SCUOLA NORMALE SUPERIORE DI PISA-CLASSE DI SCIENZE": "T2",
      "ANNALS OF PDE": "T2",
      "ANNALS OF PURE AND APPLIED LOGIC": "T2",
      "BULLETIN DES SCIENCES MATHEMATIQUES": "T2",
      "BULLETIN OF THE AMERICAN MATHEMATICAL SOCIETY": "T2",
      "BULLETIN OF THE LONDON MATHEMATICAL SOCIETY": "T2",
      "CALCULUS OF VARIATIONS AND PARTIAL DIFFERENTIAL EQUATIONS": "T2",
      "CANADIAN JOURNAL OF MATHEMATICS-JOURNAL CANADIEN DE MATHEMATIQUES": "T2",
      "CHINESE ANNALS OF MATHEMATICS SERIES B": "T2",
      "COMBINATORICA": "T2",
      "COMBINATORICS PROBABILITY & COMPUTING": "T2",
      "COMMENTARII MATHEMATICI HELVETICI": "T2",
      "COMMUNICATIONS IN ANALYSIS AND GEOMETRY": "T2",
      "COMMUNICATIONS IN PARTIAL DIFFERENTIAL EQUATIONS": "T2",
      "COMMUNICATIONS ON PURE AND APPLIED ANALYSIS": "T2",
      "DISCRETE AND CONTINUOUS DYNAMICAL SYSTEMS": "T2",
      "DISCRETE MATHEMATICS": "T2",
      "ERGODIC THEORY AND DYNAMICAL SYSTEMS": "T2",
      "EUROPEAN JOURNAL OF COMBINATORICS": "T2",
      "FORUM MATHEMATICUM": "T2",
      "FORUM OF MATHEMATICS PI": "T2",
      "FRONTIERS OF MATHEMATICS": "T2",
      "FUNDAMENTA MATHEMATICAE": "T2",
      "GEOMETRY & TOPOLOGY": "T2",
      "INDIANA UNIVERSITY MATHEMATICS JOURNAL": "T2",
      "INTERNATIONAL MATHEMATICS RESEARCH NOTICES": "T2",
      "ISRAEL JOURNAL OF MATHEMATICS": "T2",
      "JOURNAL D ANALYSE MATHEMATIQUE": "T2",
      "JOURNAL OF ALGEBRA": "T2",
      "JOURNAL OF ALGEBRAIC GEOMETRY": "T2",
      "JOURNAL OF COMBINATORIAL THEORY SERIES A": "T2",
      "JOURNAL OF COMBINATORIAL THEORY SERIES B": "T2",
      "JOURNAL OF DIFFERENTIAL EQUATIONS": "T2",
      "JOURNAL OF DIFFERENTIAL GEOMETRY": "T2",
      "JOURNAL OF FUNCTIONAL ANALYSIS": "T2",
      "JOURNAL OF GEOMETRIC ANALYSIS": "T2",
      "JOURNAL OF GEOMETRY AND PHYSICS": "T2",
      "JOURNAL OF GRAPH THEORY": "T2",
      "JOURNAL OF MATHEMATICAL LOGIC": "T2",
      "JOURNAL OF MATHEMATICAL PHYSICS": "T2",
      "JOURNAL OF MATHEMATICAL STUDY": "T2",
      "JOURNAL OF NONCOMMUTATIVE GEOMETRY": "T2",
      "JOURNAL OF NUMBER THEORY": "T2",
      "JOURNAL OF PARTIAL DIFFERENTIAL EQUATIONS": "T2",
      "JOURNAL OF PURE AND APPLIED ALGEBRA": "T2",
      "JOURNAL OF SPECTRAL THEORY": "T2",
      "JOURNAL OF SYMBOLIC LOGIC": "T2",
      "JOURNAL OF SYMPLECTIC GEOMETRY": "T2",
      "JOURNAL OF THE LONDON MATHEMATICAL SOCIETY-SECOND SERIES": "T2",
      "JOURNAL OF TOPOLOGY": "T2",
      "LETTERS IN MATHEMATICAL PHYSICS": "T2",
      "MATHEMATICAL PROCEEDINGS OF THE CAMBRIDGE PHILOSOPHICAL SOCIETY": "T2",
      "MATHEMATICAL RESEARCH LETTERS": "T2",
      "MATHEMATISCHE ZEITSCHRIFT": "T2",
      "MEMOIRES DE LA SOCIETE MATHEMATIQUE DE FRANCE": "T2",
      "PACIFIC JOURNAL OF MATHEMATICS": "T2",
      "POTENTIAL ANALYSIS": "T2",
      "PROCEEDINGS OF THE AMERICAN MATHEMATICAL SOCIETY": "T2",
      "PROCEEDINGS OF THE ROYAL SOCIETY OF EDINBURGH SECTION A-MATHEMATICS": "T2",
      "PUBLICATIONS OF THE RESEARCH INSTITUTE FOR MATHEMATICAL SCIENCES": "T2",
      "REPRESENTATION THEORY": "T2",
      "REVISTA MATEMATICA IBEROAMERICANA": "T2",
      "RUSSIAN MATHEMATICAL SURVEYS": "T2",
      "SBORNIK MATHEMATICS": "T2",
      "SELECTA MATHEMATICA-NEW SERIES": "T2",
      "SEMIGROUP FORUM": "T2",
      "STUDIA MATHEMATICA": "T2",
      "TOPOLOGY AND ITS APPLICATIONS": "T2",
      "TRANSACTIONS OF THE AMERICAN MATHEMATICAL SOCIETY": "T2",

      // T3: 94 种期刊 (只列出部分,完整列表见文档)
      "ADVANCED NONLINEAR STUDIES": "T3",
      "ADVANCES IN CALCULUS OF VARIATIONS": "T3",
      "ADVANCES IN GEOMETRY": "T3",
      "ALGEBRA COLLOQUIUM": "T3",
      "ALGEBRA UNIVERSALIS": "T3",
      "ANALYSIS AND MATHEMATICAL PHYSICS": "T3",
      "ANNALI DI MATEMATICA PURA ED APPLICATA": "T3",
      "ANNALS OF COMBINATORICS": "T3",
      "ANNALS OF GLOBAL ANALYSIS AND GEOMETRY": "T3",
      "APPLIED CATEGORICAL STRUCTURES": "T3",
      "ARCHIVE FOR MATHEMATICAL LOGIC": "T3",
      "ASIAN JOURNAL OF MATHEMATICS": "T3",
      "BANACH JOURNAL OF MATHEMATICAL ANALYSIS": "T3",
      "BULLETIN DE LA SOCIETE MATHEMATIQUE DE FRANCE": "T3",
      "BULLETIN OF SYMBOLIC LOGIC": "T3",
      "BULLETIN OF THE AUSTRALIAN MATHEMATICAL SOCIETY": "T3",
      "CANADIAN MATHEMATICAL BULLETIN-BULLETIN CANADIEN DE MATHEMATIQUES": "T3",
      "COLLOQUIUM MATHEMATICUM": "T3",
      "COMMUNICATIONS IN ALGEBRA": "T3",
      "COMMUNICATIONS IN CONTEMPORARY MATHEMATICS": "T3",
      "COMMUNICATIONS IN MATHEMATICAL RESEARCH": "T3",
      "COMMUNICATIONS OF THE AMERICAN MATHEMATICAL SOCIETY": "T3",
      "COMPTES RENDUS MATHEMATIQUE": "T3",
      "DIFFERENTIAL AND INTEGRAL EQUATIONS": "T3",
      "DIFFERENTIAL GEOMETRY AND ITS APPLICATIONS": "T3",
      "FINITE FIELDS AND THEIR APPLICATIONS": "T3",
      "FIXED POINT THEORY": "T3",
      "FORUM OF MATHEMATICS SIGMA": "T3",
      "GEOMETRIAE DEDICATA": "T3",
      "GRAPHS AND COMBINATORICS": "T3",
      "HISTORIA MATHEMATICA": "T3",
      "HOUSTON JOURNAL OF MATHEMATICS": "T3",
      "INTEGRAL EQUATIONS AND OPERATOR THEORY": "T3",
      "INTEGRAL TRANSFORMS AND SPECIAL FUNCTIONS": "T3",
      "INTERNATIONAL JOURNAL OF MATHEMATICS": "T3",
      "JOURNAL OF ALGEBRA AND ITS APPLICATIONS": "T3",
      "JOURNAL OF ALGEBRAIC COMBINATORICS": "T3",
      "JOURNAL OF APPROXIMATION THEORY": "T3",
      "JOURNAL OF COMBINATORIAL ALGEBRA": "T3",
      "JOURNAL OF CONVEX ANALYSIS": "T3",
      "JOURNAL OF DYNAMICS AND DIFFERENTIAL EQUATIONS": "T3",
      "JOURNAL OF EVOLUTION EQUATIONS": "T3",
      "JOURNAL OF FIXED POINT THEORY AND APPLICATIONS": "T3",
      "JOURNAL OF GROUP THEORY": "T3",
      "JOURNAL OF INTEGRAL EQUATIONS AND APPLICATIONS": "T3",
      "JOURNAL OF KNOT THEORY AND ITS RAMIFICATIONS": "T3",
      "JOURNAL OF LIE THEORY": "T3",
      "JOURNAL OF MATHEMATICAL ANALYSIS AND APPLICATIONS": "T3",
      "JOURNAL OF MATHEMATICAL RESEARCH WITH APPLICATIONS": "T3",
      "JOURNAL OF OPERATOR THEORY": "T3",
      "JOURNAL OF THE AUSTRALIAN MATHEMATICAL SOCIETY": "T3",
      "JOURNAL OF THE INSTITUTE OF MATHEMATICS OF JUSSIEU": "T3",
      "JOURNAL OF THE KOREAN MATHEMATICAL SOCIETY": "T3",
      "JOURNAL OF THE MATHEMATICAL SOCIETY OF JAPAN": "T3",
      "JOURNAL OF TOPOLOGY AND ANALYSIS": "T3",
      "KYOTO JOURNAL OF MATHEMATICS": "T3",
      "LINEAR & MULTILINEAR ALGEBRA": "T3",
      "LINEAR ALGEBRA AND ITS APPLICATIONS": "T3",
      "LOGIC JOURNAL OF THE IGPL": "T3",
      "MANUSCRIPTA MATHEMATICA": "T3",
      "MATHEMATICAL LOGIC QUARTERLY": "T3",
      "MATHEMATIKA": "T3",
      "MATHEMATISCHE NACHRICHTEN": "T3",
      "MICHIGAN MATHEMATICAL JOURNAL": "T3",
      "MONATSHEFTE FUR MATHEMATIK": "T3",
      "MOSCOW MATHEMATICAL JOURNAL": "T3",
      "NOTRE DAME JOURNAL OF FORMAL LOGIC": "T3",
      "ORDER-A JOURNAL ON THE THEORY OF ORDERED SETS AND ITS APPLICATIONS": "T3",
      "PROCEEDINGS OF THE EDINBURGH MATHEMATICAL SOCIETY": "T3",
      "PROCEEDINGS OF THE STEKLOV INSTITUTE OF MATHEMATICS": "T3",
      "PUBLICATIONES MATHEMATICAE-DEBRECEN": "T3",
      "QUALITATIVE THEORY OF DYNAMICAL SYSTEMS": "T3",
      "QUARTERLY JOURNAL OF MATHEMATICS": "T3",
      "RAMANUJAN JOURNAL": "T3",
      "RESULTS IN MATHEMATICS": "T3",
      "ROCKY MOUNTAIN JOURNAL OF MATHEMATICS": "T3",
      "ST PETERSBURG MATHEMATICAL JOURNAL": "T3",
      "STATISTICAL THEORY AND RELATED FIELDS": "T3",
      "SYMMETRY INTEGRABILITY AND GEOMETRY-METHODS AND APPLICATIONS": "T3",
      "THEORY AND APPLICATIONS OF CATEGORIES": "T3",
      "TOKYO JOURNAL OF MATHEMATICS": "T3",
      "TOPOLOGICAL METHODS IN NONLINEAR ANALYSIS": "T3",
      "TRANSFORMATION GROUPS": "T3"
    };

    /**
     * 规范化期刊名称用于匹配
     * @param {string} name - 期刊名称
     * @returns {string} 规范化后的名称
     */
    function normalizeJournalName(name) {
      if (!name) return '';
      return name
        .toUpperCase()
        .replace(/[^A-Z0-9\u4e00-\u9fa5]/g, ' ')  // 保留中文
        .replace(/\s+/g, ' ')
        .trim();
    }

    /**
     * 从内置数据库查询期刊分级（仅用于 mathJournalTiers）
     * @param {string} journalName - 期刊名称
     * @returns {string|null} 分级 (T1/T2/T3) 或 null
     */
    function queryBuiltinTier(journalName) {
      if (!journalName) return null;

      const normalized = normalizeJournalName(journalName);

      // 精确匹配
      if (mathJournalTiers[journalName]) {
        return mathJournalTiers[journalName];
      }

      // 规范化匹配
      for (const [key, tier] of Object.entries(mathJournalTiers)) {
        if (normalizeJournalName(key) === normalized) {
          return tier;
        }
      }

      // 模糊匹配 (包含关系)
      for (const [key, tier] of Object.entries(mathJournalTiers)) {
        const normalizedKey = normalizeJournalName(key);
        if (normalizedKey.includes(normalized) || normalized.includes(normalizedKey)) {
          return tier;
        }
      }

      return null;
    }

    /**
     * 查询期刊的所有来源分级
     * @param {string} journalName - 期刊名称
     * @returns {Object} 分级对象 { sourceKey: tierKey }
     */
    function getJournalMultiTiers(journalName) {
      if (!journalName) return {};

      const tiers = {};

      // 1. 查询用户设置的分级
      if (state.journalMultiTiers.has(journalName)) {
        Object.assign(tiers, state.journalMultiTiers.get(journalName));
      }

      // 2. 如果没有用户设置，查询内置分级
      if (!tiers.mathJournalTiers) {
        const builtinTier = queryBuiltinTier(journalName);
        if (builtinTier) {
          tiers.mathJournalTiers = builtinTier;
        }
      }

      return tiers;
    }

    /**
     * 获取期刊的主要分级（用于显示）
     * @param {string} journalName - 期刊名称
     * @returns {Object|null} { sourceKey, tierKey, source } 或 null
     */
    function getJournalPrimaryTier(journalName) {
      const multiTiers = getJournalMultiTiers(journalName);

      // 按权重排序，返回权重最高的分级
      let primaryTier = null;
      let maxWeight = 0;

      for (const [sourceKey, tierKey] of Object.entries(multiTiers)) {
        const source = state.tierSources.get(sourceKey);
        if (source && source.enabled && source.weight > maxWeight) {
          maxWeight = source.weight;
          primaryTier = {
            sourceKey,
            tierKey,
            source
          };
        }
      }

      return primaryTier;
    }

    /**
     * 兼容旧代码的函数（保持向后兼容）
     * @param {string} journalName - 期刊名称
     * @returns {string|null} 分级 (T1/T2/T3) 或 null
     */
    function getJournalTier(journalName) {
      const primary = getJournalPrimaryTier(journalName);
      return primary ? primary.tierKey : null;
    }

    /**
     * 将分级转换为评分（查询分级来源定义）
     * @param {string} sourceKey - 来源 key
     * @param {string} tierKey - 分级 key
     * @returns {number} 评分
     */
    function tierToScore(sourceKey, tierKey) {
      const source = state.tierSources.get(sourceKey);
      if (source && source.tiers && source.tiers[tierKey]) {
        return source.tiers[tierKey].score;
      }
      return 50;  // 默认50分
    }

    /**
     * 计算期刊的多来源加权自动评分
     * @param {string} journalName - 期刊名称
     * @returns {number} 加权自动评分 (0-100)
     */
    function calculateMultiSourceAutoScore(journalName) {
      const multiTiers = getJournalMultiTiers(journalName);

      let totalScore = 0;
      let totalWeight = 0;

      // 遍历所有来源的分级
      for (const [sourceKey, tierKey] of Object.entries(multiTiers)) {
        const source = state.tierSources.get(sourceKey);

        // 只计算启用的来源
        if (source && source.enabled) {
          const score = tierToScore(sourceKey, tierKey);
          totalScore += score * source.weight;
          totalWeight += source.weight;
        }
      }

      // 如果没有任何来源，返回默认分数
      if (totalWeight === 0) {
        return 50;
      }

      // 归一化权重（确保总权重为1）
      return totalScore / totalWeight;
    }

    /**
     * 计算期刊最终得分
     * @param {string} journalName - 期刊名称
     * @param {number} manualStars - 用户打星 (0-5)
     * @returns {number} 最终得分
     */
    function calculateJournalScore(journalName, manualStars) {
      // 计算多来源加权自动评分
      const autoScore = calculateMultiSourceAutoScore(journalName);

      if (manualStars > 0) {
        // 用户打星后：用户评分占 60%，自动评分占 40%
        const userScore = (manualStars / 5) * 100;
        return autoScore * 0.4 + userScore * 0.6;
      }

      // 无用户评分时使用自动评分
      return autoScore;
    }

    /**
     * 平滑滚动到指定卡片
     */
    function scrollToCard(cardElement) {
      if (!cardElement) return;

      // 使用 scrollIntoView 实现平滑滚动
      cardElement.scrollIntoView({
        behavior: 'smooth',
        block: 'center',
        inline: 'nearest'
      });
    }

    /**
     * 显示背景模糊
     */
    function showBackdrop() {
      dom.backdropBlur.classList.add('show');
      // 禁止 body 滚动
      document.body.style.overflow = 'hidden';
    }

    /**
     * 隐藏背景模糊
     */
    function hideBackdrop() {
      dom.backdropBlur.classList.remove('show');
      // 恢复 body 滚动
      document.body.style.overflow = '';
    }

    /**
     * 获取文献类型颜色
     */
    function getTypeColor(type) {
      const colorMap = {
        'article': 'var(--article-color)',
        'inproceedings': 'var(--conference-color)',
        'book': 'var(--book-color)',
        'phdthesis': 'var(--thesis-color)',
        'mastersthesis': 'var(--thesis-color)'
      };
      return colorMap[type] || 'var(--other-color)';
    }

    /**
     * 获取文献类型中文名
     */
    function getTypeName(type) {
      const nameMap = {
        'article': '期刊论文',
        'inproceedings': '会议论文',
        'book': '书籍',
        'phdthesis': '博士论文',
        'mastersthesis': '硕士论文'
      };
      return nameMap[type] || '其他';
    }

    // ==================== 星标功能 ====================

    /**
     * 切换星标状态
     * @param {string} id - 文献ID
     */
    function togglePin(id) {
      if (state.pinnedLiteratures.has(id)) {
        state.pinnedLiteratures.delete(id);
      } else {
        state.pinnedLiteratures.add(id);
      }
      savePinnedData();
      applyFilters();  // 重新排序
    }

    /**
     * 保存星标数据到 localStorage
     */
    function savePinnedData() {
      const pinnedIds = Array.from(state.pinnedLiteratures);
      localStorage.setItem('mnliterature_pinned', JSON.stringify(pinnedIds));
    }

    /**
     * 从 localStorage 加载星标数据
     */
    function loadPinnedData() {
      try {
        const saved = localStorage.getItem('mnliterature_pinned');
        if (saved) {
          const pinnedIds = JSON.parse(saved);
          state.pinnedLiteratures = new Set(pinnedIds);
        }
      } catch (error) {
        console.error('加载星标数据失败:', error);
        state.pinnedLiteratures = new Set();
      }
    }

    // ==================== 期刊数据持久化 ====================

    /**
     * 保存期刊打星数据到 localStorage
     */
    function saveJournalStarData() {
      try {
        const starData = {};
        state.journalStarRatings.forEach((stars, journalName) => {
          if (stars > 0) {
            starData[journalName] = stars;
          }
        });
        localStorage.setItem('mnliterature_journal_stars', JSON.stringify(starData));
      } catch (error) {
        console.error('保存期刊打星数据失败:', error);
      }
    }

    /**
     * 从 localStorage 加载期刊打星数据
     */
    function loadJournalStarData() {
      try {
        const saved = localStorage.getItem('mnliterature_journal_stars');
        if (saved) {
          const starData = JSON.parse(saved);
          state.journalStarRatings = new Map(Object.entries(starData));
        }
      } catch (error) {
        console.error('加载期刊打星数据失败:', error);
        state.journalStarRatings = new Map();
      }
    }

    /**
     * 保存分级来源定义到 localStorage
     */
    function saveTierSourcesData() {
      try {
        const sourcesData = {};

        // 只保存用户自定义的分级来源（内置来源不需要保存）
        state.tierSources.forEach((source, key) => {
          if (!source.builtin) {
            sourcesData[key] = source;
          }
        });

        // 同时保存分级来源的权重设置（包括内置来源的权重修改）
        const weightsData = {};
        state.tierSources.forEach((source, key) => {
          weightsData[key] = {
            weight: source.weight,
            enabled: source.enabled
          };
        });

        localStorage.setItem('mnliterature_tier_sources', JSON.stringify(sourcesData));
        localStorage.setItem('mnliterature_tier_weights', JSON.stringify(weightsData));
      } catch (error) {
        console.error('保存分级来源数据失败:', error);
      }
    }

    /**
     * 从 localStorage 加载分级来源定义
     */
    function loadTierSourcesData() {
      try {
        // 1. 加载用户自定义的分级来源
        const sourcesData = localStorage.getItem('mnliterature_tier_sources');
        if (sourcesData) {
          const sources = JSON.parse(sourcesData);
          Object.entries(sources).forEach(([key, source]) => {
            state.tierSources.set(key, source);
          });
        }

        // 2. 加载权重设置，应用到所有来源
        const weightsData = localStorage.getItem('mnliterature_tier_weights');
        if (weightsData) {
          const weights = JSON.parse(weightsData);
          Object.entries(weights).forEach(([key, config]) => {
            const source = state.tierSources.get(key);
            if (source) {
              source.weight = config.weight;
              source.enabled = config.enabled;
            }
          });
        }
      } catch (error) {
        console.error('加载分级来源数据失败:', error);
      }
    }

    /**
     * 保存期刊多来源分级数据到 localStorage
     */
    function saveJournalMultiTiersData() {
      try {
        const multiTiersData = {};
        state.journalMultiTiers.forEach((tiers, journalName) => {
          multiTiersData[journalName] = tiers;
        });
        localStorage.setItem('mnliterature_journal_multi_tiers', JSON.stringify(multiTiersData));
      } catch (error) {
        console.error('保存期刊多来源分级数据失败:', error);
      }
    }

    /**
     * 从 localStorage 加载期刊多来源分级数据
     */
    function loadJournalMultiTiersData() {
      try {
        const saved = localStorage.getItem('mnliterature_journal_multi_tiers');
        if (saved) {
          const multiTiersData = JSON.parse(saved);
          state.journalMultiTiers = new Map(Object.entries(multiTiersData));
        }
      } catch (error) {
        console.error('加载期刊多来源分级数据失败:', error);
        state.journalMultiTiers = new Map();
      }
    }

    /**
     * 切换期刊打星
     * @param {string} journalName - 期刊名称
     * @param {number} stars - 星级 (0-5, 0表示清除)
     */
    function toggleJournalStar(journalName, stars) {
      if (stars > 0) {
        state.journalStarRatings.set(journalName, stars);
      } else {
        state.journalStarRatings.delete(journalName);
      }
      saveJournalStarData();

      // 重新计算该期刊的最终得分（使用新的计算方法）
      const journal = state.journals.get(journalName);
      if (journal) {
        journal.manualStars = stars;
        journal.finalScore = calculateJournalScore(journalName, stars);
      }

      // 重新排序并更新显示
      applyFilters();
    }

    /**
     * 设置期刊的分级（单个来源）
     * @param {string} journalName - 期刊名称
     * @param {string} sourceKey - 来源 key
     * @param {string} tierKey - 分级 key（null 表示删除该来源的分级）
     */
    function setJournalTier(journalName, sourceKey, tierKey) {
      // 获取或创建该期刊的分级对象
      let tiers = state.journalMultiTiers.get(journalName);
      if (!tiers) {
        tiers = {};
        state.journalMultiTiers.set(journalName, tiers);
      }

      // 设置或删除分级
      if (tierKey) {
        tiers[sourceKey] = tierKey;
      } else {
        delete tiers[sourceKey];
      }

      // 保存数据
      saveJournalMultiTiersData();

      // 更新期刊数据
      const journal = state.journals.get(journalName);
      if (journal) {
        // 更新主要分级
        const primaryTier = getJournalPrimaryTier(journalName);
        journal.tier = primaryTier ? primaryTier.tierKey : null;
        journal.tierSource = primaryTier ? primaryTier.sourceKey : null;

        // 更新所有来源分级
        journal.multiTiers = getJournalMultiTiers(journalName);

        // 重新计算评分
        journal.autoScore = calculateMultiSourceAutoScore(journalName);
        journal.finalScore = calculateJournalScore(journalName, journal.manualStars);
      }

      // 重新排序并更新显示
      applyFilters();
    }

    /**
     * 添加或更新分级来源
     * @param {string} key - 来源 key
     * @param {Object} sourceData - 来源数据
     */
    function addOrUpdateTierSource(key, sourceData) {
      state.tierSources.set(key, sourceData);
      saveTierSourcesData();

      // 重新计算所有期刊的评分
      state.journals.forEach((journal, journalName) => {
        journal.autoScore = calculateMultiSourceAutoScore(journalName);
        journal.finalScore = calculateJournalScore(journalName, journal.manualStars);
      });

      applyFilters();
    }

    /**
     * 删除分级来源
     * @param {string} key - 来源 key
     */
    function deleteTierSource(key) {
      const source = state.tierSources.get(key);

      // 不允许删除内置来源
      if (source && source.builtin) {
        showToast("不能删除内置分级来源");
        return false;
      }

      state.tierSources.delete(key);
      saveTierSourcesData();

      // 清理所有期刊中该来源的分级
      state.journalMultiTiers.forEach((tiers, journalName) => {
        if (tiers[key]) {
          delete tiers[key];
        }
      });
      saveJournalMultiTiersData();

      // 重新计算所有期刊的评分
      state.journals.forEach((journal, journalName) => {
        const primaryTier = getJournalPrimaryTier(journalName);
        journal.tier = primaryTier ? primaryTier.tierKey : null;
        journal.tierSource = primaryTier ? primaryTier.sourceKey : null;
        journal.multiTiers = getJournalMultiTiers(journalName);
        journal.autoScore = calculateMultiSourceAutoScore(journalName);
        journal.finalScore = calculateJournalScore(journalName, journal.manualStars);
      });

      applyFilters();
      return true;
    }

    /**
     * 对文献列表排序(星标优先)
     * @param {Array} literatures - 文献列表
     * @returns {Array} 排序后的文献列表
     */
    function sortLiteratures(literatures) {
      return literatures.sort((a, b) => {
        const aPin = state.pinnedLiteratures.has(a.id) ? 1 : 0;
        const bPin = state.pinnedLiteratures.has(b.id) ? 1 : 0;

        // 星标的排在前面
        if (aPin !== bPin) {
          return bPin - aPin;
        }

        // 同等级按年份降序
        return b.year - a.year;
      });
    }

    // ==================== 数据处理 ====================

    /**
     * 提取所有期刊/会议
     */
    function extractVenues() {
      state.availableVenues.clear();
      state.literatures.forEach(lit => {
        if (lit.journal) {
          state.availableVenues.add(lit.journal);
        }
      });
    }

    /**
     * 提取所有作者及统计信息
     */
    function extractAuthors() {
      state.authors.clear();

      // 遍历筛选后的文献
      state.filteredLiteratures.forEach(lit => {
        if (!Array.isArray(lit.authors) || lit.authors.length === 0) return;

        // 处理每个作者
        lit.authors.forEach(authorName => {
          if (!authorName || !authorName.trim()) return;

          const name = authorName.trim();

          if (!state.authors.has(name)) {
            // 初始化作者数据
            state.authors.set(name, {
              name: name,
              displayName: name,             // 显示名称（智能选择的最佳变体）
              nameVariants: new Set([name]), // 名称变体集合
              affiliation: '',               // 工作单位
              role: '',                      // 职位/角色
              email: '',                     // 邮箱
              homepage: '',                  // 个人主页
              orcid: '',                     // ORCID
              notes: '',                     // 备注

              // 学术基本信息
              researchFields: [],            // 研究方向
              degree: '',                    // 最高学历
              institution: '',               // 毕业/工作机构
              academicTitle: '',             // 学术职称

              // 学术主页链接
              googleScholar: '',             // Google Scholar
              researchGate: '',              // ResearchGate

              // 荣誉与项目
              awards: [],                    // 获奖情况
              projects: [],                  // 主持项目

              count: 0,
              years: [],
              literatures: [],
              yearDistribution: new Map(),  // 年份分布
              keywords: new Map(),           // 关键词统计
              journals: new Map(),           // 期刊统计
              coauthors: new Map()           // 合作者统计
            });
          }

          const author = state.authors.get(name);
          author.count++;
          author.years.push(lit.year);
          author.literatures.push(lit);

          // 统计年份分布
          const yearCount = author.yearDistribution.get(lit.year) || 0;
          author.yearDistribution.set(lit.year, yearCount + 1);

          // 统计关键词
          if (Array.isArray(lit.keywords)) {
            lit.keywords.forEach(kw => {
              const kwCount = author.keywords.get(kw) || 0;
              author.keywords.set(kw, kwCount + 1);
            });
          }

          // 统计期刊
          if (lit.journal) {
            const journalCount = author.journals.get(lit.journal) || 0;
            author.journals.set(lit.journal, journalCount + 1);
          }

          // 统计合作者
          if (Array.isArray(lit.authors)) {
            lit.authors.forEach(coauthor => {
              const coauthorName = coauthor.trim();
              if (coauthorName !== name) {  // 排除自己
                const coauthorCount = author.coauthors.get(coauthorName) || 0;
                author.coauthors.set(coauthorName, coauthorCount + 1);
              }
            });
          }
        });
      });

      // 后处理：计算年份范围、排序文献等
      state.authors.forEach(author => {
        if (author.years.length > 0) {
          author.yearStart = Math.min(...author.years);
          author.yearEnd = Math.max(...author.years);
          author.yearRange = author.yearStart === author.yearEnd
            ? `${author.yearStart}`
            : `${author.yearStart}-${author.yearEnd}`;
        }

        // 按期刊重要性和年份排序文献
        // 1. 计算每个期刊的权重（该作者在该期刊发表的文献数）
        const journalWeights = new Map();
        author.literatures.forEach(lit => {
          if (lit.journal) {
            journalWeights.set(lit.journal, (journalWeights.get(lit.journal) || 0) + 1);
          }
        });

        // 2. 按期刊权重和年份排序
        author.topLiteratures = author.literatures
          .slice()
          .sort((a, b) => {
            // 优先按期刊权重排序
            const weightA = journalWeights.get(a.journal) || 0;
            const weightB = journalWeights.get(b.journal) || 0;
            if (weightA !== weightB) {
              return weightB - weightA;
            }
            // 同一期刊按年份降序
            return b.year - a.year;
          })
          .slice(0, 10);

        // 转换为排序后的数组便于渲染
        author.topKeywords = Array.from(author.keywords.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        author.topCoauthors = Array.from(author.coauthors.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        author.topJournals = Array.from(author.journals.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
      });
    }

    // ==================== 期刊数据处理 ====================

    /**
     * 提取所有期刊及统计信息
     */
    function extractJournals() {
      state.journals.clear();

      // 遍历筛选后的文献
      state.filteredLiteratures.forEach(lit => {
        const journalName = lit.journal;
        if (!journalName || !journalName.trim()) return;

        const name = journalName.trim();

        if (!state.journals.has(name)) {
          // 获取期刊的主要分级（用于显示）
          const primaryTier = getJournalPrimaryTier(name);

          // 获取期刊的所有来源分级
          const multiTiers = getJournalMultiTiers(name);

          // 计算多来源加权自动评分
          const autoScore = calculateMultiSourceAutoScore(name);

          // 获取用户打星
          const manualStars = state.journalStarRatings.get(name) || 0;

          // 计算最终得分
          const finalScore = calculateJournalScore(name, manualStars);

          // 初始化期刊数据
          state.journals.set(name, {
            name: name,
            // 主要分级（用于显示徽章）
            tier: primaryTier ? primaryTier.tierKey : null,
            tierSource: primaryTier ? primaryTier.sourceKey : null,
            // 所有来源的分级
            multiTiers: multiTiers,
            // 评分数据
            autoScore: autoScore,
            manualStars: manualStars,
            finalScore: finalScore,
            // 统计数据
            count: 0,
            literatures: [],
            years: [],
            yearDistribution: new Map()
          });
        }

        const journal = state.journals.get(name);
        journal.count++;
        journal.literatures.push(lit);
        journal.years.push(lit.year);

        // 统计年份分布
        const yearCount = journal.yearDistribution.get(lit.year) || 0;
        journal.yearDistribution.set(lit.year, yearCount + 1);
      });

      // 后处理：计算年份范围等
      state.journals.forEach(journal => {
        if (journal.years.length > 0) {
          journal.yearStart = Math.min(...journal.years);
          journal.yearEnd = Math.max(...journal.years);
          journal.yearRange = journal.yearStart === journal.yearEnd
            ? `${journal.yearStart}`
            : `${journal.yearStart}-${journal.yearEnd}`;
        }

        // 生成最新文献列表（按年份降序，取前5篇）
        journal.recentPapers = journal.literatures
          .slice()
          .sort((a, b) => b.year - a.year)
          .slice(0, 5);
      });
    }

    /**
     * 对期刊列表排序
     * @param {Array} journals - 期刊数组
     * @returns {Array} 排序后的期刊数组
     */
    function sortJournals(journals) {
      return journals.sort((a, b) => {
        // 按最终得分降序
        if (b.finalScore !== a.finalScore) {
          return b.finalScore - a.finalScore;
        }
        // 得分相同按文献数降序
        return b.count - a.count;
      });
    }

    /**
     * 应用筛选器
     */
    function applyFilters() {
      const { searchQuery, filters } = state;

      let results = state.literatures.filter(lit => {
        // 类型筛选
        if (filters.activeType !== 'all' && lit.type !== filters.activeType) {
          return false;
        }

        // 年份筛选
        if (lit.year < filters.yearStart || lit.year > filters.yearEnd) {
          return false;
        }

        // 期刊筛选
        if (filters.activeVenue !== 'all' && lit.journal !== filters.activeVenue) {
          return false;
        }

        // 搜索关键词
        if (searchQuery) {
          const searchText = [
            lit.title || '',
            (lit.authors || []).join(' '),
            (lit.keywords || []).join(' '),
            String(lit.year),
            lit.journal || ''
          ].join(' ').toLowerCase();

          const keywords = searchQuery.toLowerCase().split(/\s+/);
          return keywords.every(keyword => searchText.includes(keyword));
        }

        return true;
      });

      // 排序：星标优先，同级按年份降序
      results = sortLiteratures(results);

      state.filteredLiteratures = results;
      state.pagination.currentPage = 1;
      state.pagination.hasMore = results.length > state.pagination.pageSize;

      // 提取作者信息
      extractAuthors();

      // 初始化作者数据（从 sessionStorage 恢复工作单位）
      initializeAuthorData();

      // 提取期刊信息
      extractJournals();

      updateDisplay();
    }

    /**
     * 更新显示
     */
    function updateDisplay() {
      const { currentPage, pageSize } = state.pagination;
      const startIndex = 0;
      const endIndex = currentPage * pageSize;

      state.displayedLiteratures = state.filteredLiteratures.slice(startIndex, endIndex);
      state.pagination.hasMore = endIndex < state.filteredLiteratures.length;

      renderTabs();
      renderLiteratures();
      updateSearchCount();
      updateLoadMoreButton();
    }

    /**
     * 加载更多
     */
    function loadMore() {
      state.pagination.currentPage++;
      updateDisplay();
    }

    // ==================== 渲染函数 ====================

    /**
     * 渲染筛选器
     */
    function renderFilters() {
      // 渲染类型筛选
      const types = [
        { key: 'all', label: '全部类型' },
        { key: 'article', label: '期刊论文' },
        { key: 'inproceedings', label: '会议论文' },
        { key: 'book', label: '书籍' },
        { key: 'phdthesis', label: '博士论文' },
        { key: 'mastersthesis', label: '硕士论文' }
      ];

      dom.typeFilters.innerHTML = types.map(type => `
        <div class="pill ${state.filters.activeType === type.key ? 'active' : ''}"
             data-type="${type.key}">
          ${type.label}
        </div>
      `).join('');

      // 渲染期刊筛选
      const venues = ['all', ...Array.from(state.availableVenues)];
      dom.venueFilters.innerHTML = venues.map(venue => `
        <div class="pill ${state.filters.activeVenue === venue ? 'active' : ''}"
             data-venue="${venue}">
          ${venue === 'all' ? '全部期刊' : venue}
        </div>
      `).join('');
    }

    /**
     * 渲染Tab导航
     */
    function renderTabs() {
      const pinnedCount = state.pinnedLiteratures.size;
      const allCount = state.filteredLiteratures.length;
      const authorCount = state.authors.size;
      const journalCount = state.journals.size;

      const tabsHtml = `
        <div class="tab ${state.currentView === 'all' ? 'active' : ''}" data-view="all">
          📚 全部 (${allCount})
        </div>
        <div class="tab ${state.currentView === 'pinned' ? 'active' : ''}" data-view="pinned">
          ⭐ 星标 (${pinnedCount})
        </div>
        <div class="tab ${state.currentView === 'author' ? 'active' : ''}" data-view="author">
          👤 作者 (${authorCount})
        </div>
        <div class="tab ${state.currentView === 'journal' ? 'active' : ''}" data-view="journal">
          📖 期刊 (${journalCount})
        </div>
      `;

      dom.viewTabs.innerHTML = tabsHtml;
    }

    /**
     * 切换视图
     */
    function switchView(viewKey) {
      state.currentView = viewKey;

      // 切换视图时重置所有展开和选中状态
      state.selectedAuthor = null;
      state.expandedAuthor = null;
      state.selectedJournal = null;
      state.expandedJournal = null;
      state.expandedId = null;
      hideBackdrop();

      renderTabs();
      renderLiteratures();
    }

    /**
     * 渲染文献列表(基于当前视图)
     */
    function renderLiteratures() {
      // 作者视图特殊处理
      if (state.currentView === 'author') {
        if (state.selectedAuthor) {
          // 显示某个作者的文献列表
          renderAuthorLiteratures(state.selectedAuthor);
        } else {
          // 显示所有作者列表
          renderAuthors();
        }
        return;
      }

      // 期刊视图特殊处理
      if (state.currentView === 'journal') {
        if (state.selectedJournal) {
          // 显示某个期刊的文献列表
          renderJournalLiteratures(state.selectedJournal);
        } else {
          // 显示所有期刊列表
          renderJournals();
        }
        return;
      }

      // 根据当前视图过滤数据
      let displayData = [];

      switch (state.currentView) {
        case 'pinned':
          displayData = state.displayedLiteratures.filter(lit =>
            state.pinnedLiteratures.has(lit.id)
          );
          break;
        case 'all':
        default:
          displayData = state.displayedLiteratures;
          break;
      }

      // 空状态
      if (displayData.length === 0) {
        const emptyMessage = state.currentView === 'pinned'
          ? '还没有星标文献<br>点击卡片上的 ☆ 添加星标'
          : '未找到文献<br>尝试调整搜索关键词或筛选条件';

        dom.literatureGrid.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 16px;">
              ${state.currentView === 'pinned' ? '⭐' : '📚'}
            </div>
            <h3>${emptyMessage.split('<br>')[0]}</h3>
            <p>${emptyMessage.split('<br>')[1]}</p>
          </div>
        `;
        return;
      }

      // 渲染卡片
      dom.literatureGrid.className = 'literature-grid';
      dom.literatureGrid.innerHTML = displayData
        .map(lit => renderLiteratureCard(lit))
        .join('');
    }

    /**
     * 渲染单个文献卡片
     */
    function renderLiteratureCard(lit) {
      const isSelected = state.selectedId === lit.id;
      const isExpanded = isSelected && state.expandedId === lit.id;
      const isPinned = state.pinnedLiteratures.has(lit.id);
      const typeColor = getTypeColor(lit.type);
      const typeName = getTypeName(lit.type);

      // 作者显示（最多3个，其余显示 et al.）
      const authorsDisplay = Array.isArray(lit.authors)
        ? (lit.authors.length <= 3
            ? lit.authors.join(', ')
            : `${lit.authors.slice(0, 3).join(', ')} et al.`)
        : '';

      return `
        <div class="literature-card ${isSelected ? 'selected' : ''} ${isExpanded ? 'expanded' : ''}"
             data-id="${lit.id}"
             style="border-left-color: ${typeColor}">

          <!-- 操作图标 -->
          <div class="card-actions">
            <div class="action-icon pin-icon ${isPinned ? 'pinned' : ''}"
                 data-action="pin"
                 title="${isPinned ? '取消星标' : '添加星标'}">
              ${isPinned ? '⭐' : '☆'}
            </div>
            <div class="action-icon" data-action="focus" title="在 MarginNote 中定位">📍</div>
            <div class="action-icon" data-action="pdf" title="打开 PDF">📄</div>
          </div>

          <!-- 卡片头部 -->
          <div class="card-header">
            ${lit.cover ? `
              <img class="card-cover-thumbnail"
                   src="data:image/jpeg;base64,${lit.cover.base64}"
                   alt="封面"
                   title="点击查看大图 (${lit.cover.width}×${lit.cover.height})"
                   onclick="event.stopPropagation()">
            ` : ''}

            <div class="card-content-with-cover">
              <div class="card-type-badge" style="background: ${typeColor}">
                ${typeName}
              </div>
              <div class="card-title">${highlightText(lit.title, state.searchQuery)}</div>
              ${authorsDisplay ? `<div class="card-authors">${highlightText(authorsDisplay, state.searchQuery)}</div>` : ''}

              <div class="card-meta">
                <span class="meta-item">${lit.year}</span>
                ${lit.journal ? `
                  <span class="meta-divider"></span>
                  <span class="meta-item">${lit.journal.toTitleCase()}</span>
                ` : ''}
              </div>
            </div>
          </div>

          <!-- 关键词 -->
          ${lit.keywords && lit.keywords.length > 0 ? `
            <div class="card-keywords">
              ${lit.keywords.slice(0, 5).map(kw => `
                <span class="keyword-tag" data-keyword="${escapeHtml(kw)}" title="点击搜索该关键词">${kw}</span>
              `).join('')}
            </div>
          ` : ''}

          <!-- 展开的详情 -->
          <div class="card-details">
            ${lit.cover ? `
              <div class="detail-section">
                <div class="detail-label">封面</div>
                <img class="card-cover-full"
                     src="data:image/jpeg;base64,${lit.cover.base64}"
                     alt="封面图片"
                     title="尺寸: ${lit.cover.width}×${lit.cover.height}">
              </div>
            ` : ''}

            ${lit.abstract ? `
              <div class="detail-section">
                <div class="detail-label">摘要</div>
                <div class="detail-content">${escapeHtml(lit.abstract)}</div>
              </div>
            ` : ''}

            ${lit.doi ? `
              <div class="detail-section">
                <div class="detail-label">DOI</div>
                <div class="detail-content">${lit.doi}</div>
              </div>
            ` : ''}

            <div class="detail-actions">
              <button class="btn" onclick="handleAction('focus', '${lit.id}')">在 MarginNote 中查看</button>
              <button class="btn" onclick="handleAction('bibtex', '${lit.id}')">导出 BibTeX</button>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * 获取作者名字的首字母（用于头像）
     * @param {string} name - 作者名字
     * @returns {string} 首字母
     */
    function getAuthorInitial(name) {
      if (!name) return '?';

      // 如果是中文名，取第一个字
      if (/[\u4e00-\u9fa5]/.test(name)) {
        return name.charAt(0);
      }

      // 如果是英文名，取首字母
      const parts = name.trim().split(/\s+/);
      if (parts.length > 1) {
        // 取名和姓的首字母
        return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
      }

      return name.charAt(0).toUpperCase();
    }

    /**
     * 渲染研究趋势图表
     * @param {Object} author - 作者数据
     * @returns {string} HTML
     */
    function renderTrendChart(author) {
      // 获取排序后的年份
      const years = Array.from(author.yearDistribution.keys()).sort();
      if (years.length === 0) return '<p style="color: var(--muted); font-size: 12px;">暂无数据</p>';

      const maxCount = Math.max(...author.yearDistribution.values());

      return years.map(year => {
        const count = author.yearDistribution.get(year);
        const percentage = (count / maxCount) * 100;

        return `
          <div class="trend-bar">
            <div class="trend-year">${year}</div>
            <div class="trend-bar-container">
              <div class="trend-bar-fill" style="width: ${percentage}%"></div>
            </div>
            <div class="trend-count">${count}篇</div>
          </div>
        `;
      }).join('');
    }

    /**
     * 渲染关键词标签云
     * @param {Object} author - 作者数据
     * @returns {string} HTML
     */
    function renderKeywords(author) {
      if (!author.topKeywords || author.topKeywords.length === 0) {
        return '<p style="color: var(--muted); font-size: 12px;">暂无关键词</p>';
      }

      return author.topKeywords.map(([keyword, count]) => `
        <div class="author-keyword-tag">
          <span>${escapeHtml(keyword)}</span>
          <span class="keyword-count">${count}</span>
        </div>
      `).join('');
    }

    /**
     * 渲染文献列表预览
     * @param {Object} author - 作者数据
     * @returns {string} HTML
     */
    function renderLitPreview(author) {
      if (!author.topLiteratures || author.topLiteratures.length === 0) {
        return '<p style="color: var(--muted); font-size: 12px;">暂无文献</p>';
      }

      return author.topLiteratures.slice(0, 5).map(lit => `
        <div class="author-lit-item" data-lit-id="${lit.id}">
          <div class="author-lit-title">${escapeHtml(lit.title)}</div>
          <div class="author-lit-meta">
            <span>${lit.year}</span>
            ${lit.journal ? `<span>•</span><span>${escapeHtml(lit.journal.toTitleCase())}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    /**
     * 渲染合作者列表
     * @param {Object} author - 作者数据
     * @returns {string} HTML
     */
    function renderCoauthors(author) {
      if (!author.topCoauthors || author.topCoauthors.length === 0) {
        return '<p style="color: var(--muted); font-size: 12px;">暂无合作者</p>';
      }

      return author.topCoauthors.map(([name, count]) => {
        const initial = getAuthorInitial(name);
        return `
          <div class="coauthor-item" data-author="${escapeHtml(name)}">
            <div class="coauthor-avatar">${initial}</div>
            <div class="coauthor-name">${escapeHtml(name)}</div>
            <div class="coauthor-count">(${count}篇)</div>
          </div>
        `;
      }).join('');
    }

    /**
     * 渲染作者的发表期刊分布
     * @param {Object} author - 作者数据
     * @returns {string} HTML
     */
    function renderAuthorJournals(author) {
      if (!author.topJournals || author.topJournals.length === 0) {
        return '<p style="color: var(--muted); font-size: 12px;">暂无期刊信息</p>';
      }

      const html = author.topJournals.map((item) => {
        // 容错处理
        const journal = Array.isArray(item) ? item[0] : (item.journal || item);
        const count = Array.isArray(item) ? item[1] : (item.count || 1);

        return `
          <div class="journal-item">
            <div class="journal-name">${escapeHtml(journal.toTitleCase())}</div>
            <div class="journal-count">${count}篇</div>
          </div>
        `;
      }).join('');

      return html;
    }

    /**
     * 渲染作者列表
     */
    function renderAuthors() {
      // 转换 Map 为数组并按文献数量排序
      const authorsArray = Array.from(state.authors.values())
        .sort((a, b) => b.count - a.count);

      // 空状态
      if (authorsArray.length === 0) {
        dom.literatureGrid.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 16px;">👤</div>
            <h3>未找到作者</h3>
            <p>尝试调整搜索关键词或筛选条件</p>
          </div>
        `;
        return;
      }

      // 渲染作者卡片
      dom.literatureGrid.className = 'author-grid';
      dom.literatureGrid.innerHTML = authorsArray
        .map(author => {
          const initial = getAuthorInitial(author.name);
          const isExpanded = state.expandedAuthor === author.name;

          return `
            <div class="author-card ${isExpanded ? 'expanded' : ''}" data-author="${escapeHtml(author.name)}">
              <!-- 关闭按钮 -->
              <div class="author-close-btn" data-action="close-author">×</div>

              <!-- 作者头部 -->
              <div class="author-card-header">
                <div class="author-avatar">${initial}</div>
                <div class="author-info">
                  <div class="author-name">${highlightText(author.displayName || author.name, state.searchQuery)}</div>
                  <div class="author-role">${author.role || '未设置职位'}</div>
                  ${author.affiliation ? `<div class="author-affiliation">${escapeHtml(author.affiliation)}</div>` : ''}
                </div>
              </div>

              <!-- 统计信息 -->
              <div class="author-stats">
                <div class="author-stat-item">
                  <div class="author-stat-value">${author.count}</div>
                  <div class="author-stat-label">文献</div>
                </div>
                <div class="author-stat-item">
                  <div class="author-stat-value">${author.yearRange || 'N/A'}</div>
                  <div class="author-stat-label">年份</div>
                </div>
                <div class="author-stat-item">
                  <div class="author-stat-value">${author.topJournals ? author.topJournals.length : 0}</div>
                  <div class="author-stat-label">期刊</div>
                </div>
              </div>

              <!-- 详情区域（展开时显示） -->
              <div class="author-card-details">
                <!-- 基本信息 -->
                <div class="detail-section">
                  <h4>👤 基本信息</h4>
                  <div class="author-basic-info">
                    <div class="info-item">
                      <span class="info-label">姓名：</span>
                      <span class="info-value">${escapeHtml(author.displayName || author.name)}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">工作单位：</span>
                      <span class="info-value ${author.affiliation ? '' : 'empty'}">${author.affiliation || '未设置'}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">职位：</span>
                      <span class="info-value ${author.role ? '' : 'empty'}">${author.role || '未设置'}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">邮箱：</span>
                      <span class="info-value ${author.email ? '' : 'empty'}">${author.email || '未设置'}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">个人主页：</span>
                      <span class="info-value ${author.homepage ? '' : 'empty'}">${author.homepage || '未设置'}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">ORCID：</span>
                      <span class="info-value ${author.orcid ? '' : 'empty'}">${author.orcid || '未设置'}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">备注：</span>
                      <span class="info-value ${author.notes ? '' : 'empty'}">${author.notes || '未设置'}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">最高学历：</span>
                      <span class="info-value ${author.degree ? '' : 'empty'}">${author.degree || '未设置'}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">毕业/工作机构：</span>
                      <span class="info-value ${author.institution ? '' : 'empty'}">${author.institution || '未设置'}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">学术职称：</span>
                      <span class="info-value ${author.academicTitle ? '' : 'empty'}">${author.academicTitle || '未设置'}</span>
                    </div>
                    <button class="btn" data-action="edit-author-info" data-author="${escapeHtml(author.name)}" style="margin-top: 12px; width: 100%;">✏️ 编辑作者信息</button>
                  </div>
                </div>

                <!-- 研究方向 -->
                ${author.researchFields && author.researchFields.length > 0 ? `
                <div class="detail-section">
                  <h4>🔬 研究方向</h4>
                  <div class="author-keywords">
                    ${author.researchFields.map(field =>
                      `<span class="keyword-tag" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 6px; margin: 4px; display: inline-block; font-size: 13px;">${escapeHtml(field)}</span>`
                    ).join('')}
                  </div>
                </div>
                ` : ''}

                <!-- 学术主页 -->
                ${(author.googleScholar || author.researchGate) ? `
                <div class="detail-section">
                  <h4>🔗 学术主页</h4>
                  <div class="academic-links">
                    ${author.googleScholar ? `
                      <a href="${escapeHtml(author.googleScholar)}" target="_blank" class="academic-link" style="display: inline-flex; align-items: center; padding: 8px 14px; margin: 4px; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 13px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        🎓 Google Scholar
                      </a>
                    ` : ''}
                    ${author.researchGate ? `
                      <a href="${escapeHtml(author.researchGate)}" target="_blank" class="academic-link" style="display: inline-flex; align-items: center; padding: 8px 14px; margin: 4px; background: linear-gradient(135deg, #00d0b1 0%, #00a896 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 13px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        🔬 ResearchGate
                      </a>
                    ` : ''}
                  </div>
                </div>
                ` : ''}

                <!-- 荣誉与项目 -->
                ${(author.awards && author.awards.length > 0) || (author.projects && author.projects.length > 0) ? `
                <div class="detail-section">
                  <h4>🏆 荣誉与项目</h4>
                  ${author.awards && author.awards.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                      <div style="font-weight: 600; color: #4a5568; margin-bottom: 6px; font-size: 13px;">🏅 获奖情况：</div>
                      <div style="padding-left: 12px;">
                        ${author.awards.map(award =>
                          `<div style="margin-bottom: 4px; color: #5b6a80; font-size: 13px;">• ${escapeHtml(award)}</div>`
                        ).join('')}
                      </div>
                    </div>
                  ` : ''}
                  ${author.projects && author.projects.length > 0 ? `
                    <div>
                      <div style="font-weight: 600; color: #4a5568; margin-bottom: 6px; font-size: 13px;">📋 主持项目：</div>
                      <div style="padding-left: 12px;">
                        ${author.projects.map(project =>
                          `<div style="margin-bottom: 4px; color: #5b6a80; font-size: 13px;">• ${escapeHtml(project)}</div>`
                        ).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
                ` : ''}

                <!-- 研究趋势 -->
                <div class="detail-section">
                  <h4>📈 研究趋势</h4>
                  <div class="author-trend-chart">
                    ${renderTrendChart(author)}
                  </div>
                </div>

                <!-- 研究领域 -->
                <div class="detail-section">
                  <h4>🏷️ 研究领域</h4>
                  <div class="author-keywords">
                    ${renderKeywords(author)}
                  </div>
                </div>

                <!-- 代表文献 -->
                <div class="detail-section">
                  <h4>📚 代表文献</h4>
                  <div class="author-lit-preview">
                    ${renderLitPreview(author)}
                  </div>
                </div>

                <!-- 合作网络 -->
                <div class="detail-section">
                  <h4>👥 合作网络</h4>
                  <div class="author-coauthors">
                    ${renderCoauthors(author)}
                  </div>
                </div>

                <!-- 发表期刊 -->
                <div class="detail-section">
                  <h4>📖 发表期刊</h4>
                  <div class="author-journals">
                    ${renderAuthorJournals(author)}
                  </div>
                </div>

                <!-- 操作按钮 -->
                <div class="detail-actions">
                  <button class="btn primary" data-action="view-all-lit">查看全部文献 (${author.count}篇)</button>
                </div>
              </div>
            </div>
          `;
        })
        .join('');
    }

    /**
     * 渲染某个作者的文献列表
     */
    function renderAuthorLiteratures(authorName) {
      const author = state.authors.get(authorName);
      if (!author) {
        showToast("未找到该作者");
        state.selectedAuthor = null;
        renderAuthors();
        return;
      }

      // 渲染头部（返回按钮 + 作者信息）
      const headerHtml = `
        <div class="author-view-header">
          <button class="author-view-back" id="authorViewBack">
            ← 返回
          </button>
          <div class="author-view-info">
            ${author.name} 的文献 (${author.count} 篇)
          </div>
        </div>
      `;

      // 渲染文献卡片
      dom.literatureGrid.className = 'literature-grid';
      dom.literatureGrid.innerHTML = headerHtml + author.literatures
        .map(lit => renderLiteratureCard(lit))
        .join('');
    }

    // ==================== 期刊渲染函数 ====================

    /**
     * 渲染期刊列表
     */
    function renderJournals() {
      // 转换 Map 为数组并排序
      const journalsArray = sortJournals(Array.from(state.journals.values()));

      // 空状态
      if (journalsArray.length === 0) {
        dom.literatureGrid.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 16px;">📖</div>
            <h3>未找到期刊</h3>
            <p>尝试调整搜索关键词或筛选条件</p>
          </div>
        `;
        return;
      }

      // 渲染期刊卡片
      dom.literatureGrid.className = 'journal-grid';
      dom.literatureGrid.innerHTML = journalsArray
        .map(journal => renderJournalCard(journal))
        .join('');
    }

    /**
     * 渲染单个期刊卡片
     * @param {Object} journal - 期刊对象
     * @returns {string} HTML
     */
    function renderJournalCard(journal) {
      const isExpanded = state.expandedJournal === journal.name;
      const tierClass = journal.tier ? `tier-${journal.tier.toLowerCase()}` : 'tier-unranked';
      const tierLabel = journal.tier || '未分级';

      return `
        <div class="journal-card ${tierClass} ${isExpanded ? 'expanded' : ''}"
             data-journal="${escapeHtml(journal.name)}">

          <!-- 关闭按钮 -->
          <div class="journal-close-btn" data-action="close-journal">×</div>

          <!-- 期刊头部 -->
          <div class="journal-card-header">
            <div class="journal-info-main">
              <div class="journal-tier-badge ${tierClass}">${tierLabel}</div>
              <div class="journal-name">${highlightJournalName(journal.name, state.searchQuery)}</div>
            </div>

            <!-- 评分区域 -->
            <div class="journal-scores">
              <div class="journal-final-score">${journal.finalScore.toFixed(1)}</div>
              <div class="journal-score-label">最终得分</div>
              ${renderJournalStars(journal)}
            </div>
          </div>

          <!-- 统计信息 -->
          <div class="journal-stats">
            <div class="journal-stat-item">
              <div class="journal-stat-value">${journal.count}</div>
              <div class="journal-stat-label">文献数</div>
            </div>
            <div class="journal-stat-item">
              <div class="journal-stat-value">${journal.yearRange || 'N/A'}</div>
              <div class="journal-stat-label">年份</div>
            </div>
          </div>

          <!-- 详情区域（展开时显示） -->
          <div class="journal-card-details">
            <!-- 多来源分级信息 -->
            <div class="detail-section">
              <h4>📊 分级信息</h4>
              ${renderJournalMultiTiers(journal)}
              <button class="btn" data-action="manage-journal-tiers" style="margin-top: 12px; width: 100%;">⚙️ 管理分级</button>
            </div>

            <!-- 年份分布 -->
            <div class="detail-section">
              <h4>📈 年份分布</h4>
              <div class="journal-trend-chart">
                ${renderJournalTrendChart(journal)}
              </div>
            </div>

            <!-- 最新文献 -->
            <div class="detail-section">
              <h4>🆕 最新发表 (${journal.recentPapers ? journal.recentPapers.length : 0}篇)</h4>
              <div class="journal-rep-papers">
                ${renderRecentPapers(journal)}
              </div>
            </div>

            <!-- 操作按钮 -->
            <div class="journal-actions">
              <button class="btn primary" data-action="view-all-journal-lit">查看全部文献 (${journal.count}篇)</button>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * 渲染期刊打星组件
     * @param {Object} journal - 期刊对象
     * @returns {string} HTML
     */
    function renderJournalStars(journal) {
      const stars = journal.manualStars || 0;
      let html = '<div class="journal-star-rating">';

      for (let i = 1; i <= 5; i++) {
        const filled = i <= stars;
        html += `<span class="star-icon ${filled ? 'filled' : ''}"
                      data-action="rate-journal"
                      data-star="${i}">★</span>`;
      }

      html += '</div>';
      return html;
    }

    /**
     * 渲染年份分布图表
     * @param {Object} journal - 期刊对象
     * @returns {string} HTML
     */
    function renderJournalTrendChart(journal) {
      const years = Array.from(journal.yearDistribution.keys()).sort();
      if (years.length === 0) {
        return '<p style="color: var(--muted); font-size: 12px;">暂无数据</p>';
      }

      const maxCount = Math.max(...journal.yearDistribution.values());

      return years.map(year => {
        const count = journal.yearDistribution.get(year);
        const percentage = (count / maxCount) * 100;

        return `
          <div class="journal-trend-bar">
            <div class="journal-trend-year">${year}</div>
            <div class="journal-trend-bar-container">
              <div class="journal-trend-bar-fill" style="width: ${percentage}%"></div>
            </div>
            <div class="journal-trend-count">${count}篇</div>
          </div>
        `;
      }).join('');
    }

    /**
     * 渲染最新文献列表
     * @param {Object} journal - 期刊对象
     * @returns {string} HTML
     */
    function renderRecentPapers(journal) {
      if (!journal.recentPapers || journal.recentPapers.length === 0) {
        return '<p style="color: var(--muted); font-size: 12px;">暂无数据</p>';
      }

      return journal.recentPapers.map(lit => `
        <div class="journal-rep-paper-item" data-lit-id="${lit.id}">
          <div class="journal-rep-paper-title">${escapeHtml(lit.title)}</div>
          <div class="journal-rep-paper-meta">
            <span>📅 ${lit.year}</span>
            ${lit.authors && lit.authors.length > 0 ? `<span>•</span><span>${escapeHtml(lit.authors[0])}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    /**
     * 渲染期刊的多来源分级信息
     * @param {Object} journal - 期刊对象
     * @returns {string} HTML
     */
    function renderJournalMultiTiers(journal) {
      if (!journal.multiTiers || Object.keys(journal.multiTiers).length === 0) {
        return `
          <div style="padding: 12px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; text-align: center;">
            <p style="color: var(--muted); font-size: 13px; margin: 0;">暂无分级信息</p>
            <p style="color: var(--muted); font-size: 12px; margin-top: 4px;">点击下方按钮设置分级</p>
          </div>
        `;
      }

      let html = '<div class="journal-multi-tiers">';

      // 遍历所有分级来源
      for (const [sourceKey, tierKey] of Object.entries(journal.multiTiers)) {
        const source = state.tierSources.get(sourceKey);
        if (!source) continue;

        const isPrimary = journal.tierSource === sourceKey;
        const tierInfo = source.tiers[tierKey];
        const tierColor = tierInfo ? tierInfo.color : '#B0B0B0';
        const weight = Math.round(source.weight * 100);

        html += `
          <div class="tier-source-item ${isPrimary ? 'primary' : ''}">
            <div class="tier-source-header">
              <div class="tier-source-name">
                <span class="tier-source-icon">${source.builtin ? '🔒' : '👤'}</span>
                <span class="tier-source-title">${source.shortName || source.name}</span>
                ${isPrimary ? '<span class="primary-badge">主要</span>' : ''}
              </div>
              <div class="tier-source-weight">${weight}%</div>
            </div>
            <div class="tier-source-tier">
              <span class="tier-badge" style="background: ${tierColor}; color: ${tierKey === 'T2' ? '#2c3e50' : '#fff'};">
                ${tierKey}
              </span>
              ${tierInfo ? `<span class="tier-desc">${tierInfo.description || ''}</span>` : ''}
              <span class="tier-score">+${tierToScore(sourceKey, tierKey).toFixed(1)}分</span>
            </div>
          </div>
        `;
      }

      html += '</div>';

      // 添加综合评分说明
      html += `
        <div class="tier-summary">
          <div class="tier-summary-item">
            <span class="tier-summary-label">自动评分</span>
            <span class="tier-summary-value">${journal.autoScore.toFixed(1)}</span>
          </div>
          ${journal.manualStars > 0 ? `
            <div class="tier-summary-item">
              <span class="tier-summary-label">用户评分</span>
              <span class="tier-summary-value">${((journal.manualStars / 5) * 100).toFixed(1)}</span>
            </div>
          ` : ''}
          <div class="tier-summary-item highlight">
            <span class="tier-summary-label">最终得分</span>
            <span class="tier-summary-value">${journal.finalScore.toFixed(1)}</span>
          </div>
        </div>
      `;

      return html;
    }

    // ==================== 现代模态弹窗组件 ====================

    /**
     * 创建模态弹窗
     * @param {Object} options - 配置选项
     * @returns {Object} 模态弹窗实例
     */
    function createModal(options = {}) {
      const {
        title = '标题',
        subtitle = '',
        width = '600px',
        closeOnOverlay = true
      } = options;

      // 创建模态弹窗 DOM
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';

      const container = document.createElement('div');
      container.className = 'modal-container';
      if (width !== '600px') {
        container.style.maxWidth = width;
      }

      const header = document.createElement('div');
      header.className = 'modal-header';
      header.innerHTML = `
        <div>
          <h3 class="modal-title">${escapeHtml(title)}</h3>
          ${subtitle ? `<div class="modal-subtitle">${escapeHtml(subtitle)}</div>` : ''}
        </div>
        <button class="modal-close">×</button>
      `;

      const body = document.createElement('div');
      body.className = 'modal-body';

      const footer = document.createElement('div');
      footer.className = 'modal-footer';
      footer.style.display = 'none';

      container.appendChild(header);
      container.appendChild(body);
      container.appendChild(footer);
      overlay.appendChild(container);

      // 事件处理
      const closeBtn = header.querySelector('.modal-close');
      closeBtn.addEventListener('click', () => modal.hide());

      if (closeOnOverlay) {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            modal.hide();
          }
        });
      }

      // ESC 键关闭
      const handleEsc = (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('show')) {
          modal.hide();
        }
      };

      // 模态弹窗实例
      const modal = {
        show() {
          document.body.appendChild(overlay);
          setTimeout(() => overlay.classList.add('show'), 10);
          document.addEventListener('keydown', handleEsc);
          return this;
        },

        hide() {
          overlay.classList.remove('show');
          setTimeout(() => {
            if (overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }
            document.removeEventListener('keydown', handleEsc);
          }, 300);
          return this;
        },

        setContent(html) {
          body.innerHTML = html;
          return this;
        },

        setTitle(newTitle, newSubtitle = '') {
          const titleEl = header.querySelector('.modal-title');
          const subtitleEl = header.querySelector('.modal-subtitle');
          titleEl.textContent = newTitle;
          if (newSubtitle) {
            if (subtitleEl) {
              subtitleEl.textContent = newSubtitle;
            } else {
              titleEl.insertAdjacentHTML('afterend', `<div class="modal-subtitle">${escapeHtml(newSubtitle)}</div>`);
            }
          } else if (subtitleEl) {
            subtitleEl.remove();
          }
          return this;
        },

        addButton(text, className, onClick) {
          footer.style.display = 'flex';
          const button = document.createElement('button');
          button.className = `modal-button ${className}`;
          button.textContent = text;
          button.addEventListener('click', onClick);
          footer.appendChild(button);
          return this;
        },

        clearButtons() {
          footer.innerHTML = '';
          footer.style.display = 'none';
          return this;
        },

        getBody() {
          return body;
        },

        getOverlay() {
          return overlay;
        }
      };

      return modal;
    }

    /**
     * 渲染来源卡片列表
     * @param {Array} sources - 来源数组
     * @param {Object} journal - 期刊对象
     * @returns {string} HTML
     */
    function renderSourceCards(sources, journal) {
      return sources.map(source => {
        const currentTier = journal.multiTiers[source.key] || '未设置';
        const icon = source.builtin ? '🔒' : '👤';
        const isPrimary = journal.tierSource === source.key;

        return `
          <div class="option-card" data-action="select-source" data-source-key="${source.key}">
            <div class="option-icon">${icon}</div>
            <div class="option-content">
              <div class="option-title">${escapeHtml(source.shortName || source.name)}</div>
              <div class="option-desc">当前分级：${currentTier}</div>
            </div>
            ${isPrimary ? '<div class="option-badge primary">主要</div>' : `<div class="option-badge">${Math.round(source.weight * 100)}%</div>`}
          </div>
        `;
      }).join('');
    }

    /**
     * 渲染分级选择网格
     * @param {Object} tiers - 分级定义
     * @param {string} currentTier - 当前分级
     * @returns {string} HTML
     */
    function renderTierOptions(tiers, currentTier, sourceKey) {
      const tierKeys = Object.keys(tiers);
      return `
        <div class="tier-selector-grid">
          ${tierKeys.map(tierKey => {
            const tier = tiers[tierKey];
            const isSelected = currentTier === tierKey;
            return `
              <div class="tier-option ${isSelected ? 'selected' : ''}"
                   data-action="select-tier"
                   data-tier="${tierKey}">
                <div class="tier-option-badge" style="background: ${tier.color}; color: ${tierKey === 'T2' ? '#2c3e50' : '#fff'};">
                  ${tierKey}
                </div>
                <div class="tier-option-desc">${tier.description || ''}</div>
                <div class="tier-option-score">+${tierToScore(sourceKey, tierKey).toFixed(1)}分</div>
              </div>
            `;
          }).join('')}
          <div class="tier-option" data-action="clear-tier">
            <div class="tier-option-badge" style="background: #ccc; color: #666;">
              🗑️
            </div>
            <div class="tier-option-desc">清除分级</div>
          </div>
        </div>
      `;
    }

    /**
     * 显示期刊分级管理对话框（现代版）
     * @param {string} journalName - 期刊名称
     */
    async function showJournalTierManager(journalName) {
      const journal = state.journals.get(journalName);
      if (!journal) {
        showToast("未找到该期刊");
        return;
      }

      // 构建可用的分级来源列表
      const sources = Array.from(state.tierSources.entries()).map(([key, value]) => ({ key, ...value }));
      if (sources.length === 0) {
        showToast("暂无可用的分级来源");
        return;
      }

      // 创建主模态弹窗
      const modal = createModal({
        title: '管理期刊分级',
        subtitle: journal.name.length > 50 ? journal.name.substring(0, 50) + '...' : journal.name,
        width: '700px'
      });

      // 渲染主菜单内容
      function renderMainMenu() {
        const html = `
          <div class="card-list">
            ${renderSourceCards(sources, journal)}
            <div class="option-card" data-action="manage-sources">
              <div class="option-icon">⚙️</div>
              <div class="option-content">
                <div class="option-title">管理分级来源</div>
                <div class="option-desc">添加、编辑或删除分级来源</div>
              </div>
            </div>
            <div class="option-card" data-action="clear-all">
              <div class="option-icon">🗑️</div>
              <div class="option-content">
                <div class="option-title">清除所有分级</div>
                <div class="option-desc">移除该期刊的所有分级标记</div>
              </div>
            </div>
          </div>
        `;

        modal.setContent(html);

        // 事件委托：处理卡片点击
        const body = modal.getBody();
        body.onclick = (e) => {
          const card = e.target.closest('.option-card');
          if (!card) return;

          const action = card.dataset.action;
          const sourceKey = card.dataset.sourceKey;

          if (action === 'select-source') {
            // 选择分级来源
            const source = sources.find(s => s.key === sourceKey);
            if (source) {
              showTierSelector(source);
            }
          } else if (action === 'manage-sources') {
            // 管理分级来源
            modal.hide();
            showTierSourceManager(() => {
              // 返回时重新打开期刊分级管理
              showJournalTierManager(journalName);
            });
          } else if (action === 'clear-all') {
            // 清除所有分级
            clearAllTiers();
            modal.hide();
          }
        };
      }

      // 显示分级选择器
      function showTierSelector(source) {
        const currentTier = journal.multiTiers[source.key];

        // 创建分级选择模态弹窗
        const tierModal = createModal({
          title: source.shortName || source.name,
          subtitle: `为「${journal.name.substring(0, 30)}${journal.name.length > 30 ? '...' : ''}」设置分级`,
          width: '650px'
        });

        const html = renderTierOptions(source.tiers, currentTier, source.key);
        tierModal.setContent(html);

        // 添加返回按钮
        tierModal.addButton('返回', 'secondary', () => {
          tierModal.hide();
          setTimeout(() => modal.show(), 300);
        });

        // 事件委托：处理分级选择
        const body = tierModal.getBody();
        body.onclick = (e) => {
          const tierOption = e.target.closest('.tier-option');
          if (!tierOption) return;

          const action = tierOption.dataset.action;
          const tier = tierOption.dataset.tier;

          if (action === 'clear-tier') {
            // 清除该来源分级
            setJournalTier(journalName, source.key, null);
            showToast("✅ 已清除分级");
            renderJournals();
            tierModal.hide();
            setTimeout(() => modal.show(), 300);
          } else if (action === 'select-tier' && tier) {
            // 选择分级
            setJournalTier(journalName, source.key, tier);
            showToast(`✅ 已设置为 ${tier}`);
            renderJournals();
            tierModal.hide();
            setTimeout(() => modal.show(), 300);
          }
        };

        // 隐藏主菜单，显示分级选择
        modal.hide();
        setTimeout(() => tierModal.show(), 300);
      }

      // 清除所有分级
      function clearAllTiers() {
        if (confirm(`确定要清除期刊「${journal.name}」的所有分级吗？`)) {
          sources.forEach(source => {
            setJournalTier(journalName, source.key, null);
          });
          showToast("✅ 已清除所有分级");
          renderJournals();
        }
      }

      // 渲染并显示主菜单
      renderMainMenu();
      modal.show();
    }

    /**
     * 显示分级来源管理界面
     * @param {Function} returnCallback - 返回回调函数
     */
    async function showTierSourceManager(returnCallback) {
      // 创建主模态弹窗
      const modal = createModal({
        title: '管理分级来源',
        subtitle: '添加、编辑或删除期刊分级来源',
        width: '700px'
      });

      // 渲染主菜单
      function renderMainMenu() {
        const sources = Array.from(state.tierSources.entries()).map(([key, value]) => ({ key, ...value }));

        // 渲染所有来源为卡片
        const sourceCards = sources.map(s => {
          const icon = s.builtin ? '🔒' : '👤';
          const status = s.enabled ? '✅' : '❌';
          const weight = Math.round(s.weight * 100);
          const lockTag = s.builtin ? '<div class="option-badge">内置</div>' : '';

          return `
            <div class="option-card" data-action="edit-source" data-source-key="${s.key}">
              <div class="option-icon">${icon}</div>
              <div class="option-content">
                <div class="option-title">${status} ${escapeHtml(s.shortName || s.name)}</div>
                <div class="option-desc">${s.enabled ? '已启用' : '已禁用'} · 权重 ${weight}%</div>
              </div>
              ${lockTag}
            </div>
          `;
        }).join('');

        const html = `
          <div class="card-list">
            ${sourceCards}
            <div class="option-card" data-action="add-new">
              <div class="option-icon">➕</div>
              <div class="option-content">
                <div class="option-title">添加新来源</div>
                <div class="option-desc">创建自定义期刊分级来源</div>
              </div>
            </div>
          </div>
        `;

        modal.setContent(html);

        // 添加返回/关闭按钮
        modal.clearButtons();
        if (returnCallback) {
          modal.addButton('返回', 'secondary', () => {
            modal.hide();
            setTimeout(() => returnCallback(), 300);
          });
        } else {
          modal.addButton('关闭', 'secondary', () => modal.hide());
        }

        // 事件委托：处理卡片点击
        const body = modal.getBody();
        body.onclick = (e) => {
          const card = e.target.closest('.option-card');
          if (!card) return;

          const action = card.dataset.action;
          const sourceKey = card.dataset.sourceKey;

          if (action === 'edit-source') {
            const source = sources.find(s => s.key === sourceKey);
            if (source) {
              showEditSourceModal(source);
            }
          } else if (action === 'add-new') {
            showAddSourceForm();
          }
        };
      }

      // 显示编辑来源模态框
      function showEditSourceModal(source) {
        const icon = source.builtin ? '🔒' : '👤';
        const weight = Math.round(source.weight * 100);

        const editModal = createModal({
          title: `${icon} ${source.shortName || source.name}`,
          subtitle: source.builtin ? '内置分级来源（不可删除）' : '自定义分级来源',
          width: '600px'
        });

        // 构建编辑表单
        const html = `
          <div class="form-group">
            <label class="form-label">显示名称</label>
            <input type="text" class="form-input" id="editSourceName"
                   value="${escapeHtml(source.shortName || source.name)}"
                   placeholder="输入简短的显示名称">
            <div class="form-hint">显示在界面上的简称，如：数学分级、复旦分区</div>
          </div>

          <div class="form-group">
            <label class="form-label">权重设置</label>
            <div class="slider-group">
              <input type="range" class="form-slider" id="editSourceWeight"
                     min="0" max="100" value="${weight}">
              <div class="slider-value" id="editWeightDisplay">${weight}%</div>
            </div>
            <div class="form-hint">权重决定该来源在最终评分中的影响比例，建议内置来源50%，其他来源合计50%</div>
          </div>

          <div class="form-group">
            <label class="form-label">启用状态</label>
            <div class="option-card" data-action="toggle-enabled" style="cursor: pointer;">
              <div class="option-icon">${source.enabled ? '✅' : '❌'}</div>
              <div class="option-content">
                <div class="option-title">${source.enabled ? '已启用' : '已禁用'}</div>
                <div class="option-desc">点击切换启用/禁用状态</div>
              </div>
            </div>
          </div>
        `;

        editModal.setContent(html);

        // 添加按钮
        editModal.addButton('返回', 'secondary', () => {
          editModal.hide();
          setTimeout(() => modal.show(), 300);
        });

        editModal.addButton('保存', 'primary', () => {
          const newName = document.getElementById('editSourceName').value.trim();
          const newWeight = parseInt(document.getElementById('editSourceWeight').value);

          if (!newName) {
            showToast('❌ 名称不能为空');
            return;
          }

          source.shortName = newName;
          source.weight = newWeight / 100;
          addOrUpdateTierSource(source.key, source);
          showToast('✅ 已保存更改');
          renderJournals();

          editModal.hide();
          setTimeout(() => {
            renderMainMenu();
            modal.show();
          }, 300);
        });

        if (!source.builtin) {
          editModal.addButton('删除', 'danger', () => {
            if (confirm(`确定要删除分级来源"${source.shortName || source.name}"吗？\n这将清除所有使用此来源的期刊分级。`)) {
              const success = deleteTierSource(source.key);
              if (success) {
                showToast('✅ 已删除');
                renderJournals();
                editModal.hide();
                setTimeout(() => {
                  renderMainMenu();
                  modal.show();
                }, 300);
              }
            }
          });
        }

        // 实时更新权重显示
        const body = editModal.getBody();
        const weightSlider = body.querySelector('#editSourceWeight');
        const weightDisplay = body.querySelector('#editWeightDisplay');

        weightSlider.addEventListener('input', (e) => {
          weightDisplay.textContent = `${e.target.value}%`;
        });

        // 切换启用状态
        body.onclick = (e) => {
          const toggleCard = e.target.closest('[data-action="toggle-enabled"]');
          if (toggleCard) {
            source.enabled = !source.enabled;
            addOrUpdateTierSource(source.key, source);
            showToast(source.enabled ? '✅ 已启用' : '❌ 已禁用');
            renderJournals();

            // 更新显示
            const iconEl = toggleCard.querySelector('.option-icon');
            const titleEl = toggleCard.querySelector('.option-title');
            iconEl.textContent = source.enabled ? '✅' : '❌';
            titleEl.textContent = source.enabled ? '已启用' : '已禁用';
          }
        };

        // 隐藏主菜单，显示编辑界面
        modal.hide();
        setTimeout(() => editModal.show(), 300);
      }

      // 显示添加来源表单
      function showAddSourceForm() {
        const addModal = createModal({
          title: '添加分级来源',
          subtitle: '创建自定义期刊分级来源',
          width: '600px'
        });

        const html = `
          <div class="form-group">
            <label class="form-label">来源名称 <span class="required">*</span></label>
            <input type="text" class="form-input" id="addSourceName"
                   placeholder="如：复旦分区、中科院分区、JCR分区">
            <div class="form-hint">完整的分级来源名称</div>
          </div>

          <div class="form-group">
            <label class="form-label">显示简称 <span class="required">*</span></label>
            <input type="text" class="form-input" id="addSourceShortName"
                   placeholder="如：复旦、中科院、JCR">
            <div class="form-hint">显示在界面上的简短名称</div>
          </div>

          <div class="form-group">
            <label class="form-label">权重设置</label>
            <div class="slider-group">
              <input type="range" class="form-slider" id="addSourceWeight"
                     min="0" max="100" value="30">
              <div class="slider-value" id="addWeightDisplay">30%</div>
            </div>
            <div class="form-hint">建议：内置分级50%，其他来源合计50%</div>
          </div>
        `;

        addModal.setContent(html);

        // 添加按钮
        addModal.addButton('取消', 'secondary', () => {
          addModal.hide();
          setTimeout(() => modal.show(), 300);
        });

        addModal.addButton('创建', 'primary', () => {
          const name = document.getElementById('addSourceName').value.trim();
          const shortName = document.getElementById('addSourceShortName').value.trim();
          const weight = parseInt(document.getElementById('addSourceWeight').value);

          // 验证
          if (!name) {
            showToast('❌ 请输入来源名称');
            return;
          }
          if (!shortName) {
            showToast('❌ 请输入显示简称');
            return;
          }

          // 生成唯一 key
          const key = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

          // 创建新来源
          const newSource = {
            name: name,
            shortName: shortName,
            weight: weight / 100,
            enabled: true,
            builtin: false,
            description: '用户自定义分级来源',
            tiers: {
              'A+': { score: 100, name: 'A+', color: '#FFD700', description: '顶级' },
              'A': { score: 90, name: 'A', color: '#FFA500', description: '优秀' },
              'B': { score: 75, name: 'B', color: '#4CAF50', description: '良好' },
              'C': { score: 60, name: 'C', color: '#2196F3', description: '一般' },
              'D': { score: 40, name: 'D', color: '#9E9E9E', description: '较差' }
            }
          };

          // 保存
          addOrUpdateTierSource(key, newSource);
          showToast(`✅ 已添加分级来源"${shortName}"`);
          renderJournals();

          addModal.hide();
          setTimeout(() => {
            renderMainMenu();
            modal.show();
          }, 300);
        });

        // 实时更新权重显示
        const body = addModal.getBody();
        const weightSlider = body.querySelector('#addSourceWeight');
        const weightDisplay = body.querySelector('#addWeightDisplay');

        weightSlider.addEventListener('input', (e) => {
          weightDisplay.textContent = `${e.target.value}%`;
        });

        // 自动填充简称
        const nameInput = body.querySelector('#addSourceName');
        const shortNameInput = body.querySelector('#addSourceShortName');

        nameInput.addEventListener('blur', () => {
          if (!shortNameInput.value && nameInput.value) {
            // 简单提取：取前2-4个字符
            shortNameInput.value = nameInput.value.substring(0, 4);
          }
        });

        // 隐藏主菜单，显示添加表单
        modal.hide();
        setTimeout(() => addModal.show(), 300);
      }

      // 渲染并显示主菜单
      renderMainMenu();
      modal.show();
    }

    /**
     * 渲染某个期刊的文献列表
     */
    function renderJournalLiteratures(journalName) {
      const journal = state.journals.get(journalName);
      if (!journal) {
        showToast("未找到该期刊");
        state.selectedJournal = null;
        renderJournals();
        return;
      }

      // 渲染头部（返回按钮 + 期刊信息）
      const headerHtml = `
        <div class="journal-view-header">
          <button class="journal-view-back" id="journalViewBack">
            ← 返回
          </button>
          <div class="journal-view-info">
            ${journal.name.toTitleCase()} 的文献 (${journal.count} 篇)
          </div>
        </div>
      `;

      // 渲染文献卡片
      dom.literatureGrid.className = 'literature-grid';
      dom.literatureGrid.innerHTML = headerHtml + journal.literatures
        .map(lit => renderLiteratureCard(lit))
        .join('');
    }

    /**
     * 更新搜索计数
     */
    function updateSearchCount() {
      const count = state.filteredLiteratures.length;
      dom.searchCount.textContent = `${count} 篇文献`;
    }

    /**
     * 更新加载更多按钮
     */
    function updateLoadMoreButton() {
      if (state.pagination.hasMore) {
        dom.loadMoreContainer.classList.add('show');
        const remaining = state.filteredLiteratures.length - state.displayedLiteratures.length;
        dom.loadMoreBtn.textContent = `加载更多 (剩余 ${remaining} 篇)`;
      } else {
        dom.loadMoreContainer.classList.remove('show');
      }
    }

    // ==================== 事件处理 ====================

    /**
     * 处理卡片点击
     */
    function handleCardClick(event) {
      const card = event.target.closest('.literature-card');
      if (!card) return;

      // 如果点击的是操作图标，不处理卡片点击
      if (event.target.closest('.action-icon') || event.target.closest('.btn')) {
        return;
      }

      const id = card.dataset.id;

      if (state.selectedId === id) {
        // 第二次点击：展开/收起详情
        if (state.expandedId === id) {
          // 收起详情
          state.expandedId = null;
          hideBackdrop();
        } else {
          // 展开详情
          state.expandedId = id;
          renderLiteratures();

          // 延迟执行滚动和显示背景，等待 DOM 更新
          setTimeout(() => {
            const expandedCard = document.querySelector('.literature-card.expanded');
            if (expandedCard) {
              scrollToCard(expandedCard);
              showBackdrop();
            }
          }, 50);
          return;
        }
      } else {
        // 第一次点击：选中卡片
        state.selectedId = id;
        state.expandedId = null;
        hideBackdrop();
      }

      renderLiteratures();
    }

    /**
     * 处理操作按钮点击
     */
    function handleAction(action, id) {
      const lit = state.literatures.find(l => l.id === id);
      if (!lit) return;

      switch (action) {
        case 'pin':
          togglePin(id);
          showToast(state.pinnedLiteratures.has(id) ? '✅ 已添加星标' : '已取消星标');
          break;
        case 'focus':
          postBridge('focusInMindMap', { id });
          showToast('正在定位到 MarginNote...');
          break;
        case 'pdf':
          postBridge('openPDF', { id });
          showToast('正在打开 PDF...');
          break;
        case 'bibtex':
          postBridge('exportBibTeX', { id });
          showToast('已复制 BibTeX');
          break;
      }
    }

    /**
     * 处理搜索输入
     */
    const handleSearchInput = debounce(function() {
      state.searchQuery = dom.searchInput.value.trim();
      applyFilters();
    }, 300);

    /**
     * 处理筛选器切换
     */
    function handleFilterToggle() {
      const isShowing = dom.filtersPanel.classList.contains('show');

      if (isShowing) {
        dom.filtersPanel.classList.remove('show');
        dom.mainLayout.classList.remove('with-filters');
        dom.toggleFiltersBtn.textContent = '筛选';
      } else {
        dom.filtersPanel.classList.add('show');
        dom.mainLayout.classList.add('with-filters');
        dom.toggleFiltersBtn.textContent = '收起筛选';
      }
    }

    /**
     * 处理清空操作
     */
    function handleClear() {
      dom.searchInput.value = '';
      state.searchQuery = '';
      state.filters.activeType = 'all';
      state.filters.yearStart = 2000;
      state.filters.yearEnd = 2030;
      state.filters.activeVenue = 'all';
      state.selectedId = null;
      state.expandedId = null;

      dom.yearStartRange.value = 2000;
      dom.yearEndRange.value = 2030;
      dom.yearStartLabel.textContent = '2000';
      dom.yearEndLabel.textContent = '2030';

      hideBackdrop();
      applyFilters();
      renderFilters();
      showToast('已清空筛选条件');
    }

    // ==================== 初始化 ====================

    function init() {
      // 添加全局错误监听
      window.addEventListener('error', (e) => {
        console.error('页面错误:', e.message, e.filename, e.lineno, e.colno);
        showToast('❌ 加载错误: ' + e.message);
      });

      // 添加未捕获的 Promise 错误监听
      window.addEventListener('unhandledrejection', (e) => {
        console.error('Promise 错误:', e.reason);
        showToast('❌ 操作失败: ' + (e.reason?.message || e.reason));
      });

      // 加载星标数据
      loadPinnedData();

      // 加载期刊数据
      loadJournalStarData();

      // 加载分级来源数据
      loadTierSourcesData();

      // 加载期刊多来源分级数据
      loadJournalMultiTiersData();

      // 事件监听
      dom.searchInput.addEventListener('input', handleSearchInput);
      dom.toggleFiltersBtn.addEventListener('click', handleFilterToggle);
      dom.clearBtn.addEventListener('click', handleClear);
      dom.refreshBtn.addEventListener('click', () => Bridge.refreshData());
      dom.loadMoreBtn.addEventListener('click', loadMore);
      dom.literatureGrid.addEventListener('click', handleCardClick);

      // 作者卡片点击和返回按钮处理（使用事件委托）
      dom.literatureGrid.addEventListener('click', (e) => {
        // 处理关闭按钮点击
        const closeBtn = e.target.closest('.author-close-btn');
        if (closeBtn) {
          e.stopPropagation();
          state.expandedAuthor = null;
          hideBackdrop();
          renderAuthors();
          return;
        }

        // 处理"查看全部文献"按钮
        const viewAllBtn = e.target.closest('[data-action="view-all-lit"]');
        if (viewAllBtn) {
          e.stopPropagation();
          const authorCard = viewAllBtn.closest('.author-card');
          const authorName = authorCard.dataset.author;
          state.selectedAuthor = authorName;
          state.expandedAuthor = null;
          hideBackdrop();
          renderLiteratures();
          return;
        }

        // 处理"编辑工作单位"按钮
        const editAffiliationBtn = e.target.closest('[data-action="edit-affiliation"]');
        if (editAffiliationBtn) {
          e.stopPropagation();
          const authorName = editAffiliationBtn.dataset.author;
          if (authorName) {
            showEditAffiliationDialog(authorName);
          }
          return;
        }

        // 处理"编辑作者信息"按钮
        const editAuthorInfoBtn = e.target.closest('[data-action="edit-author-info"]');
        if (editAuthorInfoBtn) {
          e.stopPropagation();
          const authorName = editAuthorInfoBtn.dataset.author;
          if (authorName) {
            editAuthorInfo(authorName);
          }
          return;
        }

        // 处理合作者点击（跳转到该作者）
        const coauthorItem = e.target.closest('.coauthor-item');
        if (coauthorItem) {
          e.stopPropagation();
          const coauthorName = coauthorItem.dataset.author;
          // 关闭当前展开，展开新作者
          state.expandedAuthor = coauthorName;
          renderAuthors();

          // 滚动到对应的作者卡片
          setTimeout(() => {
            const targetCard = document.querySelector(`.author-card[data-author="${coauthorName}"]`);
            if (targetCard && !targetCard.classList.contains('expanded')) {
              targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 100);
          return;
        }

        // 处理作者卡片点击
        const authorCard = e.target.closest('.author-card');
        if (authorCard && !e.target.closest('.author-card-details')) {
          // 只有点击卡片头部才触发展开/收起
          const authorName = authorCard.dataset.author;

          // 如果是作者列表视图
          if (state.currentView === 'author' && !state.selectedAuthor) {
            if (state.expandedAuthor === authorName) {
              // 再次点击：收起
              state.expandedAuthor = null;
              hideBackdrop();
            } else {
              // 展开悬浮显示
              state.expandedAuthor = authorName;
              showBackdrop();
            }
            renderAuthors();
            return;
          }
        }

        // 处理返回按钮点击
        const backBtn = e.target.closest('.author-view-back');
        if (backBtn) {
          state.selectedAuthor = null;
          state.expandedAuthor = null;
          hideBackdrop();
          renderLiteratures();
          return;
        }

        // ============ 期刊卡片事件处理 ============

        // 处理期刊关闭按钮点击
        const journalCloseBtn = e.target.closest('.journal-close-btn');
        if (journalCloseBtn) {
          e.stopPropagation();
          state.expandedJournal = null;
          hideBackdrop();
          renderJournals();
          return;
        }

        // 处理期刊打星
        const starIcon = e.target.closest('.star-icon');
        if (starIcon && starIcon.dataset.action === 'rate-journal') {
          e.stopPropagation();
          const journalCard = starIcon.closest('.journal-card');
          const journalName = journalCard.dataset.journal;
          const stars = parseInt(starIcon.dataset.star);

          // 如果点击的是当前星级,则清除评分
          const currentStars = state.journalStarRatings.get(journalName) || 0;
          const newStars = (currentStars === stars) ? 0 : stars;

          toggleJournalStar(journalName, newStars);

          // 仅更新当前卡片的星级显示,避免重新渲染整个列表
          const starRating = journalCard.querySelector('.journal-star-rating');
          if (starRating) {
            starRating.innerHTML = Array.from({length: 5}, (_, i) => {
              const filled = (i + 1) <= newStars;
              return `<span class="star-icon ${filled ? 'filled' : ''}"
                           data-action="rate-journal"
                           data-star="${i + 1}">★</span>`;
            }).join('');
          }

          // 更新评分显示
          const scoreElement = journalCard.querySelector('.journal-final-score');
          if (scoreElement) {
            const journal = state.journals.get(journalName);
            scoreElement.textContent = journal.finalScore.toFixed(1);
          }

          showToast(newStars > 0 ? `✅ 已评分 ${newStars} 星` : '已清除评分');
          return;
        }

        // 处理"查看全部文献"按钮
        const viewAllJournalBtn = e.target.closest('[data-action="view-all-journal-lit"]');
        if (viewAllJournalBtn) {
          e.stopPropagation();
          const journalCard = viewAllJournalBtn.closest('.journal-card');
          const journalName = journalCard.dataset.journal;
          state.selectedJournal = journalName;
          state.expandedJournal = null;
          hideBackdrop();
          renderLiteratures();
          return;
        }

        // 处理"管理分级"按钮
        const manageTiersBtn = e.target.closest('[data-action="manage-journal-tiers"]');
        if (manageTiersBtn) {
          e.stopPropagation();
          const journalCard = manageTiersBtn.closest('.journal-card');
          const journalName = journalCard.dataset.journal;
          showJournalTierManager(journalName);
          return;
        }

        // 处理期刊卡片点击
        const journalCard = e.target.closest('.journal-card');
        if (journalCard && !e.target.closest('.journal-card-details')) {
          // 只有点击卡片头部才触发展开/收起
          const journalName = journalCard.dataset.journal;

          // 如果是期刊列表视图
          if (state.currentView === 'journal' && !state.selectedJournal) {
            if (state.expandedJournal === journalName) {
              // 再次点击：收起
              state.expandedJournal = null;
              hideBackdrop();
            } else {
              // 展开悬浮显示
              state.expandedJournal = journalName;
              showBackdrop();
            }
            renderJournals();
            return;
          }
        }

        // 处理期刊返回按钮点击
        const journalBackBtn = e.target.closest('.journal-view-back');
        if (journalBackBtn) {
          state.selectedJournal = null;
          state.expandedJournal = null;
          hideBackdrop();
          renderLiteratures();
          return;
        }

        // ============ 文献卡片点击跳转 ============

        // 处理作者文献列表中的文献卡片点击
        const authorLitItem = e.target.closest('.author-lit-item');
        if (authorLitItem) {
          e.stopPropagation();
          const litId = authorLitItem.dataset.litId;

          // 切换回全部视图
          state.currentView = 'all';
          state.selectedAuthor = null;
          state.expandedAuthor = null;
          hideBackdrop();

          // 聚焦并展开对应的文献卡片
          state.selectedId = litId;
          state.expandedId = litId;

          renderLiteratures();

          // 等待 DOM 更新后滚动到卡片位置
          setTimeout(() => {
            const targetCard = document.querySelector(`.literature-card[data-id="${litId}"]`);
            if (targetCard) {
              scrollToCard(targetCard);
              showBackdrop();
            }
          }, 100);

          showToast('📍 已定位到文献');
          return;
        }

        // 处理期刊文献列表中的文献卡片点击
        const journalLitItem = e.target.closest('.journal-rep-paper-item');
        if (journalLitItem) {
          e.stopPropagation();
          const litId = journalLitItem.dataset.litId;

          // 切换回全部视图
          state.currentView = 'all';
          state.selectedJournal = null;
          state.expandedJournal = null;
          hideBackdrop();

          // 聚焦并展开对应的文献卡片
          state.selectedId = litId;
          state.expandedId = litId;

          renderLiteratures();

          // 等待 DOM 更新后滚动到卡片位置
          setTimeout(() => {
            const targetCard = document.querySelector(`.literature-card[data-id="${litId}"]`);
            if (targetCard) {
              scrollToCard(targetCard);
              showBackdrop();
            }
          }, 100);

          showToast('📍 已定位到文献');
          return;
        }
      });

      // Tab 切换
      dom.viewTabs.addEventListener('click', (e) => {
        const tab = e.target.closest('.tab');
        if (!tab || tab.classList.contains('disabled')) return;

        const viewKey = tab.dataset.view;
        switchView(viewKey);
      });

      // 类型筛选
      dom.typeFilters.addEventListener('click', (e) => {
        const pill = e.target.closest('.pill');
        if (!pill) return;

        state.filters.activeType = pill.dataset.type;
        applyFilters();
        renderFilters();
      });

      // 期刊筛选
      dom.venueFilters.addEventListener('click', (e) => {
        const pill = e.target.closest('.pill');
        if (!pill) return;

        state.filters.activeVenue = pill.dataset.venue;
        applyFilters();
        renderFilters();
      });

      // 年份范围
      dom.yearStartRange.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        state.filters.yearStart = value;
        dom.yearStartLabel.textContent = value;

        // 确保起始年份不大于结束年份
        if (value > state.filters.yearEnd) {
          state.filters.yearEnd = value;
          dom.yearEndRange.value = value;
          dom.yearEndLabel.textContent = value;
        }

        applyFilters();
      });

      dom.yearEndRange.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        state.filters.yearEnd = value;
        dom.yearEndLabel.textContent = value;

        // 确保结束年份不小于起始年份
        if (value < state.filters.yearStart) {
          state.filters.yearStart = value;
          dom.yearStartRange.value = value;
          dom.yearStartLabel.textContent = value;
        }

        applyFilters();
      });

      // 操作图标点击
      dom.literatureGrid.addEventListener('click', (e) => {
        const icon = e.target.closest('.action-icon');
        if (!icon) return;

        e.stopPropagation();
        const card = icon.closest('.literature-card');
        const id = card.dataset.id;
        const action = icon.dataset.action;

        handleAction(action, id);
      });

      // 关键词点击搜索
      dom.literatureGrid.addEventListener('click', (e) => {
        const keywordTag = e.target.closest('.keyword-tag');
        if (!keywordTag) return;

        e.stopPropagation();
        const keyword = keywordTag.dataset.keyword;

        // 设置搜索关键词
        dom.searchInput.value = keyword;
        state.searchQuery = keyword;

        // 执行搜索
        applyFilters();

        // 滚动到顶部查看结果
        dom.mainLayout.scrollTo({ top: 0, behavior: 'smooth' });

        // 显示提示
        const count = state.filteredLiteratures.length;
        showToast(`🔍 找到 ${count} 篇包含「${keyword}」的文献`);
      });

      // 点击背景遮罩关闭详情
      dom.backdropBlur.addEventListener('click', () => {
        if (state.expandedId) {
          state.expandedId = null;
          hideBackdrop();
          renderLiteratures();
        } else if (state.expandedAuthor) {
          state.expandedAuthor = null;
          hideBackdrop();
          renderAuthors();
        } else if (state.expandedJournal) {
          state.expandedJournal = null;
          hideBackdrop();
          renderJournals();
        }
      });

      // ESC 键关闭详情
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (state.expandedId) {
            state.expandedId = null;
            hideBackdrop();
            renderLiteratures();
          } else if (state.expandedAuthor) {
            state.expandedAuthor = null;
            hideBackdrop();
            renderAuthors();
          } else if (state.expandedJournal) {
            state.expandedJournal = null;
            hideBackdrop();
            renderJournals();
          }
        }
      });

      // 加载示例数据（用于测试）
      loadSampleData();

      // 通知 Native 准备就绪
      Bridge.notifyReady();
    }

    /**
     * 加载示例数据（测试用）
     */
    function loadSampleData() {
      const sampleData = [
        {
          id: 'zhang2023transformer',
          title: 'Transformer 模型在自然语言处理中的突破性进展',
          authors: ['张伟', '李明', 'Anna Wilson'],
          year: 2023,
          type: 'article',
          journal: '人工智能学报',
          keywords: ['自然语言处理', 'Transformer', '注意力机制', '深度学习'],
          abstract: '本文深入分析了Transformer架构在自然语言处理领域的革命性影响。通过对多个大规模NLP任务的实验评估，我们证明了Transformer模型在处理长序列和语义理解方面的显著优势。',
          doi: '10.1000/ai.2023.001',
          citations: 128,
          pdfLink: 'marginnote://note/xxx'
        },
        {
          id: 'wang2022federated',
          title: '联邦学习在医疗图像分析中的隐私保护应用',
          authors: ['王芳', 'Robert Davis', '刘强'],
          year: 2022,
          type: 'inproceedings',
          journal: '国际医学影像会议',
          keywords: ['联邦学习', '医疗图像', '隐私保护', '深度学习'],
          abstract: '针对医疗数据隐私保护需求，本研究提出了一种基于联邦学习的医学图像分析框架。该方案在保持数据本地化的基础上实现了分布式模型训练。',
          citations: 89
        },
        {
          id: 'chen2021reinforcement',
          title: '基于深度强化学习的自动驾驶决策系统',
          authors: ['陈明', 'Steven Chen', '赵敏'],
          year: 2021,
          type: 'article',
          journal: 'IEEE 智能交通系统',
          keywords: ['自动驾驶', '强化学习', '决策系统', '人工智能'],
          abstract: '本文提出了一种结合深度强化学习的自动驾驶决策框架。通过设计新型奖励函数和状态表示方法，系统在复杂交通场景中表现出优异的决策能力。',
          doi: '10.1109/TITS.2021.xxx',
          citations: 145
        },
        {
          id: 'liu2020knowledge',
          title: '知识图谱构建中的实体对齐技术研究',
          authors: ['刘建华', '王伟', '张明'],
          year: 2020,
          type: 'article',
          journal: '计算机研究与发展',
          keywords: ['知识图谱', '实体对齐', '图神经网络', '自然语言处理'],
          abstract: '本研究系统探讨了大规模知识图谱构建中的实体对齐关键技术。提出了一种基于图神经网络和预训练语言模型的联合学习方法。',
          citations: 76
        },
        {
          id: 'huang2023compression',
          title: '神经网络模型压缩与加速技术综述',
          authors: ['Steven Chen', '黄伟', 'Anna Wilson'],
          year: 2023,
          type: 'article',
          journal: 'IEEE 模式分析与机器智能',
          keywords: ['模型压缩', '神经网络', '模型加速', '边缘计算'],
          abstract: '本文全面综述了深度神经网络模型压缩与加速的最新研究进展。系统分析了剪枝、量化、知识蒸馏和轻量化网络设计等技术的原理与应用场景。',
          doi: '10.1109/TPAMI.2023.xxx',
          citations: 112
        },
        // ========== 新增测试数据 ==========
        {
          id: 'li2023nlp',
          title: '预训练语言模型在跨语言理解中的应用',
          authors: ['李华', 'Emily Zhang', '王磊'],
          year: 2023,
          type: 'inproceedings',
          journal: 'ACL 2023',
          keywords: ['自然语言处理', 'Transformer', '跨语言学习', '预训练模型'],
          abstract: '本文探讨了预训练语言模型在跨语言理解任务中的应用。通过设计新型的跨语言对齐机制，我们的模型在多个基准测试中取得了显著提升。',
          doi: '10.18653/v1/2023.acl-long.123',
          citations: 67
        },
        {
          id: 'zhao2022vision',
          title: '视觉 Transformer 在医疗影像分析中的研究',
          authors: ['赵丽', 'John Smith', '陈强'],
          year: 2022,
          type: 'article',
          journal: 'Medical Image Analysis',
          keywords: ['深度学习', 'Transformer', '医疗图像', '计算机视觉'],
          abstract: '将 Vision Transformer 应用于医学影像分析，特别是在肿瘤检测和病变分割任务中。实验表明 ViT 在处理高分辨率医学图像时具有明显优势。',
          doi: '10.1016/j.media.2022.102456',
          citations: 89
        },
        {
          id: 'wu2024multimodal',
          title: '多模态大语言模型的视觉推理能力研究',
          authors: ['吴明', 'Sarah Lee', '张鹏'],
          year: 2024,
          type: 'inproceedings',
          journal: 'CVPR 2024',
          keywords: ['深度学习', '多模态学习', 'Transformer', '视觉推理'],
          abstract: '研究多模态大语言模型在视觉推理任务中的表现，提出了一种新的视觉-语言对齐方法，显著提升了模型的推理能力。',
          citations: 34
        },
        {
          id: 'sun2021attention',
          title: '注意力机制在时序预测中的应用综述',
          authors: ['孙伟', 'Michael Brown'],
          year: 2021,
          type: 'article',
          journal: 'IEEE Transactions on Neural Networks',
          keywords: ['注意力机制', '时序预测', '深度学习', 'Transformer'],
          abstract: '全面综述了注意力机制在时序预测领域的应用进展，包括 Transformer、时间注意力网络等架构的原理和应用场景。',
          doi: '10.1109/TNNLS.2021.3089456',
          citations: 156
        },
        {
          id: 'tang2023robotics',
          title: '深度强化学习在机器人操控任务中的应用',
          authors: ['唐莉', 'David Kim', '林强'],
          year: 2023,
          type: 'inproceedings',
          journal: 'ICRA 2023',
          keywords: ['强化学习', '机器人', '深度学习', '操控系统'],
          abstract: '提出了一种基于深度强化学习的机器人操控框架，通过模仿学习和在线强化学习的结合，实现了复杂操控任务的快速学习。',
          citations: 45
        },
        {
          id: 'ma2022graph',
          title: '图神经网络在社交网络分析中的最新进展',
          authors: ['马涛', 'Jennifer Wang', '周敏'],
          year: 2022,
          type: 'article',
          journal: 'ACM Computing Surveys',
          keywords: ['图神经网络', '社交网络', '深度学习', '网络分析'],
          abstract: '系统回顾了图神经网络在社交网络分析中的应用，包括社区发现、影响力传播、链路预测等任务的最新研究进展。',
          doi: '10.1145/3522771',
          citations: 203
        },
        {
          id: 'xu2024edge',
          title: '边缘计算环境下的深度学习模型优化',
          authors: ['徐刚', 'Lisa Chen'],
          year: 2024,
          type: 'article',
          journal: 'IEEE Internet of Things Journal',
          keywords: ['边缘计算', '深度学习', '模型压缩', '模型加速'],
          abstract: '针对边缘设备资源受限的特点，提出了一套完整的深度学习模型优化方案，包括量化、剪枝和知识蒸馏等技术。',
          doi: '10.1109/JIOT.2024.3356789',
          citations: 28
        },
        {
          id: 'qian2021privacy',
          title: '联邦学习中的差分隐私保护机制',
          authors: ['钱红', 'Andrew Miller', '宋伟'],
          year: 2021,
          type: 'inproceedings',
          journal: 'NeurIPS 2021',
          keywords: ['联邦学习', '隐私保护', '差分隐私', '机器学习'],
          abstract: '研究联邦学习场景下的隐私保护问题，提出了一种高效的差分隐私机制，在保证隐私的同时最小化性能损失。',
          citations: 98
        },
        {
          id: 'ding2023adversarial',
          title: '对抗训练在自然语言处理中的鲁棒性研究',
          authors: ['丁磊', 'Rebecca White', '何敏'],
          year: 2023,
          type: 'article',
          journal: 'Computational Linguistics',
          keywords: ['自然语言处理', '对抗训练', '鲁棒性', '深度学习'],
          abstract: '深入研究对抗训练方法在提升 NLP 模型鲁棒性方面的作用，提出了多种针对文本数据的对抗样本生成策略。',
          doi: '10.1162/coli_a_00456',
          citations: 72
        },
        {
          id: 'gao2022semantic',
          title: '基于语义理解的图像分割新方法',
          authors: ['高静', 'Thomas Anderson'],
          year: 2022,
          type: 'inproceedings',
          journal: 'ECCV 2022',
          keywords: ['计算机视觉', '图像分割', '语义理解', '深度学习'],
          abstract: '提出了一种结合语义理解的图像分割方法，通过引入语言先验知识，显著提升了分割的准确性和一致性。',
          citations: 81
        },
        {
          id: 'pan2020survey',
          title: '迁移学习理论与应用研究综述',
          authors: ['潘伟', '杨敏', 'Kevin Lee'],
          year: 2020,
          type: 'article',
          journal: 'IEEE Transactions on Knowledge and Data Engineering',
          keywords: ['迁移学习', '深度学习', '领域适应', '机器学习'],
          abstract: '全面综述了迁移学习的理论基础和实际应用，涵盖了领域适应、任务迁移、零样本学习等多个方面。',
          doi: '10.1109/TKDE.2020.2987980',
          citations: 267
        },
        // ========== 数学领域期刊测试数据 ==========
        {
          id: 'wang2023annals',
          title: 'On the Riemann Hypothesis and Prime Number Distribution',
          authors: ['王建', 'Peter Smith', '李华'],
          year: 2023,
          type: 'article',
          journal: 'ANNALS OF MATHEMATICS',
          keywords: ['数论', '黎曼猜想', '素数分布', '解析数论'],
          abstract: '本文研究了黎曼猜想与素数分布之间的深层联系。通过引入新的解析方法，我们对黎曼 ζ 函数的零点分布给出了更精确的估计。',
          doi: '10.4007/annals.2023.197.1.1',
          citations: 234
        },
        {
          id: 'liu2022advances',
          title: 'Advances in Algebraic Topology and Homotopy Theory',
          authors: ['刘明', 'Anna Wilson'],
          year: 2022,
          type: 'article',
          journal: 'ADVANCES IN MATHEMATICS',
          keywords: ['代数拓扑', '同伦论', '范畴论', '拓扑学'],
          abstract: '我们发展了一套新的代数拓扑工具来研究同伦群的计算问题。这些方法在计算高维球面的同伦群时特别有效。',
          doi: '10.1016/j.aim.2022.108123',
          citations: 156
        },
        {
          id: 'zhang2024china',
          title: 'Nonlinear Partial Differential Equations on Manifolds',
          authors: ['张伟', '陈明', 'Robert Johnson'],
          year: 2024,
          type: 'article',
          journal: 'SCIENCE CHINA-MATHEMATICS',
          keywords: ['偏微分方程', '流形', '几何分析', '非线性分析'],
          abstract: '本文研究了流形上的非线性偏微分方程解的存在性和唯一性问题。我们证明了在紧致黎曼流形上，某类椭圆方程具有光滑解。',
          doi: '10.1007/s11425-024-2056-3',
          citations: 89
        },
        {
          id: 'chen2023algebra',
          title: 'Representation Theory of Finite Groups',
          authors: ['陈强', 'David Miller'],
          year: 2023,
          type: 'article',
          journal: 'JOURNAL OF ALGEBRA',
          keywords: ['群表示论', '有限群', '代数', '特征标理论'],
          abstract: '我们研究了有限群的复表示理论，特别关注不可约表示的构造和分类问题。给出了某些重要群类的完整特征标表。',
          doi: '10.1016/j.jalgebra.2023.04.012',
          citations: 67
        },
        {
          id: 'yang2022calculus',
          title: 'Calculus of Variations and Optimal Control',
          authors: ['杨磊', 'Sarah Lee', '赵敏'],
          year: 2022,
          type: 'article',
          journal: 'CALCULUS OF VARIATIONS AND PARTIAL DIFFERENTIAL EQUATIONS',
          keywords: ['变分法', '最优控制', '泛函分析', '偏微分方程'],
          abstract: '本文建立了一个统一的框架来处理变分问题和最优控制问题。我们证明了在一般假设下解的存在性定理。',
          doi: '10.1007/s00526-022-02345-6',
          citations: 78
        },
        {
          id: 'zhao2021fundamental',
          title: 'Fundamentals of Mathematical Logic and Set Theory',
          authors: ['赵建华', 'Michael Brown'],
          year: 2021,
          type: 'article',
          journal: 'FUNDAMENTA MATHEMATICAE',
          keywords: ['数理逻辑', '集合论', '模型论', '证明论'],
          abstract: '我们发展了一个新的集合论模型，在其中某些经典的独立性结果可以被解决。这为集合论的基础研究提供了新的视角。',
          doi: '10.4064/fm123-4-5678',
          citations: 45
        },
        {
          id: 'li2024linear',
          title: 'Linear Algebra and Matrix Theory Applications',
          authors: ['李静', 'Thomas Anderson', '吴明'],
          year: 2024,
          type: 'article',
          journal: 'LINEAR ALGEBRA AND ITS APPLICATIONS',
          keywords: ['线性代数', '矩阵论', '数值分析', '特征值问题'],
          abstract: '本文提出了一种新的算法来计算大规模稀疏矩阵的特征值。该算法在实际应用中表现出优异的收敛性和稳定性。',
          doi: '10.1016/j.laa.2024.01.001',
          citations: 52
        },
        {
          id: 'sun2023acta',
          title: 'Harmonic Analysis on Lie Groups',
          authors: ['孙伟', 'Jennifer Wang'],
          year: 2023,
          type: 'article',
          journal: 'ACTA MATHEMATICA SINICA-ENGLISH SERIES',
          keywords: ['调和分析', '李群', '表示论', '傅里叶分析'],
          abstract: '我们研究了李群上的调和分析理论，特别是 Peter-Weyl 定理在紧李群上的推广。建立了与表示论之间的深刻联系。',
          doi: '10.1007/s10114-023-1234-5',
          citations: 61
        }
      ];

      Bridge.loadLiteratures({ literatures: sampleData });
    }

    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // 暴露 handleAction 到全局（用于按钮点击）
    window.handleAction = handleAction;
  </script>
</body>
</html>
