<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ç¦æ­¢ç¼©æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebDAVé…ç½®</title>
    <link rel="stylesheet" href="notyf.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -o-user-select: none;
            user-select: none;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0px;
            padding: 15px;
            width: 100%;
            height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="url"],
        input[type="password"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-icon {
            position: relative;
        }

        .input-icon::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-size: contain;
            opacity: 0.5;
        }

        .input-icon.url::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1' /%3E%3C/svg%3E");
        }

        .input-icon.user::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' /%3E%3C/svg%3E");
        }

        .input-icon.password::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z' /%3E%3C/svg%3E");
        }

        .input-icon.custom::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z' /%3E%3C/svg%3E");
        }

        .input-icon input {
            padding-left: 48px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding-left: 0px;
            padding-right: 0px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
            padding-left: 0px;
            padding-right: 0px;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .status-message {
            margin-top: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.show {
            opacity: 1;
        }

        .toggle-password {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            font-size: 14px;
            padding: 0;
            background-color: white;
        }

        .toggle-password:hover {
            color: #495057;
        }

        /* ä¸»å†…å®¹åŒºåŸŸå¸ƒå±€ */
        .main-content {
            display: flex;
            gap: 15px;
            height: 100%;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            flex: 0 0 280px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e9ecef;
            overflow-y: scroll;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        /* ä¸»è§†å›¾æ ·å¼ */
        .main-view {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e9ecef;
            overflow-y: scroll;
        }

        .main-view-header {
            margin-bottom: 24px;
        }

        .main-view-header h3 {
            margin: 0;
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .btn-add-source {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            white-space: nowrap;
        }

        .btn-add-source:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .source-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .source-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 16px;
            width: 100%;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .source-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .source-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .source-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .source-name {
            font-weight: 600;
            font-size: 16px;
            margin: 0;
        }

        .source-actions {
            display: flex;
            gap: 4px;
        }

        .source-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            background: rgba(200, 200, 200, 0.2);
            color: #6c757d;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .source-item.active .source-action-btn {
            color: white;
            background: rgba(25, 25, 25, 0.2);
        }

        .source-action-btn:hover {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }

        .source-item.active .source-action-btn:hover {
            background: rgba(173, 36, 50, 0.8);
            color: white;
        }

        .source-url {
            font-size: 12px;
            color: #6c757d;
            margin: 0;
            word-break: break-all;
        }

        .source-item.active .source-url {
            color: rgba(255, 255, 255, 0.8);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state h4 {
            margin: 0 0 8px 0;
            color: #495057;
        }
        .webdavForm {
          overflow: scroll;
        }







        @media (max-width: 650px) {
            body {
                margin: 0px;
                padding: 0px;
            }
            
            .container {
                padding: 15px 15px;
                margin: 0px;
                max-width: 100%;
                border-radius: 0px;
            }

            /* ç§»åŠ¨ç«¯ä½¿ç”¨ç«–ç›´å¸ƒå±€ */
            .main-content {
                flex-direction: column;
                gap: 15px;
                min-height: auto;
            }

            .sidebar {
                flex: none;
                order: 1;
                background: rgba(248, 249, 250, 0.8);
                padding: 16px;
            }

            .main-view {
                flex: none;
                order: 2;
                background: rgba(255, 255, 255, 0.95);
                padding: 20px;
                overflow-y: scroll;
            }

            .sidebar-header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
                text-align: center;
            }

            .btn-add-source {
                font-size: 15px;
                padding: 12px 16px;
            }
            
            .btn-group {
                flex-direction: column;
            }

            .source-list {
                gap: 10px;
            }

            .source-item {
                padding: 14px;
            }

            .main-view-header h3 {
                font-size: 18px;
                text-align: center;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
        <div class="header">
            <h1>WebDAVé…ç½®</h1>
            <p>é…ç½®æ‚¨çš„WebDAVè¿æ¥ä¿¡æ¯</p>
        </div>
                <div class="sidebar-header">
                    <button type="button" class="btn-add-source" onclick="addNewSource()">
                        <span>+</span> æ·»åŠ æ–°æº
                    </button>
                </div>
                <div class="source-list" id="sourceList">
                    <!-- æºåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ä¸»è§†å›¾ -->
            <div class="main-view">
                <div class="main-view-header">
                    <h3>é…ç½®ä¿¡æ¯</h3>
                </div>
                
                <form id="webdavForm">
            <div class="form-group">
                <label for="sourceName">æºåç§°</label>
                <div class="input-icon custom">
                    <input 
                        type="text" 
                        id="sourceName" 
                        name="sourceName" 
                        placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„äº‘ç›˜"
                        required
                    >
                </div>
            </div>

            <div class="form-group">
                <label for="url">æœåŠ¡å™¨åœ°å€ (URL)</label>
                <div class="input-icon url">
                    <input 
                        type="url" 
                        id="url" 
                        name="url" 
                        placeholder="https://example.com/webdav"
                        required
                    >
                </div>
            </div>

            <div class="form-group">
                <label for="username">ç”¨æˆ·å (Username)</label>
                <div class="input-icon user">
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å"
                        required
                    >
                </div>
            </div>

            <div class="form-group">
                <label for="password">å¯†ç  (Password)</label>
                <div class="input-icon password" style="position: relative;">
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        placeholder="è¾“å…¥æ‚¨çš„å¯†ç "
                        required
                    >
                    <button type="button" class="toggle-password" onclick="togglePassword()">
                        <span id="toggleText">æ˜¾ç¤º</span>
                    </button>
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn-secondary" onclick="clearForm()">
                    æ¸…ç©º
                </button>
                <button type="button" class="btn-secondary" onclick="deleteCurrentSource()" id="deleteBtn" style="display: none;">
                    åˆ é™¤æº
                </button>
            </div>
            <div class="btn-group">
                <button type="button" class="btn-primary" onclick="testConnection()">
                    æµ‹è¯•
                </button>
                <button type="submit" class="btn-primary" id="submitBtn">
                    ä¿å­˜é…ç½®
                </button>
            </div>
                </form>

                <div id="statusMessage" class="status-message"></div>
            </div>
        </div>
    </div>



    <script>
        // ç”¨æˆ·è‡ªå®šä¹‰æºåˆ—è¡¨
        let userSources = [];
        let currentSourceId = null;
        let sourceConfigs = {}
        let isFileManagerPage = false;//ç”¨æ’ä»¶åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶ç®¡ç†é¡µé¢,å½“å‰ä¸ºé…ç½®ç•Œé¢
        // åˆå§‹åŒ– Notyf å®ä¾‹
        let notyf = undefined
    /**
     * æ˜¾ç¤ºæ¶ˆæ¯æç¤º
     */
    function showToast(message, type = 'info') {
        if (!notyf) {
          notyf = new Notyf({
            duration: 3000,
            position: {
                x: 'center',
                y: 'top'
            },
            dismissible: true
        });
        }
        try {
            // ä½¿ç”¨ Notyf æ˜¾ç¤ºé€šçŸ¥
            switch (type) {
                case 'success':
                    notyf.success(message);
                    break;
                case 'error':
                case 'danger':
                    notyf.error(message);
                    break;
                case 'warning':
                case 'warn':
                    // Notyf è‡ªå®šä¹‰è­¦å‘Šç±»å‹
                    notyf.open({
                        type: 'warning',
                        message: message,
                        background: '#f39c12',
                        icon: {
                            className: 'fas fa-exclamation-triangle',
                            tagName: 'i',
                            color: '#fff'
                        }
                    });
                    break;
                case 'info':
                default:
                    // Notyf è‡ªå®šä¹‰ä¿¡æ¯ç±»å‹
                    notyf.open({
                        type: 'info',
                        message: message,
                        background: '#3498db',
                        duration: 1000,
                        icon: {
                            className: 'fas fa-info-circle',
                            tagName: 'i',
                            color: '#fff'
                        }
                    });
                    break;
            }
        } catch (error) {
            // å¦‚æœ Notyf æœªåˆå§‹åŒ–ï¼Œåˆ™å›é€€åˆ°æ§åˆ¶å°è¾“å‡º
            console.warn('Notyf æœªåˆå§‹åŒ–ï¼Œå›é€€åˆ°æ§åˆ¶å°è¾“å‡º');
            console.log(`${type.toUpperCase()}: ${message}`);
        }
    }
        /**
         * (æ‰‹åŠ¨å®ç°) æ ¹æ®æŒ‡å®šçš„ schemeã€è·¯å¾„å’Œå‚æ•°ç”Ÿæˆä¸€ä¸ª URL Scheme å­—ç¬¦ä¸²ã€‚
         * æ­¤ç‰ˆæœ¬ä¸ä½¿ç”¨ URLSearchParamsã€‚
         *
         * @param {string} scheme - URL scheme, ä¾‹å¦‚ 'myapp'ã€‚
         * @param {string} [path] - å¯é€‰çš„è·¯å¾„æˆ–æ“ä½œåã€‚
         * @param {Object<string, string|number|boolean>} [params] - æŸ¥è¯¢å‚æ•°å¯¹è±¡ã€‚
         * @returns {string} - ç”Ÿæˆçš„å®Œæ•´ URL å­—ç¬¦ä¸²ã€‚
         */
        function generateUrlScheme(scheme, path, params) {
          let url = `${scheme}://${path || ''}`;

          if (params && Object.keys(params).length > 0) {
            const queryParts = [];
            for (const key in params) {
              // ç¡®ä¿æˆ‘ä»¬åªå¤„ç†å¯¹è±¡è‡ªèº«çš„å±æ€§
              if (Object.prototype.hasOwnProperty.call(params, key)) {
                const value = params[key];
                const type = typeof value
                // å¯¹é”®å’Œå€¼éƒ½è¿›è¡Œç¼–ç ï¼Œè¿™æ˜¯è‡³å…³é‡è¦çš„ï¼
                const encodedKey = encodeURIComponent(key);
                const encodedValue = encodeURIComponent(type === "object"? JSON.stringify(value):value);
                queryParts.push(`${encodedKey}=${encodedValue}`);
              }
            }

            if (queryParts.length > 0) {
              url += `?${queryParts.join('&')}`;
            }
          }
          return url;
        }
        function postMessageToAddon(scheme, path, params) {
          let url = generateUrlScheme(scheme,path,params)
          window.location.href = url
        }

        function init(encodedConfig) {
        try {
          

          let configAll = JSON.parse(decodeURIComponent(encodedConfig))
          userSources = configAll.sources
          sourceConfigs = configAll.sourceConfigs ?? {}
          const savedSourceId = configAll.currentSourceId

          if (userSources.length === 0) {
              const defaultSource = {
                  id: generateId(),
                  name: 'æˆ‘çš„WebDAV',
                  url: '',
                  createdAt: new Date().toISOString()
              };
              userSources.push(defaultSource);
          }
          renderSourceList();
          initializeForms();
          if (savedSourceId && userSources.find(s => s.id === savedSourceId)) {
              selectSource(savedSourceId);
          } else if (userSources.length > 0) {
              selectSource(userSources[0].id);
          }
        } catch (error) {
          showToast(error.toString(),"error")
        }
        }


        // åŠ è½½ç”¨æˆ·æºåˆ—è¡¨
        function loadUserSources() {
            const saved = localStorage.getItem('userWebdavSources');
            if (saved) {
                try {
                    userSources = JSON.parse(saved);
                } catch (e) {
                    console.log('åŠ è½½æºåˆ—è¡¨å¤±è´¥:', e);
                    userSources = [];
                }
            }
        }

        // ä¿å­˜ç”¨æˆ·æºåˆ—è¡¨
        function saveUserSources() {
            localStorage.setItem('userWebdavSources', JSON.stringify(userSources));

        }

        // åˆ›å»ºé»˜è®¤æºï¼ˆå¦‚æœéœ€è¦ï¼‰
        function createDefaultSourceIfNeeded() {
            if (userSources.length === 0) {
                const defaultSource = {
                    id: generateId(),
                    name: 'æˆ‘çš„WebDAV',
                    url: '',
                    createdAt: new Date().toISOString()
                };
                userSources.push(defaultSource);
                saveUserSources();
            }
        }

        // æ¸²æŸ“æºåˆ—è¡¨
        function renderSourceList() {
            const sourceList = document.getElementById('sourceList');
            
            sourceList.innerHTML = userSources.map(source => `
                <div class="source-item ${source.id === currentSourceId ? 'active' : ''}" 
                     onclick="selectSource('${source.id}')">
                    <div class="source-item-header">
                        <h4 class="source-name">${source.name}</h4>
                        <div class="source-actions">
                            <button class="source-action-btn" onclick="deleteSource(event, '${source.id}')" title="åˆ é™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                    <p class="source-url">${source.url || 'æœªé…ç½®åœ°å€'}</p>
                </div>
            `).join('');
        }

        // é€‰æ‹©æº
        function selectSource(sourceId,postMessage = false) {
            currentSourceId = sourceId;
            const source = userSources.find(s => s.id === sourceId);
            
            if (source) {
                // å¡«å……è¡¨å•
                document.getElementById('sourceName').value = source.name;
                document.getElementById('url').value = source.url || '';
                
                // åŠ è½½ä¿å­˜çš„é…ç½®
                loadSavedConfig(sourceId);
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const deleteBtn = document.getElementById('deleteBtn');
                if (userSources.length > 1) {
                    deleteBtn.style.display = 'inline-block';
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
            
            renderSourceList();
            if (postMessage) {
              
            }
        }

        // åˆ é™¤æº
        function deleteSource(event, sourceId) {
            event.stopPropagation();
            
            if (userSources.length <= 1) {
                showMessage('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæº', 'error');
                return;
            }
            
            const source = userSources.find(s => s.id === sourceId);
            postMessageToAddon("mnwebdav","deletesource",{id:source.id,name:source.name})
        }

        // åˆ é™¤å½“å‰æº
        function deleteCurrentSource() {
            if (currentSourceId) {
                deleteSource({ stopPropagation: () => {} }, currentSourceId);
            }
        }

                        // æ·»åŠ æ–°æº
        function addNewSource() {
            const newSource = {
                id: generateId(),
                name: 'æ–°çš„WebDAVæº',
                url: '',
                createdAt: new Date().toISOString()
            };
            
            userSources.push(newSource);
            saveUserSources();
            selectSource(newSource.id);
            renderSourceList();
            showMessage('æ–°æºå·²æ·»åŠ ï¼Œè¯·é…ç½®ä¿¡æ¯', 'success');
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return 'source_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // åˆå§‹åŒ–è¡¨å•
        function initializeForms() {
            // ä¸»è¡¨å•æäº¤
            document.getElementById('webdavForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCurrentSource();
            });
        }

        // ä¿å­˜å½“å‰æº
        function saveCurrentSource() {
            if (!currentSourceId) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæº', 'error');
                return;
            }
            
            const formData = new FormData(document.getElementById('webdavForm'));
            const sourceName = formData.get('sourceName').trim();
            const url = formData.get('url').trim();
            const username = formData.get('username').trim();
            const password = formData.get('password').trim();

            // åŸºæœ¬éªŒè¯
            if (!sourceName) {
                showMessage('æºåç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (!url) {
                showMessage('æœåŠ¡å™¨åœ°å€ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (!isValidUrl(url)) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€', 'error');
                return;
            }

            if (!username) {
                showMessage('ç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (!password) {
                showMessage('å¯†ç ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦é‡å¤ï¼ˆæ’é™¤å½“å‰æºï¼‰
            const existingNameSource = userSources.find(s => s.name === sourceName && s.id !== currentSourceId);
            if (existingNameSource) {
                showMessage('æºåç§°å·²å­˜åœ¨', 'error');
                return;
            }

            // const existingUrlSource = userSources.find(s => s.url === url && s.id !== currentSourceId);
            // if (existingUrlSource) {
            //     showMessage('è¯¥URLå·²è¢«å…¶ä»–æºä½¿ç”¨', 'error');
            //     return;
            // }

            // æ›´æ–°æºä¿¡æ¯
            const source = userSources.find(s => s.id === currentSourceId);
            if (source) {
                source.name = sourceName;
                source.url = url;
                source.updatedAt = new Date().toISOString();
                saveUserSources();
            }

            // ä¿å­˜é…ç½®ä¿¡æ¯
            const config = {
                url: url,
                username: username,
                password: password,
                sourceId: currentSourceId,
                sourceName: sourceName,
                savedAt: new Date().toISOString()
            };

            saveConfiguration(config);
            renderSourceList();
            // let sourceConfigs = {//è¿™ä¸ªæ‰æœ‰è®°å½•è´¦æˆ·å¯†ç 

            // }
            postMessageToAddon("mnwebdav","saveconfig",{sourceConfigs:sourceConfigs,currentSourceId:currentSourceId,sources:userSources})
        }

        // URLéªŒè¯
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // ä¿å­˜é…ç½®
        function saveConfiguration(config) {
            // æ¨¡æ‹Ÿä¿å­˜è¿‡ç¨‹
            showMessage('æ­£åœ¨ä¿å­˜é…ç½®...', 'success');
            sourceConfigs[currentSourceId] = config
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„APIè°ƒç”¨
            setTimeout(() => {
                // ä¸ºå½“å‰æºä¿å­˜é…ç½®
                const configKey = currentSourceId;
                localStorage.setItem(configKey, JSON.stringify(config));
                
                // ä¹Ÿä¿å­˜å½“å‰é€‰æ‹©çš„æº
                localStorage.setItem('currentWebdavSourceId', currentSourceId);
                
                showMessage(`${config.sourceName}é…ç½®å·²æˆåŠŸä¿å­˜ï¼`, 'success');
                
                // å¯é€‰ï¼šé‡å®šå‘æˆ–å…¶ä»–æ“ä½œ
                console.log('ä¿å­˜çš„é…ç½®:', config);

            }, 1000);
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showMessage(message, type) {
            showToast(message,type)
            // const statusEl = document.getElementById('statusMessage');
            // statusEl.textContent = message;
            // statusEl.className = `status-message ${type} show`;
            
            // // 3ç§’åéšè—æ¶ˆæ¯
            // setTimeout(() => {
            //     statusEl.classList.remove('show');
            // }, 3000);
        }

        // åˆ‡æ¢å¯†ç æ˜¾ç¤º/éšè—
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleText = document.getElementById('toggleText');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleText.textContent = 'éšè—';
            } else {
                passwordInput.type = 'password';
                toggleText.textContent = 'æ˜¾ç¤º';
            }
        }
        //æµ‹è¯•è¿æ¥
        function testConnection() {
            if (!currentSourceId) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæº', 'error');
                return;
            }
            const formData = new FormData(document.getElementById('webdavForm'));
            const sourceName = formData.get('sourceName').trim();
            const url = formData.get('url').trim();
            const username = formData.get('username').trim();
            const password = formData.get('password').trim();

            // åŸºæœ¬éªŒè¯
            if (!sourceName) {
                showMessage('æºåç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (!url) {
                showMessage('æœåŠ¡å™¨åœ°å€ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (!isValidUrl(url)) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€', 'error');
                return;
            }

            if (!username) {
                showMessage('ç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (!password) {
                showMessage('å¯†ç ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            // const source = userSources.find(s => s.id === currentSourceId);
            // const config = sourceConfigs[source.id]
            // if (config) {
            //   postMessageToAddon("mnwebdav","testconnection",config)
            // }else{
              postMessageToAddon("mnwebdav","testconnection",{
                sourceName:sourceName,
                url:url,
                username:username,
                password:password
              })
            // }
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            if (!currentSourceId) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæº', 'error');
                return;
            }
            
            const source = userSources.find(s => s.id === currentSourceId);
            if (source) {
                // åªæ¸…ç©ºç”¨æˆ·åå’Œå¯†ç ï¼Œä¿ç•™æºåç§°å’ŒURL
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showMessage('å·²æ¸…ç©ºï¼Œç‚¹å‡»ä¿å­˜ç”Ÿæ•ˆ', 'success');
            }
        }

        // åŠ è½½ä¿å­˜çš„é…ç½®
        function loadSavedConfig(sourceId) {
            if (!sourceId) sourceId = currentSourceId;
            if (!sourceId) return;

            // åŠ è½½æŒ‡å®šæºçš„é…ç½®
            const savedConfig = sourceConfigs[sourceId];
            
            if (savedConfig) {
                try {
                    document.getElementById('username').value = savedConfig.username || '';
                    // å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œä¸æ¢å¤å¯†ç 
                    document.getElementById('password').value = savedConfig.password;
                } catch (e) {
                    console.log('æ— æ³•æ¢å¤é…ç½®:', e);
                }
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é…ç½®ï¼Œæ¸…ç©ºè¡¨å•
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }



        // å®æ—¶URLéªŒè¯
        document.getElementById('url').addEventListener('blur', function() {
            const url = this.value;
            if (url && !isValidUrl(url)) {
                this.style.borderColor = '#dc3545';
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€ï¼ˆå¦‚ï¼šhttps://example.com/webdavï¼‰', 'error');
            } else {
                this.style.borderColor = '#e1e5e9';
            }
        });
    </script>
    <script src="notyf.min.js"></script>
</body>
</html> 