# 上下文相关同义词替换功能 - 需求规格说明书

## Introduction

### 功能概述
本功能为 MNMath 搜索系统增加上下文相关的同义词替换能力，解决学术研究中词汇同义关系受领域上下文影响的问题。例如，在内积空间中"元素"和"向量"可以互换使用，但在一般集合论中则不能。

### 用户价值
- **提高搜索精确度**：避免跨领域的错误匹配，减少无关结果
- **保持使用习惯**：支持用户在不同上下文使用不同术语的自然习惯
- **增强学术体验**：为数学、物理等精确科学提供更专业的搜索支持

### 范围界定
- **技术范围**：仅涉及 `/mnutils/mnutils/xdyyutils.js` 中的同义词相关功能
- **兼容性要求**：保持与现有同义词系统完全向后兼容
- **内容范围**：不包括预设学科领域配置内容的添加

## Alignment with Product Vision

### 与 MNMath 愿景对齐
MNMath 致力于为学术研究提供精确、智能的知识管理工具。本功能通过以下方式支持这一愿景：

1. **精确性提升**：上下文感知的同义词替换避免了跨领域的术语混淆，符合学术研究对精确性的要求
2. **智能化增强**：系统能够理解词汇的使用上下文，体现了工具的智能化特性
3. **用户体验优化**：允许用户按照自然的学术习惯使用术语，提高工具的易用性

### 与现有功能的协同
- **搜索系统增强**：作为现有搜索功能的智能化升级，不破坏现有工作流
- **配置系统扩展**：基于现有同义词管理界面，保持用户体验的一致性
- **知识管理完善**：支持更细粒度的知识分类和检索，完善整体知识管理体系

## Requirements

### 用户故事

### US-1: 上下文相关同义词配置
**作为** 学术研究者  
**我希望** 能够配置上下文相关的同义词组  
**以便于** 在特定学科领域使用精确的同义词替换规则

**验收标准:**
- WHEN 我创建同义词组时，THEN 系统应提供contextTriggers字段用于设置上下文触发词数组
- WHEN 我设置触发词为["内积空间", "赋范线性空间"]时，THEN 仅在标题包含任一触发词的卡片中进行"元素"↔"向量"替换
- WHEN 我不设置触发词（contextTriggers为undefined或空数组）时，THEN 同义词组应按原有全局逻辑工作
- WHEN 触发词包含特殊字符或标点时，THEN 系统应进行字符串标准化后进行精确匹配
- WHEN contextMode设置为"all"且标题不包含所有触发词时，THEN 该同义词组不应被应用

### US-2: 智能搜索匹配
**作为** 用户  
**我希望** 搜索"元素"时能根据卡片标题上下文智能匹配  
**以便于** 获得更精确的搜索结果

**验收标准:**
- WHEN 我搜索"元素"且某卡片标题包含"内积空间"时，THEN 该卡片中的"向量"应被匹配
- WHEN 我搜索"元素"且某卡片标题不包含任何触发词时，THEN 该卡片中的"向量"不应被匹配
- WHEN 同义词组未设置触发词（全局模式）时，THEN 搜索行为应与现有系统完全一致
- WHEN 卡片标题为空或null时，THEN 系统应按全局模式处理该卡片的同义词替换
- WHEN 搜索关键词本身就是触发词时，THEN 系统应正确处理循环匹配问题

### US-3: 向后兼容性
**作为** 现有用户  
**我希望** 升级后我的现有同义词配置仍然正常工作  
**以便于** 无需重新配置即可继续使用

**验收标准:**
- WHEN 系统升级后，THEN 现有同义词组应继续按全局逻辑工作
- WHEN 现有同义词组没有 contextTriggers 字段时，THEN 系统应默认为全局模式
- WHEN 加载旧版配置文件时，THEN 不应出现错误或功能失效

### US-4: 上下文模式配置
**作为** 高级用户  
**我希望** 能够配置触发词的匹配模式  
**以便于** 灵活控制何时应用同义词替换

**验收标准:**
- WHEN 我设置 contextMode 为 "any" 时，THEN 标题包含任一触发词即应用同义词
- WHEN 我设置 contextMode 为 "all" 时，THEN 标题必须包含所有触发词才应用同义词
- WHEN 我未设置 contextMode 时，THEN 系统应默认使用 "any" 模式

### US-5: 配置导出与分享
**作为** 用户  
**我希望** 能够完整导出包含上下文配置的同义词设置  
**以便于** 备份和与他人分享我的配置

**验收标准:**
- WHEN 我导出同义词配置时，THEN 导出的JSON应包含所有contextTriggers和contextMode字段
- WHEN contextTriggers未设置时，THEN 导出的JSON中该字段应为undefined或不存在
- WHEN 我导入包含新字段的配置时，THEN 系统应正确加载并应用这些设置
- WHEN 我导入不包含新字段的旧版配置时，THEN 系统应将其作为全局同义词组处理

## 功能需求

### FR-1: 数据结构扩展
系统应扩展现有同义词组结构，支持以下字段：
```javascript
{
  id: "group_xxx",
  name: "同义词组名称",
  words: ["词1", "词2"],
  enabled: true,
  contextTriggers: ["触发词1", "触发词2"], // 新增：可选字段
  contextMode: "any",                     // 新增：默认值
  partialReplacement: false,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### FR-2: 上下文感知的关键词扩展
系统应修改 `expandKeywordsWithSynonyms` 相关方法：
- 接受额外的标题参数进行上下文判断
- 仅当标题匹配触发条件时才应用该同义词组
- 保持无触发词时的全局行为不变

### FR-3: 搜索流程集成
系统应修改 `searchNotesInDescendants` 方法：
- 在匹配每个候选卡片时，传递该卡片的标题信息
- 根据不同卡片标题动态扩展关键词
- 维持现有搜索性能和准确性

### FR-4: 管理界面增强
系统应扩展 `manageSynonymGroupsByPopup` 功能：
- 支持编辑上下文触发词
- 支持选择上下文匹配模式
- 显示同义词组的上下文配置状态

### FR-5: 配置导入导出增强
系统应修改 `exportSynonymGroups` 和相关导入功能：
- 在导出配置时包含新增的 `contextTriggers` 和 `contextMode` 字段
- 确保导入配置时正确处理新字段的加载
- 保持导出配置的向后兼容性（旧版本可以忽略新字段）
- 在配置验证时检查新字段的有效性

## 非功能需求

### NFR-1: 性能要求
- 上下文判断不应显著影响搜索性能（增加时间<10%）
- 支持处理包含1000+同义词组的配置

### NFR-2: 兼容性要求
- 与现有 MNMath 框架100%向后兼容
- 支持现有配置文件的无缝迁移
- 不破坏现有插件生态系统

### NFR-3: 可用性要求
- 用户界面直观易懂，无需额外培训
- 配置变更应实时生效
- 提供清晰的状态反馈

### NFR-4: 可维护性要求
- 代码遵循现有项目规范和命名约定
- 添加适当的注释和错误处理
- 支持调试和日志记录

## 约束和限制

### 技术约束
- 必须使用现有的 MNUtils 框架和 API
- 不得修改数据库结构或存储格式
- 保持与 MarginNote 4 的兼容性

### 业务约束
- 功能增强不应影响现有用户工作流
- 不添加预设的学科领域配置内容
- 保持插件整体稳定性

## 验收测试场景

### 场景1：基本上下文匹配
1. 创建同义词组：name="数学向量", words=["元素","向量"], contextTriggers=["内积空间"]
2. 创建测试卡片：标题="内积空间中的基本概念", 内容包含"向量的定义"
3. 搜索"元素"
4. 预期：该卡片被匹配并返回

### 场景2：上下文不匹配时不替换
1. 使用上述同义词组配置
2. 创建测试卡片：标题="集合论基础", 内容包含"向量的定义"
3. 搜索"元素"
4. 预期：该卡片不被匹配

### 场景3：向后兼容性验证
1. 创建同义词组：name="通用词汇", words=["概念","理念"]（无contextTriggers）
2. 创建测试卡片：标题="任意标题", 内容包含"理念的内涵"
3. 搜索"概念"
4. 预期：该卡片被匹配（全局替换行为）

### 场景4：多触发词"any"模式
1. 创建同义词组：contextTriggers=["内积空间","赋范空间"], contextMode="any"
2. 测试标题仅包含"内积空间"的卡片
3. 预期：同义词替换被激活

### 场景5：多触发词"all"模式
1. 创建同义词组：contextTriggers=["内积空间","有界性"], contextMode="all"
2. 测试标题仅包含"内积空间"的卡片
3. 预期：同义词替换不被激活

## 风险评估

### 高风险
- **性能退化**：上下文判断可能影响大量卡片搜索的性能
- **兼容性问题**：新字段可能导致旧版本配置加载失败

### 中风险
- **用户界面复杂性**：新配置选项可能增加用户学习成本
- **边界情况处理**：触发词的大小写、标点符号处理

### 低风险
- **功能误用**：用户可能过度依赖上下文规则

## 成功标准

### 定量标准
- 现有功能回归测试通过率：100%
- 新功能测试用例通过率：≥95%
- 搜索性能退化：<10%

### 定性标准
- 用户反馈满意度：正面反馈≥80%
- 代码质量符合项目标准
- 文档完整性和清晰度良好

## 项目里程碑

1. **需求确认** - 需求文档获得批准
2. **设计完成** - 技术设计方案确定
3. **开发完成** - 核心功能实现完毕
4. **测试通过** - 所有测试用例验证通过
5. **部署上线** - 功能集成到主版本

---

*本文档版本：1.0*  
*创建日期：2025-01-17*  
*最后更新：2025-01-17*