> å¦‚æœä½ æ²¡å¬æ‡‚æˆ‘çš„éœ€æ±‚æˆ–è€…æœ‰ä»»ä½•è§‰å¾—æˆ‘æ²¡è¯´æ¸…æ¥šçš„åœ°æ–¹ï¼Œè¯·ä¸è¦éšä¾¿çŒœæµ‹ï¼Œç›´æ¥é—®æˆ‘ã€‚
> ä¸¥ç¦è‡ªå·±å‡­ç©ºåˆ›é€ ä¸å­˜åœ¨çš„ APIï¼æƒ³ä½¿ç”¨ä»»ä½•æ²¡å‡ºç°è¿‡çš„ API éƒ½è¦åœ¨æ‰€æœ‰æ’ä»¶æ–‡ä»¶é‡Œæœç´¢ä¸€éï¼Œç¡®è®¤å®ƒç¡®å®å­˜åœ¨ä¸”èƒ½ç”¨ã€‚
> å¦‚æœç”¨æˆ·è®©ä½ åˆ†æä»»ä½•åŠŸèƒ½ä»£ç ï¼Œå¹¶ä¸”è®©ä½ ç”Ÿæˆ Markdown æ–‡æ¡£çš„è¯ï¼Œå¦‚æœæˆ‘æ²¡å‘Šè¯‰ä½ å…·ä½“çš„æ–‡æ¡£è·¯å¾„ï¼Œé»˜è®¤æŠŠè¿™ä¸ª `.md` æ–‡æ¡£ç”Ÿæˆåˆ° [å¦ä¸€ä¸ªè·¯å¾„](/Users/xiakangwei/Nutstore/Obsidian/IOTO/1-è¾“å…¥/ç¢ç‰‡ç¬”è®°/MarginNote) ä¸­ã€‚
> Markdown æ–‡æ¡£ç¼–å†™ä¸¥æ ¼ç”¨ UTF-8 ç¼–ç ï¼
> å¦‚æœç”¨æˆ·è®©ä½ å‚è€ƒæœ¬ç›®å½•çš„æ’ä»¶ï¼Œé»˜è®¤ä¸å‚è€ƒï¼š
> - Gotopage
> - mntask
> - mntoolbar/mntoolbar

# MarginNote 4 æ’ä»¶å¼€å‘æŒ‡å—

## 1. ä»€ä¹ˆæ˜¯ MarginNote 4

MarginNote 4 æ˜¯ä¸€ä¸ª**åŸºäºæ•°æ®ç»“æ„çš„çŸ¥è¯†ç®¡ç†ç³»ç»Ÿ**ï¼Œä¸ä»…ä»…æ˜¯ PDF é˜…è¯»å™¨æˆ–ç¬”è®°è½¯ä»¶ã€‚å…¶æ ¸å¿ƒè®¾è®¡ç†å¿µï¼š

- **çŸ¥è¯†çš„åŸå­åŒ–**ï¼šå°†çŸ¥è¯†åˆ†è§£ä¸ºæœ€å°å¯ç®¡ç†å•å…ƒï¼ˆå¡ç‰‡ï¼‰
- **çŸ¥è¯†çš„ç»“æ„åŒ–**ï¼šé€šè¿‡å…³ç³»ç½‘ç»œæ„å»ºçŸ¥è¯†ä½“ç³»
- **çŸ¥è¯†çš„æµåŠ¨æ€§**ï¼šåŒä¸€æ•°æ®åœ¨ä¸åŒè§†å›¾é—´è‡ªç”±æµè½¬ï¼ˆæ–‡æ¡£/è„‘å›¾/å¤ä¹ ï¼‰
- **çŸ¥è¯†çš„å¯è®¡ç®—æ€§**ï¼šæ”¯æŒæ£€ç´¢ã€é“¾æ¥ã€è‡ªåŠ¨åŒ–å¤„ç†

### ä¸‰å±‚æ•°æ®æ¶æ„
1. **å¡ç‰‡ï¼ˆCardï¼‰**ï¼šçŸ¥è¯†çš„åŸå­å•ä½ï¼ŒåŒ…å«æ ‡é¢˜ã€æ‘˜å½•ã€è¯„è®º
2. **æ–‡æ¡£ï¼ˆDocumentï¼‰**ï¼šçŸ¥è¯†çš„è½½ä½“ï¼Œæ”¯æŒ PDF/EPUB ç­‰æ ¼å¼
3. **å­¦ä¹ é›†ï¼ˆStudy Setï¼‰**ï¼šçŸ¥è¯†çš„å·¥ä½œç©ºé—´ï¼Œæ•´åˆæ–‡æ¡£ã€è„‘å›¾ã€å¤ä¹ 

## 2. MarginNote æ’ä»¶ç³»ç»Ÿ

### æŠ€æœ¯åŸºç¡€
- **JSBridge æ¡†æ¶**ï¼šObjective-C ä¸ JavaScript çš„æ¡¥æ¥æŠ€æœ¯
- **è¿è¡Œç¯å¢ƒ**ï¼šåŸºäº Safari çš„ JavaScript å¼•æ“
- **é™åˆ¶**ï¼šæ—  Node.js APIï¼ŒBrowser API æ”¯æŒæœ‰é™

### æ’ä»¶ç»“æ„ï¼ˆ.mnaddonï¼‰
```
plugin.mnaddon/
â”œâ”€â”€ mnaddon.json    # æ’ä»¶é…ç½®æ¸…å•
â”œâ”€â”€ main.js         # æ’ä»¶ä¸»ä»£ç 
â””â”€â”€ logo.png        # æ’ä»¶å›¾æ ‡
```

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
```javascript
JSB.newAddon = () => {
  return JSB.defineClass("PluginName: JSExtension", {
    // çª—å£ç”Ÿå‘½å‘¨æœŸ
    sceneWillConnect() {},       // æ–°å»ºçª—å£
    sceneDidDisconnect() {},     // å…³é—­çª—å£
    
    // ç¬”è®°æœ¬ç”Ÿå‘½å‘¨æœŸ
    notebookWillOpen(topicid) {}, // æ‰“å¼€ç¬”è®°æœ¬
    notebookWillClose(topicid) {}, // å…³é—­ç¬”è®°æœ¬
    
    // æ–‡æ¡£ç”Ÿå‘½å‘¨æœŸ
    documentDidOpen(docmd5) {},    // æ‰“å¼€æ–‡æ¡£
    documentWillClose(docmd5) {}   // å…³é—­æ–‡æ¡£
  })
}
```

### å¦‚ä½•æ‰“åŒ…å’Œè§£åŒ…æ’ä»¶

åœ¨æ’ä»¶ç›®å½•ä¸‹ä½¿ç”¨ `mnaddon4 build` æ‰“åŒ…ã€ `mnaddon4 unpack`è§£åŒ…ï¼Œæ¯”å¦‚ï¼š
```bash
mnaddon4 build plugin_0827
```
æ‰“åŒ…çš„è¯ï¼Œä¼˜å…ˆä½¿ç”¨ mnaddon-package è¿™ä¸ª agent æ¥æ‰“åŒ…ã€‚

## 3. MNUtils æ¡†æ¶ - æ’ä»¶å¼€å‘çš„åŸºç¡€è®¾æ–½ â­â­â­â­â­

### ä¸ºä»€ä¹ˆ MNUtils æ˜¯å¿…éœ€çš„

MNUtils æ˜¯ MarginNote æ’ä»¶ç”Ÿæ€çš„**æ ¸å¿ƒåŸºç¡€è®¾æ–½å±‚**ï¼š

1. **é»˜è®¤åŠ è½½**ï¼šæ¡†æ¶å·²è‡ªåŠ¨åŠ è½½ï¼Œæ‰€æœ‰æ’ä»¶å¯ç›´æ¥ä½¿ç”¨
2. **å®Œæ•´å°è£…**ï¼šæä¾› 500+ ä¸ª API æ–¹æ³•ï¼Œè¦†ç›–æ‰€æœ‰åŠŸèƒ½éœ€æ±‚
3. **æœ€ä½³å®è·µ**ï¼šç»è¿‡å¤§é‡å®è·µéªŒè¯çš„è®¾è®¡æ¨¡å¼
4. **é™ä½é—¨æ§›**ï¼šæ— éœ€ç†è§£åº•å±‚ Objective-C API

### æ ¸å¿ƒç»„æˆ

**mnutils.js - åŸºç¡€æ¡†æ¶ï¼ˆ8,439è¡Œï¼‰**
- 10 ä¸ªæ ¸å¿ƒç±»ï¼Œ500+ API æ–¹æ³•
- ä¸»è¦ç±»ï¼š
  - `MNUtil`ï¼šç³»ç»Ÿå·¥å…·ç±»ï¼ˆ400+ æ–¹æ³•ï¼‰
  - `MNNote`ï¼šç¬”è®°æ“ä½œç±»ï¼ˆ180+ æ–¹æ³•ï¼‰ï¼ˆå·²è¿ç§»åˆ° `mnnote.js`ï¼‰
  - `MNComment`ï¼šè¯„è®ºç®¡ç†
  - `MNDocument`ï¼šæ–‡æ¡£æ“ä½œ
  - `MNNotebook`ï¼šç¬”è®°æœ¬ç®¡ç†

**xdyyutils.js - å­¦æœ¯æ‰©å±•ï¼ˆ15,560è¡Œï¼‰**
- é’ˆå¯¹å­¦æœ¯åœºæ™¯ä¼˜åŒ–
- æ™ºèƒ½é“¾æ¥ç®¡ç†
- ä¸­æ–‡æ’ç‰ˆä¼˜åŒ–ï¼ˆPangu.jsï¼‰

### ä½¿ç”¨ MNUtils çš„ç¬¬ä¸€æ­¥

```javascript
// å¿…é¡»åœ¨æ’ä»¶å¯åŠ¨æ—¶åˆå§‹åŒ–
MNUtil.init(self.path);

// ä¹‹åå³å¯ä½¿ç”¨æ‰€æœ‰ API
let note = MNNote.getFocusNote();
MNUtil.showHUD("Hello MarginNote!");
```

## 4. å¦‚ä½•å­¦ä¹ å’Œä½¿ç”¨ API

### ğŸ“š æ–‡æ¡£æŸ¥é˜…é¡ºåº

1. **æŸ¥çœ‹ API æŒ‡å—**ï¼š`mnutils/MNUtils_API_Guide.md`
   - å®Œæ•´çš„ API å‚è€ƒæ–‡æ¡£
   - åŒ…å«æ‰€æœ‰ç±»å’Œæ–¹æ³•è¯´æ˜
   - æä¾›ä¸°å¯Œçš„ä½¿ç”¨ç¤ºä¾‹

2. **ç¡®è®¤æ–¹æ³•å­˜åœ¨**ï¼šåœ¨ `mnutils.js`, `mnnote.js` å’Œ `xdyyutils.js` ä¸­æœç´¢
   - æ–‡æ¡£å¯èƒ½æœ‰é—æ¼ï¼Œä»¥æºç ä¸ºå‡†
   - ä½¿ç”¨ Cmd+F å¿«é€Ÿå®šä½æ–¹æ³•

3. **äº†è§£å®ç°ç»†èŠ‚**ï¼šå‚è€ƒ `mnutils/CLAUDE.md`
   - æ·±å…¥äº†è§£å†…éƒ¨å®ç°
   - æŸ¥çœ‹æ³¨æ„äº‹é¡¹å’Œå·²çŸ¥é—®é¢˜

### ç»¼åˆç±»å‹çš„åŠŸèƒ½å‚è€ƒ

ä¸‹é¢ä¼šåˆ—å‡ºä¸€äº›åŸºäº MNUtils å®ç°çš„è¾ƒä¸ºç»¼åˆå’Œå¤æ‚çš„åŠŸèƒ½ï¼Œä¾›ä½ å¼€å‘ç±»ä¼¼çš„åŠŸèƒ½çš„æ—¶å€™è¿›è¡Œå‚è€ƒã€‚

#### å¼¹çª—ç±»å‹

å¦‚æœä½ è¦å¼€å‘ã€Œè¾“å…¥æ¡†ã€+ã€Œé€‰æ‹©ã€ç±»å‹çš„å¼¹çª—ï¼Œå¯ä»¥å‚è€ƒï¼š

##### 1. manageCommentsByPopupï¼ˆå¤šå±‚çº§å¼¹çª—ç®¡ç†ç³»ç»Ÿï¼‰
- **ä½ç½®**ï¼š`mnutils/xdyyutils.js:4419-4508`
- **åŠŸèƒ½**ï¼šè¯„è®ºçš„ç§»åŠ¨ã€åˆ é™¤ã€æå–ç­‰æ“ä½œ
- **ç‰¹ç‚¹**ï¼š
  - å¤šå±‚çº§å¼¹çª—æ¶æ„ï¼ˆä¸»èœå• â†’ é€‰æ‹©æ–¹å¼ â†’ æ“ä½œç¡®è®¤ï¼‰
  - é€’å½’å¯¼èˆªæ¨¡å¼ï¼Œæ”¯æŒè¿”å›ä¸Šä¸€å±‚
  - ç­–ç•¥æ¨¡å¼å¤„ç†ä¸åŒçš„é€‰æ‹©æ–¹å¼
  - é€šè¿‡å›è°ƒå‡½æ•°é“¾ç®¡ç†å¤æ‚æµç¨‹

##### 2. searchNotesInDescendantsï¼ˆå¤æ‚æœç´¢äº¤äº’ç³»ç»Ÿï¼‰
- **ä½ç½®**ï¼š`mnutils/xdyyutils.js:8904-9121`
- **åŠŸèƒ½**ï¼šåœ¨å¤šä¸ªæ ¹ç›®å½•çš„å­å­™å¡ç‰‡ä¸­è¿›è¡Œé«˜çº§æœç´¢
- **ç‰¹ç‚¹**ï¼š
  - å¾ªç¯å¼äº¤äº’ç•Œé¢ï¼Œæ— éœ€é‡å¤æ‰“å¼€å¯¹è¯æ¡†
  - åŠ¨æ€æŒ‰é’®çŠ¶æ€ï¼ˆæ ¹æ®é…ç½®å®æ—¶æ›´æ–°æŒ‰é’®æ–‡å­—ï¼‰
  - æ”¯æŒå¤šç§æœç´¢é…ç½®ï¼ˆç±»å‹ç­›é€‰ã€å…³é”®è¯æ‰©å±•ã€æ’é™¤è¯ç­‰ï¼‰
  - è¿›åº¦æ˜¾ç¤ºå’Œé”™è¯¯å¤„ç†æœºåˆ¶

#### å¼¹çª—å¼€å‘æ¨¡å¼è¯¦è§£

##### å¤šå±‚çº§å¼¹çª—æ¶æ„

**æ ¸å¿ƒè®¾è®¡æ¨¡å¼**ï¼š
```javascript
// 1. ä½¿ç”¨å¯¹è±¡æ˜ å°„ç®¡ç†é€‰é¡¹å’Œå¤„ç†å‡½æ•°
const optionHandlers = {
  "é€‰é¡¹1": () => { /* å¤„ç†é€»è¾‘ */ },
  "é€‰é¡¹2": () => { /* å¤„ç†é€»è¾‘ */ }
};

// 2. é€’å½’è°ƒç”¨å®ç°è¿”å›åŠŸèƒ½
function showMainDialog() {
  UIAlertView.show(..., (alert, buttonIndex) => {
    if (buttonIndex === 0) return; // å–æ¶ˆ
    
    // è¿›å…¥ä¸‹ä¸€å±‚
    showSubDialog(() => {
      // è¿”å›å›è°ƒï¼šé‡æ–°æ˜¾ç¤ºä¸»å¯¹è¯æ¡†
      showMainDialog();
    });
  });
}

// 3. é€šè¿‡å‚æ•°ä¼ é€’å®ç°çŠ¶æ€ä¿æŒ
function showSubDialog(previousDialog) {
  UIAlertView.show(..., (alert, buttonIndex) => {
    if (buttonIndex === 0) {
      previousDialog(); // è¿”å›ä¸Šä¸€å±‚
      return;
    }
    // å¤„ç†é€»è¾‘
  });
}
```

##### çŠ¶æ€ç®¡ç†æ¨¡å¼

**ä½¿ç”¨é—­åŒ…å’Œ Set ç®¡ç†é€‰æ‹©çŠ¶æ€**ï¼š
```javascript
// ä½¿ç”¨ Set å­˜å‚¨é€‰ä¸­é¡¹
const selectedItems = new Set();

// åœ¨å¼¹çª—é—´ä¼ é€’çŠ¶æ€
function showMultiSelectDialog(allOptions, selectedItems, callback) {
  // æ ¹æ® selectedItems æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
  const displayOptions = allOptions.map((opt, idx) => 
    selectedItems.has(idx) ? `âœ… ${opt}` : `â˜ ${opt}`
  );
  
  UIAlertView.show(...displayOptions...);
}
```

##### åŠ¨æ€é€‰é¡¹ç”Ÿæˆ

**æ ¹æ®æ•°æ®åŠ¨æ€æ„å»ºé€‰é¡¹åˆ—è¡¨**ï¼š
```javascript
// æ ¹æ®ç¬”è®°å†…å®¹ç”Ÿæˆé€‰é¡¹
function getAllCommentOptions(note) {
  return note.comments.map((comment, index) => {
    const preview = comment.text.substring(0, 30);
    return `${index}: ${preview}...`;
  });
}

// åŠ¨æ€æ›´æ–°æŒ‰é’®æ–‡å­—
const buttonText = isEnabled ? "â˜‘ï¸ å·²å¯ç”¨" : "â˜ æœªå¯ç”¨";
```

#### æŠ€æœ¯è¦ç‚¹æé†’

##### UIAlertView ä½¿ç”¨æ³¨æ„äº‹é¡¹
1. **alertViewStyle ç±»å‹**ï¼š
   - 0ï¼šé»˜è®¤ï¼ˆæ— è¾“å…¥æ¡†ï¼‰
   - 1ï¼šå¯†ç è¾“å…¥
   - 2ï¼šæ™®é€šæ–‡æœ¬è¾“å…¥
   - 3ï¼šç”¨æˆ·åå’Œå¯†ç è¾“å…¥

2. **æŒ‰é’®ç´¢å¼•**ï¼š
   - 0ï¼šå–æ¶ˆæŒ‰é’®
   - 1+ï¼šå…¶ä»–æŒ‰é’®ï¼ˆä»1å¼€å§‹ï¼‰

3. **æ–‡æœ¬è·å–**ï¼š
   ```javascript
   const inputText = alert.textFieldAtIndex(0).text;
   ```

##### æ€§èƒ½ä¼˜åŒ–å»ºè®®
1. **é¿å…æ·±å±‚é€’å½’**ï¼šä½¿ç”¨å¾ªç¯æ›¿ä»£è¿‡æ·±çš„é€’å½’è°ƒç”¨
2. **æ‰¹é‡æ“ä½œ**ï¼šä½¿ç”¨ `MNUtil.undoGrouping()` åŒ…è£…æ‰¹é‡ä¿®æ”¹
3. **å¼‚æ­¥å¤„ç†**ï¼šé•¿æ—¶é—´æ“ä½œä½¿ç”¨ `MNUtil.delay()` é¿å…é˜»å¡
4. **è¿›åº¦æç¤º**ï¼šæ“ä½œè¶…è¿‡1ç§’åº”æ˜¾ç¤ºè¿›åº¦ HUD

##### é”™è¯¯å¤„ç†æ¨¡å¼
```javascript
try {
  // ä¸»è¦é€»è¾‘
} catch (error) {
  MNUtil.copyJSON(error);
  MNUtil.showHUD("æ“ä½œå¤±è´¥: " + error.message);
  // å¯é€‰ï¼šè¿”å›åˆ°å®‰å…¨çŠ¶æ€
  this.reset();
}
```

## 5. é‡è¦æé†’

1. **API ç‰ˆæœ¬å·®å¼‚**
   - `xdyyutils.js` ä¿®æ”¹äº†éƒ¨åˆ†é»˜è®¤å€¼ï¼ˆå¦‚ `getNoteById` çš„ alert å‚æ•°ï¼‰
   - ä½¿ç”¨å‰è¯·ç¡®è®¤æ˜¯å¦ç¬¦åˆéœ€æ±‚

2. **å¤šçª—å£å¤„ç†**
   - MarginNote æ”¯æŒå¤šçª—å£ï¼Œä¸åŒçª—å£çš„æ’ä»¶å®ä¾‹ç‹¬ç«‹
   - æ•°æ®å¿…é¡»æŒ‚è½½åˆ° `self` ä¸Šä»¥åŒºåˆ†çª—å£

3. **æ€§èƒ½ä¼˜åŒ–**
   - å¤§æ‰¹é‡æ“ä½œä½¿ç”¨ `undoGrouping`
   - é€‚å½“ä½¿ç”¨ `delay` é¿å…ç•Œé¢å¡é¡¿
   - æ³¨æ„å†…å­˜ç®¡ç†ï¼ŒåŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡

4. **è°ƒè¯•æŠ€å·§**
   - ä½¿ç”¨ `MNLog` è®°å½•ç»“æ„åŒ–æ—¥å¿—ï¼ˆæ¨èï¼‰
   - ä½¿ç”¨ `MNUtil.log()` è®°å½•ç®€å•æ—¥å¿—
   - ä½¿ç”¨ `MNUtil.copyJSON()` å¤åˆ¶å¯¹è±¡åˆ°å‰ªè´´æ¿
   - é”™è¯¯ä¼šè‡ªåŠ¨è®°å½•å¹¶å¤åˆ¶

## 6. è·å–æ›´å¤šå¸®åŠ©

- **è¯¦ç»† API æ–‡æ¡£**ï¼šæŸ¥çœ‹ `mnutils/MNUtils_API_Guide.md`
- **å®ç°ç»†èŠ‚**ï¼šæŸ¥çœ‹ `mnutils/CLAUDE.md`
- **æ•°æ®ç»“æ„ç†è§£**ï¼šå‚è€ƒ `MNGuide_DataStructure.md`
- **æ’ä»¶ç³»ç»Ÿæ–‡æ¡£**ï¼šå‚è€ƒ `MarginNoteæ’ä»¶ç³»ç»Ÿæ–‡æ¡£.md`

> ğŸ’¡ **è®°ä½**ï¼šMNUtils ä¸ä»…æ˜¯ä¸€ä¸ªå·¥å…·åº“ï¼Œæ›´æ˜¯æ•´ä¸ª MarginNote æ’ä»¶ç”Ÿæ€çš„åŸºç¡€è®¾æ–½ã€‚æŒæ¡å®ƒç­‰äºæŒæ¡äº† MarginNote æ’ä»¶å¼€å‘çš„æ ¸å¿ƒã€‚

---

# MN-Addon å¼€å‘ç»éªŒä¸å¸¸è§é—®é¢˜

## å…³äº self å’Œ this

åœ¨ JSB.defineClass å†…éƒ¨ä¸¥ç¦ä½¿ç”¨ `let self = this;`ï¼Œè¿™æ˜¯é”™è¯¯çš„å†™æ³•ã€‚ç›´æ¥ç”¨ `self` æŒ‡å‘å½“å‰æ’ä»¶å®ä¾‹å³å¯ã€‚

## note.MNComments ä¸ note.comments çš„å…³é”®åŒºåˆ«

### æ ¸å¿ƒåŒºåˆ«

#### 1. `note.comments` - åŸå§‹è¯„è®ºæ•°ç»„
- åŒ…å«åº•å±‚çš„ `NoteComment` å¯¹è±¡
- `comment.type` åªæœ‰ 5 ç§åŸºç¡€ç±»å‹å€¼ï¼š
  - `"TextNote"` - æ–‡æœ¬è¯„è®º
  - `"HtmlNote"` - HTML è¯„è®º
  - `"LinkNote"` - åˆå¹¶æ‘˜å½•è¯„è®º
  - `"PaintNote"` - ç»˜å›¾è¯„è®ºï¼ˆåŒ…æ‹¬å›¾ç‰‡å’Œæ‰‹å†™ï¼‰
  - `"AudioNote"` - éŸ³é¢‘è¯„è®º

#### 2. `note.MNComments` - å¤„ç†åçš„è¯„è®ºæ•°ç»„  
- é€šè¿‡ `MNComment.from(note)` ç”Ÿæˆçš„ `MNComment` å®ä¾‹æ•°ç»„
- æ„é€ æ—¶è‡ªåŠ¨è°ƒç”¨ `MNComment.getCommentType(comment)` è®¾ç½® type
- `MNComment` çš„ `type` å±æ€§æ˜¯ç»†åˆ†åçš„ 15+ ç§ç±»å‹ï¼š
  - æ–‡æœ¬ç±»ï¼š`"textComment"`, `"markdownComment"`, `"tagComment"`
  - é“¾æ¥ç±»ï¼š`"linkComment"`, `"summaryComment"`
  - HTMLç±»ï¼š`"HtmlComment"`
  - åˆå¹¶ç±»ï¼š`"mergedTextComment"`, `"mergedImageComment"`, `"mergedImageCommentWithDrawing"`
  - å›¾ç‰‡ç±»ï¼š`"imageComment"`, `"imageCommentWithDrawing"`
  - æ‰‹å†™ç±»ï¼š`"drawingComment"`
  - å…¶ä»–ï¼š`"audioComment"`, `"blankTextComment"`, `"blankImageComment"`

### å¸¸è§é”™è¯¯ä¸æ­£ç¡®ç”¨æ³•

```javascript
// âŒ é”™è¯¯1ï¼šå¯¹ MNComments å…ƒç´ å†æ¬¡è°ƒç”¨ getCommentType
let commentType = MNComment.getCommentType(note.MNComments[0]);

// âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨ type å±æ€§ï¼ˆå·²ç»æ˜¯ç»†åˆ†ç±»å‹ï¼‰
let commentType = note.MNComments[0].type;

// âŒ é”™è¯¯2ï¼šå¯¹åŸå§‹ comments ä½¿ç”¨ç»†åˆ†ç±»å‹åˆ¤æ–­
if (note.comments[0].type === "drawingComment") { } // æ°¸è¿œä¸º false

// âœ… æ­£ç¡®ï¼šå¯¹åŸå§‹ comments ä½¿ç”¨åŸºç¡€ç±»å‹
if (note.comments[0].type === "PaintNote") { }
```

### å®é™…æ¡ˆä¾‹ï¼šåˆ¤æ–­æ‰‹å†™è¯„è®º

```javascript
// æ¨èæ–¹æ³•ï¼šä½¿ç”¨ MNComments
function isHandwritingComment(note, index) {
  let commentType = note.MNComments[index].type;
  return commentType === "drawingComment" || 
         commentType === "imageCommentWithDrawing" || 
         commentType === "mergedImageCommentWithDrawing";
}

// å¤‡é€‰æ–¹æ³•ï¼šä½¿ç”¨åŸå§‹ commentsï¼ˆæ›´å¤æ‚ï¼‰
function isHandwritingCommentAlt(note, index) {
  let comment = note.comments[index];
  if (comment.type === "PaintNote" || comment.type === "LinkNote") {
    let commentType = MNComment.getCommentType(comment);
    return commentType === "drawingComment" || 
           commentType === "imageCommentWithDrawing" || 
           commentType === "mergedImageCommentWithDrawing";
  }
  return false;
}
```

### æœ€ä½³å®è·µ
1. **ä¼˜å…ˆä½¿ç”¨ `note.MNComments`**ï¼šç±»å‹å·²ç»†åˆ†ï¼Œä½¿ç”¨æ›´æ–¹ä¾¿
2. **é¿å…é‡å¤è°ƒç”¨ `getCommentType`**ï¼šMNComments å·²ç»å¤„ç†è¿‡äº†
3. **ç†è§£ç±»å‹å±‚æ¬¡**ï¼šåŸºç¡€ç±»å‹ï¼ˆ5ç§ï¼‰ â†’ ç»†åˆ†ç±»å‹ï¼ˆ15+ç§ï¼‰
4. **è°ƒè¯•æŠ€å·§**ï¼š`MNUtil.log(note.MNComments[0])` æŸ¥çœ‹å®é™… type å€¼

### å½±å“èŒƒå›´
- æ‰€æœ‰æ¶‰åŠè¯„è®ºç±»å‹åˆ¤æ–­çš„åŠŸèƒ½
- ç‰¹åˆ«æ˜¯æ‰‹å†™ã€å›¾ç‰‡ã€åˆå¹¶å†…å®¹çš„è¯†åˆ«

# Git å·¥ä½œæµè§„èŒƒ

åŸåˆ™ä¸Šä¸å…è®¸åœ¨æœªç»æˆ‘å…è®¸çš„æƒ…å†µä¸‹è‡ªå·±è¿›è¡Œ git commit å’Œ pushã€‚

## GitHub Issue å·¥ä½œæµè§„èŒƒ

### æ¦‚è¿°
æ ‡å‡†åŒ–çš„ GitHub é—®é¢˜ç®¡ç†æµç¨‹ï¼Œç¡®ä¿é—®é¢˜è¿½è¸ªçš„ä¸“ä¸šæ€§å’Œå¯è¿½æº¯æ€§ã€‚

### 1. é—®é¢˜å‘ç°ä¸è®°å½•
å½“å¼€å‘è¿‡ç¨‹ä¸­å‘ç°é—®é¢˜æ—¶ï¼š
- åˆ›å»ºä¸´æ—¶è®°å½•æ–‡ä»¶ï¼ˆå¦‚ `fix_summary.md`ï¼‰
- è¯¦ç»†è®°å½•ï¼š
  - é—®é¢˜ç°è±¡
  - å¤ç°æ­¥éª¤
  - åŸå› åˆ†æ
  - è§£å†³æ–¹æ¡ˆ

### 2. ä»£ç ä¿®å¤æµç¨‹
- åœ¨æœ¬åœ°åˆ†æ”¯è¿›è¡Œä¿®å¤
- ç¡®ä¿ä¿®å¤ç»è¿‡å……åˆ†æµ‹è¯•
- ä¿æŒä»£ç æ”¹åŠ¨çš„åŸå­æ€§ï¼ˆä¸€ä¸ªæäº¤è§£å†³ä¸€ä¸ªé—®é¢˜ï¼‰
- é¿å…åœ¨ä¸€ä¸ªæäº¤ä¸­æ··æ‚å¤šä¸ªä¸ç›¸å…³çš„ä¿®æ”¹

### 3. æäº¤è§„èŒƒ
```bash
# 1. æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
git add [ä¿®æ”¹çš„æ–‡ä»¶]

# 2. åˆ›å»ºè¯­ä¹‰åŒ–æäº¤
git commit -m "fix: ç®€è¦æè¿°ä¿®å¤å†…å®¹

- è¯¦ç»†è¯´æ˜ä¿®å¤çš„é—®é¢˜ (#issue-number)
- åˆ—å‡ºä¸»è¦æ”¹åŠ¨ç‚¹
- è¯´æ˜å½±å“èŒƒå›´"

# 3. æ¨é€åˆ°è¿œç¨‹ä»“åº“
git push [remote-name] [branch-name]
```

### 4. åˆ›å»º Issue
**é‡è¦åŸåˆ™**ï¼šå¿…é¡»åœ¨ä»£ç æäº¤å¹¶æ¨é€åæ‰åˆ›å»º issue

```bash
gh issue create \
  --title "[æ’ä»¶å] é—®é¢˜ç®€è¦æè¿°" \
  --body "## é—®é¢˜æè¿°
è¯¦ç»†æè¿°é—®é¢˜ç°è±¡...

## å¤ç°æ­¥éª¤
1. æ­¥éª¤ä¸€
2. æ­¥éª¤äºŒ
3. ...

## åŸå› åˆ†æ
è¯´æ˜é—®é¢˜çš„æ ¹æœ¬åŸå› ...

## è§£å†³æ–¹æ¡ˆ
æè¿°é‡‡ç”¨çš„è§£å†³æ–¹æ¡ˆ...

## ç›¸å…³ä»£ç 
- ä¿®å¤ä½ç½®ï¼š[GitHub ä»£ç æ°¸ä¹…é“¾æ¥]
- Commit: [commit hash]

## ä¿®å¤çŠ¶æ€
âœ… å·²åœ¨ [branch] åˆ†æ”¯ä¿®å¤" \
  --label "æ’ä»¶å" \
  --label "bug/feature/enhancement"
```

### 5. Issue æ›´æ–°æœ€ä½³å®è·µ

#### ä½¿ç”¨ä»£ç æ°¸ä¹…é“¾æ¥
```
https://github.com/[ç”¨æˆ·å]/[ä»“åº“å]/blob/[commit-hash]/[æ–‡ä»¶è·¯å¾„]#L[è¡Œå·]
```
ç¤ºä¾‹ï¼š
```
https://github.com/xkwxdyy/MN-Addons/blob/0a16a5805278ffa676a7365c22361e94d16d1876/mntask/xdyy_utils_extensions.js#L538-L546
```

#### æ›´æ–° Issue è¯„è®º
```bash
gh issue comment [issue-number] --body "å·²åœ¨ commit [hash] ä¸­ä¿®å¤

### ç›¸å…³ä»£ç é“¾æ¥ï¼š
- [å…·ä½“ä¿®å¤æè¿°]ï¼š[ä»£ç æ°¸ä¹…é“¾æ¥]

### ä¿®å¤è¯´æ˜ï¼š
[è¯¦ç»†è¯´æ˜ä¿®å¤çš„å†…å®¹]"
```

### 6. å…³é—­ Issue
```bash
# éªŒè¯ä¿®å¤åå…³é—­
gh issue close [issue-number] --comment "å·²ä¿®å¤å¹¶éªŒè¯é€šè¿‡"

# æˆ–è€…ç®€å•å…³é—­
gh issue close [issue-number]
```

### 7. å®Œæ•´å·¥ä½œæµç¤ºä¾‹

ä»¥ TaskFieldUtils æ–¹æ³•åå†²çªé—®é¢˜ä¸ºä¾‹ï¼š

1. **å‘ç°é—®é¢˜**ï¼šå­—æ®µå†…å®¹æå–å…¨éƒ¨è¿”å› null
2. **åˆ†æåŸå› **ï¼šå‘ç°å­˜åœ¨åŒåæ–¹æ³•å¯¼è‡´è¦†ç›–
3. **æœ¬åœ°ä¿®å¤**ï¼šå°†æ–¹æ³•é‡å‘½åä¸º `extractFieldText`
4. **æµ‹è¯•éªŒè¯**ï¼šç¡®è®¤å­—æ®µå†…å®¹èƒ½æ­£ç¡®æå–
5. **æäº¤ä»£ç **ï¼š
   ```bash
   git add xdyy_utils_extensions.js
   git commit -m "fix: ä¿®å¤ TaskFieldUtils æ–¹æ³•åå†²çªå¯¼è‡´å­—æ®µæå–å¤±è´¥ (#3)"
   git push github dev
   ```
6. **åˆ›å»º Issue**ï¼šåŒ…å«é—®é¢˜æè¿°ã€åŸå› åˆ†æã€è§£å†³æ–¹æ¡ˆ
7. **æ›´æ–° Issue**ï¼šæ·»åŠ å…·ä½“çš„ä»£ç é“¾æ¥
8. **å…³é—­ Issue**ï¼šç¡®è®¤ä¿®å¤åå…³é—­

### 8. æ³¨æ„äº‹é¡¹

#### æ ‡ç­¾ä½¿ç”¨è§„èŒƒ
- **æ’ä»¶æ ‡ç­¾**ï¼šå¿…é¡»æ·»åŠ ï¼ˆå¦‚ `mntask`ã€`mnai`ï¼‰
- **ç±»å‹æ ‡ç­¾**ï¼š
  - `bug`ï¼šé”™è¯¯ä¿®å¤
  - `feature`ï¼šæ–°åŠŸèƒ½
  - `enhancement`ï¼šåŠŸèƒ½æ”¹è¿›
  - `documentation`ï¼šæ–‡æ¡£æ›´æ–°

#### ä»£ç é“¾æ¥è¦æ±‚
- ä½¿ç”¨åŒ…å« commit hash çš„æ°¸ä¹…é“¾æ¥
- é“¾æ¥åˆ°å…·ä½“çš„ä»£ç è¡Œæˆ–ä»£ç å—
- å¤šä¸ªç›¸å…³ä½ç½®éƒ½è¦æä¾›é“¾æ¥

#### Issue æè¿°è§„èŒƒ
- æ ‡é¢˜ç®€æ´æ˜äº†ï¼ŒåŒ…å«æ’ä»¶å
- æ­£æ–‡ç»“æ„åŒ–ï¼Œä½¿ç”¨ Markdown æ ¼å¼
- åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- æä¾›å¤ç°æ­¥éª¤ï¼ˆå¦‚é€‚ç”¨ï¼‰

#### æ—¶æœºæŠŠæ¡
- **å…ˆä»£ç å Issue**ï¼šç¡®ä¿ Issue åˆ›å»ºæ—¶ä»£ç å·²ç»åœ¨ä»“åº“ä¸­
- **åŠæ—¶æ›´æ–°**ï¼šé‡è¦è¿›å±•åŠæ—¶æ›´æ–°åˆ° Issue è¯„è®ºä¸­
- **åŠæ—¶å…³é—­**ï¼šé—®é¢˜è§£å†³ååŠæ—¶å…³é—­ï¼Œé¿å…ç§¯å‹

### 9. æ‰¹é‡å¤„ç†æŠ€å·§

å½“ä¸€æ¬¡ä¿®å¤å¤šä¸ªç›¸å…³é—®é¢˜æ—¶ï¼š
```bash
# 1. ä¸€æ¬¡æäº¤ä¿®å¤å¤šä¸ªé—®é¢˜
git commit -m "fix: ä¿®å¤ MNTask åˆ¶å¡åŠŸèƒ½çš„å¤šä¸ªé—®é¢˜

- ä¿®å¤é—®é¢˜ A (#1)
- ä¿®å¤é—®é¢˜ B (#2)
- ä¿®å¤é—®é¢˜ C (#3)"

# 2. åˆ†åˆ«æ›´æ–°å„ä¸ª Issue
for issue in 1 2 3; do
  gh issue comment $issue --body "å·²åœ¨ commit [hash] ä¸­ä¿®å¤
  ç›¸å…³ä»£ç ï¼š[å¯¹åº”çš„ä»£ç é“¾æ¥]"
done

# 3. æ‰¹é‡å…³é—­
gh issue close 1 2 3
```

### 10. æ–‡æ¡£ç»´æŠ¤

- é‡è¦é—®é¢˜çš„è§£å†³æ–¹æ¡ˆåº”è®°å½•åˆ° CLAUDE.md
- é€šç”¨æ€§çš„è§£å†³æ–¹æ¡ˆå¯ä»¥æ•´ç†æˆæœ€ä½³å®è·µ
- å®šæœŸå›é¡¾å’Œæ›´æ–°æ–‡æ¡£ï¼Œä¿æŒå…¶æ—¶æ•ˆæ€§

## Git æ“ä½œé‡è¦æé†’ï¼ˆ2025-01-17ï¼‰

### å…³é”®äº‹é¡¹
1. **æäº¤åå¿…é¡» push**ï¼šå®Œæˆ git commit åï¼Œä¸€å®šè¦è®°å¾—æ‰§è¡Œ git push æ¨é€åˆ°è¿œç¨‹ä»“åº“
2. **è¿œç¨‹ä»“åº“åç§°**ï¼šMN-Addon é¡¹ç›®çš„è¿œç¨‹ä»“åº“åæ˜¯ `github`ï¼Œä¸æ˜¯é»˜è®¤çš„ `origin`

### æ­£ç¡®çš„ Git å·¥ä½œæµ
```bash
# 1. æ·»åŠ æ–‡ä»¶
git add [æ–‡ä»¶å]

# 2. æäº¤æ›´æ”¹
git commit -m "æäº¤ä¿¡æ¯"

# 3. æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼ˆé‡è¦ï¼ï¼‰
git push github [åˆ†æ”¯å]  # æ³¨æ„ï¼šæ˜¯ github è€Œä¸æ˜¯ origin
```

### å¸¸è§é”™è¯¯
```bash
# âŒ é”™è¯¯ï¼šä½¿ç”¨ origin
git push origin dev  # ä¼šæŠ¥é”™ï¼š'origin' does not appear to be a git repository

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ github
git push github dev
```

### æ£€æŸ¥è¿œç¨‹ä»“åº“é…ç½®
```bash
# æŸ¥çœ‹å½“å‰é…ç½®çš„è¿œç¨‹ä»“åº“
git remote -v

# è¾“å‡ºç¤ºä¾‹ï¼š
# github  https://github.com/xkwxdyy/MN-Addons.git (fetch)
# github  https://github.com/xkwxdyy/MN-Addons.git (push)
```

### é‡è¦æé†’
- åœ¨åˆ›å»º GitHub Issue ä¹‹å‰ï¼Œç¡®ä¿ä»£ç å·²ç»æ¨é€åˆ°è¿œç¨‹ä»“åº“
- ä½¿ç”¨ `git push github [åˆ†æ”¯å]` è€Œä¸æ˜¯ `git push origin [åˆ†æ”¯å]`
- å¦‚æœå¿˜è®° pushï¼ŒIssue ä¸­å¼•ç”¨çš„ä»£ç é“¾æ¥å°†æ— æ³•è®¿é—®
## UIAlertView API ä½¿ç”¨è§„èŒƒ(æå…¶é‡è¦!âš ï¸)

### âŒ ç¦æ­¢ä½¿ç”¨

**é”™è¯¯ç¤ºä¾‹(æ°¸è¿œä¸è¦è¿™æ ·å†™):**

```javascript
// âŒ é”™è¯¯:ä½¿ç”¨ UIAlertView.show()
UIAlertView.show(
  "æ ‡é¢˜",
  "æ¶ˆæ¯",
  "å–æ¶ˆ",
  ["é€‰é¡¹1", "é€‰é¡¹2"],
  (alert, buttonIndex) => {
    if (buttonIndex === 0) return  // å–æ¶ˆ
    // å¤„ç†é€»è¾‘
  }
)
```

**é—®é¢˜:**
- `UIAlertView.show()` æ˜¯ä½å±‚çº§åŸç”Ÿ APIï¼Œä¸åº”ç›´æ¥ä½¿ç”¨
- ä½¿ç”¨å›è°ƒæ¨¡å¼ï¼Œå®¹æ˜“äº§ç”Ÿå›è°ƒåœ°ç‹±
- ä¸ç¬¦åˆ MarginNote æ’ä»¶å¼€å‘è§„èŒƒ

### âœ… æ­£ç¡®ä½¿ç”¨:MNUtil.userSelect

**æ­£ç¡®ç¤ºä¾‹(æ¨è):**

```javascript
// âœ… æ­£ç¡®:ä½¿ç”¨ MNUtil.userSelect()
let selected = await MNUtil.userSelect(
  "æ ‡é¢˜",
  "æ¶ˆæ¯",
  ["é€‰é¡¹1", "é€‰é¡¹2"]
)

// è¿”å›å€¼è¯´æ˜:
// 0 = å–æ¶ˆ
// 1 = é€‰é¡¹1
// 2 = é€‰é¡¹2
// ...

if (selected === 0) return  // ç”¨æˆ·å–æ¶ˆ

// å¤„ç†é€‰æ‹©
let selectedIndex = selected - 1  // è½¬æ¢ä¸º 0-based ç´¢å¼•
MNUtil.showHUD(`é€‰æ‹©äº†: ${options[selectedIndex]}`)
```

**å®é™…æ¡ˆä¾‹:æ‰¹é‡è½¬ç§»åŠŸèƒ½**

```javascript
// webviewController.js:2993-3096
transferSelectedPins: async function(button) {
  try {
    // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­é¡¹
    let selectedCards = self.getSelectedCards()
    if (selectedCards.length === 0) {
      MNUtil.showHUD("è¯·å…ˆé€‰ä¸­è‡³å°‘ä¸€ä¸ªé¡¹ç›®")
      return
    }

    // è·å–ç›®æ ‡åˆ†åŒºåˆ—è¡¨
    let currentSection = self.currentSection
    let allSections = SectionRegistry.getOrderedKeys(self.currentViewMode)

    let sectionOptions = []
    let sectionKeys = []

    allSections.forEach(sectionKey => {
      let config = SectionRegistry.getConfig(sectionKey)
      if (config) {
        let displayName = config.displayName || sectionKey
        let icon = config.icon || ""

        if (sectionKey === currentSection) {
          sectionOptions.push(`${icon} ${displayName} (å½“å‰)`)
        } else {
          sectionOptions.push(`${icon} ${displayName}`)
        }
        sectionKeys.push(sectionKey)
      }
    })

    // âœ… ä½¿ç”¨ MNUtil.userSelect æ›¿ä»£ UIAlertView.show
    let selected = await MNUtil.userSelect(
      `æ‰¹é‡è½¬ç§» (å·²é€‰ ${selectedCards.length} é¡¹)`,
      "è¯·é€‰æ‹©ç›®æ ‡åˆ†åŒº",
      sectionOptions
    )

    // ç”¨æˆ·å–æ¶ˆ
    if (selected === 0) return

    // è·å–é€‰ä¸­çš„åˆ†åŒºç´¢å¼•(selected - 1ï¼Œå› ä¸ºè¿”å›å€¼ä»1å¼€å§‹)
    let selectedIndex = selected - 1
    let targetSection = sectionKeys[selectedIndex]

    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å½“å‰åˆ†åŒº
    if (targetSection === currentSection) {
      MNUtil.showHUD("æ— æ³•è½¬ç§»åˆ°å½“å‰åˆ†åŒº")
      return
    }

    // æ‰§è¡Œæ‰¹é‡è½¬ç§»
    let successCount = 0
    let failCount = 0

    MNUtil.undoGrouping(() => {
      selectedCards.forEach(card => {
        let success = pinnerConfig.transferPin(
          card.rawPin,
          card.section,
          targetSection
        )

        if (success) {
          successCount++
        } else {
          failCount++
        }
      })
    })

    // æ˜¾ç¤ºç»“æœ
    if (failCount === 0) {
      MNUtil.showHUD(`âœ… å·²è½¬ç§» ${successCount} ä¸ªé¡¹ç›®`)
    } else {
      MNUtil.showHUD(`âš ï¸ æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`)
    }

    // æ¸…ç©ºé€‰æ‹©å¹¶åˆ·æ–°ç•Œé¢
    self.clearSelection()
    self.refreshSectionCards(currentSection)

  } catch (error) {
    pinnerUtils.addErrorLog(error, "transferSelectedPins")
    MNUtil.showHUD("è½¬ç§»å¤±è´¥: " + error.message)
  }
}
```

### âœ… ç‰¹æ®Šæƒ…å†µ:éœ€è¦è¾“å…¥ + é€‰æ‹©

**å”¯ä¸€å…è®¸çš„ UIAlertView ç›´æ¥è°ƒç”¨åœºæ™¯:**

å½“éœ€è¦**åŒæ—¶æ”¯æŒè¾“å…¥å’Œé€‰æ‹©**æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å®Œæ•´çš„åŸç”Ÿ API:

```javascript
// âœ… å¯ä»¥æ¥å—:éœ€è¦è¾“å…¥æ¡† + å¤šä¸ªé€‰æ‹©æŒ‰é’®
UIAlertView.showWithTitleMessageStyleCancelButtonTitleOtherButtonTitlesTapBlock(
  "ä¿®æ”¹é¡µé¢æ ‡é¢˜",
  "è¾“å…¥æ ‡é¢˜æˆ–é€‰æ‹©é¢„è®¾çŸ­è¯­",
  2,  // alertViewStyle = 2(æ–‡æœ¬è¾“å…¥æ¡†)
  "å–æ¶ˆ",
  ["ç¡®å®š", "é¢„è®¾1", "é¢„è®¾2"],  // å¤šä¸ªé€‰é¡¹æŒ‰é’®
  (alert, buttonIndex) => {
    if (buttonIndex === 0) return  // å–æ¶ˆ

    let inputText = alert.textFieldAtIndex(0).text.trim()

    if (buttonIndex === 1) {
      // ç¡®å®šæŒ‰é’® - ä½¿ç”¨è¾“å…¥æ¡†å†…å®¹
      // ...
    } else {
      // é€‰æ‹©äº†é¢„è®¾çŸ­è¯­
      let preset = presets[buttonIndex - 2]
      // ...
    }
  }
)
```

**ä½¿ç”¨æ¡ä»¶:**
- å¿…é¡»åŒæ—¶éœ€è¦è¾“å…¥å’Œé€‰æ‹©åŠŸèƒ½
- ä½¿ç”¨å®Œæ•´æ–¹æ³•å:`UIAlertView.showWithTitleMessageStyleCancelButtonTitleOtherButtonTitlesTapBlock`
- **ç»å¯¹ä¸èƒ½ç”¨** `UIAlertView.show()`

### å¯¹æ¯”è¡¨æ ¼

| API | æ˜¯å¦å…è®¸ | é€‚ç”¨åœºæ™¯ | è¿”å›æ–¹å¼ |
|-----|---------|---------|---------|
| `UIAlertView.show()` | âŒ ç¦æ­¢ | æ—  | å›è°ƒ |
| `MNUtil.userSelect()` | âœ… æ¨è | çº¯é€‰æ‹© | async/await |
| `UIAlertView.showWithTitle...TapBlock()` | âš ï¸ ç‰¹æ®Šæƒ…å†µ | è¾“å…¥+é€‰æ‹© | å›è°ƒ |

### é‡è¦æé†’

1. **æ°¸è¿œä¸è¦ä½¿ç”¨ `UIAlertView.show()`**
2. **ä¼˜å…ˆä½¿ç”¨ MNUtils å°è£…çš„ API**
3. **ä½¿ç”¨ async/await ä»£æ›¿å›è°ƒæ¨¡å¼**
4. **åªåœ¨å¿…é¡»åŒæ—¶éœ€è¦è¾“å…¥å’Œé€‰æ‹©æ—¶æ‰ä½¿ç”¨åŸç”Ÿ API**
5. **å¿…é¡»ä½¿ç”¨å®Œæ•´çš„æ–¹æ³•åï¼Œè€Œä¸æ˜¯ç®€å†™å½¢å¼**

---

## MNLog æ—¥å¿—ç³»ç»Ÿä½¿ç”¨è§„èŒƒ â­â­â­â­â­

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ MNLog

`MNLog` æ˜¯ MNUtils æä¾›çš„**ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ**ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **ç»“æ„åŒ–æ•°æ®**ï¼šæ”¯æŒ `detail` å­—æ®µè®°å½•è¯¦ç»†ä¿¡æ¯ï¼ˆå¯¹è±¡ã€æ•°ç»„ç­‰ï¼‰
2. **åˆ†ç±»ç®¡ç†**ï¼šé€šè¿‡ `source` å­—æ®µæ ‡è¯†æ—¥å¿—æ¥æº
3. **çº§åˆ«åŒºåˆ†**ï¼šæ”¯æŒ `INFO`ã€`ERROR`ã€`DEBUG` ç­‰çº§åˆ«
4. **å¯è§†åŒ–æŸ¥çœ‹**ï¼šæ—¥å¿—ä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨ MNUtils çš„æ—¥å¿—æŸ¥çœ‹å™¨ä¸­
5. **è¯¦ç»†å±•å¼€**ï¼šç‚¹å‡»æ—¥å¿—å¯ä»¥æŸ¥çœ‹å®Œæ•´çš„ `detail` å†…å®¹

### âŒ é”™è¯¯ç”¨æ³•

**é”™è¯¯ç¤ºä¾‹ï¼š**

```javascript
// âŒ é”™è¯¯1ï¼šåªè®°å½•å­—ç¬¦ä¸²æ¶ˆæ¯ï¼Œæ²¡æœ‰è¯¦ç»†ä¿¡æ¯
MNUtil.log(`å¤„ç†æ ¹å¡ç‰‡: ${rootNote.noteTitle} (${rootNote.noteId})`);
MNUtil.log(`childNotes æ•°é‡: ${rootNote.childNotes?.length || 0}`);

// âŒ é”™è¯¯2ï¼šé”™è¯¯ä¿¡æ¯ä¸å®Œæ•´
MNLog.error(errorMessage, "KnowledgeBaseIndexer");

// âŒ é”™è¯¯3ï¼šä½¿ç”¨ MNUtil.log è®°å½• JSON å­—ç¬¦ä¸²
MNUtil.log(`rootNote è¯¦æƒ…: ${JSON.stringify({
  noteId: rootNote.noteId,
  noteTitle: rootNote.noteTitle
})}`);
```

**é—®é¢˜ï¼š**
- æ—¥å¿—åªæ˜¾ç¤ºæ¶ˆæ¯æ–‡æœ¬ï¼Œæ— æ³•å±•å¼€æŸ¥çœ‹è¯¦ç»†å†…å®¹
- è°ƒè¯•æ—¶å¿…é¡»å¤åˆ¶æ•´ä¸ªé•¿å­—ç¬¦ä¸²æ‰èƒ½çœ‹åˆ°å®Œæ•´ä¿¡æ¯
- æ— æ³•åˆ©ç”¨æ—¥å¿—æŸ¥çœ‹å™¨çš„ç»“æ„åŒ–å±•ç¤ºåŠŸèƒ½

### âœ… æ­£ç¡®ç”¨æ³•

**æ­£ç¡®ç¤ºä¾‹ï¼š**

```javascript
// âœ… æ­£ç¡®1ï¼šä½¿ç”¨å¯¹è±¡å½¢å¼ï¼ŒåŒ…å« detail å­—æ®µ
MNLog.info({
  message: "å¼€å§‹å¤„ç†æ ¹å¡ç‰‡",
  source: "KnowledgeBaseIndexer",
  detail: {
    noteId: rootNote.noteId,
    noteTitle: rootNote.noteTitle,
    childNotesCount: rootNote.childNotes?.length || 0
  }
});

// âœ… æ­£ç¡®2ï¼šè®°å½•é”™è¯¯æ—¶åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
MNLog.error({
  message: "è·å– descendants æ—¶å‘ç”Ÿæ ˆæº¢å‡º",
  source: "KnowledgeBaseIndexer",
  detail: {
    noteId: rootNote.noteId,
    noteTitle: rootNote.noteTitle,
    errorMessage: error?.message,
    errorStack: error?.stack
  }
});

// âœ… æ­£ç¡®3ï¼šæˆåŠŸæ“ä½œä¹Ÿè®°å½•è¯¦ç»†ä¿¡æ¯
MNLog.info({
  message: "æˆåŠŸè·å– descendants",
  source: "KnowledgeBaseIndexer",
  detail: {
    noteId: rootNote.noteId,
    noteTitle: rootNote.noteTitle,
    descendantsCount: descendants.length
  }
});
```

### MNLog API è¯¦è§£

#### 1. åŸºæœ¬æ–¹æ³•

```javascript
// ä¿¡æ¯æ—¥å¿—
MNLog.info({
  message: "æ“ä½œæè¿°",
  source: "æ¥æºæ ‡è¯†",
  detail: { /* è¯¦ç»†ä¿¡æ¯å¯¹è±¡ */ }
});

// é”™è¯¯æ—¥å¿—
MNLog.error({
  message: "é”™è¯¯æè¿°",
  source: "æ¥æºæ ‡è¯†",
  detail: { /* é”™è¯¯è¯¦æƒ…å¯¹è±¡ */ }
});

// è°ƒè¯•æ—¥å¿—
MNLog.debug({
  message: "è°ƒè¯•ä¿¡æ¯",
  source: "æ¥æºæ ‡è¯†",
  detail: { /* è°ƒè¯•è¯¦æƒ…å¯¹è±¡ */ }
});

// é€šç”¨æ—¥å¿—ï¼ˆè‡ªåŠ¨åˆ¤æ–­çº§åˆ«ï¼‰
MNLog.log({
  message: "æ—¥å¿—æ¶ˆæ¯",
  level: "INFO",  // å¯é€‰ï¼š"INFO", "ERROR", "DEBUG"
  source: "æ¥æºæ ‡è¯†",
  detail: { /* è¯¦ç»†ä¿¡æ¯å¯¹è±¡ */ }
});
```

#### 2. ç®€åŒ–å†™æ³•

```javascript
// å¦‚æœåªä¼ å­—ç¬¦ä¸²ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºåŸºæœ¬æ—¥å¿—
MNLog.log("ç®€å•æ¶ˆæ¯");  // ç­‰åŒäº { message: "ç®€å•æ¶ˆæ¯", level: "INFO", source: "Default" }

// æ”¯æŒç¬¬äºŒä¸ªå‚æ•°ä½œä¸º detail
MNLog.log("å¤„ç†å¡ç‰‡", {
  noteId: "xxx",
  noteTitle: "æ ‡é¢˜"
});
```

#### 3. æ—¥å¿—å¯¹è±¡ç»“æ„

```javascript
{
  message: string,      // å¿…éœ€ï¼šæ—¥å¿—æ¶ˆæ¯ï¼ˆç®€çŸ­æè¿°ï¼‰
  level: string,        // å¯é€‰ï¼šæ—¥å¿—çº§åˆ«ï¼ˆé»˜è®¤ "INFO"ï¼‰
  source: string,       // å¯é€‰ï¼šæ¥æºæ ‡è¯†ï¼ˆé»˜è®¤ "Default"ï¼‰
  timestamp: number,    // å¯é€‰ï¼šæ—¶é—´æˆ³ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
  detail: object|string // å¯é€‰ï¼šè¯¦ç»†ä¿¡æ¯ï¼ˆå¯¹è±¡ä¼šè‡ªåŠ¨ JSON.stringifyï¼‰
}
```

### å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šè®°å½•æ“ä½œæµç¨‹

```javascript
// å¼€å§‹å¤„ç†
MNLog.info({
  message: "å¼€å§‹æ„å»ºç´¢å¼•",
  source: "KnowledgeBaseIndexer",
  detail: {
    mode: "full",
    rootNotesCount: rootNotes.length
  }
});

// å¤„ç†ä¸­
for (const rootNote of rootNotes) {
  MNLog.info({
    message: "å¤„ç†æ ¹å¡ç‰‡",
    source: "KnowledgeBaseIndexer",
    detail: {
      noteId: rootNote.noteId,
      noteTitle: rootNote.noteTitle,
      progress: `${processed}/${total}`
    }
  });
}

// å®Œæˆ
MNLog.info({
  message: "ç´¢å¼•æ„å»ºå®Œæˆ",
  source: "KnowledgeBaseIndexer",
  detail: {
    totalCards: validCount,
    totalParts: manifest.metadata.totalParts,
    duration: Date.now() - startTime
  }
});
```

#### åœºæ™¯2ï¼šè®°å½•é”™è¯¯å’Œå¼‚å¸¸

```javascript
try {
  // ä¸šåŠ¡é€»è¾‘
} catch (error) {
  MNLog.error({
    message: "ç´¢å¼•æ„å»ºå¤±è´¥",
    source: "KnowledgeBaseIndexer: buildSearchIndex",
    detail: {
      errorMessage: error?.message || "æœªçŸ¥é”™è¯¯",
      errorStack: error?.stack || "æ— å †æ ˆä¿¡æ¯",
      errorType: typeof error,
      context: {
        mode: mode,
        processedCount: processedCount,
        currentNote: currentNote?.noteId
      }
    }
  });
}
```

#### åœºæ™¯3ï¼šå¾ªç¯å¼•ç”¨æ£€æµ‹

```javascript
// åœ¨ descendantNodes ä¸­æ£€æµ‹å¾ªç¯å¼•ç”¨
if (visited.has(node.noteId)) {
  MNLog.error({
    message: "æ£€æµ‹åˆ°å¾ªç¯å¼•ç”¨",
    source: "MNNote.descendantNodes",
    detail: {
      nodeId: node.noteId,
      nodeTitle: node.noteTitle,
      visitedPath: Array.from(visited)
    }
  });
  return;
}
```

### æœ€ä½³å®è·µ

1. **æ°¸è¿œä½¿ç”¨å¯¹è±¡å½¢å¼**ï¼šå³ä½¿æ˜¯ç®€å•æ—¥å¿—ï¼Œä¹Ÿå»ºè®®ä½¿ç”¨å¯¹è±¡å½¢å¼ä»¥ä¾¿æœªæ¥æ‰©å±•
2. **æ˜ç¡® source**ï¼šä½¿ç”¨ `ç±»å.æ–¹æ³•å` æˆ– `æ’ä»¶å:åŠŸèƒ½å` æ ¼å¼
3. **detail åŒ…å«å…³é”®ä¿¡æ¯**ï¼š
   - æ“ä½œå¯¹è±¡çš„ ID å’Œæ ‡è¯†
   - ç›¸å…³çš„æ•°é‡ã€çŠ¶æ€ã€è¿›åº¦
   - é”™è¯¯çš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆmessageã€stackã€typeï¼‰
4. **åŒºåˆ†æ—¥å¿—çº§åˆ«**ï¼š
   - `INFO`ï¼šæ­£å¸¸æ“ä½œæµç¨‹
   - `ERROR`ï¼šé”™è¯¯å’Œå¼‚å¸¸
   - `DEBUG`ï¼šè°ƒè¯•ä¿¡æ¯ï¼ˆå¯åœ¨å‘å¸ƒæ—¶ç§»é™¤ï¼‰
5. **é¿å…æ•æ„Ÿä¿¡æ¯**ï¼šä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•å¯†ç ã€Token ç­‰æ•æ„Ÿæ•°æ®

### å¯¹æ¯”è¡¨æ ¼

| æ–¹æ³• | é€‚ç”¨åœºæ™¯ | detail æ”¯æŒ | å¯è§†åŒ– | æ¨èåº¦ |
|------|---------|-----------|--------|--------|
| `MNLog.info()` | ç»“æ„åŒ–æ—¥å¿— | âœ… å®Œæ•´æ”¯æŒ | âœ… å¯å±•å¼€ | â­â­â­â­â­ |
| `MNLog.error()` | é”™è¯¯æ—¥å¿— | âœ… å®Œæ•´æ”¯æŒ | âœ… å¯å±•å¼€ | â­â­â­â­â­ |
| `MNUtil.log()` | ç®€å•æ–‡æœ¬ | âŒ ä¸æ”¯æŒ | âŒ çº¯æ–‡æœ¬ | â­â­ |
| `console.log()` | æµè§ˆå™¨è°ƒè¯• | âŒ ä¸æ”¯æŒ | âŒ æ§åˆ¶å° | â­ |

### é‡è¦æé†’

1. **ä¼˜å…ˆä½¿ç”¨ `MNLog`**ï¼šæ‰€æœ‰æ–°ä»£ç éƒ½åº”è¯¥ä½¿ç”¨ `MNLog` è€Œä¸æ˜¯ `MNUtil.log()`
2. **detail æ˜¯æ ¸å¿ƒ**ï¼šå……åˆ†åˆ©ç”¨ `detail` å­—æ®µè®°å½•è¯¦ç»†ä¿¡æ¯
3. **source è¦æ˜ç¡®**ï¼šä¾¿äºè¿‡æ»¤å’Œå®šä½é—®é¢˜
4. **å¯¹è±¡è‡ªåŠ¨åºåˆ—åŒ–**ï¼š`detail` ä¸­çš„å¯¹è±¡ä¼šè‡ªåŠ¨ `JSON.stringify`ï¼Œä¸éœ€è¦æ‰‹åŠ¨è½¬æ¢
5. **æŸ¥çœ‹æ—¥å¿—**ï¼šä½¿ç”¨ `MNLog.showLogViewer()` æ‰“å¼€æ—¥å¿—æŸ¥çœ‹å™¨
